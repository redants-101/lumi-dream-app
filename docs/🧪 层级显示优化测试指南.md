# 🧪 层级显示优化测试指南

## 🎯 测试目标

验证方案 A + B 是否消除了用户层级显示闪烁问题。

**核心验证**：
- ✅ Anonymous：立即显示 2/4
- ✅ Free 首次：Skeleton → 5/10
- ✅ Basic 首次：Skeleton → 10/50（无 5/10 错误显示）
- ✅ Pro 首次：Skeleton → Premium AI

---

## 🚀 快速测试步骤

### 准备工作

```bash
1. 确保开发服务器运行中
2. 准备测试账号：
   - Free 账号
   - Basic 账号（如有）
   - Pro 账号（如有）
```

---

## 测试 1：Anonymous 用户 ✅

### 步骤

```bash
1. 打开无痕窗口（Ctrl + Shift + N）
2. 访问：http://localhost:3000
3. 打开开发者工具（F12）
4. 观察右上角显示
```

### 预期结果

```
立即显示："2 today • 4 this month" ✅
无加载状态 ✅
无闪烁 ✅
```

### 验证点

- [ ] 页面加载后立即显示 2/4
- [ ] 无 Skeleton
- [ ] 无数值变化
- [ ] localStorage 无 "lumi_user_tier" 缓存

### 控制台日志

```
（无特殊日志，anonymous 用户不调用 API）
```

---

## 测试 2：Free 用户（首次登录）✅

### 步骤

```bash
1. 清除浏览器缓存（Ctrl + Shift + Delete）
2. 打开无痕窗口
3. 访问：http://localhost:3000
4. 打开开发者工具 → Network + Console
5. 登录 Free 账号
6. 观察右上角显示变化
```

### 预期结果

```
0-1000ms：显示 Skeleton（灰色加载条）✅
1000ms：显示 "5 today • 10 this month" ✅
无闪烁 ✅
```

### 验证点

- [ ] 登录后显示 Skeleton（约 1 秒）
- [ ] 加载完成显示 5/10
- [ ] 无 "0 today" 或其他错误显示
- [ ] localStorage 有 "lumi_user_tier": "free"

### 控制台日志

```
[Usage Limit V2] 🔄 Initializing user data (first time)...
[Usage Limit V2] ✅ User info loaded: free
[Usage Limit V2] ✅ Usage synced from user-info: { dailyCount: 0, monthlyCount: 0, ... }
```

### Network 面板

```
GET /api/user-info  200  ~1000ms  ✅ 只 1 次
```

---

## 测试 3：Basic 用户（首次登录）⭐ 核心测试

### 步骤

```bash
1. 清除浏览器缓存
2. 打开无痕窗口
3. 访问：http://localhost:3000
4. 打开开发者工具 → Network + Console
5. 登录 Basic 账号
6. 仔细观察右上角显示变化
```

### 预期结果（修复后）

```
0-1000ms：显示 Skeleton ✅
1000ms：显示 "10 today • 50 this month" ✅
无闪烁 ✅
```

### ⚠️ 关键验证：不应该看到

```
❌ "0 today, 0 this month"
❌ "5 today, 10 this month"（free 层级的错误显示）
```

### 验证点

- [ ] 登录后显示 Skeleton
- [ ] 加载完成立即显示 10/50 ✅ 核心
- [ ] **绝对不出现** 5/10 的错误显示 ✅✅ 最重要
- [ ] localStorage 有 "lumi_user_tier": "basic"

### 控制台日志

```
[Usage Limit V2] 🔄 Initializing user data (first time)...
[Usage Limit V2] ✅ User info loaded: basic
[Usage Limit V2] ✅ Usage synced from user-info: { dailyCount: 0, monthlyCount: 0, ... }
```

---

## 测试 4：Basic 用户（再次访问）⭐ 最佳效果

### 步骤

```bash
1. 已登录 Basic 用户（测试 3 完成后）
2. 刷新页面（F5）
3. 观察右上角显示变化
```

### 预期结果

```
0ms：立即显示 "10 today • 50 this month" ✅ 使用缓存
1000ms：API 完成，保持不变 ✅
完全无闪烁 ✅ 最佳效果
```

### 验证点

- [ ] **立即显示** 10/50（无 Skeleton）✅ 最佳体验
- [ ] API 完成后无变化
- [ ] 完全无闪烁
- [ ] localStorage 缓存生效

### 控制台日志

```
[Usage Limit V2] 📦 Using cached tier: basic  ← 关键日志
[Usage Limit V2] 🔄 Initializing user data (first time)...
[Usage Limit V2] ✅ User info loaded: basic
```

---

## 测试 5：Pro 用户（首次登录）✅

### 步骤

```bash
1. 清除浏览器缓存
2. 打开无痕窗口
3. 登录 Pro 账号
4. 观察右上角显示
```

### 预期结果

```
0-1000ms：显示 Skeleton ✅
1000ms：显示 "🔥 Premium AI (100 premium) | 20 today" ✅
无闪烁 ✅
```

### 验证点

- [ ] 登录后显示 Skeleton
- [ ] 加载完成显示 Premium AI 标识
- [ ] **不出现** free/basic 层级显示
- [ ] localStorage 有 "lumi_user_tier": "pro"

---

## 测试 6：Pro 用户（再次访问）✅

### 步骤

```bash
1. 已登录 Pro 用户
2. 刷新页面（F5）
3. 观察显示
```

### 预期结果

```
0ms：立即显示 "🔥 Premium AI (100 premium) | 20 today" ✅
1000ms：保持不变 ✅
完全无闪烁 ✅
```

### 验证点

- [ ] **立即显示** Premium AI（无 Skeleton）
- [ ] 完全无闪烁
- [ ] 缓存生效

---

## 测试 7：登出再登录（不同账号）✅

### 步骤

```bash
1. Basic 用户登录（缓存 "basic"）
2. 登出
3. Free 用户登录
4. 观察显示
```

### 预期结果

```
登出：
  ↓
清除缓存（lumi_user_tier）✅
  ↓
Free 用户登录：
  ↓
显示 Skeleton（无缓存）✅
  ↓
显示 "5 today • 10 this month" ✅ 正确（free）
```

### 验证点

- [ ] 登出时清除缓存
- [ ] **不显示上个用户的层级**（如 10/50）
- [ ] 显示新用户的正确层级（5/10）

### 控制台日志

```
登出：
[Usage Limit V2] 🔄 User logged out, resetting state...
[Usage Limit V2] 🗑️ Cleared cached tier

登录：
[Usage Limit V2] 🔄 Initializing user data (first time)...
[Usage Limit V2] ✅ User info loaded: free
```

---

## 测试 8：用户升级（Free → Basic）✅

### 步骤

```bash
1. 以 Free 用户登录（缓存 "free"）
2. 完成付费升级到 Basic
3. 刷新页面
4. 观察显示变化
```

### 预期结果

```
刷新前：
  显示 "5 today • 10 this month"（free）
  
刷新后：
  0ms：显示 "5 today • 10 this month"（缓存，暂时不准确）⚠️
  1000ms：显示 "10 today • 50 this month"（API 验证后）✅
```

### 验证点

- [ ] 初始使用缓存（可能短暂不准确）
- [ ] API 完成后自动更正
- [ ] 缓存更新为 "basic"
- [ ] 闪烁 1 次（可接受）

### 建议

**支付成功后主动刷新**：
```typescript
// pricing/success/page.tsx
const { refreshUserInfo } = useUsageLimitV2()
await refreshUserInfo()  // ✅ 立即更新层级
```

---

## 📊 测试记录表

### Anonymous 用户

| 检查项 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| 立即显示 2/4 | ✅ | | [ ] |
| 无 Skeleton | ✅ | | [ ] |
| 无闪烁 | ✅ | | [ ] |

### Free 用户（首次）

| 检查项 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| 显示 Skeleton | ✅ | | [ ] |
| 加载后显示 5/10 | ✅ | | [ ] |
| 无闪烁 | ✅ | | [ ] |
| 缓存 "free" | ✅ | | [ ] |

### Basic 用户（首次）⭐

| 检查项 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| 显示 Skeleton | ✅ | | [ ] |
| 加载后显示 10/50 | ✅ | | [ ] |
| **不显示 5/10** | ✅ | | [ ] |
| 无闪烁 | ✅ | | [ ] |
| 缓存 "basic" | ✅ | | [ ] |

### Basic 用户（再次访问）⭐

| 检查项 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| **立即显示 10/50** | ✅ | | [ ] |
| 无 Skeleton | ✅ | | [ ] |
| 完全无闪烁 | ✅ | | [ ] |

### Pro 用户

| 检查项 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| 显示 Skeleton | ✅ | | [ ] |
| Premium AI 标识 | ✅ | | [ ] |
| 无闪烁 | ✅ | | [ ] |
| 缓存 "pro" | ✅ | | [ ] |

---

## 🔍 验证 localStorage

### 查看缓存值

```javascript
// 在浏览器控制台执行
localStorage.getItem('lumi_user_tier')

// 预期输出：
// Anonymous: null
// Free: "free"
// Basic: "basic"
// Pro: "pro"
```

### 清除缓存（测试用）

```javascript
// 清除层级缓存
localStorage.removeItem('lumi_user_tier')

// 清除所有缓存
localStorage.clear()
```

---

## ✅ 测试完成清单

### 基础功能
- [ ] Anonymous 用户正常
- [ ] Free 用户正常
- [ ] Basic 用户正常
- [ ] Pro 用户正常

### 核心修复（最重要）
- [ ] Basic 用户不再显示 5/10 ✅✅
- [ ] Pro 用户不再显示 5/10 ✅✅
- [ ] 无闪烁

### 缓存机制
- [ ] 登录时缓存层级
- [ ] 登出时清除缓存
- [ ] 再次访问使用缓存

### 特殊场景
- [ ] 用户升级正确更新
- [ ] 用户降级正确更新
- [ ] 登出再登录缓存已清除

---

## 🎉 预期测试结果

**核心修复**：
✅ Basic 用户首次登录：Skeleton → 10/50（无 5/10 错误）  
✅ Basic 用户再次访问：立即显示 10/50（完全无闪烁）  
✅ Pro 用户：同样无闪烁，Premium 标识立即显示  

**用户体验**：
- Anonymous：保持优秀 ⭐⭐⭐⭐⭐
- Free 首次：良好 ⭐⭐⭐⭐
- Basic 首次：良好 ⭐⭐⭐⭐
- Pro 首次：良好 ⭐⭐⭐⭐
- 再次访问：完美 ⭐⭐⭐⭐⭐

---

**祝测试顺利！** 🚀

如果发现任何问题，请记录在测试表格中。

