# 🧪 方案 3：合并接口测试指南

## 🎯 测试目标

验证新的 `/api/user-info` 合并接口是否正常工作：
- ✅ 登录时只调用 1 次 API
- ✅ 正确返回订阅和使用数据
- ✅ 响应速度提升 50%
- ✅ 前端正确显示数据

---

## 🚀 快速测试步骤

### 步骤 1：清理环境

```bash
1. 关闭所有浏览器标签页
2. 清除浏览器缓存：
   - Chrome: Ctrl + Shift + Delete
   - 选择"所有时间"
   - 勾选"缓存的图片和文件"
   - 点击"清除数据"
3. 打开新的无痕窗口（Ctrl + Shift + N）
```

### 步骤 2：打开开发者工具

```bash
1. 按 F12 打开开发者工具
2. 切换到 Network 标签
3. 勾选 "Preserve log"（保留日志）
4. 清空当前日志（点击 🚫 图标）
```

### 步骤 3：访问并登录

```bash
1. 访问：http://localhost:3000
2. 点击登录按钮
3. 完成登录流程
4. 观察 Network 面板
```

### 步骤 4：验证 API 调用

在 Network 面板中查找以下请求：

#### ✅ 应该看到（新接口）
```
Name: user-info
Method: GET
Status: 200
Time: ~1000-1500ms
```

#### ❌ 不应该看到（旧接口）
```
subscription/manage  ← 不应该出现
usage                ← 不应该出现
```

**关键验证**：
- ✅ 只有 1 次 `/api/user-info` 调用
- ✅ 没有 `/api/subscription/manage` 调用
- ✅ 没有 `/api/usage` 调用

---

## 🔍 详细验证步骤

### 验证 1：API 响应数据

#### 查看响应内容

1. 在 Network 面板点击 `user-info` 请求
2. 切换到 "Response" 标签
3. 验证响应格式

#### 预期响应格式

```json
{
  "success": true,
  "data": {
    "subscription": {
      "tier": "free",           ← 验证层级正确
      "status": "active"        ← 验证状态
    },
    "usage": {
      "daily": 0,               ← 验证日使用次数
      "monthly": 0              ← 验证月使用次数
    },
    "limits": {
      "daily": 5,               ← 验证日限制（free = 5）
      "monthly": 10             ← 验证月限制（free = 10）
    },
    "remaining": {
      "daily": 5,               ← 验证剩余（5-0=5）
      "monthly": 10             ← 验证剩余（10-0=10）
    }
  },
  "metadata": {
    "source": "database",       ← 验证数据源
    "userId": "xxx",            ← 验证用户 ID
    "tier": "free"              ← 验证层级
  }
}
```

#### 验证清单

- [ ] `success` 为 `true`
- [ ] `data.subscription.tier` 正确（free/basic/pro）
- [ ] `data.usage` 包含 `daily` 和 `monthly`
- [ ] `data.limits` 包含正确的限制值
- [ ] `data.remaining` 计算正确
- [ ] `metadata.source` 为 `"database"`

---

### 验证 2：前端显示

#### 检查页面元素

登录成功后，检查页面右上角显示：

```
Free 用户应该看到：
"5 today, 10 this month"

Basic 用户应该看到：
"10 today, 50 this month"

Pro 用户应该看到：
"20 today, 200 this month"
或
"🔥 Premium AI (100 premium) | 20 today"
```

#### 验证清单

- [ ] 显示正确的剩余次数
- [ ] 显示正确的层级标识
- [ ] 无错误提示
- [ ] 页面加载流畅

---

### 验证 3：控制台日志

#### 打开 Console 标签

在开发者工具切换到 Console 标签，查找以下日志：

#### 预期日志（优化后）

```
[Usage Limit V2] 🔄 Initializing user data (first time)...
[Usage Limit V2] ✅ User info loaded: free
[Usage Limit V2] ✅ Usage synced from user-info: { dailyCount: 0, monthlyCount: 0, date: '2025-10-30', month: '2025-10' }
```

#### 不应该看到（旧日志）

```
❌ [Usage Limit V2] User subscription loaded: free
❌ [Usage Limit V2] ✅ Synced from database: { ... }
```

#### 验证清单

- [ ] 看到 "User info loaded" 日志
- [ ] 看到 "Usage synced from user-info" 日志
- [ ] 只有 1 组初始化日志（不重复）
- [ ] 没有错误日志

---

### 验证 4：响应时间

#### 测量性能

在 Network 面板查看 `user-info` 请求的时间：

```
首次访问（含编译）：
Time: 1500-2500ms  ← 包含编译时间，正常

后续访问（无编译）：
Time: 800-1200ms   ← 纯 API 响应时间
```

#### 对比旧版本

```
旧版本（2 次调用）：
subscription/manage: ~1000ms
usage: ~1000ms
总计: ~2000ms

新版本（1 次调用）：
user-info: ~1000ms  ✅ 减少 50%
```

#### 验证清单

- [ ] 响应时间 < 1500ms（不含首次编译）
- [ ] 比旧版本快（如果有对比数据）

---

## 🧪 功能测试场景

### 场景 1：Anonymous 用户

```bash
步骤：
1. 未登录状态访问首页
2. 观察 Network 面板

预期：
- 不调用 /api/user-info（anonymous 用户无需调用）
- 页面显示："2 today, 4 this month"
```

### 场景 2：Free 用户登录

```bash
步骤：
1. 使用 Free 账号登录
2. 观察 API 调用

预期：
✅ 调用 1 次 /api/user-info
✅ 返回 tier: "free"
✅ 页面显示："5 today, 10 this month"
```

### 场景 3：使用解梦功能

```bash
步骤：
1. 登录后输入梦境
2. 点击解析
3. 观察使用次数变化

预期：
✅ 解析成功
✅ 页面显示更新为："4 today, 9 this month"
✅ 使用次数正确减少
```

### 场景 4：跨页面导航

```bash
步骤：
1. 登录状态
2. 访问：Home → Dashboard → Home
3. 观察 Network 面板

预期：
✅ 初始化时调用 1 次 /api/user-info
✅ Dashboard 可能调用 /api/subscription/manage（正常，未迁移）
✅ 返回 Home 不重复调用（已初始化）
```

### 场景 5：刷新页面

```bash
步骤：
1. 登录状态
2. 按 F5 刷新页面
3. 观察 API 调用

预期：
✅ 重新调用 1 次 /api/user-info（正常，React 重新挂载）
✅ 数据正确加载
```

### 场景 6：手动刷新数据

```bash
前提：需要在代码中临时添加测试按钮

测试代码：
const { refreshUserInfo } = useUsageLimitV2()

<button onClick={refreshUserInfo}>
  刷新用户信息
</button>

步骤：
1. 点击"刷新用户信息"按钮
2. 观察 Network 面板

预期：
✅ 调用 1 次 /api/user-info
✅ 前端数据更新
```

---

## 🔍 错误场景测试

### 场景 1：网络断开

```bash
步骤：
1. 打开开发者工具 → Network 标签
2. 选择 "Offline"（离线模式）
3. 刷新页面
4. 观察错误处理

预期：
✅ 降级为 free 层级
✅ 显示友好错误提示（可选）
✅ 应用仍然可用（使用 localStorage）
```

### 场景 2：API 返回错误

```bash
模拟方法：
临时修改 API 返回 500 错误

预期：
✅ 控制台显示错误日志
✅ 降级为 free 层级
✅ 不影响用户使用
```

---

## 📊 性能基准测试

### 测试工具

使用 Chrome DevTools Performance 标签：

```bash
1. 打开 Performance 标签
2. 点击 Record（录制）
3. 刷新页面（F5）
4. 等待页面完全加载
5. 停止录制
6. 分析结果
```

### 关键指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| API 调用次数 | 1 次 | /api/user-info |
| API 响应时间 | < 1500ms | 不含编译时间 |
| 首屏渲染时间 | < 3000ms | FCP |
| 可交互时间 | < 4000ms | TTI |

---

## 🐛 常见问题排查

### 问题 1：仍然看到 2 次 API 调用

**症状**：
```
GET /api/subscription/manage
GET /api/usage
```

**原因**：
- 代码未正确更新
- 浏览器缓存未清除
- 仍在使用旧代码

**解决**：
```bash
1. 确认 hooks/use-usage-limit-v2.ts 已修改
2. 清除浏览器缓存
3. 重启开发服务器（Ctrl+C, 然后重新运行）
```

### 问题 2：API 返回 404

**症状**：
```
GET /api/user-info 404 (Not Found)
```

**原因**：
- 新接口文件未创建
- 文件路径错误

**解决**：
```bash
1. 确认文件存在：app/api/user-info/route.ts
2. 检查文件名拼写
3. 重启开发服务器
```

### 问题 3：前端数据未更新

**症状**：
- API 调用成功
- 但页面显示不正确

**原因**：
- Hook 未正确处理响应
- 状态更新失败

**解决**：
```bash
1. 打开 Console 查看错误日志
2. 检查 fetchUserInfo 函数实现
3. 验证响应数据格式
```

### 问题 4：控制台显示错误

**症状**：
```
[Usage Limit V2] Error fetching user info: ...
```

**排查步骤**：
```bash
1. 检查 Network 面板的响应状态
2. 查看 Response 内容
3. 检查数据库连接
4. 验证 Supabase 配置
```

---

## ✅ 测试完成清单

### 基础功能

- [ ] API 只调用 1 次 `/api/user-info`
- [ ] 响应包含完整的订阅和使用数据
- [ ] 响应格式符合预期
- [ ] 前端正确显示层级和剩余次数

### 性能验证

- [ ] 响应时间 < 1500ms
- [ ] 比旧版本快（如有对比）
- [ ] 无明显延迟或卡顿

### 兼容性验证

- [ ] Anonymous 用户正常工作
- [ ] Free/Basic/Pro 用户正常工作
- [ ] 跨页面导航正常
- [ ] 页面刷新正常

### 错误处理

- [ ] 网络断开时降级处理正确
- [ ] API 错误时有友好提示
- [ ] 不影响用户正常使用

### 日志验证

- [ ] 控制台日志清晰正确
- [ ] 无重复初始化
- [ ] 无错误日志

---

## 📝 测试报告模板

```markdown
## 方案 3 合并接口测试报告

**测试日期**：2025-10-30  
**测试人**：[你的名字]  
**测试环境**：本地开发

### 功能测试

#### ✅ API 调用
- [x] 只调用 1 次 /api/user-info
- [x] 响应时间：1200ms
- [x] 响应格式正确

#### ✅ 前端显示
- [x] Free 用户显示："5 today, 10 this month"
- [x] 使用次数正确更新
- [x] 无错误提示

#### ✅ 性能
- [x] API 响应 < 1500ms
- [x] 页面加载流畅
- [x] 比旧版本快 50%

### 发现的问题
1. [如有问题，在此列出]

### 总结
✅ 所有测试通过，方案 3 工作正常，可以部署
```

---

## 🎯 下一步

测试通过后：

1. **✅ 提交代码**
   ```bash
   git add .
   git commit -m "feat: 实施方案3 - 合并接口优化"
   ```

2. **✅ 部署到生产**
   - 推送到 GitHub
   - Vercel 自动部署

3. **✅ 监控生产环境**
   - 观察 API 调用次数
   - 监控响应时间
   - 收集用户反馈

4. **✅ 性能优化迭代**
   - 考虑实施方案 1（缓存）
   - 优化 Dashboard 页面
   - 全面迁移到新接口

---

**祝测试顺利！** 🎉

如果遇到任何问题，请参考常见问题排查部分，或查看实施文档。

