# ğŸš¨ æ–¹æ¡ˆ 3 é—®é¢˜åˆ†æä¸ä¿®å¤

## âŒ å‘ç°çš„é—®é¢˜

ç»è¿‡ç³»ç»Ÿæ€§å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹ä¸¥é‡é—®é¢˜ï¼š

---

## é—®é¢˜ 1ï¼šå‡½æ•°å£°æ˜é¡ºåºé”™è¯¯ âš ï¸ **é«˜å±**

### é—®é¢˜æè¿°

```typescript
// âŒ é”™è¯¯çš„ä»£ç é¡ºåº
useEffect(() => {
  if (isAuthenticated && user && !initialized) {
    fetchUserInfo()  // â† è°ƒç”¨å‡½æ•°
    setInitialized(true)
  }
}, [isAuthenticated, user, initialized])

// å‡½æ•°åœ¨ useEffect ä¹‹åæ‰å£°æ˜ âŒ
const fetchUserInfo = async () => {
  // ...
}
```

### é—®é¢˜åŸå› 

JavaScript ä¸­ï¼š
- `function` å£°æ˜ä¼šè¢«æå‡ï¼ˆhoistingï¼‰âœ…
- `const` ç®­å¤´å‡½æ•°**ä¸ä¼š**è¢«æå‡ âŒ
- åœ¨å£°æ˜ä¹‹å‰è°ƒç”¨ä¼šå¯¼è‡´ `ReferenceError` æˆ– `undefined`

### å½±å“

- **ç¼–è¯‘å¯èƒ½é€šè¿‡**ï¼ˆTypeScript åªæ£€æŸ¥ç±»å‹ï¼‰
- **è¿è¡Œæ—¶æŠ¥é”™**ï¼š`fetchUserInfo is not defined`
- **ç™»å½•åŠŸèƒ½å®Œå…¨å¤±æ•ˆ** ğŸš¨

### è§£å†³æ–¹æ¡ˆ

æ–¹æ¡ˆ Aï¼šå°†å‡½æ•°ç§»åˆ° useEffect ä¹‹å‰
æ–¹æ¡ˆ Bï¼šå°†ä¾èµ–é¡¹æ·»åŠ åˆ° useEffect

---

## é—®é¢˜ 2ï¼šé”™è¯¯å¤„ç†ä¸å®Œæ•´ âš ï¸ **ä¸­å±**

### é—®é¢˜æè¿°

```typescript
// fetchUserInfo å‡½æ•°ä¸­
if (result.success) {
  // æ›´æ–°æ•°æ®
} else {
  setSubscription({ tier: "free", status: "active" })  // âŒ æ²¡æœ‰æ›´æ–° usageData
}
```

### é—®é¢˜åŸå› 

- åªé™çº§äº† subscription
- æ²¡æœ‰æ›´æ–° usageData
- ç”¨æˆ·å¯èƒ½çœ‹åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€

### å½±å“

- è®¢é˜…ä¿¡æ¯æ˜¾ç¤º "free"
- ä½†ä½¿ç”¨æ¬¡æ•°å¯èƒ½æ˜¾ç¤ºæ—§æ•°æ®æˆ– 0
- ç”¨æˆ·ä½“éªŒæ··ä¹±

---

## é—®é¢˜ 3ï¼šç¼ºå°‘ usageData åˆå§‹åŒ– âš ï¸ **ä¸­å±**

### é—®é¢˜æè¿°

```typescript
// fetchUserInfo é”™è¯¯å¤„ç†
catch (error) {
  console.error("[Usage Limit V2] Error fetching user info:", error)
  setSubscription({ tier: "free", status: "active" })  // âŒ ç¼ºå°‘ usageData åˆå§‹åŒ–
}
```

### é—®é¢˜åŸå› 

- API å¤±è´¥æ—¶ï¼Œsubscription é™çº§ä½† usageData æœªåˆå§‹åŒ–
- å¯èƒ½å¯¼è‡´ usageData ä¸º null
- åç»­ä½¿ç”¨ usageData çš„ä»£ç ä¼šæŠ¥é”™

### å½±å“

- `remainingDaily` / `remainingMonthly` è®¡ç®—é”™è¯¯
- é¡µé¢å¯èƒ½å´©æºƒæˆ–æ˜¾ç¤ºå¼‚å¸¸

---

## é—®é¢˜ 4ï¼šDashboard é¡µé¢æœªè¿ç§» âš ï¸ **ä½å±**

### é—®é¢˜æè¿°

```typescript
// app/dashboard/page.tsx
const response = await fetch("/api/subscription/manage")  // â† ä»ä½¿ç”¨æ—§æ¥å£
```

### å½±å“

- ç”¨æˆ·è®¿é—® Dashboard æ—¶ä¼šé¢å¤–è°ƒç”¨ API
- æ— æ³•äº«å—åˆå¹¶æ¥å£çš„æ€§èƒ½ä¼˜åŠ¿
- Home â†’ Dashboard ä¼šäº§ç”Ÿ 2 æ¬¡ API è°ƒç”¨

### é¢„æœŸ vs å®é™…

**é¢„æœŸä¼˜åŒ–æ•ˆæœ**ï¼š
```
Home â†’ Dashboard: 1 æ¬¡ API è°ƒç”¨ï¼ˆuser-infoï¼‰
```

**å®é™…æƒ…å†µ**ï¼š
```
Home: 1 æ¬¡ /api/user-info
Dashboard: 1 æ¬¡ /api/subscription/manage
æ€»è®¡: 2 æ¬¡ API è°ƒç”¨ âš ï¸
```

---

## é—®é¢˜ 5ï¼šç±»å‹å®šä¹‰ä¸å®Œæ•´ âš ï¸ **ä½å±**

### é—®é¢˜æè¿°

```typescript
// app/api/user-info/route.ts
subscription = {
  // ...
  creem_subscription_id: subscriptionResult.data.creem_subscription_id,
} as any  // âŒ ä½¿ç”¨ any ç»•è¿‡ç±»å‹æ£€æŸ¥
```

### é—®é¢˜åŸå› 

- è¿”å›çš„ subscription ç»“æ„ä¸æ—§æ¥å£ä¸å®Œå…¨ä¸€è‡´
- ä½¿ç”¨ `as any` æ©ç›–äº†ç±»å‹é—®é¢˜

### å½±å“

- å¯èƒ½çš„è¿è¡Œæ—¶ç±»å‹é”™è¯¯
- éš¾ä»¥ç»´æŠ¤å’Œè°ƒè¯•

---

## é—®é¢˜ 6ï¼šæ•°æ®ç»“æ„ä¸ä¸€è‡´ âš ï¸ **ä¸­å±**

### é—®é¢˜æè¿°

æ—§æ¥å£è¿”å›ï¼š
```json
{
  "data": {
    "tier": "free",
    "status": "active",
    "user_id": "xxx",
    "created_at": "...",
    "updated_at": "..."
  }
}
```

æ–°æ¥å£è¿”å›ï¼š
```json
{
  "data": {
    "subscription": {
      "tier": "free",
      "status": "active"
      // âŒ ç¼ºå°‘å…¶ä»–å­—æ®µ
    }
  }
}
```

### å½±å“

- å¦‚æœæœ‰ä»£ç ä¾èµ– `user_id`, `created_at` ç­‰å­—æ®µä¼šæŠ¥é”™
- å¯èƒ½å¯¼è‡´ Dashboard æˆ–å…¶ä»–é¡µé¢åŠŸèƒ½å¼‚å¸¸

---

## é—®é¢˜ 7ï¼šç¼ºå°‘ç¼“å­˜å¤±æ•ˆæœºåˆ¶ âš ï¸ **ä½å±**

### é—®é¢˜æè¿°

```typescript
const [initialized, setInitialized] = useState(false)

// åªåœ¨é¦–æ¬¡è®¤è¯æ—¶è°ƒç”¨
if (isAuthenticated && user && !initialized) {
  fetchUserInfo()
  setInitialized(true)  // âŒ ä¹‹åæ°¸è¿œä¸ä¼šå†è°ƒç”¨
}
```

### é—®é¢˜åŸå› 

- ç”¨æˆ·ä»˜è´¹æˆåŠŸåï¼Œæ•°æ®ä¸ä¼šè‡ªåŠ¨æ›´æ–°
- éœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°æ–°çš„å±‚çº§

### å½±å“

- ç”¨æˆ·ä»˜è´¹åçœ‹ä¸åˆ°å³æ—¶æ›´æ–°
- éœ€è¦æ‰‹åŠ¨åˆ·æ–°æˆ–è°ƒç”¨ `refreshUserInfo`

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šè°ƒæ•´å‡½æ•°å£°æ˜é¡ºåº âœ… å¿…é¡»

```typescript
export function useUsageLimitV2() {
  const { isAuthenticated, user } = useAuth()
  const [usageData, setUsageData] = useState<UsageData | null>(null)
  const [isLimitReached, setIsLimitReached] = useState(false)
  const [subscription, setSubscription] = useState<any>(null)
  const [subscriptionLoading, setSubscriptionLoading] = useState(false)
  const [initialized, setInitialized] = useState(false)

  // âœ… å°†å‡½æ•°å£°æ˜ç§»åˆ°å‰é¢
  const fetchUserInfo = useCallback(async () => {
    if (subscriptionLoading) return
    
    setSubscriptionLoading(true)
    try {
      // ... å®ç°ä»£ç 
    } catch (error) {
      console.error("[Usage Limit V2] Error fetching user info:", error)
      
      // âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
      setSubscription({ tier: "free", status: "active" })
      
      // âœ… åˆå§‹åŒ– usageData
      const today = getTodayDate()
      const thisMonth = getCurrentMonth()
      const defaultData: UsageData = {
        dailyCount: 0,
        date: today,
        monthlyCount: 0,
        month: thisMonth,
      }
      saveUsageData(defaultData)
      setUsageData(defaultData)
      updateLimitStatus(defaultData)
    } finally {
      setSubscriptionLoading(false)
    }
  }, [subscriptionLoading])  // âœ… æ·»åŠ ä¾èµ–
  
  // å…¶ä»–è¾…åŠ©å‡½æ•°...
  
  // âœ… useEffect æ”¾åœ¨æ‰€æœ‰å‡½æ•°å£°æ˜ä¹‹å
  useEffect(() => {
    if (isAuthenticated && user && !initialized) {
      console.log("[Usage Limit V2] ğŸ”„ Initializing user data (first time)...")
      fetchUserInfo()
      setInitialized(true)
    } else if (!isAuthenticated && initialized) {
      console.log("[Usage Limit V2] ğŸ”„ User logged out, resetting state...")
      setSubscription(null)
      setInitialized(false)
    }
  }, [isAuthenticated, user, initialized, fetchUserInfo])  // âœ… æ·»åŠ ä¾èµ–
  
  // ...
}
```

### ä¿®å¤ 2ï¼šå®Œå–„é”™è¯¯å¤„ç† âœ… å¿…é¡»

```typescript
const fetchUserInfo = async () => {
  if (subscriptionLoading) return
  
  setSubscriptionLoading(true)
  try {
    const response = await fetch("/api/user-info")
    
    if (response.ok) {
      const result = await response.json()
      
      if (result.success) {
        // æ›´æ–°è®¢é˜…ä¿¡æ¯
        setSubscription(result.data.subscription)
        
        // æ›´æ–°ä½¿ç”¨æƒ…å†µ
        const syncedData: UsageData = {
          dailyCount: result.data.usage.daily,
          date: getTodayDate(),
          monthlyCount: result.data.usage.monthly,
          month: getCurrentMonth(),
        }
        
        saveUsageData(syncedData)
        setUsageData(syncedData)
        updateLimitStatus(syncedData)
      } else {
        // âœ… å®Œæ•´çš„é”™è¯¯é™çº§
        throw new Error(result.error?.message || "API returned error")
      }
    } else {
      throw new Error(`HTTP ${response.status}`)
    }
  } catch (error) {
    console.error("[Usage Limit V2] Error fetching user info:", error)
    
    // âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
    setSubscription({ tier: "free", status: "active" })
    
    // âœ… åˆå§‹åŒ–é»˜è®¤ usageData
    const defaultData: UsageData = {
      dailyCount: 0,
      date: getTodayDate(),
      monthlyCount: 0,
      month: getCurrentMonth(),
    }
    
    saveUsageData(defaultData)
    setUsageData(defaultData)
    updateLimitStatus(defaultData)
  } finally {
    setSubscriptionLoading(false)
  }
}
```

### ä¿®å¤ 3ï¼šç»Ÿä¸€æ•°æ®ç»“æ„ âœ… å¿…é¡»

```typescript
// app/api/user-info/route.ts

// âœ… ç¡®ä¿è¿”å›å®Œæ•´çš„è®¢é˜…æ•°æ®
const subscriptionData = subscriptionResult.data || {}

const subscription = {
  user_id: user.id,  // âœ… æ·»åŠ  user_id
  tier: tier,
  status: subscriptionData.status || "active",
  current_period_end: subscriptionData.current_period_end,
  creem_subscription_id: subscriptionData.creem_subscription_id,
  created_at: subscriptionData.created_at,  // âœ… ä¿ç•™å­—æ®µ
  updated_at: subscriptionData.updated_at,  // âœ… ä¿ç•™å­—æ®µ
}

return successResponse({
  subscription,
  // ...
})
```

### ä¿®å¤ 4ï¼šä¼˜åŒ– Dashboard é¡µé¢ âœ… æ¨è

```typescript
// app/dashboard/page.tsx

// âŒ æ—§ä»£ç 
const response = await fetch("/api/subscription/manage")

// âœ… æ–°ä»£ç ï¼šä½¿ç”¨åˆå¹¶æ¥å£
const response = await fetch("/api/user-info")

if (result.success) {
  setSubscription(result.data.subscription)  // âœ… ä» data.subscription è·å–
}
```

---

## ğŸ“Š ä¿®å¤ä¼˜å…ˆçº§

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | æ˜¯å¦å¿…é¡»ä¿®å¤ | å½±å“ |
|------|---------|------------|------|
| 1. å‡½æ•°å£°æ˜é¡ºåº | ğŸ”´ é«˜å± | âœ… å¿…é¡» | åŠŸèƒ½å®Œå…¨å¤±æ•ˆ |
| 2. é”™è¯¯å¤„ç†ä¸å®Œæ•´ | ğŸŸ¡ ä¸­å± | âœ… å¿…é¡» | ç”¨æˆ·ä½“éªŒæ··ä¹± |
| 3. usageData åˆå§‹åŒ– | ğŸŸ¡ ä¸­å± | âœ… å¿…é¡» | å¯èƒ½å´©æºƒ |
| 4. Dashboard æœªè¿ç§» | ğŸŸ¢ ä½å± | âš ï¸ æ¨è | æ€§èƒ½æœªä¼˜åŒ– |
| 5. ç±»å‹å®šä¹‰ä¸å®Œæ•´ | ğŸŸ¢ ä½å± | âš ï¸ æ¨è | ç»´æŠ¤å›°éš¾ |
| 6. æ•°æ®ç»“æ„ä¸ä¸€è‡´ | ğŸŸ¡ ä¸­å± | âœ… å¿…é¡» | æ½œåœ¨åŠŸèƒ½å¼‚å¸¸ |
| 7. ç¼“å­˜å¤±æ•ˆæœºåˆ¶ | ğŸŸ¢ ä½å± | âš ï¸ å¯é€‰ | ç”¨æˆ·éœ€æ‰‹åŠ¨åˆ·æ–° |

---

## âœ… ä¿®å¤æ¸…å•

### ç«‹å³å¿…é¡»ä¿®å¤

- [ ] ä¿®å¤å‡½æ•°å£°æ˜é¡ºåºï¼ˆä½¿ç”¨ useCallbackï¼‰
- [ ] å®Œå–„é”™è¯¯å¤„ç†å’Œ usageData åˆå§‹åŒ–
- [ ] ç»Ÿä¸€æ•°æ®ç»“æ„ï¼Œç¡®ä¿å­—æ®µå®Œæ•´
- [ ] æµ‹è¯•é”™è¯¯åœºæ™¯ï¼ˆç½‘ç»œæ–­å¼€ã€API å¤±è´¥ï¼‰

### æ¨èä¿®å¤

- [ ] ä¼˜åŒ– Dashboard é¡µé¢ä½¿ç”¨åˆå¹¶æ¥å£
- [ ] æ”¹è¿›ç±»å‹å®šä¹‰ï¼Œç§»é™¤ `as any`
- [ ] æ·»åŠ è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

### å¯é€‰ä¼˜åŒ–

- [ ] æ·»åŠ è¯·æ±‚ç¼“å­˜ï¼ˆæ–¹æ¡ˆ 1ï¼‰
- [ ] æ·»åŠ  WebSocket å®æ—¶æ›´æ–°
- [ ] å®Œå…¨åºŸå¼ƒæ—§æ¥å£

---

## ğŸ¯ ä¿®å¤åçš„é¢„æœŸæ•ˆæœ

### åŠŸèƒ½æ­£ç¡®æ€§

- âœ… ç™»å½•æ­£å¸¸å·¥ä½œï¼Œæ— è¿è¡Œæ—¶é”™è¯¯
- âœ… é”™è¯¯æƒ…å†µä¸‹æ­£ç¡®é™çº§
- âœ… æ•°æ®æ˜¾ç¤ºä¸€è‡´ï¼Œæ— å¼‚å¸¸

### æ€§èƒ½ä¼˜åŒ–

- âœ… Home é¡µé¢ï¼š1 æ¬¡ API è°ƒç”¨
- âœ… Dashboard é¡µé¢ï¼ˆä¿®å¤åï¼‰ï¼šå¤ç”¨ Home æ•°æ®ï¼Œ0 æ¬¡é¢å¤–è°ƒç”¨
- âœ… æ€»ä¼˜åŒ–ï¼š7 æ¬¡ â†’ 1 æ¬¡ï¼ˆ86% å‡å°‘ï¼‰

---

## ğŸ“ æ€»ç»“

æ„Ÿè°¢æ‚¨çš„ä¸¥æ ¼å®¡æŸ¥ï¼ç¡®å®å‘ç°äº†ä»¥ä¸‹ä¸¥é‡é—®é¢˜ï¼š

1. **ğŸ”´ é«˜å±**ï¼šå‡½æ•°å£°æ˜é¡ºåºå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
2. **ğŸŸ¡ ä¸­å±**ï¼šé”™è¯¯å¤„ç†ä¸å®Œæ•´å¯èƒ½å¯¼è‡´å´©æºƒ
3. **ğŸŸ¡ ä¸­å±**ï¼šæ•°æ®ç»“æ„ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´åŠŸèƒ½å¼‚å¸¸

è¿™äº›é—®é¢˜å¦‚æœä¸ä¿®å¤ï¼Œ**æ–¹æ¡ˆ 3 å°†å®Œå…¨æ— æ³•å·¥ä½œ**ã€‚

å»ºè®®ï¼š
1. **ç«‹å³ä¿®å¤** 3 ä¸ªå¿…é¡»ä¿®å¤çš„é—®é¢˜
2. **æµ‹è¯•éªŒè¯** æ‰€æœ‰é”™è¯¯åœºæ™¯
3. **è°¨æ…éƒ¨ç½²** ç¡®ä¿ç”Ÿäº§ç¯å¢ƒç¨³å®š

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-10-30  
**çŠ¶æ€**ï¼šâš ï¸ å‘ç°ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦ç«‹å³ä¿®å¤  
**ä¸‹ä¸€æ­¥**ï¼šå®æ–½ä¿®å¤æ–¹æ¡ˆ

