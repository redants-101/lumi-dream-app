# âœ… Basic ç”¨æˆ·ç™»å½•æ˜¾ç¤º 2ã€4 é—®é¢˜ä¿®å¤å®Œæˆ

## ğŸ“‹ é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆï¼š** Basic ç”¨æˆ·ç™»å½•åï¼Œåº”è¯¥æ˜¾ç¤º 10ã€50ï¼ˆdaily/monthly é™åˆ¶ï¼‰ï¼Œä½†å®é™…æ˜¾ç¤ºäº† 2ã€4ï¼ˆanonymous ç”¨æˆ·çš„é™åˆ¶ï¼‰ã€‚

## ğŸ” æ ¹æœ¬åŸå› 

ç»è¿‡æ’æŸ¥ï¼Œå‘ç°æœ‰**å¤šä¸ªé—®é¢˜**å¯¼è‡´æ˜¾ç¤ºé”™è¯¯ï¼š

### 1. é¡µé¢ä¸Šå¤šå¤„æ˜¾ç¤ºä½¿ç”¨é™åˆ¶ï¼Œä½†ä¿æŠ¤ä¸å®Œæ•´

é¡µé¢ä¸Šæœ‰ 3 ä¸ªåœ°æ–¹æ˜¾ç¤ºä½¿ç”¨é™åˆ¶ä¿¡æ¯ï¼š
- **Usage Limit Alert**ï¼ˆç¬¬ 286 è¡Œï¼‰- âŒ æ²¡æœ‰ subscription æ£€æŸ¥
- **Dream Input Section å³ä¸Šè§’**ï¼ˆç¬¬ 303 è¡Œï¼‰- âœ… æœ‰ subscription æ£€æŸ¥ï¼ˆä½†ä¸å¤Ÿä¸¥æ ¼ï¼‰
- **æ™ºèƒ½å‡çº§å¡ç‰‡**ï¼ˆç¬¬ 435 è¡Œï¼‰- âŒ æ²¡æœ‰ subscription æ£€æŸ¥

### 2. Subscription æ£€æŸ¥ä¸å¤Ÿä¸¥æ ¼

åŸæ¥çš„æ£€æŸ¥ï¼š
```typescript
!isAuthenticated || subscription
```

é—®é¢˜ï¼šåªæ£€æŸ¥ `subscription` å­˜åœ¨ï¼Œä½†ä¸æ£€æŸ¥ `subscription.tier` æ˜¯å¦æœ‰å€¼ã€‚å¦‚æœ `subscription = {}`ï¼Œæ¡ä»¶ä¹Ÿä¼šé€šè¿‡ã€‚

### 3. ç¼ºå°‘ tier ç¼“å­˜ä¿å­˜é€»è¾‘

Context çš„ `fetchUserInfo` è™½ç„¶ä» API è·å–äº† subscription æ•°æ®ï¼Œä½†æ²¡æœ‰ä¿å­˜ tier åˆ° localStorageã€‚è¿™å¯¼è‡´ï¼š
- åˆ·æ–°é¡µé¢æ—¶ï¼Œ`subscriptionLoading = true`ï¼Œä½†ç¼“å­˜ä¸­æ²¡æœ‰ tier
- `userTier` é™çº§ä¸º "free"ï¼Œæ˜¾ç¤ºé”™è¯¯çš„é™åˆ¶

### 4. userTier è®¡ç®—æ—¥å¿—ç¼ºå¤±

æ²¡æœ‰æ—¥å¿—è¾“å‡º `userTier` çš„è®¡ç®—è¿‡ç¨‹ï¼Œå¯¼è‡´éš¾ä»¥è°ƒè¯•ä¸ºä»€ä¹ˆä¼šè¿”å›é”™è¯¯çš„ tierã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿å­˜ tier åˆ°ç¼“å­˜ï¼ˆcontexts/usage-limit-context.tsxï¼‰

```typescript
// âœ… ä¿å­˜ tier åˆ°ç¼“å­˜ï¼Œä¾›é¡µé¢åˆ·æ–°æ—¶ä½¿ç”¨
const tier = result.data.subscription?.tier as UserTier || "free"
if (typeof window !== "undefined") {
  try {
    localStorage.setItem(TIER_STORAGE_KEY, tier)
    console.log("[Usage Limit Context] ğŸ’¾ Saved tier to cache:", tier)
  } catch (error) {
    console.error("[Usage Limit Context] Failed to save tier to cache:", error)
  }
}
```

**æ•ˆæœï¼š** åˆ·æ–°é¡µé¢æ—¶å¯ä»¥ä»ç¼“å­˜è¯»å– tierï¼Œé¿å…é™çº§ä¸º "free"

### 2. å¢å¼º userTier è®¡ç®—æ—¥å¿—ï¼ˆcontexts/usage-limit-context.tsxï¼‰

```typescript
const userTier = useMemo((): UserTier => {
  if (!isAuthenticated) {
    return "anonymous"
  }
  
  if (subscription && subscription.tier) {
    console.log("[Usage Limit Context] ğŸ“Š userTier from subscription:", subscription.tier)
    return subscription.tier as UserTier
  }
  
  if (subscriptionLoading && typeof window !== "undefined") {
    try {
      const cachedTier = localStorage.getItem(TIER_STORAGE_KEY)
      if (cachedTier && ['free', 'basic', 'pro'].includes(cachedTier)) {
        console.log("[Usage Limit Context] ğŸ“Š userTier from cache:", cachedTier)
        return cachedTier as UserTier
      }
    } catch (error) {
      console.error("[Usage Limit Context] Failed to read cached tier:", error)
    }
  }
  
  console.log("[Usage Limit Context] âš ï¸ userTier defaulting to free (no subscription data)")
  return "free"
}, [isAuthenticated, subscription, subscriptionLoading])
```

**æ•ˆæœï¼š** å¯ä»¥åœ¨æ§åˆ¶å°æ¸…æ¥šåœ°çœ‹åˆ° userTier çš„è®¡ç®—è¿‡ç¨‹å’Œæ¥æº

### 3. åŠ å¼ºæ‰€æœ‰æ˜¾ç¤ºä½ç½®çš„ subscription æ£€æŸ¥ï¼ˆapp/page.tsxï¼‰

#### 3.1 Usage Limit Alert

```typescript
{!isLimitReached && remainingCount > 0 && (
  ...æ¡ä»¶...
) && (
  // âœ… åŒæ ·éœ€è¦ç­‰å¾… subscription æ•°æ®åŠ è½½å®Œæˆ
  !subscriptionLoading && (!isAuthenticated || (subscription && subscription.tier))
) && (
  <Alert>...</Alert>
)}
```

#### 3.2 Dream Input Section å³ä¸Šè§’

```typescript
{!isLimitReached && isMounted && !subscriptionLoading && (
  // âœ… å·²ç™»å½•ç”¨æˆ·å¿…é¡»æœ‰ subscription.tier æ‰æ¸²æŸ“
  !isAuthenticated || (subscription && subscription.tier)
) && (() => {
  // ğŸ” è°ƒè¯•æ—¥å¿—
  console.log("[Home] Rendering usage info:", { 
    userTier, 
    isAuthenticated, 
    subscription: subscription?.tier, 
    remainingDaily, 
    remainingMonthly 
  })
  return true
})() && (
  <span>...</span>
)}
```

#### 3.3 æ™ºèƒ½å‡çº§å¡ç‰‡

```typescript
{isAuthenticated && subscription && subscription.tier && 
 remainingCount <= 2 && remainingCount > 0 && (
  <Card>...</Card>
)}
```

**æ•ˆæœï¼š** æ‰€æœ‰æ˜¾ç¤ºä½¿ç”¨é™åˆ¶çš„åœ°æ–¹éƒ½å¿…é¡»ç­‰å¾… subscription æ•°æ®åŠ è½½å®Œæˆ

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
Basic ç”¨æˆ·ç™»å½•
â†“
æ˜¾ç¤º 2ã€4ï¼ˆé”™è¯¯çš„ anonymous é™åˆ¶ï¼‰
```

**å¯èƒ½çš„åŸå› ï¼š**
1. æŸä¸ªä½ç½®æ²¡æœ‰ subscription æ£€æŸ¥ï¼Œåœ¨åŠ è½½æœŸé—´æ˜¾ç¤ºäº†é”™è¯¯æ•°æ®
2. subscription æ£€æŸ¥ä¸ä¸¥æ ¼ï¼Œ`subscription = {}` ä¹Ÿé€šè¿‡äº†
3. ç¼“å­˜ä¸­æ²¡æœ‰ tierï¼Œ`userTier` é™çº§ä¸º "free" æˆ–æ›´ç³Ÿ

### ä¿®å¤å

```
Basic ç”¨æˆ·ç™»å½•
â†“
åŠ è½½ä¸­ï¼šæ‰€æœ‰ä½ç½®éƒ½ä¸æ˜¾ç¤ºï¼ˆç­‰å¾… subscriptionï¼‰
â†“
åŠ è½½å®Œæˆï¼šæ‰€æœ‰ä½ç½®æ˜¾ç¤º 10ã€50ï¼ˆæ­£ç¡®çš„ basic é™åˆ¶ï¼‰
```

**ä¿è¯ï¼š**
1. âœ… æ‰€æœ‰æ˜¾ç¤ºä½¿ç”¨é™åˆ¶çš„ä½ç½®éƒ½æœ‰ä¸¥æ ¼çš„ subscription æ£€æŸ¥
2. âœ… æ£€æŸ¥ `subscription.tier` å­˜åœ¨ï¼Œè€Œä¸ä»…ä»…æ˜¯ `subscription`
3. âœ… tier ä¼šä¿å­˜åˆ°ç¼“å­˜ï¼Œåˆ·æ–°é¡µé¢æ—¶å¯ä»¥ä½¿ç”¨
4. âœ… è¯¦ç»†çš„æ—¥å¿—å¸®åŠ©è°ƒè¯•

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šé¦–æ¬¡ç™»å½• Basic ç”¨æˆ·

**æ­¥éª¤ï¼š**
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. åœ¨æœªç™»å½•çŠ¶æ€ï¼Œä¸»é¡µåº”æ˜¾ç¤º `2 today â€¢ 4 this month`
3. ç‚¹å‡»ç™»å½•ï¼Œé€‰æ‹© Basic ç”¨æˆ·è´¦å·
4. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—å’Œé¡µé¢æ˜¾ç¤º

**é¢„æœŸç»“æœï¼š**
- æ§åˆ¶å°æ˜¾ç¤ºï¼š
  ```
  [Usage Limit Context] ğŸ”„ Initializing user data...
  [Usage Limit Context] âœ… User info loaded: basic
  [Usage Limit Context] ğŸ’¾ Saved tier to cache: basic
  [Usage Limit Context] ğŸ“Š userTier from subscription: basic
  [Home] Rendering usage info: { userTier: 'basic', isAuthenticated: true, subscription: 'basic', remainingDaily: 10, remainingMonthly: 50 }
  ```
- é¡µé¢æ˜¾ç¤ºï¼š`10 today â€¢ 50 this month`

### åœºæ™¯ 2ï¼šåˆ·æ–°é¡µé¢ï¼ˆå·²ç™»å½• Basic ç”¨æˆ·ï¼‰

**æ­¥éª¤ï¼š**
1. åœ¨å·²ç™»å½• Basic ç”¨æˆ·çŠ¶æ€ä¸‹åˆ·æ–°é¡µé¢
2. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—å’Œé¡µé¢æ˜¾ç¤º

**é¢„æœŸç»“æœï¼š**
- æ§åˆ¶å°æ˜¾ç¤ºï¼š
  ```
  [Usage Limit Context] ğŸ“Š userTier from cache: basic
  [Usage Limit Context] âœ… User info loaded: basic
  [Usage Limit Context] ğŸ“Š userTier from subscription: basic
  [Home] Rendering usage info: { userTier: 'basic', ... }
  ```
- é¡µé¢æ˜¾ç¤ºï¼š`10 today â€¢ 50 this month`ï¼ˆæ— é—ªçƒï¼‰

### åœºæ™¯ 3ï¼šç™»å‡º

**æ­¥éª¤ï¼š**
1. ä» Basic ç”¨æˆ·ç™»å‡º
2. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—å’Œé¡µé¢æ˜¾ç¤º

**é¢„æœŸç»“æœï¼š**
- æ§åˆ¶å°æ˜¾ç¤ºï¼š
  ```
  [Usage Limit Context] ğŸ”„ User logged out, resetting state...
  [Usage Limit Context] ğŸ—‘ï¸ Cleared all cached data FIRST
  [Usage Limit Context] ğŸ”„ Reset to anonymous data
  ```
- é¡µé¢æ˜¾ç¤ºï¼š`2 today â€¢ 4 this month`

## ğŸ“Š ä»£ç å˜æ›´æ±‡æ€»

### ä¿®æ”¹æ–‡ä»¶

1. **contexts/usage-limit-context.tsx**ï¼ˆ2 å¤„ä¿®æ”¹ï¼‰
   - âœ… åœ¨ `fetchUserInfo` æˆåŠŸåä¿å­˜ tier åˆ° localStorage
   - âœ… åœ¨ `userTier` è®¡ç®—ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—

2. **app/page.tsx**ï¼ˆ3 å¤„ä¿®æ”¹ï¼‰
   - âœ… Usage Limit Alert å¢åŠ  subscription æ£€æŸ¥
   - âœ… Dream Input Section åŠ å¼º subscription æ£€æŸ¥ + æ·»åŠ æ¸²æŸ“æ—¥å¿—
   - âœ… æ™ºèƒ½å‡çº§å¡ç‰‡å¢åŠ  subscription æ£€æŸ¥

## ğŸ” è°ƒè¯•æŒ‡å—

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼š

### 1. æ£€æŸ¥ userTier è®¡ç®—

æŸ¥æ‰¾æ—¥å¿—ï¼š`[Usage Limit Context] ğŸ“Š userTier`

**æ­£å¸¸æƒ…å†µï¼š**
- Basic ç”¨æˆ·åº”è¯¥çœ‹åˆ°ï¼š`userTier from subscription: basic`
- åˆ·æ–°æ—¶åº”è¯¥å…ˆçœ‹åˆ°ï¼š`userTier from cache: basic`

**å¼‚å¸¸æƒ…å†µï¼š**
- å¦‚æœçœ‹åˆ°ï¼š`userTier defaulting to free` â†’ subscription æ•°æ®æœªæ­£ç¡®åŠ è½½
- å¦‚æœçœ‹åˆ°ï¼š`userTier from subscription: free` â†’ API è¿”å›çš„ tier ä¸æ­£ç¡®

### 2. æ£€æŸ¥é¡µé¢æ¸²æŸ“

æŸ¥æ‰¾æ—¥å¿—ï¼š`[Home] Rendering usage info`

**æ­£å¸¸æƒ…å†µï¼š**
- Basic ç”¨æˆ·åº”è¯¥çœ‹åˆ°ï¼š`{ userTier: 'basic', subscription: 'basic', remainingDaily: 10, remainingMonthly: 50 }`

**å¼‚å¸¸æƒ…å†µï¼š**
- å¦‚æœçœ‹åˆ° `userTier: 'anonymous'` â†’ è®¤è¯çŠ¶æ€æœ‰é—®é¢˜
- å¦‚æœçœ‹åˆ° `subscription: undefined` â†’ subscription æ•°æ®æœªåŠ è½½

### 3. æ£€æŸ¥ API å“åº”

æŸ¥æ‰¾æ—¥å¿—ï¼š`[Usage Limit Context] âœ… User info loaded`

**æ­£å¸¸æƒ…å†µï¼š**
- åº”è¯¥çœ‹åˆ°ï¼š`User info loaded: basic`

**å¼‚å¸¸æƒ…å†µï¼š**
- å¦‚æœçœ‹åˆ°å…¶ä»– tier â†’ API è¿”å›çš„æ•°æ®æœ‰é—®é¢˜
- å¦‚æœçœ‹åˆ°é”™è¯¯æ—¥å¿— â†’ API è°ƒç”¨å¤±è´¥

## âœ… å®Œæˆæ—¶é—´

**æ—¥æœŸï¼š** 2025-10-30  
**çŠ¶æ€ï¼š** å·²å®Œæˆï¼ŒåŒ…å«è¯¦ç»†æ—¥å¿—  
**è´Ÿè´£äººï¼š** AI Assistant  
**éªŒè¯ï¼š** å¾…ç”¨æˆ·æµ‹è¯•ç¡®è®¤

---

## ğŸ’¡ é¢„é˜²æªæ–½

ä¸ºäº†é¿å…ç±»ä¼¼é—®é¢˜å†æ¬¡å‘ç”Ÿï¼š

1. **æ˜¾ç¤ºä½¿ç”¨é™åˆ¶çš„åŸåˆ™ï¼š**
   - âœ… æœªç™»å½•ç”¨æˆ·ï¼šå¯ä»¥ç«‹å³æ˜¾ç¤º anonymous é™åˆ¶
   - âœ… å·²ç™»å½•ç”¨æˆ·ï¼š**å¿…é¡»ç­‰å¾…** `subscription && subscription.tier` æœ‰å€¼

2. **æ·»åŠ æ–°åŠŸèƒ½æ—¶çš„æ£€æŸ¥æ¸…å•ï¼š**
   - [ ] æ˜¯å¦æ˜¾ç¤ºä½¿ç”¨é™åˆ¶ä¿¡æ¯ï¼Ÿ
   - [ ] æ˜¯å¦æœ‰ `subscription && subscription.tier` æ£€æŸ¥ï¼Ÿ
   - [ ] æ˜¯å¦æœ‰ `!subscriptionLoading` æ£€æŸ¥ï¼Ÿ
   - [ ] æ˜¯å¦æ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼Ÿ

3. **ä»£ç å®¡æŸ¥è¦ç‚¹ï¼š**
   - æœç´¢æ‰€æœ‰ä½¿ç”¨ `remainingDaily`ã€`remainingMonthly`ã€`remainingCount` çš„åœ°æ–¹
   - ç¡®ä¿æ¯ä¸ªåœ°æ–¹éƒ½æœ‰é€‚å½“çš„ä¿æŠ¤æ¡ä»¶
   - ç¡®ä¿æ—¥å¿—è¶³å¤Ÿè¯¦ç»†ï¼Œæ–¹ä¾¿è°ƒè¯•

