# ğŸ“˜ å®šä»·ç³»ç»Ÿä½¿ç”¨æŒ‡å—

æœ¬æ–‡æ¡£å±•ç¤ºå¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å®šä»·é…ç½®ç³»ç»Ÿã€‚

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
lib/
â”œâ”€â”€ ai-config.ts          # AI æ¨¡å‹é…ç½®
â”œâ”€â”€ pricing-config.ts     # å®šä»·é…ç½®ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ utils.ts             # å·¥å…·å‡½æ•°

docs/
â””â”€â”€ PRICING_STRATEGY.md  # å®šä»·ç­–ç•¥æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯¼å…¥é…ç½®

```typescript
import { 
  PRICING, 
  getPricingConfig,
  calculateYearlySavings,
  getRemainingInterpretations,
} from "@/lib/pricing-config"
```

### 2. è·å–ç”¨æˆ·å±‚çº§é…ç½®

```typescript
// è·å–ç”¨æˆ·å½“å‰å±‚çº§
const userTier = user?.subscription_tier || "free"

// è·å–è¯¥å±‚çº§çš„å®Œæ•´é…ç½®
const config = getPricingConfig(userTier)

console.log(config.limits.monthlyInterpretations) // 50 (Basic ç”¨æˆ·)
console.log(config.aiModel)                       // "anthropic/claude-3.5-haiku"
```

### 3. æ£€æŸ¥ä½¿ç”¨é™åˆ¶

```typescript
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¿˜æœ‰å‰©ä½™æ¬¡æ•°
const usedCount = 15  // ä»æ•°æ®åº“è·å–
const remaining = getRemainingInterpretations(userTier, usedCount)

if (remaining <= 0) {
  toast({
    title: "é¢åº¦å·²ç”¨å®Œ",
    description: "å‡çº§è‡³ Basic ç‰ˆç»§ç»­ä½¿ç”¨",
    variant: "destructive"
  })
  return
}
```

---

## ğŸ’¡ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: æ˜¾ç¤ºå®šä»·é¡µé¢

```typescript
// app/pricing/page.tsx
"use client"

import { PRICING_PAGE_DATA } from "@/lib/pricing-config"
import { Button } from "@/components/ui/button"
import { Card, CardHeader, CardContent } from "@/components/ui/card"

export default function PricingPage() {
  return (
    <div className="container py-12">
      <h1 className="text-4xl font-bold text-center mb-12">
        é€‰æ‹©é€‚åˆä½ çš„å¥—é¤
      </h1>
      
      <div className="grid md:grid-cols-3 gap-8">
        {PRICING_PAGE_DATA.tiers.map((tier) => (
          <Card key={tier.tier} className="relative">
            {tier.recommended && (
              <div className="absolute -top-4 left-1/2 -translate-x-1/2">
                <span className="bg-primary text-primary-foreground px-4 py-1 rounded-full text-sm">
                  {tier.badge}
                </span>
              </div>
            )}
            
            <CardHeader>
              <h3 className="text-2xl font-bold">{tier.displayName}</h3>
              <div className="text-4xl font-bold mt-4">
                {tier.monthlyPrice === 0 ? (
                  "å…è´¹"
                ) : (
                  <>
                    ${tier.monthlyPrice}
                    <span className="text-base text-muted-foreground">/æœˆ</span>
                  </>
                )}
              </div>
            </CardHeader>
            
            <CardContent>
              <ul className="space-y-3 mb-6">
                {tier.features.map((feature) => (
                  <li key={feature} className="flex items-center gap-2">
                    <Check className="w-5 h-5 text-primary" />
                    <span>{feature}</span>
                  </li>
                ))}
              </ul>
              
              <Button 
                variant={tier.ctaVariant}
                className="w-full"
              >
                {tier.ctaText}
              </Button>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  )
}
```

### åœºæ™¯ 2: API è·¯ç”±ä¸­éªŒè¯æƒé™

```typescript
// app/api/interpret/route.ts
import { getPricingConfig, getRemainingInterpretations } from "@/lib/pricing-config"
import { getModelByTier } from "@/lib/ai-config"

export async function POST(request: Request) {
  try {
    const { dream, userId } = await request.json()
    
    // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»æ•°æ®åº“ï¼‰
    const user = await getUserById(userId)
    const tier = user?.subscription_tier || "free"
    
    // æ£€æŸ¥ä½¿ç”¨é™åˆ¶
    const usedCount = await getMonthlyUsageCount(userId)
    const remaining = getRemainingInterpretations(tier, usedCount)
    
    if (remaining <= 0) {
      return Response.json(
        { error: "Monthly limit reached. Please upgrade." },
        { status: 403 }
      )
    }
    
    // è·å–è¯¥å±‚çº§çš„ AI æ¨¡å‹
    const model = getModelByTier(tier)
    
    // è°ƒç”¨ AI è§£æ
    const result = await interpretDream(dream, model)
    
    // è®°å½•ä½¿ç”¨æ¬¡æ•°
    await incrementUsageCount(userId)
    
    return Response.json({ 
      result,
      remaining: remaining - 1 
    })
    
  } catch (error) {
    console.error("[Interpret Error]:", error)
    return Response.json(
      { error: "Failed to interpret dream" },
      { status: 500 }
    )
  }
}
```

### åœºæ™¯ 3: å®¢æˆ·ç«¯æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°

```typescript
// components/usage-indicator.tsx
"use client"

import { useEffect, useState } from "react"
import { Progress } from "@/components/ui/progress"
import { getRemainingInterpretations, getPricingConfig } from "@/lib/pricing-config"

export function UsageIndicator({ 
  tier, 
  usedCount 
}: { 
  tier: "free" | "basic" | "pro"
  usedCount: number 
}) {
  const config = getPricingConfig(tier)
  const remaining = getRemainingInterpretations(tier, usedCount)
  const total = config.limits.monthlyInterpretations
  const percentage = (usedCount / total) * 100
  
  return (
    <div className="space-y-2">
      <div className="flex justify-between text-sm">
        <span>æœ¬æœˆå·²ä½¿ç”¨</span>
        <span className="font-medium">
          {usedCount} / {total}
        </span>
      </div>
      
      <Progress value={percentage} className="h-2" />
      
      {remaining <= 5 && remaining > 0 && (
        <p className="text-sm text-orange-500">
          âš ï¸ ä»…å‰© {remaining} æ¬¡ï¼Œè€ƒè™‘å‡çº§ï¼Ÿ
        </p>
      )}
      
      {remaining === 0 && (
        <p className="text-sm text-destructive">
          âŒ æœ¬æœˆé¢åº¦å·²ç”¨å®Œï¼Œå‡çº§ä»¥ç»§ç»­ä½¿ç”¨
        </p>
      )}
    </div>
  )
}
```

### åœºæ™¯ 4: Pro ç”¨æˆ·è¶…é‡è‡ªåŠ¨é™çº§

```typescript
// lib/get-optimal-model.ts
import { getModelByTier } from "@/lib/ai-config"
import { shouldDowngradeModel } from "@/lib/pricing-config"

/**
 * æ™ºèƒ½è·å–æœ€ä¼˜æ¨¡å‹
 * Pro ç”¨æˆ·è¶…è¿‡ 200 æ¬¡åè‡ªåŠ¨é™çº§åˆ° Haiku
 */
export function getOptimalModel(
  tier: "free" | "basic" | "pro",
  usedCount: number
): string {
  // æ£€æŸ¥æ˜¯å¦éœ€è¦é™çº§
  if (shouldDowngradeModel(tier, usedCount)) {
    console.log("[Model] Pro user exceeded limit, downgrading to Haiku")
    return "anthropic/claude-3.5-haiku"
  }
  
  // æ­£å¸¸è¿”å›å¯¹åº”æ¨¡å‹
  return getModelByTier(tier)
}

// ä½¿ç”¨ç¤ºä¾‹
const model = getOptimalModel(user.tier, user.monthlyUsage)
const result = await interpretDream(dream, model)
```

### åœºæ™¯ 5: å‡çº§æç¤º UI

```typescript
// components/upgrade-prompt.tsx
"use client"

import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { Sparkles } from "lucide-react"
import { calculateYearlySavings } from "@/lib/pricing-config"

export function UpgradePrompt({ currentTier }: { currentTier: "free" | "basic" }) {
  const targetTier = currentTier === "free" ? "basic" : "pro"
  const savings = calculateYearlySavings(targetTier)
  
  return (
    <Card className="p-6 bg-gradient-to-r from-purple-500/10 to-pink-500/10">
      <div className="flex items-start gap-4">
        <Sparkles className="w-8 h-8 text-primary flex-shrink-0" />
        
        <div className="flex-1">
          <h3 className="text-xl font-bold mb-2">
            å‡çº§è‡³ {targetTier === "basic" ? "åŸºç¡€ç‰ˆ" : "ä¸“ä¸šç‰ˆ"}
          </h3>
          
          <p className="text-muted-foreground mb-4">
            {targetTier === "basic" 
              ? "è§£é” 50 æ¬¡/æœˆè§£æï¼Œä½¿ç”¨ Claude Haiku æ¸©æš–å¿ƒç†é£æ ¼"
              : "æ— é™è§£æï¼ŒClaude Sonnet æœ€å¼ºåŒç†å¿ƒä½“éªŒ"
            }
          </p>
          
          <div className="flex items-center gap-4">
            <Button>
              ç«‹å³å‡çº§ - ${targetTier === "basic" ? "4.99" : "9.99"}/æœˆ
            </Button>
            
            <span className="text-sm text-muted-foreground">
              å¹´ä»˜ç«‹çœ ${savings}
            </span>
          </div>
        </div>
      </div>
    </Card>
  )
}
```

---

## ğŸ” æ•°æ®åº“é›†æˆç¤ºä¾‹

### Supabase Schema

```sql
-- ç”¨æˆ·è®¢é˜…è¡¨
CREATE TABLE user_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- è®¢é˜…å±‚çº§
  tier TEXT NOT NULL CHECK (tier IN ('free', 'basic', 'pro')),
  
  -- è®¡è´¹å‘¨æœŸ
  billing_cycle TEXT CHECK (billing_cycle IN ('monthly', 'yearly')),
  
  -- è®¢é˜…çŠ¶æ€
  status TEXT NOT NULL CHECK (status IN ('active', 'canceled', 'expired')),
  
  -- Stripe ç›¸å…³
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  
  -- æ—¶é—´æˆ³
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id)
);

-- ä½¿ç”¨è®°å½•è¡¨
CREATE TABLE usage_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- ä½¿ç”¨è¯¦æƒ…
  dream_text TEXT NOT NULL,
  model_used TEXT NOT NULL,
  tokens_used INTEGER,
  
  -- æ—¶é—´æˆ³
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_usage_records_user_month ON usage_records(
  user_id, 
  DATE_TRUNC('month', created_at)
);

-- è·å–æœˆåº¦ä½¿ç”¨æ¬¡æ•°çš„å‡½æ•°
CREATE OR REPLACE FUNCTION get_monthly_usage(p_user_id UUID)
RETURNS INTEGER AS $$
  SELECT COUNT(*)::INTEGER
  FROM usage_records
  WHERE user_id = p_user_id
    AND created_at >= DATE_TRUNC('month', CURRENT_DATE)
    AND created_at < DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month';
$$ LANGUAGE SQL STABLE;
```

### ä½¿ç”¨å‡½æ•°

```typescript
// lib/supabase/usage.ts
import { createClient } from "@/lib/supabase/server"

/**
 * è·å–ç”¨æˆ·æœ¬æœˆä½¿ç”¨æ¬¡æ•°
 */
export async function getMonthlyUsageCount(userId: string): Promise<number> {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .rpc('get_monthly_usage', { p_user_id: userId })
  
  if (error) {
    console.error("[Usage Error]:", error)
    return 0
  }
  
  return data || 0
}

/**
 * è®°å½•ä¸€æ¬¡ä½¿ç”¨
 */
export async function recordUsage(
  userId: string,
  dreamText: string,
  model: string,
  tokensUsed: number
) {
  const supabase = await createClient()
  
  const { error } = await supabase
    .from('usage_records')
    .insert({
      user_id: userId,
      dream_text: dreamText,
      model_used: model,
      tokens_used: tokensUsed,
    })
  
  if (error) {
    console.error("[Record Usage Error]:", error)
  }
}

/**
 * è·å–ç”¨æˆ·è®¢é˜…ä¿¡æ¯
 */
export async function getUserSubscription(userId: string) {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('user_subscriptions')
    .select('*')
    .eq('user_id', userId)
    .single()
  
  if (error || !data) {
    return { tier: 'free' as const }
  }
  
  return data
}
```

---

## ğŸ“Š ç›‘æ§ä¸åˆ†æ

### ä½¿ç”¨æƒ…å†µä»ªè¡¨æ¿

```typescript
// app/dashboard/page.tsx
"use client"

import { useEffect, useState } from "react"
import { Card, CardHeader, CardContent } from "@/components/ui/card"
import { getPricingConfig } from "@/lib/pricing-config"

export default function DashboardPage() {
  const [stats, setStats] = useState({
    tier: "free" as const,
    usedThisMonth: 0,
    totalCost: 0,
  })
  
  useEffect(() => {
    // ä» API è·å–ç»Ÿè®¡æ•°æ®
    fetch("/api/user/stats")
      .then(res => res.json())
      .then(data => setStats(data))
  }, [])
  
  const config = getPricingConfig(stats.tier)
  const remaining = config.limits.monthlyInterpretations - stats.usedThisMonth
  
  return (
    <div className="container py-12">
      <h1 className="text-3xl font-bold mb-8">æˆ‘çš„ä»ªè¡¨æ¿</h1>
      
      <div className="grid md:grid-cols-3 gap-6">
        <Card>
          <CardHeader>å½“å‰å¥—é¤</CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">
              {config.displayName}
            </div>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader>æœ¬æœˆä½¿ç”¨</CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">
              {stats.usedThisMonth} / {config.limits.monthlyInterpretations}
            </div>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader>å‰©ä½™æ¬¡æ•°</CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-primary">
              {remaining}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… å·²å®Œæˆé…ç½®æ–‡ä»¶åˆ›å»º
2. â¬œ å®ç° Stripe æ”¯ä»˜é›†æˆ
3. â¬œ åˆ›å»ºè®¢é˜…ç®¡ç†é¡µé¢
4. â¬œ å®ç°è‡ªåŠ¨é™çº§é€»è¾‘
5. â¬œ æ·»åŠ ä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®šä»·ç­–ç•¥è¯¦ç»†åˆ†æ](./å®šä»·ç­–ç•¥.md)
- [AI æ¨¡å‹é…ç½®](../lib/ai-config.ts)
- [Supabase å¿«é€Ÿå¼€å§‹](./Supabaseå¿«é€Ÿå¼€å§‹.md)
- [ä½¿ç”¨é™åˆ¶åŠŸèƒ½](./ä½¿ç”¨æ¬¡æ•°é™åˆ¶åŠŸèƒ½.md)

---

**æœ€åæ›´æ–°**: 2025-10-21

