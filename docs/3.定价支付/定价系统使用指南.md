# 📘 定价系统使用指南

本文档展示如何在项目中使用定价配置系统。

---

## 📦 文件结构

```
lib/
├── ai-config.ts          # AI 模型配置
├── pricing-config.ts     # 定价配置（新增）
└── utils.ts             # 工具函数

docs/
└── PRICING_STRATEGY.md  # 定价策略文档
```

---

## 🚀 快速开始

### 1. 导入配置

```typescript
import { 
  PRICING, 
  getPricingConfig,
  calculateYearlySavings,
  getRemainingInterpretations,
} from "@/lib/pricing-config"
```

### 2. 获取用户层级配置

```typescript
// 获取用户当前层级
const userTier = user?.subscription_tier || "free"

// 获取该层级的完整配置
const config = getPricingConfig(userTier)

console.log(config.limits.monthlyInterpretations) // 50 (Basic 用户)
console.log(config.aiModel)                       // "anthropic/claude-3.5-haiku"
```

### 3. 检查使用限制

```typescript
// 检查用户是否还有剩余次数
const usedCount = 15  // 从数据库获取
const remaining = getRemainingInterpretations(userTier, usedCount)

if (remaining <= 0) {
  toast({
    title: "额度已用完",
    description: "升级至 Basic 版继续使用",
    variant: "destructive"
  })
  return
}
```

---

## 💡 常见使用场景

### 场景 1: 显示定价页面

```typescript
// app/pricing/page.tsx
"use client"

import { PRICING_PAGE_DATA } from "@/lib/pricing-config"
import { Button } from "@/components/ui/button"
import { Card, CardHeader, CardContent } from "@/components/ui/card"

export default function PricingPage() {
  return (
    <div className="container py-12">
      <h1 className="text-4xl font-bold text-center mb-12">
        选择适合你的套餐
      </h1>
      
      <div className="grid md:grid-cols-3 gap-8">
        {PRICING_PAGE_DATA.tiers.map((tier) => (
          <Card key={tier.tier} className="relative">
            {tier.recommended && (
              <div className="absolute -top-4 left-1/2 -translate-x-1/2">
                <span className="bg-primary text-primary-foreground px-4 py-1 rounded-full text-sm">
                  {tier.badge}
                </span>
              </div>
            )}
            
            <CardHeader>
              <h3 className="text-2xl font-bold">{tier.displayName}</h3>
              <div className="text-4xl font-bold mt-4">
                {tier.monthlyPrice === 0 ? (
                  "免费"
                ) : (
                  <>
                    ${tier.monthlyPrice}
                    <span className="text-base text-muted-foreground">/月</span>
                  </>
                )}
              </div>
            </CardHeader>
            
            <CardContent>
              <ul className="space-y-3 mb-6">
                {tier.features.map((feature) => (
                  <li key={feature} className="flex items-center gap-2">
                    <Check className="w-5 h-5 text-primary" />
                    <span>{feature}</span>
                  </li>
                ))}
              </ul>
              
              <Button 
                variant={tier.ctaVariant}
                className="w-full"
              >
                {tier.ctaText}
              </Button>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  )
}
```

### 场景 2: API 路由中验证权限

```typescript
// app/api/interpret/route.ts
import { getPricingConfig, getRemainingInterpretations } from "@/lib/pricing-config"
import { getModelByTier } from "@/lib/ai-config"

export async function POST(request: Request) {
  try {
    const { dream, userId } = await request.json()
    
    // 获取用户信息（从数据库）
    const user = await getUserById(userId)
    const tier = user?.subscription_tier || "free"
    
    // 检查使用限制
    const usedCount = await getMonthlyUsageCount(userId)
    const remaining = getRemainingInterpretations(tier, usedCount)
    
    if (remaining <= 0) {
      return Response.json(
        { error: "Monthly limit reached. Please upgrade." },
        { status: 403 }
      )
    }
    
    // 获取该层级的 AI 模型
    const model = getModelByTier(tier)
    
    // 调用 AI 解析
    const result = await interpretDream(dream, model)
    
    // 记录使用次数
    await incrementUsageCount(userId)
    
    return Response.json({ 
      result,
      remaining: remaining - 1 
    })
    
  } catch (error) {
    console.error("[Interpret Error]:", error)
    return Response.json(
      { error: "Failed to interpret dream" },
      { status: 500 }
    )
  }
}
```

### 场景 3: 客户端显示剩余次数

```typescript
// components/usage-indicator.tsx
"use client"

import { useEffect, useState } from "react"
import { Progress } from "@/components/ui/progress"
import { getRemainingInterpretations, getPricingConfig } from "@/lib/pricing-config"

export function UsageIndicator({ 
  tier, 
  usedCount 
}: { 
  tier: "free" | "basic" | "pro"
  usedCount: number 
}) {
  const config = getPricingConfig(tier)
  const remaining = getRemainingInterpretations(tier, usedCount)
  const total = config.limits.monthlyInterpretations
  const percentage = (usedCount / total) * 100
  
  return (
    <div className="space-y-2">
      <div className="flex justify-between text-sm">
        <span>本月已使用</span>
        <span className="font-medium">
          {usedCount} / {total}
        </span>
      </div>
      
      <Progress value={percentage} className="h-2" />
      
      {remaining <= 5 && remaining > 0 && (
        <p className="text-sm text-orange-500">
          ⚠️ 仅剩 {remaining} 次，考虑升级？
        </p>
      )}
      
      {remaining === 0 && (
        <p className="text-sm text-destructive">
          ❌ 本月额度已用完，升级以继续使用
        </p>
      )}
    </div>
  )
}
```

### 场景 4: Pro 用户超量自动降级

```typescript
// lib/get-optimal-model.ts
import { getModelByTier } from "@/lib/ai-config"
import { shouldDowngradeModel } from "@/lib/pricing-config"

/**
 * 智能获取最优模型
 * Pro 用户超过 200 次后自动降级到 Haiku
 */
export function getOptimalModel(
  tier: "free" | "basic" | "pro",
  usedCount: number
): string {
  // 检查是否需要降级
  if (shouldDowngradeModel(tier, usedCount)) {
    console.log("[Model] Pro user exceeded limit, downgrading to Haiku")
    return "anthropic/claude-3.5-haiku"
  }
  
  // 正常返回对应模型
  return getModelByTier(tier)
}

// 使用示例
const model = getOptimalModel(user.tier, user.monthlyUsage)
const result = await interpretDream(dream, model)
```

### 场景 5: 升级提示 UI

```typescript
// components/upgrade-prompt.tsx
"use client"

import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { Sparkles } from "lucide-react"
import { calculateYearlySavings } from "@/lib/pricing-config"

export function UpgradePrompt({ currentTier }: { currentTier: "free" | "basic" }) {
  const targetTier = currentTier === "free" ? "basic" : "pro"
  const savings = calculateYearlySavings(targetTier)
  
  return (
    <Card className="p-6 bg-gradient-to-r from-purple-500/10 to-pink-500/10">
      <div className="flex items-start gap-4">
        <Sparkles className="w-8 h-8 text-primary flex-shrink-0" />
        
        <div className="flex-1">
          <h3 className="text-xl font-bold mb-2">
            升级至 {targetTier === "basic" ? "基础版" : "专业版"}
          </h3>
          
          <p className="text-muted-foreground mb-4">
            {targetTier === "basic" 
              ? "解锁 50 次/月解析，使用 Claude Haiku 温暖心理风格"
              : "无限解析，Claude Sonnet 最强同理心体验"
            }
          </p>
          
          <div className="flex items-center gap-4">
            <Button>
              立即升级 - ${targetTier === "basic" ? "4.99" : "9.99"}/月
            </Button>
            
            <span className="text-sm text-muted-foreground">
              年付立省 ${savings}
            </span>
          </div>
        </div>
      </div>
    </Card>
  )
}
```

---

## 🔐 数据库集成示例

### Supabase Schema

```sql
-- 用户订阅表
CREATE TABLE user_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- 订阅层级
  tier TEXT NOT NULL CHECK (tier IN ('free', 'basic', 'pro')),
  
  -- 计费周期
  billing_cycle TEXT CHECK (billing_cycle IN ('monthly', 'yearly')),
  
  -- 订阅状态
  status TEXT NOT NULL CHECK (status IN ('active', 'canceled', 'expired')),
  
  -- Stripe 相关
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  
  -- 时间戳
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id)
);

-- 使用记录表
CREATE TABLE usage_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- 使用详情
  dream_text TEXT NOT NULL,
  model_used TEXT NOT NULL,
  tokens_used INTEGER,
  
  -- 时间戳
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建索引
CREATE INDEX idx_usage_records_user_month ON usage_records(
  user_id, 
  DATE_TRUNC('month', created_at)
);

-- 获取月度使用次数的函数
CREATE OR REPLACE FUNCTION get_monthly_usage(p_user_id UUID)
RETURNS INTEGER AS $$
  SELECT COUNT(*)::INTEGER
  FROM usage_records
  WHERE user_id = p_user_id
    AND created_at >= DATE_TRUNC('month', CURRENT_DATE)
    AND created_at < DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month';
$$ LANGUAGE SQL STABLE;
```

### 使用函数

```typescript
// lib/supabase/usage.ts
import { createClient } from "@/lib/supabase/server"

/**
 * 获取用户本月使用次数
 */
export async function getMonthlyUsageCount(userId: string): Promise<number> {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .rpc('get_monthly_usage', { p_user_id: userId })
  
  if (error) {
    console.error("[Usage Error]:", error)
    return 0
  }
  
  return data || 0
}

/**
 * 记录一次使用
 */
export async function recordUsage(
  userId: string,
  dreamText: string,
  model: string,
  tokensUsed: number
) {
  const supabase = await createClient()
  
  const { error } = await supabase
    .from('usage_records')
    .insert({
      user_id: userId,
      dream_text: dreamText,
      model_used: model,
      tokens_used: tokensUsed,
    })
  
  if (error) {
    console.error("[Record Usage Error]:", error)
  }
}

/**
 * 获取用户订阅信息
 */
export async function getUserSubscription(userId: string) {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('user_subscriptions')
    .select('*')
    .eq('user_id', userId)
    .single()
  
  if (error || !data) {
    return { tier: 'free' as const }
  }
  
  return data
}
```

---

## 📊 监控与分析

### 使用情况仪表板

```typescript
// app/dashboard/page.tsx
"use client"

import { useEffect, useState } from "react"
import { Card, CardHeader, CardContent } from "@/components/ui/card"
import { getPricingConfig } from "@/lib/pricing-config"

export default function DashboardPage() {
  const [stats, setStats] = useState({
    tier: "free" as const,
    usedThisMonth: 0,
    totalCost: 0,
  })
  
  useEffect(() => {
    // 从 API 获取统计数据
    fetch("/api/user/stats")
      .then(res => res.json())
      .then(data => setStats(data))
  }, [])
  
  const config = getPricingConfig(stats.tier)
  const remaining = config.limits.monthlyInterpretations - stats.usedThisMonth
  
  return (
    <div className="container py-12">
      <h1 className="text-3xl font-bold mb-8">我的仪表板</h1>
      
      <div className="grid md:grid-cols-3 gap-6">
        <Card>
          <CardHeader>当前套餐</CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">
              {config.displayName}
            </div>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader>本月使用</CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">
              {stats.usedThisMonth} / {config.limits.monthlyInterpretations}
            </div>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader>剩余次数</CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-primary">
              {remaining}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
```

---

## 🎯 下一步

1. ✅ 已完成配置文件创建
2. ⬜ 实现 Stripe 支付集成
3. ⬜ 创建订阅管理页面
4. ⬜ 实现自动降级逻辑
5. ⬜ 添加使用统计功能

---

## 📚 相关文档

- [定价策略详细分析](./定价策略.md)
- [AI 模型配置](../lib/ai-config.ts)
- [Supabase 快速开始](./Supabase快速开始.md)
- [使用限制功能](./使用次数限制功能.md)

---

**最后更新**: 2025-10-21

