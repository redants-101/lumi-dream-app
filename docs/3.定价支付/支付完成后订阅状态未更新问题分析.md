# ğŸ› æ”¯ä»˜å®Œæˆåè®¢é˜…çŠ¶æ€æœªæ›´æ–°é—®é¢˜åˆ†æ

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**: ç”¨æˆ·å®Œæˆ Basic å¥—é¤æ”¯ä»˜åï¼Œè·³è½¬åˆ° `/dashboard` é¡µé¢ä»æ˜¾ç¤ºä¸º `free` ç”¨æˆ·ã€‚

**æœŸæœ›**: æ”¯ä»˜å®Œæˆåï¼Œdashboard åº”æ˜¾ç¤ºä¸º `basic` æˆ– `pro` ç”¨æˆ·ï¼Œå¹¶æ˜¾ç¤ºç›¸åº”çš„è®¢é˜…ä¿¡æ¯ã€‚

---

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### 1. æ”¯ä»˜æµç¨‹å›é¡¾

```
ç”¨æˆ·ç‚¹å‡»è®¢é˜…æŒ‰é’®
    â†“
å‰ç«¯è°ƒç”¨ /api/checkout/create-session
    â†“
åˆ›å»º Creem ç»“è´¦ä¼šè¯ï¼ˆä¼ é€’ metadataï¼‰
    â†“
ç”¨æˆ·åœ¨ Creem å®Œæˆæ”¯ä»˜
    â†“
Creem å‘é€ Webhook â†’ /api/webhooks/creem
    â†“
Webhook æ›´æ–°æ•°æ®åº“ user_subscriptions è¡¨
    â†“
ç”¨æˆ·é‡å®šå‘åˆ° /pricing/success
    â†“
ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹æˆ‘çš„è®¢é˜…" â†’ /dashboard
    â†“
Dashboard è°ƒç”¨ /api/subscription/manage (GET)
    â†“
æŸ¥è¯¢ user_subscriptions è¡¨
```

### 2. å¯èƒ½çš„é—®é¢˜ç‚¹

#### âš ï¸ é—®é¢˜ 1: Webhook æœªæ­£ç¡®é…ç½®æˆ–æœªè§¦å‘

**ç—‡çŠ¶**:
- Creem åå°æ²¡æœ‰ webhook å‘é€è®°å½•
- æˆ– webhook è¿”å› 4xx/5xx é”™è¯¯

**åŸå› **:
1. Webhook URL é…ç½®é”™è¯¯ï¼ˆç”Ÿäº§ç¯å¢ƒ vs æœ¬åœ°å¼€å‘ï¼‰
2. Webhook ç­¾åéªŒè¯å¤±è´¥
3. Creem äº§å“æœªæ­£ç¡®é…ç½®ä¸ºè®¢é˜…ç±»å‹

**æ’æŸ¥**:
```bash
# æŸ¥çœ‹ Creem åå° Webhook æ—¥å¿—
1. ç™»å½• Creem Dashboard
2. Settings â†’ Webhooks
3. æŸ¥çœ‹æœ€è¿‘çš„ webhook äº‹ä»¶
4. æ£€æŸ¥çŠ¶æ€ç å’Œå“åº”å†…å®¹
```

---

#### âš ï¸ é—®é¢˜ 2: Metadata ä¸­ user_id æœªæ­£ç¡®ä¼ é€’

**ç—‡çŠ¶**:
- Webhook æ—¥å¿—æ˜¾ç¤º `No user_id in metadata`
- æ•°æ®åº“æ— æ–°è®°å½•

**å½“å‰ä»£ç **:
```typescript:app/api/checkout/create-session/route.ts
const session = await creemClient.createCheckoutSession({
  product_id: productId,
  success_url: CREEM_CONFIG.successUrl,
  metadata: {
    user_id: user?.id || "",           // âš ï¸ å¦‚æœ user ä¸º nullï¼Œè¿™é‡Œæ˜¯ç©ºå­—ç¬¦ä¸²
    user_email: user?.email || "",
    tier,
    billing_cycle: billingCycle,
  },
})
```

**é—®é¢˜**:
- å¦‚æœç”¨æˆ·**æœªç™»å½•**æˆ–**ç™»å½•çŠ¶æ€å¤±æ•ˆ**ï¼Œ`user?.id` ä¸ºç©º
- ç©ºçš„ `user_id` ä¼šå¯¼è‡´ webhook æ— æ³•å…³è”åˆ°æ­£ç¡®çš„ç”¨æˆ·

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// âœ… ä¿®æ”¹åï¼šå¼ºåˆ¶è¦æ±‚ç™»å½•
if (!user) {
  return Response.json(
    { error: "Please sign in to subscribe" },
    { status: 401 }
  )
}

const session = await creemClient.createCheckoutSession({
  product_id: productId,
  success_url: CREEM_CONFIG.successUrl,
  metadata: {
    user_id: user.id,      // ç°åœ¨ä¿è¯æœ‰å€¼
    user_email: user.email,
    tier,
    billing_cycle: billingCycle,
  },
})
```

---

#### âš ï¸ é—®é¢˜ 3: æ•°æ®åº“ RLS ç­–ç•¥é˜»æ­¢å†™å…¥

**ç—‡çŠ¶**:
- Webhook è¿”å› 500 é”™è¯¯
- æ—¥å¿—æ˜¾ç¤º `Failed to update subscription: new row violates row-level security policy`

**å½“å‰æ•°æ®åº“ç­–ç•¥**:
```sql:docs/3.å®šä»·æ”¯ä»˜/Creemæ•°æ®åº“Schema.sql
-- ç­–ç•¥ 3: æœåŠ¡ç«¯å¯ä»¥æ’å…¥è®¢é˜…è®°å½•ï¼ˆé€šè¿‡ service roleï¼‰
CREATE POLICY "Service can insert subscriptions"
  ON user_subscriptions
  FOR INSERT
  WITH CHECK (true);

-- ç­–ç•¥ 4: æœåŠ¡ç«¯å¯ä»¥æ›´æ–°è®¢é˜…è®°å½•ï¼ˆWebhook ä½¿ç”¨ï¼‰
CREATE POLICY "Service can update subscriptions"
  ON user_subscriptions
  FOR UPDATE
  USING (true);
```

**é—®é¢˜**:
- ç­–ç•¥çœ‹èµ·æ¥æ­£ç¡®ï¼Œä½†**å¿…é¡»ä½¿ç”¨ service_role key**
- å¦‚æœä½¿ç”¨æ™®é€šçš„ anon keyï¼Œç­–ç•¥ä¼šé˜»æ­¢å†™å…¥

**æ’æŸ¥**:
```typescript
// æ£€æŸ¥ lib/supabase/server.ts
// ç¡®ä¿ä½¿ç”¨ service_role key
import { createClient } from '@supabase/supabase-js'

export const createClient = () => {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,  // âœ… å¿…é¡»ä½¿ç”¨ service role key
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    }
  )
}
```

---

#### âš ï¸ é—®é¢˜ 4: æ•°æ®åº“ç¼ºå°‘ creem_product_id å­—æ®µ

**ç—‡çŠ¶**:
- Webhook æ‰§è¡ŒæˆåŠŸï¼Œä½†æ•°æ®ä¸å®Œæ•´
- æ— æ³•è¿½è¸ªå…·ä½“çš„äº§å“è´­ä¹°è®°å½•

**å½“å‰ Schema**:
```sql:docs/3.å®šä»·æ”¯ä»˜/Creemæ•°æ®åº“Schema.sql
CREATE TABLE IF NOT EXISTS user_subscriptions (
  -- ...
  creem_subscription_id TEXT UNIQUE,
  creem_customer_email TEXT,
  creem_product_id TEXT,              -- âœ… å·²ç»æœ‰è¿™ä¸ªå­—æ®µ
  -- ...
);
```

**æ£€æŸ¥**:
```sql
-- åœ¨ Supabase SQL Editor ä¸­è¿è¡Œ
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user_subscriptions';
```

**å¦‚æœç¼ºå°‘è¯¥å­—æ®µ**:
```sql
ALTER TABLE user_subscriptions 
ADD COLUMN creem_product_id TEXT;
```

---

#### âš ï¸ é—®é¢˜ 5: Webhook å¤„ç†å®Œæˆå‰ç”¨æˆ·å°±è®¿é—® Dashboard

**ç—‡çŠ¶**:
- ç¬¬ä¸€æ¬¡è®¿é—® dashboard æ˜¾ç¤º free
- åˆ·æ–°é¡µé¢åæ˜¾ç¤ºæ­£ç¡®çš„å¥—é¤

**åŸå› **:
- æ”¯ä»˜å®Œæˆåç«‹å³é‡å®šå‘åˆ° `/pricing/success`
- æ­¤æ—¶ Creem webhook å¯èƒ½è¿˜æœªå¤„ç†å®Œæˆ
- ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹è®¢é˜…"æ—¶ï¼Œæ•°æ®åº“å°šæœªæ›´æ–°

**æ—¶é—´çº¿**:
```
T0: ç”¨æˆ·å®Œæˆæ”¯ä»˜
T0+100ms: Creem é‡å®šå‘åˆ° /pricing/success
T0+500ms: ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹æˆ‘çš„è®¢é˜…"
T0+800ms: Dashboard æŸ¥è¯¢æ•°æ®åº“ï¼ˆè®¢é˜…æœªæ¿€æ´» âŒï¼‰
T0+1200ms: Webhook å¤„ç†å®Œæˆï¼Œæ•°æ®åº“æ›´æ–° âœ…
```

**è§£å†³æ–¹æ¡ˆ**:

æ–¹æ¡ˆ A: **åœ¨ success é¡µé¢è½®è¯¢éªŒè¯è®¢é˜…çŠ¶æ€**ï¼ˆæ¨èï¼‰

```typescript
// app/pricing/success/page.tsx
useEffect(() => {
  let attempts = 0
  const maxAttempts = 10 // æœ€å¤šè½®è¯¢ 10 æ¬¡
  
  const checkSubscription = async () => {
    try {
      const response = await fetch("/api/subscription/manage")
      const data = await response.json()
      
      if (data.tier !== "free") {
        // âœ… è®¢é˜…å·²æ¿€æ´»
        setLoading(false)
        return true
      }
      
      // è®¢é˜…æœªæ¿€æ´»ï¼Œç»§ç»­ç­‰å¾…
      attempts++
      if (attempts < maxAttempts) {
        setTimeout(checkSubscription, 1000) // 1ç§’åé‡è¯•
      } else {
        // è¶…æ—¶ï¼Œä½†ä»å¯èƒ½æˆåŠŸï¼ˆwebhook å»¶è¿Ÿï¼‰
        setLoading(false)
      }
    } catch (error) {
      console.error("Failed to check subscription:", error)
      setLoading(false)
    }
  }
  
  // å»¶è¿Ÿ 2 ç§’åå¼€å§‹æ£€æŸ¥ï¼ˆç»™ webhook å¤„ç†æ—¶é—´ï¼‰
  setTimeout(checkSubscription, 2000)
}, [])
```

æ–¹æ¡ˆ B: **Webhook å®Œæˆåé€šè¿‡ SSE æˆ– WebSocket é€šçŸ¥å‰ç«¯**ï¼ˆé«˜çº§ï¼‰

---

#### âš ï¸ é—®é¢˜ 6: Webhook ä¸­ product_id æœªæ­£ç¡®å­˜å‚¨

**å½“å‰ Webhook ä»£ç **:
```typescript:app/api/webhooks/creem/route.ts
const { error } = await supabase.from("user_subscriptions").upsert(
  {
    user_id: userId,
    tier: tierInfo.tier,
    billing_cycle: tierInfo.billingCycle,
    status: "active",
    creem_subscription_id: subscription_id,
    creem_customer_email: customer_email,
    // âš ï¸ ç¼ºå°‘ creem_product_id å­—æ®µ
    current_period_start: new Date().toISOString(),
    current_period_end: new Date(
      Date.now() +
        (tierInfo.billingCycle === "yearly" ? 365 : 30) * 24 * 60 * 60 * 1000
    ).toISOString(),
    updated_at: new Date().toISOString(),
  },
  {
    onConflict: "user_id",
  }
)
```

**ä¿®å¤**:
```typescript
const { error } = await supabase.from("user_subscriptions").upsert(
  {
    user_id: userId,
    tier: tierInfo.tier,
    billing_cycle: tierInfo.billingCycle,
    status: "active",
    creem_subscription_id: subscription_id,
    creem_customer_email: customer_email,
    creem_product_id: product_id,  // âœ… æ·»åŠ è¿™ä¸€è¡Œ
    current_period_start: new Date().toISOString(),
    current_period_end: new Date(
      Date.now() +
        (tierInfo.billingCycle === "yearly" ? 365 : 30) * 24 * 60 * 60 * 1000
    ).toISOString(),
    updated_at: new Date().toISOString(),
  },
  {
    onConflict: "user_id",
  }
)
```

---

## ğŸ“Š åº”è¯¥å­˜å…¥æ•°æ®åº“çš„å®Œæ•´å­—æ®µ

### å¿…é¡»å­—æ®µï¼ˆå½“å‰å·²æœ‰ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|------|--------|
| `id` | UUID | ä¸»é”® | `550e8400-e29b-41d4-a716-446655440000` |
| `user_id` | UUID | ç”¨æˆ· IDï¼ˆå¤–é”®ï¼‰ | `123e4567-e89b-12d3-a456-426614174000` |
| `tier` | TEXT | è®¢é˜…å±‚çº§ | `"basic"` / `"pro"` / `"free"` |
| `billing_cycle` | TEXT | è®¡è´¹å‘¨æœŸ | `"monthly"` / `"yearly"` |
| `status` | TEXT | è®¢é˜…çŠ¶æ€ | `"active"` / `"canceled"` / `"expired"` |

### Creem ç›¸å…³å­—æ®µï¼ˆå½“å‰å·²æœ‰ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | æ¥æº |
|--------|------|------|------|
| `creem_subscription_id` | TEXT | Creem è®¢é˜… ID | Webhook `data.subscription_id` |
| `creem_customer_email` | TEXT | å®¢æˆ·é‚®ç®± | Webhook `data.customer_email` |
| `creem_product_id` | TEXT | äº§å“ ID | Webhook `data.product_id` âš ï¸ éœ€æ·»åŠ  |

### æ—¶é—´æˆ³å­—æ®µï¼ˆå½“å‰å·²æœ‰ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | è®¡ç®—æ–¹å¼ |
|--------|------|------|----------|
| `current_period_start` | TIMESTAMPTZ | å½“å‰å‘¨æœŸå¼€å§‹ | `new Date().toISOString()` |
| `current_period_end` | TIMESTAMPTZ | å½“å‰å‘¨æœŸç»“æŸ | å¼€å§‹æ—¶é—´ + 30å¤©ï¼ˆæœˆä»˜ï¼‰æˆ– 365å¤©ï¼ˆå¹´ä»˜ï¼‰ |
| `canceled_at` | TIMESTAMPTZ | å–æ¶ˆæ—¶é—´ | ç”¨æˆ·å–æ¶ˆæ—¶è®¾ç½® |
| `created_at` | TIMESTAMPTZ | åˆ›å»ºæ—¶é—´ | é»˜è®¤ `NOW()` |
| `updated_at` | TIMESTAMPTZ | æ›´æ–°æ—¶é—´ | é»˜è®¤ `NOW()`ï¼Œè§¦å‘å™¨è‡ªåŠ¨æ›´æ–° |

### å¯é€‰å­—æ®µï¼ˆæ¨èæ·»åŠ ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç”¨é€” |
|--------|------|------|------|
| `metadata` | JSONB | é¢å¤–å…ƒæ•°æ® | å­˜å‚¨ Creem è¿”å›çš„å…¶ä»–ä¿¡æ¯ |
| `trial_end` | TIMESTAMPTZ | è¯•ç”¨ç»“æŸæ—¶é—´ | å¦‚æœæœ‰è¯•ç”¨æœŸ |
| `discount_code` | TEXT | æŠ˜æ‰£ç  | å¦‚æœä½¿ç”¨äº†ä¼˜æƒ åˆ¸ |
| `amount_paid` | NUMERIC | å®é™…æ”¯ä»˜é‡‘é¢ | ç”¨äºè´¢åŠ¡å¯¹è´¦ |
| `currency` | TEXT | è´§å¸ç±»å‹ | `"USD"` |

---

## âœ… å®Œæ•´çš„ Webhook å¤„ç†é€»è¾‘

### æ¨èçš„ upsert è¯­å¥

```typescript
// app/api/webhooks/creem/route.ts

async function handleCheckoutCompleted(data: any) {
  console.log("[Webhook] Checkout completed:", data.id)

  const { 
    customer_email, 
    product_id, 
    metadata, 
    subscription_id,
    amount_paid,      // æ–°å¢ï¼šæ”¯ä»˜é‡‘é¢
    currency,         // æ–°å¢ï¼šè´§å¸
  } = data

  // è§£æå¥—é¤ä¿¡æ¯
  const tierInfo = parseTierFromProductId(product_id)
  if (!tierInfo) {
    console.error("[Webhook] Unknown product ID:", product_id)
    return
  }

  // è·å–ç”¨æˆ· IDï¼ˆä¼˜å…ˆä» metadataï¼‰
  const userId = metadata?.user_id
  
  if (!userId) {
    console.error("[Webhook] No user_id in metadata")
    console.error("[Webhook] Data:", JSON.stringify(data, null, 2))
    return
  }
  
  console.log("[Webhook] Processing for user:", userId)
  console.log("[Webhook] Tier:", tierInfo.tier)
  console.log("[Webhook] Billing cycle:", tierInfo.billingCycle)
  
  const supabase = await createClient()

  // è®¡ç®—å‘¨æœŸç»“æŸæ—¶é—´
  const periodStart = new Date()
  const periodEnd = new Date(
    periodStart.getTime() + 
    (tierInfo.billingCycle === "yearly" ? 365 : 30) * 24 * 60 * 60 * 1000
  )

  // âœ… å®Œæ•´çš„ upsert è¯­å¥
  const { data: result, error } = await supabase
    .from("user_subscriptions")
    .upsert(
      {
        user_id: userId,
        tier: tierInfo.tier,
        billing_cycle: tierInfo.billingCycle,
        status: "active",
        
        // Creem ç›¸å…³ä¿¡æ¯
        creem_subscription_id: subscription_id,
        creem_customer_email: customer_email,
        creem_product_id: product_id,  // âœ… æ·»åŠ äº§å“ ID
        
        // æ—¶é—´æˆ³
        current_period_start: periodStart.toISOString(),
        current_period_end: periodEnd.toISOString(),
        updated_at: new Date().toISOString(),
        
        // å¯é€‰ï¼šæ”¯ä»˜ä¿¡æ¯
        metadata: {
          amount_paid: amount_paid || 0,
          currency: currency || "USD",
          checkout_id: data.id,
          activated_at: new Date().toISOString(),
        },
      },
      {
        onConflict: "user_id",
      }
    )
    .select() // âœ… è¿”å›æ’å…¥çš„æ•°æ®ï¼Œç”¨äºéªŒè¯

  if (error) {
    console.error("[Webhook] Failed to update subscription:", error)
    console.error("[Webhook] Error details:", JSON.stringify(error, null, 2))
    return
  }

  console.log("[Webhook] âœ… Subscription activated successfully")
  console.log("[Webhook] Data:", JSON.stringify(result, null, 2))
}
```

---

## ğŸ”§ è°ƒè¯•æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥ Webhook æ˜¯å¦è§¦å‘

```bash
# 1. æŸ¥çœ‹ Creem åå°
Creem Dashboard â†’ Settings â†’ Webhooks â†’ Events

# 2. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
# Vercel: https://vercel.com/[ä½ çš„é¡¹ç›®]/deployments
# æˆ–æœ¬åœ°: æŸ¥çœ‹ç»ˆç«¯è¾“å‡º

# 3. ç¡®è®¤ Webhook URL æ­£ç¡®
ç”Ÿäº§ç¯å¢ƒ: https://www.lumidreams.app/api/webhooks/creem
å¼€å‘ç¯å¢ƒ: https://[ngrok-url]/api/webhooks/creem
```

### æ­¥éª¤ 2: æ£€æŸ¥æ•°æ®åº“è®°å½•

```sql
-- åœ¨ Supabase SQL Editor ä¸­è¿è¡Œ

-- æŸ¥çœ‹æ‰€æœ‰è®¢é˜…è®°å½•
SELECT * FROM user_subscriptions;

-- æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„è®¢é˜…
SELECT * FROM user_subscriptions 
WHERE user_id = 'YOUR_USER_ID';

-- æŸ¥çœ‹æœ€è¿‘åˆ›å»ºçš„è®¢é˜…
SELECT * FROM user_subscriptions 
ORDER BY created_at DESC 
LIMIT 10;
```

### æ­¥éª¤ 3: æ‰‹åŠ¨æµ‹è¯• Webhook

```bash
# ä½¿ç”¨ curl æ¨¡æ‹Ÿ Webhook è¯·æ±‚
curl -X POST https://www.lumidreams.app/api/webhooks/creem \
  -H "Content-Type: application/json" \
  -H "x-creem-signature: YOUR_SIGNATURE" \
  -d '{
    "type": "checkout.session.completed",
    "data": {
      "id": "cs_test_123",
      "customer_email": "test@example.com",
      "product_id": "YOUR_PRODUCT_ID",
      "subscription_id": "sub_test_123",
      "metadata": {
        "user_id": "YOUR_USER_ID",
        "tier": "basic",
        "billing_cycle": "monthly"
      }
    }
  }'
```

### æ­¥éª¤ 4: éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€

```typescript
// åœ¨ /api/checkout/create-session æ·»åŠ æ—¥å¿—
console.log("User logged in:", !!user)
console.log("User ID:", user?.id)
console.log("User Email:", user?.email)
```

---

## ğŸ“ å®Œæ•´ä¿®å¤æ¸…å•

### 1. ä¿®å¤ checkout APIï¼ˆå¼ºåˆ¶ç™»å½•ï¼‰

```typescript
// app/api/checkout/create-session/route.ts

export async function POST(request: NextRequest) {
  // ... éªŒè¯å‚æ•° ...

  // âœ… è·å–å½“å‰ç”¨æˆ·ï¼ˆå¿…é¡»ç™»å½•ï¼‰
  const supabase = await createClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()
  
  // âœ… å¼ºåˆ¶è¦æ±‚ç™»å½•
  if (!user) {
    console.error("âŒ [Checkout] User not authenticated")
    return Response.json(
      { error: "Please sign in to subscribe" },
      { status: 401 }
    )
  }
  
  console.log("âœ… [Checkout] User authenticated:", user.email)
  
  // ... å…¶ä½™ä»£ç  ...
}
```

### 2. ä¿®å¤ Webhook å¤„ç†ï¼ˆæ·»åŠ  product_idï¼‰

```typescript
// app/api/webhooks/creem/route.ts

const { error } = await supabase.from("user_subscriptions").upsert(
  {
    user_id: userId,
    tier: tierInfo.tier,
    billing_cycle: tierInfo.billingCycle,
    status: "active",
    creem_subscription_id: subscription_id,
    creem_customer_email: customer_email,
    creem_product_id: product_id,  // âœ… æ·»åŠ è¿™ä¸€è¡Œ
    current_period_start: new Date().toISOString(),
    current_period_end: new Date(
      Date.now() +
        (tierInfo.billingCycle === "yearly" ? 365 : 30) * 24 * 60 * 60 * 1000
    ).toISOString(),
    updated_at: new Date().toISOString(),
  },
  {
    onConflict: "user_id",
  }
)
.select() // âœ… è¿”å›ç»“æœç”¨äºè°ƒè¯•

// âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—
if (error) {
  console.error("[Webhook] âŒ Failed to update subscription")
  console.error("[Webhook] Error:", JSON.stringify(error, null, 2))
  console.error("[Webhook] User ID:", userId)
  console.error("[Webhook] Tier:", tierInfo.tier)
  return
}

console.log("[Webhook] âœ… Subscription updated successfully")
```

### 3. ä¿®å¤ Success é¡µé¢ï¼ˆè½®è¯¢éªŒè¯ï¼‰

```typescript
// app/pricing/success/page.tsx

"use client"

import { useEffect, useState } from "react"
import { useRouter } from "next/navigation"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { CheckCircle, Loader2, XCircle } from "lucide-react"
import confetti from "canvas-confetti"
import { toast } from "sonner"

export default function PaymentSuccessPage() {
  const router = useRouter()
  const [loading, setLoading] = useState(true)
  const [subscriptionTier, setSubscriptionTier] = useState<string | null>(null)
  const [verificationFailed, setVerificationFailed] = useState(false)

  useEffect(() => {
    // è§¦å‘åº†ç¥åŠ¨ç”»
    const duration = 3 * 1000
    const animationEnd = Date.now() + duration

    const interval = setInterval(() => {
      const timeLeft = animationEnd - Date.now()

      if (timeLeft <= 0) {
        clearInterval(interval)
        return
      }

      confetti({
        particleCount: 2,
        angle: 60,
        spread: 55,
        origin: { x: 0 },
        colors: ["#a855f7", "#ec4899", "#f59e0b"],
      })
      confetti({
        particleCount: 2,
        angle: 120,
        spread: 55,
        origin: { x: 1 },
        colors: ["#a855f7", "#ec4899", "#f59e0b"],
      })
    }, 30)

    return () => clearInterval(interval)
  }, [])

  useEffect(() => {
    // âœ… è½®è¯¢éªŒè¯è®¢é˜…çŠ¶æ€
    let attempts = 0
    const maxAttempts = 10 // æœ€å¤šè½®è¯¢ 10 æ¬¡ï¼ˆ10 ç§’ï¼‰
    
    const checkSubscription = async () => {
      try {
        console.log(`[Success] Checking subscription (attempt ${attempts + 1}/${maxAttempts})`)
        
        const response = await fetch("/api/subscription/manage")
        
        if (!response.ok) {
          throw new Error("Failed to fetch subscription")
        }
        
        const data = await response.json()
        console.log("[Success] Subscription data:", data)
        
        if (data.tier !== "free") {
          // âœ… è®¢é˜…å·²æ¿€æ´»
          console.log("[Success] âœ… Subscription activated:", data.tier)
          setSubscriptionTier(data.tier)
          setLoading(false)
          toast.success("Subscription activated successfully!")
          return
        }
        
        // è®¢é˜…æœªæ¿€æ´»ï¼Œç»§ç»­ç­‰å¾…
        attempts++
        if (attempts < maxAttempts) {
          console.log("[Success] Subscription not ready, retrying in 1s...")
          setTimeout(checkSubscription, 1000) // 1ç§’åé‡è¯•
        } else {
          // âš ï¸ è¶…æ—¶ï¼Œä½†å¯èƒ½æ˜¯ webhook å»¶è¿Ÿ
          console.warn("[Success] âš ï¸ Verification timeout, but subscription might still activate")
          setLoading(false)
          setVerificationFailed(true)
          toast.warning("Subscription verification is taking longer than expected. Please check your dashboard.")
        }
      } catch (error) {
        console.error("[Success] Error checking subscription:", error)
        attempts++
        if (attempts < maxAttempts) {
          setTimeout(checkSubscription, 1000)
        } else {
          setLoading(false)
          setVerificationFailed(true)
          toast.error("Failed to verify subscription. Please check your dashboard.")
        }
      }
    }
    
    // å»¶è¿Ÿ 2 ç§’åå¼€å§‹æ£€æŸ¥ï¼ˆç»™ webhook å¤„ç†æ—¶é—´ï¼‰
    setTimeout(checkSubscription, 2000)
  }, [])

  return (
    <div className="min-h-screen bg-gradient-to-b from-background to-muted/20 flex items-center justify-center p-4">
      <Card className="max-w-md w-full text-center glow-box">
        <CardHeader className="pb-4">
          {loading ? (
            <div className="flex justify-center mb-4">
              <Loader2 className="w-16 h-16 text-primary animate-spin" />
            </div>
          ) : verificationFailed ? (
            <div className="flex justify-center mb-4">
              <XCircle className="w-16 h-16 text-yellow-500" />
            </div>
          ) : (
            <div className="flex justify-center mb-4">
              <CheckCircle className="w-16 h-16 text-green-500" />
            </div>
          )}
          
          <CardTitle className="text-3xl">
            {loading 
              ? "Activating..." 
              : verificationFailed 
                ? "Payment Received" 
                : "Payment Successful!"}
          </CardTitle>
          
          <CardDescription className="text-base mt-2">
            {loading
              ? "We're activating your subscription..."
              : verificationFailed
                ? "Your payment is being processed. It may take a few minutes to activate."
                : `Your ${subscriptionTier?.toUpperCase()} subscription is now active!`}
          </CardDescription>
        </CardHeader>

        <CardContent className="space-y-4">
          {!loading && (
            <>
              <div className="bg-muted rounded-lg p-4 text-sm text-left space-y-2">
                {verificationFailed ? (
                  <>
                    <p>âœ… Payment completed</p>
                    <p>â³ Activation in progress</p>
                    <p>ğŸ“§ You'll receive a confirmation email</p>
                  </>
                ) : (
                  <>
                    <p>âœ¨ Subscription activated</p>
                    <p>ğŸ“§ Confirmation email sent</p>
                    <p>ğŸ‰ Premium features unlocked</p>
                  </>
                )}
              </div>

              <div className="flex flex-col gap-2">
                <Button
                  onClick={() => router.push("/")}
                  size="lg"
                  className="w-full"
                >
                  Start Interpreting Dreams
                </Button>
                
                <Button
                  onClick={() => router.push("/dashboard")}
                  variant="outline"
                  size="lg"
                  className="w-full"
                >
                  View My Subscription
                </Button>
              </div>
            </>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

### 4. æ£€æŸ¥æ•°æ®åº“å­—æ®µæ˜¯å¦å®Œæ•´

```sql
-- åœ¨ Supabase SQL Editor ä¸­è¿è¡Œ

-- æ£€æŸ¥è¡¨ç»“æ„
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'user_subscriptions'
ORDER BY ordinal_position;

-- å¦‚æœç¼ºå°‘ creem_product_id å­—æ®µï¼Œæ·»åŠ å®ƒ
ALTER TABLE user_subscriptions 
ADD COLUMN IF NOT EXISTS creem_product_id TEXT;

-- éªŒè¯ RLS ç­–ç•¥
SELECT * FROM pg_policies WHERE tablename = 'user_subscriptions';
```

### 5. éªŒè¯ Supabase Service Role Key

```bash
# æ£€æŸ¥ .env.local æ–‡ä»¶
SUPABASE_SERVICE_ROLE_KEY=eyJ...  # å¿…é¡»æ˜¯ service_role keyï¼Œä¸æ˜¯ anon key
```

```typescript
// lib/supabase/server.ts

import { createClient as createSupabaseClient } from '@supabase/supabase-js'

export async function createClient() {
  return createSupabaseClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,  // âœ… å¿…é¡»ä½¿ç”¨ service_role
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    }
  )
}
```

---

## ğŸ“Š æ•°æ®åº“å­—æ®µæ€»ç»“

### æœ€ç»ˆçš„ user_subscriptions è¡¨ç»“æ„

```sql
CREATE TABLE user_subscriptions (
  -- ä¸»é”®å’Œå¤–é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  
  -- è®¢é˜…ä¿¡æ¯
  tier TEXT NOT NULL DEFAULT 'free' CHECK (tier IN ('free', 'basic', 'pro')),
  billing_cycle TEXT CHECK (billing_cycle IN ('monthly', 'yearly')),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'canceled', 'expired', 'past_due')),
  
  -- Creem ç›¸å…³ä¿¡æ¯ï¼ˆå¿…é¡»å­—æ®µï¼‰
  creem_subscription_id TEXT UNIQUE,
  creem_customer_email TEXT,
  creem_product_id TEXT,              -- âœ… å¿…é¡»å­˜å‚¨
  
  -- æ—¶é—´æˆ³ï¼ˆå¿…é¡»å­—æ®µï¼‰
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  canceled_at TIMESTAMPTZ,
  
  -- å…ƒæ•°æ®ï¼ˆå¯é€‰ä½†æ¨èï¼‰
  metadata JSONB DEFAULT '{}'::jsonb,
  
  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### å¿…é¡»å­˜å‚¨çš„å­—æ®µï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

- âœ… `user_id` - å…³è”ç”¨æˆ·
- âœ… `tier` - è®¢é˜…å±‚çº§
- âœ… `billing_cycle` - è®¡è´¹å‘¨æœŸ
- âœ… `status` - è®¢é˜…çŠ¶æ€
- âœ… `creem_subscription_id` - Creem è®¢é˜… IDï¼ˆç”¨äºå–æ¶ˆè®¢é˜…ï¼‰
- âœ… `creem_product_id` - Creem äº§å“ IDï¼ˆç”¨äºè¿½è¸ªï¼‰
- âœ… `current_period_end` - å‘¨æœŸç»“æŸæ—¶é—´ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼‰

### æ¨èå­˜å‚¨çš„å­—æ®µï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

- âœ… `creem_customer_email` - å®¢æˆ·é‚®ç®±ï¼ˆç”¨äºå¯¹è´¦ï¼‰
- âœ… `current_period_start` - å‘¨æœŸå¼€å§‹æ—¶é—´
- âœ… `metadata` - é¢å¤–ä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼Œçµæ´»ï¼‰

### å¯é€‰å­—æ®µï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

- `canceled_at` - å–æ¶ˆæ—¶é—´
- `trial_end` - è¯•ç”¨ç»“æŸæ—¶é—´
- `discount_code` - æŠ˜æ‰£ç 

---

## ğŸ¯ å¿«é€Ÿä¿®å¤æ­¥éª¤

1. **ä¿®å¤ checkout API**ï¼ˆ5 åˆ†é’Ÿï¼‰
   - æ·»åŠ ç™»å½•æ£€æŸ¥
   - ç¡®ä¿ `user_id` ä¸ä¸ºç©º

2. **ä¿®å¤ Webhook**ï¼ˆ5 åˆ†é’Ÿï¼‰
   - æ·»åŠ  `creem_product_id` å­—æ®µ
   - æ·»åŠ è¯¦ç»†æ—¥å¿—
   - ä½¿ç”¨ `.select()` è¿”å›ç»“æœ

3. **ä¿®å¤ Success é¡µé¢**ï¼ˆ10 åˆ†é’Ÿï¼‰
   - æ·»åŠ è½®è¯¢é€»è¾‘
   - éªŒè¯è®¢é˜…çŠ¶æ€
   - æ”¹å–„ç”¨æˆ·ä½“éªŒ

4. **éªŒè¯æ•°æ®åº“**ï¼ˆ3 åˆ†é’Ÿï¼‰
   - æ£€æŸ¥è¡¨ç»“æ„
   - ç¡®è®¤ RLS ç­–ç•¥
   - éªŒè¯ service role key

5. **æµ‹è¯•å®Œæ•´æµç¨‹**ï¼ˆ10 åˆ†é’Ÿï¼‰
   - å®Œæˆä¸€æ¬¡æµ‹è¯•æ”¯ä»˜
   - æŸ¥çœ‹ webhook æ—¥å¿—
   - éªŒè¯æ•°æ®åº“è®°å½•
   - è®¿é—® dashboard

**æ€»æ—¶é—´**: çº¦ 30-40 åˆ†é’Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: ğŸ”§ å¾…ä¿®å¤

