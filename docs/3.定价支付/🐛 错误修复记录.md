# ğŸ› é”™è¯¯ä¿®å¤è®°å½•

**ä¿®å¤æ—¥æœŸ**: 2025-10-27

---

## âŒ é”™è¯¯ 1: ç¼ºå°‘ canvas-confetti æ¨¡å—

### é”™è¯¯ä¿¡æ¯
```
Module not found: Can't resolve 'canvas-confetti'
in app/pricing/success/page.tsx
```

### åŸå› 
æ”¯ä»˜æˆåŠŸé¡µé¢ä½¿ç”¨äº† `canvas-confetti` åŒ…æ¥æ˜¾ç¤ºåº†ç¥åŠ¨ç”»ï¼Œä½†è¯¥åŒ…æœªå®‰è£…ã€‚

### è§£å†³æ–¹æ¡ˆ âœ…
```bash
pnpm add canvas-confetti
pnpm add -D @types/canvas-confetti
```

### å½±å“
- âŒ ç”¨æˆ·æ”¯ä»˜æˆåŠŸåæ— æ³•è®¿é—®æˆåŠŸé¡µé¢ï¼ˆ500 é”™è¯¯ï¼‰
- âœ… ä¿®å¤åç”¨æˆ·å¯ä»¥çœ‹åˆ°åº†ç¥åŠ¨ç”»

---

## âŒ é”™è¯¯ 2: Webhook ç­¾åéªŒè¯å¤±è´¥

### é”™è¯¯ä¿¡æ¯
```
[Webhook] Missing signature
POST /api/webhooks/creem 401
POST /api/webhooks/creem 500
```

### åŸå› åˆ†æ

1. **ç­¾åå¤´ç¼ºå¤±**
   - Creem å¯èƒ½ä¸å‘é€ `x-creem-signature` å¤´
   - æˆ–è€…ä½¿ç”¨ä¸åŒçš„å¤´åç§°

2. **æŸ¥è¯¢ç”¨æˆ·å¤±è´¥**
   - å°è¯•æŸ¥è¯¢ `auth.users` è¡¨ï¼ˆSupabase ä¿ç•™è¡¨ï¼‰
   - åº”è¯¥ä½¿ç”¨ metadata ä¸­çš„ `user_id`

### è§£å†³æ–¹æ¡ˆ âœ…

#### 1. å¢å¼º Webhook æ—¥å¿—
```typescript
// è®°å½•æ‰€æœ‰ headers
const headers = Object.fromEntries(request.headers.entries())
console.log("[Webhook] Headers:", JSON.stringify(headers, null, 2))

// è®°å½•å®Œæ•´ event æ•°æ®
console.log("[Webhook] Event data:", JSON.stringify(event, null, 2))
```

#### 2. æ”¯æŒå¤šç§ç­¾åå¤´
```typescript
const signature = request.headers.get("x-creem-signature") || 
                 request.headers.get("x-signature") ||
                 request.headers.get("signature")
```

#### 3. å…è®¸è·³è¿‡ç­¾åéªŒè¯ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
```typescript
// åœ¨ .env.local è®¾ç½®
CREEM_SKIP_SIGNATURE=true

// ä»£ç ä¸­
const skipSignatureValidation = process.env.CREEM_SKIP_SIGNATURE === "true"
if (!signature && !skipSignatureValidation) {
  return Response.json({ error: "Missing signature" }, { status: 401 })
}
```

#### 4. ä¿®å¤ç”¨æˆ·æŸ¥è¯¢é€»è¾‘
```typescript
// âŒ ä¹‹å‰ï¼šæŸ¥è¯¢ auth.users è¡¨
const { data: users } = await supabase
  .from("auth.users")  // æ— æƒé™è®¿é—®
  .select("id")
  .eq("email", customer_email)

// âœ… ç°åœ¨ï¼šä½¿ç”¨ metadata ä¸­çš„ user_id
const userId = metadata?.user_id
if (!userId) {
  console.error("[Webhook] No user_id in metadata")
  return
}
```

### å½±å“
- âŒ Webhook æ— æ³•å¤„ç†æ”¯ä»˜æˆåŠŸäº‹ä»¶
- âŒ ç”¨æˆ·è®¢é˜…æ— æ³•è‡ªåŠ¨æ¿€æ´»
- âœ… ä¿®å¤åå¯ä»¥æ­£å¸¸æ¥æ”¶å’Œå¤„ç† Webhook

---

## ğŸ” è°ƒè¯•æ–¹æ³•

### 1. æŸ¥çœ‹ Webhook æ—¥å¿—

ä¿®å¤åï¼ŒWebhook ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š

```
ğŸ”” [Webhook] Received request
[Webhook] Payload length: 1234
[Webhook] Headers: {
  "x-creem-signature": "...",
  "content-type": "application/json",
  ...
}
[Webhook] Signature header: Found
[Webhook] âœ… Signature verified
[Webhook] ğŸ“¦ Event received: checkout.session.completed
[Webhook] Event data: {
  "type": "checkout.session.completed",
  "data": {
    "id": "ch_xxx",
    "product_id": "prod_xxx",
    "metadata": {
      "user_id": "xxx",
      "user_email": "xxx",
      ...
    }
  }
}
```

### 2. ä¸´æ—¶è·³è¿‡ç­¾åéªŒè¯

å¦‚æœç­¾åå¤´ç¼ºå¤±ï¼Œå¯ä»¥ä¸´æ—¶è·³è¿‡éªŒè¯ï¼š

```bash
# .env.local
CREEM_SKIP_SIGNATURE=true
```

**è­¦å‘Š**: âš ï¸ ä»…ç”¨äºæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»éªŒè¯ç­¾åï¼

### 3. æ£€æŸ¥ Creem Webhook é…ç½®

åœ¨ Creem åå°ç¡®è®¤ï¼š
1. Webhook URL æ­£ç¡®ï¼š`https://xxx.ngrok-free.dev/api/webhooks/creem`
2. äº‹ä»¶å·²é€‰æ‹©ï¼š`checkout.session.completed`, `subscription.updated` ç­‰
3. Webhook çŠ¶æ€ï¼šActive

---

## ğŸ“‹ ä¿®å¤æ¸…å•

- [x] å®‰è£… `canvas-confetti` åŒ…
- [x] å®‰è£… `@types/canvas-confetti` ç±»å‹å®šä¹‰
- [x] å¢å¼º Webhook æ—¥å¿—è¾“å‡º
- [x] æ”¯æŒå¤šç§ç­¾åå¤´åç§°
- [x] æ·»åŠ ç­¾åéªŒè¯è·³è¿‡é€‰é¡¹
- [x] ä¿®å¤ç”¨æˆ· ID è·å–é€»è¾‘
- [x] ç§»é™¤ auth.users è¡¨æŸ¥è¯¢
- [ ] æµ‹è¯•å®Œæ•´æ”¯ä»˜æµç¨‹
- [ ] éªŒè¯ Webhook å¤„ç†
- [ ] ç¡®è®¤è®¢é˜…æ¿€æ´»

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æ”¯ä»˜æˆåŠŸé¡µé¢

```bash
# è®¿é—®
http://localhost:3000/pricing/success

# æœŸæœ›ï¼š
âœ… é¡µé¢æ­£å¸¸æ˜¾ç¤º
âœ… çœ‹åˆ°åº†ç¥åŠ¨ç”»ï¼ˆconfettiï¼‰
âœ… æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
```

### 2. æµ‹è¯• Webhook æ¥æ”¶

```bash
# 1. å®Œæˆæ”¯ä»˜
# 2. è§‚å¯Ÿç»ˆç«¯æ—¥å¿—

# æœŸæœ›æ—¥å¿—ï¼š
ğŸ”” [Webhook] Received request
[Webhook] Headers: {...}
[Webhook] ğŸ“¦ Event received: checkout.session.completed
[Webhook] Processing for user: xxx
[Webhook] âœ… Subscription activated
```

### 3. éªŒè¯è®¢é˜…æ¿€æ´»

```bash
# 1. ç™»å½• Supabase
# 2. æŸ¥çœ‹ user_subscriptions è¡¨
# 3. ç¡®è®¤æ–°è®°å½•å­˜åœ¨

# æœŸæœ›å­—æ®µï¼š
user_id: xxx
tier: basic æˆ– pro
status: active
creem_subscription_id: sub_xxx
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **è®¾ç½®ç¯å¢ƒå˜é‡**ï¼ˆå¦‚æœéœ€è¦è·³è¿‡ç­¾åéªŒè¯ï¼‰ï¼š
```bash
# .env.local
CREEM_SKIP_SIGNATURE=true
```

2. **é‡å¯æœåŠ¡å™¨**ï¼š
```bash
pnpm dev
```

3. **æµ‹è¯•æ”¯ä»˜æµç¨‹**ï¼š
   - è®¿é—® /pricing
   - ç‚¹å‡»è®¢é˜…
   - å®Œæˆæ”¯ä»˜
   - è§‚å¯Ÿæ—¥å¿—

4. **éªŒè¯ç»“æœ**ï¼š
   - æ”¯ä»˜æˆåŠŸé¡µé¢æ˜¾ç¤º
   - Webhook æ—¥å¿—æ­£å¸¸
   - è®¢é˜…å·²æ¿€æ´»

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `app/pricing/success/page.tsx` - æ”¯ä»˜æˆåŠŸé¡µé¢
- `app/api/webhooks/creem/route.ts` - Webhook å¤„ç†å™¨
- `lib/creem-config.ts` - Creem é…ç½®
- `.env.local` - ç¯å¢ƒå˜é‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç­¾åéªŒè¯**
   - æµ‹è¯•ç¯å¢ƒå¯ä»¥è·³è¿‡
   - ç”Ÿäº§ç¯å¢ƒ**å¿…é¡»**å¯ç”¨

2. **ç”¨æˆ· ID**
   - å¿…é¡»åœ¨åˆ›å»º checkout æ—¶ä¼ é€’ `metadata.user_id`
   - Webhook ä¾èµ–æ­¤å­—æ®µæ¿€æ´»è®¢é˜…

3. **Ngrok URL**
   - æ¯æ¬¡é‡å¯ ngrok ä¼šæ›´æ–° URL
   - éœ€è¦åœ¨ Creem åå°æ›´æ–° Webhook URL

---

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…æµ‹è¯•  
**å¯ä»¥ç»§ç»­**: âœ… æ˜¯

