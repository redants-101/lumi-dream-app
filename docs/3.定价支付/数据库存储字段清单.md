# ðŸ“‹ æ”¯ä»˜ç³»ç»Ÿæ•°æ®åº“å­˜å‚¨å­—æ®µæ¸…å•

## ðŸŽ¯ å¿«é€Ÿå›žç­”ï¼šåº”è¯¥å­˜å‚¨å“ªäº›ä¿¡æ¯åˆ°æ•°æ®åº“ï¼Ÿ

### æ ¸å¿ƒå¿…é¡»å­—æ®µï¼ˆç¼ºä¸€ä¸å¯ï¼‰

```typescript
{
  // ðŸ”‘ ç”¨æˆ·å…³è”
  user_id: "123e4567-e89b-12d3-a456-426614174000",  // UUIDï¼Œæ¥è‡ª Supabase Auth
  
  // ðŸ’³ è®¢é˜…ä¿¡æ¯
  tier: "basic",                      // "free" | "basic" | "pro"
  billing_cycle: "monthly",           // "monthly" | "yearly"
  status: "active",                   // "active" | "canceled" | "expired"
  
  // ðŸ·ï¸ Creem å…³è”ä¿¡æ¯ï¼ˆç”¨äºŽåŽç»­æ“ä½œï¼‰
  creem_subscription_id: "sub_abc123",    // Creem è®¢é˜… IDï¼ˆç”¨äºŽå–æ¶ˆ/æ›´æ–°ï¼‰
  creem_product_id: "prod_xyz456",        // âš ï¸ é‡è¦ï¼ç”¨äºŽè¿½è¸ªå…·ä½“äº§å“
  creem_customer_email: "user@example.com",
  
  // â° æ—¶é—´ç®¡ç†
  current_period_start: "2025-10-28T00:00:00Z",
  current_period_end: "2025-11-28T00:00:00Z",   // ç”¨äºŽåˆ¤æ–­æ˜¯å¦è¿‡æœŸ
  
  // ðŸ“ å®¡è®¡å­—æ®µ
  created_at: "2025-10-28T10:30:00Z",
  updated_at: "2025-10-28T10:30:00Z"
}
```

---

## ðŸ” é—®é¢˜åˆ†æžï¼šä¸ºä»€ä¹ˆæ”¯ä»˜åŽè¿˜æ˜¯ Free ç”¨æˆ·ï¼Ÿ

### åŽŸå›  1: Webhook æœªè§¦å‘æˆ–å¤±è´¥ âŒ

```
ç”¨æˆ·æ”¯ä»˜æˆåŠŸ
    â†“
Creem åº”è¯¥å‘é€ Webhook â†’ /api/webhooks/creem
    â†“
âŒ ä½† Webhook å¯èƒ½ï¼š
    - æœªé…ç½®
    - URL é”™è¯¯
    - ç­¾åéªŒè¯å¤±è´¥
    - è¿”å›ž 500 é”™è¯¯
```

**æŽ’æŸ¥**: æŸ¥çœ‹ Creem åŽå° â†’ Webhooks â†’ Events

---

### åŽŸå›  2: metadata.user_id ä¸ºç©º âŒ

```typescript
// âŒ é—®é¢˜ä»£ç 
const session = await creemClient.createCheckoutSession({
  metadata: {
    user_id: user?.id || "",  // å¦‚æžœç”¨æˆ·æœªç™»å½•ï¼Œè¿™é‡Œæ˜¯ç©ºå­—ç¬¦ä¸²ï¼
  },
})

// âœ… ä¿®å¤åŽ
if (!user) {
  return Response.json({ error: "Please sign in" }, { status: 401 })
}
const session = await creemClient.createCheckoutSession({
  metadata: {
    user_id: user.id,  // çŽ°åœ¨ä¿è¯æœ‰å€¼
  },
})
```

---

### åŽŸå›  3: æ•°æ®åº“å†™å…¥å¤±è´¥ï¼ˆRLS ç­–ç•¥ï¼‰âŒ

```typescript
// âš ï¸ å¿…é¡»ä½¿ç”¨ service_role key
import { createClient } from '@supabase/supabase-js'

export const createClient = () => {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,  // âœ… ä¸æ˜¯ ANON_KEY
  )
}
```

---

### åŽŸå›  4: ç¼ºå°‘ creem_product_id å­—æ®µ âŒ

```typescript
// âŒ å½“å‰ Webhook ä»£ç ç¼ºå°‘è¿™ä¸ªå­—æ®µ
await supabase.from("user_subscriptions").upsert({
  user_id: userId,
  tier: tierInfo.tier,
  // âŒ ç¼ºå°‘: creem_product_id
})

// âœ… åº”è¯¥æ·»åŠ 
await supabase.from("user_subscriptions").upsert({
  user_id: userId,
  tier: tierInfo.tier,
  creem_product_id: product_id,  // âœ… ä»Ž webhook data ä¸­èŽ·å–
})
```

---

### åŽŸå›  5: æ—¶åºé—®é¢˜ï¼ˆWebhook å»¶è¿Ÿï¼‰â±ï¸

```
T0:    ç”¨æˆ·å®Œæˆæ”¯ä»˜
T+100ms: é‡å®šå‘åˆ° /pricing/success
T+500ms: ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹è®¢é˜…"
T+800ms: Dashboard æŸ¥è¯¢æ•°æ®åº“ â†’ è®¢é˜…æœªæ¿€æ´» âŒ
T+1200ms: Webhook å¤„ç†å®Œæˆ â†’ æ•°æ®åº“æ›´æ–° âœ…
```

**è§£å†³æ–¹æ¡ˆ**: åœ¨ Success é¡µé¢è½®è¯¢éªŒè¯è®¢é˜…çŠ¶æ€

---

## ðŸ“Š æ•°æ®åº“è¡¨ç»“æž„

### å½“å‰ Schemaï¼ˆæ¥è‡ª Creemæ•°æ®åº“Schema.sqlï¼‰

```sql
CREATE TABLE user_subscriptions (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ç”¨æˆ·å…³è”
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- è®¢é˜…ä¿¡æ¯
  tier TEXT NOT NULL DEFAULT 'free' CHECK (tier IN ('free', 'basic', 'pro')),
  billing_cycle TEXT CHECK (billing_cycle IN ('monthly', 'yearly')),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'canceled', 'expired', 'past_due')),
  
  -- Creem ç›¸å…³
  creem_subscription_id TEXT UNIQUE,
  creem_customer_email TEXT,
  creem_product_id TEXT,              -- âœ… å·²å®šä¹‰ï¼Œä½† Webhook æœªå†™å…¥
  
  -- æ—¶é—´æˆ³
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  canceled_at TIMESTAMPTZ,
  
  -- å…ƒæ•°æ®
  metadata JSONB DEFAULT '{}'::jsonb,
  
  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- çº¦æŸ
  UNIQUE(user_id)
);
```

### âš ï¸ æ£€æŸ¥æ•°æ®åº“å­—æ®µæ˜¯å¦å­˜åœ¨

```sql
-- åœ¨ Supabase SQL Editor ä¸­è¿è¡Œ
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user_subscriptions'
ORDER BY ordinal_position;
```

**æœŸæœ›è¾“å‡ºåº”åŒ…å«**:
- âœ… `creem_subscription_id`
- âœ… `creem_product_id`
- âœ… `creem_customer_email`

---

## ðŸ”§ å®Œæ•´çš„ Webhook å­˜å‚¨é€»è¾‘

### Webhook æŽ¥æ”¶çš„æ•°æ®ç»“æž„ï¼ˆCreemï¼‰

```json
{
  "type": "checkout.session.completed",
  "data": {
    "id": "cs_abc123",
    "customer_email": "user@example.com",
    "product_id": "prod_xyz456",           // âš ï¸ é‡è¦
    "subscription_id": "sub_def789",       // âš ï¸ é‡è¦
    "amount_paid": 4.99,
    "currency": "USD",
    "metadata": {
      "user_id": "123e4567-...",           // âš ï¸ æœ€é‡è¦
      "tier": "basic",
      "billing_cycle": "monthly"
    }
  }
}
```

### æ­£ç¡®çš„ upsert è¯­å¥

```typescript
// app/api/webhooks/creem/route.ts

async function handleCheckoutCompleted(data: any) {
  const { 
    customer_email, 
    product_id,          // âš ï¸ å¿…é¡»å­˜å‚¨
    subscription_id,     // âš ï¸ å¿…é¡»å­˜å‚¨
    metadata 
  } = data

  const userId = metadata?.user_id
  if (!userId) {
    console.error("[Webhook] No user_id in metadata")
    return
  }

  const tierInfo = parseTierFromProductId(product_id)
  if (!tierInfo) {
    console.error("[Webhook] Unknown product ID:", product_id)
    return
  }

  const supabase = await createClient()

  // âœ… å®Œæ•´çš„å­—æ®µå­˜å‚¨
  const { data: result, error } = await supabase
    .from("user_subscriptions")
    .upsert(
      {
        // ðŸ”‘ ç”¨æˆ·å…³è”
        user_id: userId,
        
        // ðŸ’³ è®¢é˜…ä¿¡æ¯
        tier: tierInfo.tier,
        billing_cycle: tierInfo.billingCycle,
        status: "active",
        
        // ðŸ·ï¸ Creem å…³è”ä¿¡æ¯
        creem_subscription_id: subscription_id,    // âœ… ç”¨äºŽåŽç»­å–æ¶ˆè®¢é˜…
        creem_customer_email: customer_email,
        creem_product_id: product_id,              // âœ… é‡è¦ï¼ç”¨äºŽè¿½è¸ª
        
        // â° æ—¶é—´ç®¡ç†
        current_period_start: new Date().toISOString(),
        current_period_end: new Date(
          Date.now() + 
          (tierInfo.billingCycle === "yearly" ? 365 : 30) * 24 * 60 * 60 * 1000
        ).toISOString(),
        
        // ðŸ“ å®¡è®¡å­—æ®µ
        updated_at: new Date().toISOString(),
      },
      { onConflict: "user_id" }
    )
    .select()  // âœ… è¿”å›žç»“æžœç”¨äºŽéªŒè¯

  if (error) {
    console.error("[Webhook] âŒ Database error:", error)
    return
  }

  console.log("[Webhook] âœ… Subscription activated:", result)
}
```

---

## ðŸ“‹ å­—æ®µé‡è¦æ€§è¯„çº§

| å­—æ®µ | é‡è¦æ€§ | è¯´æ˜Ž | åŽæžœï¼ˆå¦‚æžœç¼ºå¤±ï¼‰ |
|------|--------|------|------------------|
| `user_id` | ðŸ”´ å¿…é¡» | å…³è”ç”¨æˆ· | æ— æ³•çŸ¥é“æ˜¯è°çš„è®¢é˜… |
| `tier` | ðŸ”´ å¿…é¡» | è®¢é˜…å±‚çº§ | æ— æ³•åˆ¤æ–­ç”¨æˆ·æƒé™ |
| `status` | ðŸ”´ å¿…é¡» | è®¢é˜…çŠ¶æ€ | æ— æ³•åŒºåˆ†å·²å–æ¶ˆè®¢é˜… |
| `creem_subscription_id` | ðŸ”´ å¿…é¡» | Creem è®¢é˜… ID | æ— æ³•å–æ¶ˆè®¢é˜… |
| `creem_product_id` | ðŸŸ  é‡è¦ | äº§å“ ID | æ— æ³•è¿½è¸ªå…·ä½“äº§å“è´­ä¹° |
| `current_period_end` | ðŸŸ  é‡è¦ | å‘¨æœŸç»“æŸæ—¶é—´ | æ— æ³•åˆ¤æ–­æ˜¯å¦è¿‡æœŸ |
| `billing_cycle` | ðŸŸ¡ æŽ¨è | è®¡è´¹å‘¨æœŸ | æ— æ³•æ˜¾ç¤ºæœˆä»˜/å¹´ä»˜ |
| `creem_customer_email` | ðŸŸ¡ æŽ¨è | å®¢æˆ·é‚®ç®± | æ— æ³•è¿›è¡Œè´¢åŠ¡å¯¹è´¦ |
| `metadata` | ðŸŸ¢ å¯é€‰ | é¢å¤–ä¿¡æ¯ | å½±å“è¾ƒå° |

---

## ðŸŽ¯ å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: ä¿®å¤ Checkout APIï¼ˆ5 åˆ†é’Ÿï¼‰

```typescript
// app/api/checkout/create-session/route.ts

// âœ… æ·»åŠ ç™»å½•æ£€æŸ¥
if (!user) {
  return Response.json(
    { error: "Please sign in to subscribe" },
    { status: 401 }
  )
}
```

### æ­¥éª¤ 2: ä¿®å¤ Webhook å¤„ç†ï¼ˆ5 åˆ†é’Ÿï¼‰

```typescript
// app/api/webhooks/creem/route.ts

// âœ… æ·»åŠ  creem_product_id å­—æ®µ
const { error } = await supabase.from("user_subscriptions").upsert({
  user_id: userId,
  tier: tierInfo.tier,
  billing_cycle: tierInfo.billingCycle,
  status: "active",
  creem_subscription_id: subscription_id,
  creem_customer_email: customer_email,
  creem_product_id: product_id,  // âš ï¸ æ·»åŠ è¿™ä¸€è¡Œ
  // ...
})
.select()  // âœ… è¿”å›žç»“æžœç”¨äºŽè°ƒè¯•
```

### æ­¥éª¤ 3: ä¿®å¤ Success é¡µé¢ï¼ˆ10 åˆ†é’Ÿï¼‰

```typescript
// app/pricing/success/page.tsx

useEffect(() => {
  let attempts = 0
  const maxAttempts = 10
  
  const checkSubscription = async () => {
    const response = await fetch("/api/subscription/manage")
    const data = await response.json()
    
    if (data.tier !== "free") {
      setLoading(false)
      return  // âœ… è®¢é˜…å·²æ¿€æ´»
    }
    
    attempts++
    if (attempts < maxAttempts) {
      setTimeout(checkSubscription, 1000)  // 1ç§’åŽé‡è¯•
    } else {
      setLoading(false)
      setVerificationFailed(true)
    }
  }
  
  setTimeout(checkSubscription, 2000)  // å»¶è¿Ÿ2ç§’å¼€å§‹
}, [])
```

### æ­¥éª¤ 4: éªŒè¯æ•°æ®åº“ï¼ˆ3 åˆ†é’Ÿï¼‰

```sql
-- æ£€æŸ¥è¡¨ç»“æž„
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user_subscriptions';

-- æ£€æŸ¥æœ€è¿‘çš„è®¢é˜…è®°å½•
SELECT * FROM user_subscriptions 
ORDER BY created_at DESC 
LIMIT 5;
```

### æ­¥éª¤ 5: æµ‹è¯•å®Œæ•´æµç¨‹ï¼ˆ10 åˆ†é’Ÿï¼‰

1. âœ… ç™»å½•ç”¨æˆ·è´¦æˆ·
2. âœ… è®¿é—® `/pricing` é¡µé¢
3. âœ… ç‚¹å‡»"Subscribe"æŒ‰é’®
4. âœ… å®Œæˆ Creem æ”¯ä»˜
5. âœ… æŸ¥çœ‹ Creem Webhook æ—¥å¿—
6. âœ… æŸ¥çœ‹æ•°æ®åº“è®°å½•
7. âœ… è®¿é—® `/dashboard` éªŒè¯è®¢é˜…çŠ¶æ€

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´é—®é¢˜åˆ†æž](./æ”¯ä»˜å®ŒæˆåŽè®¢é˜…çŠ¶æ€æœªæ›´æ–°é—®é¢˜åˆ†æž.md) - è¯¦ç»†çš„åŽŸå› åˆ†æžå’Œè§£å†³æ–¹æ¡ˆ
- [Creemæ•°æ®åº“Schema.sql](./Creemæ•°æ®åº“Schema.sql) - æ•°æ®åº“è¡¨ç»“æž„å®šä¹‰
- [Creemæ”¯ä»˜é›†æˆæŒ‡å—.md](./Creemæ”¯ä»˜é›†æˆæŒ‡å—.md) - å®Œæ•´çš„é›†æˆæ•™ç¨‹

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨å®Œæˆæ”¯ä»˜æµ‹è¯•å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] ç”¨æˆ·åœ¨æ”¯ä»˜å‰å·²ç™»å½•
- [ ] Creem Webhook URL å·²æ­£ç¡®é…ç½®
- [ ] çŽ¯å¢ƒå˜é‡ `SUPABASE_SERVICE_ROLE_KEY` å·²è®¾ç½®
- [ ] æ•°æ®åº“è¡¨åŒ…å« `creem_product_id` å­—æ®µ
- [ ] Webhook å¤„ç†é€»è¾‘åŒ…å«æ‰€æœ‰å¿…é¡»å­—æ®µ
- [ ] Success é¡µé¢åŒ…å«è®¢é˜…éªŒè¯é€»è¾‘

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-28  
**æœ€åŽæ›´æ–°**: 2025-10-28

