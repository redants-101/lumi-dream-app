# 📋 支付系统数据库存储字段清单

## 🎯 快速回答：应该存储哪些信息到数据库？

### 核心必须字段（缺一不可）

```typescript
{
  // 🔑 用户关联
  user_id: "123e4567-e89b-12d3-a456-426614174000",  // UUID，来自 Supabase Auth
  
  // 💳 订阅信息
  tier: "basic",                      // "free" | "basic" | "pro"
  billing_cycle: "monthly",           // "monthly" | "yearly"
  status: "active",                   // "active" | "canceled" | "expired"
  
  // 🏷️ Creem 关联信息（用于后续操作）
  creem_subscription_id: "sub_abc123",    // Creem 订阅 ID（用于取消/更新）
  creem_product_id: "prod_xyz456",        // ⚠️ 重要！用于追踪具体产品
  creem_customer_email: "user@example.com",
  
  // ⏰ 时间管理
  current_period_start: "2025-10-28T00:00:00Z",
  current_period_end: "2025-11-28T00:00:00Z",   // 用于判断是否过期
  
  // 📝 审计字段
  created_at: "2025-10-28T10:30:00Z",
  updated_at: "2025-10-28T10:30:00Z"
}
```

---

## 🔍 问题分析：为什么支付后还是 Free 用户？

### 原因 1: Webhook 未触发或失败 ❌

```
用户支付成功
    ↓
Creem 应该发送 Webhook → /api/webhooks/creem
    ↓
❌ 但 Webhook 可能：
    - 未配置
    - URL 错误
    - 签名验证失败
    - 返回 500 错误
```

**排查**: 查看 Creem 后台 → Webhooks → Events

---

### 原因 2: metadata.user_id 为空 ❌

```typescript
// ❌ 问题代码
const session = await creemClient.createCheckoutSession({
  metadata: {
    user_id: user?.id || "",  // 如果用户未登录，这里是空字符串！
  },
})

// ✅ 修复后
if (!user) {
  return Response.json({ error: "Please sign in" }, { status: 401 })
}
const session = await creemClient.createCheckoutSession({
  metadata: {
    user_id: user.id,  // 现在保证有值
  },
})
```

---

### 原因 3: 数据库写入失败（RLS 策略）❌

```typescript
// ⚠️ 必须使用 service_role key
import { createClient } from '@supabase/supabase-js'

export const createClient = () => {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,  // ✅ 不是 ANON_KEY
  )
}
```

---

### 原因 4: 缺少 creem_product_id 字段 ❌

```typescript
// ❌ 当前 Webhook 代码缺少这个字段
await supabase.from("user_subscriptions").upsert({
  user_id: userId,
  tier: tierInfo.tier,
  // ❌ 缺少: creem_product_id
})

// ✅ 应该添加
await supabase.from("user_subscriptions").upsert({
  user_id: userId,
  tier: tierInfo.tier,
  creem_product_id: product_id,  // ✅ 从 webhook data 中获取
})
```

---

### 原因 5: 时序问题（Webhook 延迟）⏱️

```
T0:    用户完成支付
T+100ms: 重定向到 /pricing/success
T+500ms: 用户点击"查看订阅"
T+800ms: Dashboard 查询数据库 → 订阅未激活 ❌
T+1200ms: Webhook 处理完成 → 数据库更新 ✅
```

**解决方案**: 在 Success 页面轮询验证订阅状态

---

## 📊 数据库表结构

### 当前 Schema（来自 Creem数据库Schema.sql）

```sql
CREATE TABLE user_subscriptions (
  -- 主键
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- 用户关联
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- 订阅信息
  tier TEXT NOT NULL DEFAULT 'free' CHECK (tier IN ('free', 'basic', 'pro')),
  billing_cycle TEXT CHECK (billing_cycle IN ('monthly', 'yearly')),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'canceled', 'expired', 'past_due')),
  
  -- Creem 相关
  creem_subscription_id TEXT UNIQUE,
  creem_customer_email TEXT,
  creem_product_id TEXT,              -- ✅ 已定义，但 Webhook 未写入
  
  -- 时间戳
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  canceled_at TIMESTAMPTZ,
  
  -- 元数据
  metadata JSONB DEFAULT '{}'::jsonb,
  
  -- 审计字段
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 约束
  UNIQUE(user_id)
);
```

### ⚠️ 检查数据库字段是否存在

```sql
-- 在 Supabase SQL Editor 中运行
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user_subscriptions'
ORDER BY ordinal_position;
```

**期望输出应包含**:
- ✅ `creem_subscription_id`
- ✅ `creem_product_id`
- ✅ `creem_customer_email`

---

## 🔧 完整的 Webhook 存储逻辑

### Webhook 接收的数据结构（Creem）

```json
{
  "type": "checkout.session.completed",
  "data": {
    "id": "cs_abc123",
    "customer_email": "user@example.com",
    "product_id": "prod_xyz456",           // ⚠️ 重要
    "subscription_id": "sub_def789",       // ⚠️ 重要
    "amount_paid": 4.99,
    "currency": "USD",
    "metadata": {
      "user_id": "123e4567-...",           // ⚠️ 最重要
      "tier": "basic",
      "billing_cycle": "monthly"
    }
  }
}
```

### 正确的 upsert 语句

```typescript
// app/api/webhooks/creem/route.ts

async function handleCheckoutCompleted(data: any) {
  const { 
    customer_email, 
    product_id,          // ⚠️ 必须存储
    subscription_id,     // ⚠️ 必须存储
    metadata 
  } = data

  const userId = metadata?.user_id
  if (!userId) {
    console.error("[Webhook] No user_id in metadata")
    return
  }

  const tierInfo = parseTierFromProductId(product_id)
  if (!tierInfo) {
    console.error("[Webhook] Unknown product ID:", product_id)
    return
  }

  const supabase = await createClient()

  // ✅ 完整的字段存储
  const { data: result, error } = await supabase
    .from("user_subscriptions")
    .upsert(
      {
        // 🔑 用户关联
        user_id: userId,
        
        // 💳 订阅信息
        tier: tierInfo.tier,
        billing_cycle: tierInfo.billingCycle,
        status: "active",
        
        // 🏷️ Creem 关联信息
        creem_subscription_id: subscription_id,    // ✅ 用于后续取消订阅
        creem_customer_email: customer_email,
        creem_product_id: product_id,              // ✅ 重要！用于追踪
        
        // ⏰ 时间管理
        current_period_start: new Date().toISOString(),
        current_period_end: new Date(
          Date.now() + 
          (tierInfo.billingCycle === "yearly" ? 365 : 30) * 24 * 60 * 60 * 1000
        ).toISOString(),
        
        // 📝 审计字段
        updated_at: new Date().toISOString(),
      },
      { onConflict: "user_id" }
    )
    .select()  // ✅ 返回结果用于验证

  if (error) {
    console.error("[Webhook] ❌ Database error:", error)
    return
  }

  console.log("[Webhook] ✅ Subscription activated:", result)
}
```

---

## 📋 字段重要性评级

| 字段 | 重要性 | 说明 | 后果（如果缺失） |
|------|--------|------|------------------|
| `user_id` | 🔴 必须 | 关联用户 | 无法知道是谁的订阅 |
| `tier` | 🔴 必须 | 订阅层级 | 无法判断用户权限 |
| `status` | 🔴 必须 | 订阅状态 | 无法区分已取消订阅 |
| `creem_subscription_id` | 🔴 必须 | Creem 订阅 ID | 无法取消订阅 |
| `creem_product_id` | 🟠 重要 | 产品 ID | 无法追踪具体产品购买 |
| `current_period_end` | 🟠 重要 | 周期结束时间 | 无法判断是否过期 |
| `billing_cycle` | 🟡 推荐 | 计费周期 | 无法显示月付/年付 |
| `creem_customer_email` | 🟡 推荐 | 客户邮箱 | 无法进行财务对账 |
| `metadata` | 🟢 可选 | 额外信息 | 影响较小 |

---

## 🎯 快速修复步骤

### 步骤 1: 修复 Checkout API（5 分钟）

```typescript
// app/api/checkout/create-session/route.ts

// ✅ 添加登录检查
if (!user) {
  return Response.json(
    { error: "Please sign in to subscribe" },
    { status: 401 }
  )
}
```

### 步骤 2: 修复 Webhook 处理（5 分钟）

```typescript
// app/api/webhooks/creem/route.ts

// ✅ 添加 creem_product_id 字段
const { error } = await supabase.from("user_subscriptions").upsert({
  user_id: userId,
  tier: tierInfo.tier,
  billing_cycle: tierInfo.billingCycle,
  status: "active",
  creem_subscription_id: subscription_id,
  creem_customer_email: customer_email,
  creem_product_id: product_id,  // ⚠️ 添加这一行
  // ...
})
.select()  // ✅ 返回结果用于调试
```

### 步骤 3: 修复 Success 页面（10 分钟）

```typescript
// app/pricing/success/page.tsx

useEffect(() => {
  let attempts = 0
  const maxAttempts = 10
  
  const checkSubscription = async () => {
    const response = await fetch("/api/subscription/manage")
    const data = await response.json()
    
    if (data.tier !== "free") {
      setLoading(false)
      return  // ✅ 订阅已激活
    }
    
    attempts++
    if (attempts < maxAttempts) {
      setTimeout(checkSubscription, 1000)  // 1秒后重试
    } else {
      setLoading(false)
      setVerificationFailed(true)
    }
  }
  
  setTimeout(checkSubscription, 2000)  // 延迟2秒开始
}, [])
```

### 步骤 4: 验证数据库（3 分钟）

```sql
-- 检查表结构
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user_subscriptions';

-- 检查最近的订阅记录
SELECT * FROM user_subscriptions 
ORDER BY created_at DESC 
LIMIT 5;
```

### 步骤 5: 测试完整流程（10 分钟）

1. ✅ 登录用户账户
2. ✅ 访问 `/pricing` 页面
3. ✅ 点击"Subscribe"按钮
4. ✅ 完成 Creem 支付
5. ✅ 查看 Creem Webhook 日志
6. ✅ 查看数据库记录
7. ✅ 访问 `/dashboard` 验证订阅状态

---

## 📚 相关文档

- [完整问题分析](./支付完成后订阅状态未更新问题分析.md) - 详细的原因分析和解决方案
- [Creem数据库Schema.sql](./Creem数据库Schema.sql) - 数据库表结构定义
- [Creem支付集成指南.md](./Creem支付集成指南.md) - 完整的集成教程

---

## ✅ 检查清单

在完成支付测试前，请确认：

- [ ] 用户在支付前已登录
- [ ] Creem Webhook URL 已正确配置
- [ ] 环境变量 `SUPABASE_SERVICE_ROLE_KEY` 已设置
- [ ] 数据库表包含 `creem_product_id` 字段
- [ ] Webhook 处理逻辑包含所有必须字段
- [ ] Success 页面包含订阅验证逻辑

---

**文档版本**: v1.0  
**创建日期**: 2025-10-28  
**最后更新**: 2025-10-28

