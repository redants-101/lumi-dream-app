# ğŸ” ç™»å‡ºæ˜¾ç¤ºé”™è¯¯é—®é¢˜åˆ†æ

## ğŸš¨ é—®é¢˜é‡ç°

**ç”¨æˆ·æ“ä½œ**ï¼š
1. Basic ç”¨æˆ·åœ¨ Dashboard ç™»å‡º
2. è‡ªåŠ¨è·³è½¬åˆ° Pricing æˆ– Home
3. è§‚å¯Ÿæ˜¾ç¤ºï¼š10 today, 50 this month âŒ é”™è¯¯ï¼ˆbasic é™åˆ¶ï¼‰
4. åº”è¯¥æ˜¾ç¤ºï¼š2 today, 4 this month âœ… æ­£ç¡®ï¼ˆanonymous é™åˆ¶ï¼‰

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### getUserTier() çš„é€»è¾‘æµç¨‹

```typescript
const getUserTier = useCallback((): UserTier => {
  // 1ï¸âƒ£ æ£€æŸ¥æ˜¯å¦ç™»å½•
  if (!isAuthenticated) {
    return "anonymous"  // âœ… æœªç™»å½•åº”è¯¥èµ°è¿™é‡Œ
  }
  
  // 2ï¸âƒ£ æ£€æŸ¥ subscription
  if (subscription && subscription.tier) {
    localStorage.setItem(TIER_STORAGE_KEY, tier)  // ç¼“å­˜
    return tier
  }
  
  // 3ï¸âƒ£ åŠ è½½ä¸­ï¼šè¯»å–ç¼“å­˜
  if (subscriptionLoading && typeof window !== "undefined") {
    const cachedTier = localStorage.getItem(TIER_STORAGE_KEY)
    if (cachedTier && ['free', 'basic', 'pro'].includes(cachedTier)) {
      return cachedTier  // âš ï¸ è¿”å›ç¼“å­˜å€¼
    }
  }
  
  // 4ï¸âƒ£ é»˜è®¤
  return "free"
}, [isAuthenticated, subscription, subscriptionLoading])
```

### é—®é¢˜åœºæ™¯æ¨æ¼”

#### åœºæ™¯ Aï¼šæ­£å¸¸æƒ…å†µï¼ˆåº”è¯¥å·¥ä½œï¼‰

```
ç™»å‡ºæ“ä½œï¼š
  â†“
isAuthenticated: true â†’ false âœ…
  â†“
getUserTier() è°ƒç”¨ï¼š
  â”œâ”€ if (!isAuthenticated) â†’ true âœ…
  â””â”€ return "anonymous" âœ…
  â†“
æ˜¾ç¤ºï¼š"2 today, 4 this month" âœ… æ­£ç¡®
```

**è¿™ä¸ªé€»è¾‘åº”è¯¥æ˜¯å¯¹çš„ï¼**

---

#### åœºæ™¯ Bï¼šuseMemo ç¼“å­˜é—®é¢˜ï¼ˆå¯èƒ½åŸå› ï¼‰

```
ç™»å‡ºå‰ï¼š
  userTier = useMemo(() => getUserTier(), [getUserTier])
  â†“
  getUserTier ä¾èµ–ï¼š[isAuthenticated, subscription, subscriptionLoading]
  â†“
  userTier ç¼“å­˜å€¼ï¼š"basic"

ç™»å‡ºæ—¶ï¼š
  isAuthenticated: true â†’ false
  subscription: {...} â†’ null
  â†“
  getUserTier é‡æ–°åˆ›å»ºï¼ˆä¾èµ–é¡¹å˜åŒ–ï¼‰âœ…
  â†“
  ä½† userTier çš„ useMemo éœ€è¦ç­‰åˆ°ä¸‹æ¬¡æ¸²æŸ“æ‰é‡æ–°è®¡ç®— âš ï¸
  â†“
  åœ¨é‡æ–°è®¡ç®—å‰ï¼ŒuserTier è¿˜æ˜¯ "basic" âŒ
  â†“
  é¡µé¢æ˜¾ç¤ºï¼š10/50ï¼ˆbasic çš„é™åˆ¶ï¼‰âŒ
```

**è¿™æ˜¯æ—¶åºé—®é¢˜ï¼**

---

#### åœºæ™¯ Cï¼šReact æ‰¹é‡æ›´æ–°ï¼ˆæœ€å¯èƒ½ï¼‰

```
ç™»å‡ºçš„ useEffect æ‰§è¡Œï¼š
  â”œâ”€ setSubscription(null)
  â”œâ”€ setUsageData(null)  
  â”œâ”€ setIsLimitReached(false)
  â”œâ”€ setSubscriptionLoading(false)
  â”œâ”€ setInitialized(false)
  â””â”€ localStorage.removeItem(...)

React æ‰¹é‡æ›´æ–°ï¼ˆBatchingï¼‰ï¼š
  â†“
  åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“å‰ï¼Œæ‰€æœ‰ setState éƒ½ä¸ç”Ÿæ•ˆ
  â†“
  getUserTier() åœ¨è¿™æœŸé—´è¢«è°ƒç”¨ï¼ˆuseMemo è®¡ç®—ï¼‰
  â†“
  æ­¤æ—¶ subscription å¯èƒ½è¿˜æ˜¯æ—§å€¼ âŒ
  â†“
  è¿”å› "basic" âŒ
```

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç«‹å³æ¸…é™¤ localStorageï¼ˆåœ¨ setState ä¹‹å‰ï¼‰

```typescript
useEffect(() => {
  if (!isAuthenticated && initialized) {
    console.log("[Usage Limit Context] ğŸ”„ User logged out, resetting state...")
    
    // âœ… 1. å…ˆæ¸…é™¤ localStorageï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
    if (typeof window !== "undefined") {
      try {
        localStorage.removeItem(TIER_STORAGE_KEY)
        localStorage.removeItem(STORAGE_KEY)
        console.log("[Usage Limit Context] ğŸ—‘ï¸ Cleared all cached data")
      } catch (error) {
        console.error("[Usage Limit Context] Failed to clear cache:", error)
      }
    }
    
    // âœ… 2. å†é‡ç½®çŠ¶æ€
    setSubscription(null)
    setUsageData(null)
    setIsLimitReached(false)
    setSubscriptionLoading(false)
    setInitialized(false)
  }
}, [isAuthenticated, user, initialized, fetchUserInfo])
```

**æ•ˆæœ**ï¼š
- localStorage ç«‹å³æ¸…é™¤
- getUserTier() è¯»ä¸åˆ°ç¼“å­˜
- å³ä½¿ subscription è¿˜æ˜¯æ—§å€¼ï¼Œä¹Ÿä¸ä¼šç”¨

---

### æ–¹æ¡ˆ 2ï¼šgetUserTier ä¸è¯»ç¼“å­˜ï¼ˆå½“æœªç™»å½•æ—¶ï¼‰

å½“å‰é€»è¾‘å·²ç»æ­£ç¡®ï¼š
```typescript
if (!isAuthenticated) {
  return "anonymous"  // âœ… æœªç™»å½•ç›´æ¥è¿”å›ï¼Œä¸æ£€æŸ¥ç¼“å­˜
}
```

**è¿™éƒ¨åˆ†æ˜¯å¯¹çš„ï¼**

---

### æ–¹æ¡ˆ 3ï¼šæ£€æŸ¥ useMemo çš„ä¾èµ–

```typescript
// å½“å‰ä»£ç 
const userTier = useMemo(() => getUserTier(), [getUserTier])
```

**é—®é¢˜**ï¼š
- `getUserTier` æ˜¯ useCallbackï¼Œä¾èµ– [isAuthenticated, subscription, subscriptionLoading]
- å½“è¿™äº›å˜åŒ–æ—¶ï¼ŒgetUserTier ä¼šé‡æ–°åˆ›å»º
- ä½† useMemo çš„é‡æ–°è®¡ç®—ä¾èµ–äº getUserTier çš„å¼•ç”¨å˜åŒ–
- å¯èƒ½æœ‰å¾®å°çš„å»¶è¿Ÿ

**æ›´å¥½çš„æ–¹å¼**ï¼š
```typescript
// âœ… ç›´æ¥ä¾èµ–åŸå§‹å€¼
const userTier = useMemo(() => {
  if (!isAuthenticated) return "anonymous"
  if (subscription && subscription.tier) return subscription.tier
  // ...
}, [isAuthenticated, subscription, subscriptionLoading])
```

---

## ğŸ¯ æ¨èä¿®å¤

ç«‹å³å®æ–½æ–¹æ¡ˆ 1 + 3 çš„ç»„åˆã€‚

