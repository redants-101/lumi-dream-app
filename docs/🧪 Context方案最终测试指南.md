# ğŸ§ª Context æ–¹æ¡ˆæœ€ç»ˆæµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯ React Context æ–¹æ¡ˆæ˜¯å¦çœŸæ­£å®ç°äº†ï¼š
- âœ… å…¨å±€çŠ¶æ€å…±äº«
- âœ… Dashboard 0 æ¬¡ API è°ƒç”¨
- âœ… è·¨ç»„ä»¶æ•°æ®åŒæ­¥
- âœ… æ€§èƒ½ä¼˜åŒ–è¾¾åˆ°æœ€ä¼˜

---

## ğŸš€ æ ¸å¿ƒæµ‹è¯•åœºæ™¯

### æµ‹è¯• 1ï¼šéªŒè¯å…¨å±€å•ä¾‹ï¼ˆæœ€å…³é”®ï¼‰â­

```bash
æ­¥éª¤ï¼š
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl + Shift + Deleteï¼‰
2. æ‰“å¼€æ— ç—•çª—å£ï¼ˆCtrl + Shift + Nï¼‰
3. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
4. åˆ‡æ¢åˆ° Console å’Œ Network æ ‡ç­¾
5. è®¿é—®ï¼šhttp://localhost:3000
6. ç™»å½•è´¦å·
7. è§‚å¯Ÿæ—¥å¿—å’Œ Network

é¢„æœŸæ—¥å¿—ï¼š
[Usage Limit Context] ğŸ”„ Initializing (GLOBAL)...  â† å…³é”®ï¼šæ ‡æ³¨ GLOBAL
[Usage Limit Context] âœ… User info loaded: free
[Usage Limit Context] âœ… Usage synced from user-info: { ... }

é¢„æœŸ Networkï¼š
GET /api/user-info  200  ~1000ms  â† åªæœ‰ 1 æ¬¡

éªŒè¯ç‚¹ï¼š
âœ… æ—¥å¿—åŒ…å« "(GLOBAL)"ï¼ˆè¡¨ç¤ºå…¨å±€åˆå§‹åŒ–ï¼‰
âœ… API åªè°ƒç”¨ 1 æ¬¡
âœ… Home é¡µé¢æ•°æ®æ­£ç¡®æ˜¾ç¤º
```

---

### æµ‹è¯• 2ï¼šDashboard 0 æ¬¡ API è°ƒç”¨ï¼ˆæ ¸å¿ƒéªŒè¯ï¼‰â­â­â­

```bash
æ­¥éª¤ï¼š
1. å·²ç™»å½•çŠ¶æ€ï¼ˆæµ‹è¯• 1 å®Œæˆåï¼‰
2. Network é¢æ¿æ¸…ç©ºï¼ˆç‚¹å‡» ğŸš«ï¼‰
3. ç‚¹å‡» "Dashboard" å¯¼èˆª
4. ä»”ç»†è§‚å¯Ÿ Network é¢æ¿

é¢„æœŸç»“æœï¼š
âœ… Network é¢æ¿å®Œå…¨ç©ºç™½
âœ… æ— ä»»ä½• /api/user-info è°ƒç”¨
âœ… æ— ä»»ä½• /api/subscription/manage è°ƒç”¨
âœ… Dashboard å³æ—¶æ˜¾ç¤ºï¼ˆ< 50msï¼‰
âœ… æ•°æ®å®Œå…¨æ­£ç¡®

éªŒè¯ç‚¹ï¼ˆæœ€é‡è¦ï¼‰ï¼š
âœ… Network é¢æ¿ï¼š0 æ¡è®°å½•
âœ… Console æ— æ–°çš„åˆå§‹åŒ–æ—¥å¿—
âœ… Dashboard æ˜¾ç¤ºçš„æ•°æ®ä¸ Home ä¸€è‡´
```

---

### æµ‹è¯• 3ï¼šè·¨ç»„ä»¶æ•°æ®åŒæ­¥ï¼ˆå®æ—¶æ€§ï¼‰â­

```bash
æ­¥éª¤ï¼š
1. Home é¡µé¢ï¼ˆå·²ç™»å½•ï¼‰
2. è§‚å¯Ÿæ˜¾ç¤ºï¼š"5 today, 10 this month"ï¼ˆfree ç”¨æˆ·ä¸ºä¾‹ï¼‰
3. è¾“å…¥æ¢¦å¢ƒï¼Œç‚¹å‡»è§£æ
4. æˆåŠŸåè§‚å¯Ÿæ˜¾ç¤ºï¼š"4 today, 9 this month"
5. ç«‹å³å¯¼èˆªåˆ° Dashboard
6. è§‚å¯Ÿ Dashboard çš„ä½¿ç”¨ç»Ÿè®¡

é¢„æœŸç»“æœï¼š
âœ… Dashboard ç«‹å³æ˜¾ç¤ºï¼š"9 / 10"
âœ… ä¸ Home æ˜¾ç¤ºçš„ "9 this month" å®Œå…¨ä¸€è‡´
âœ… æ—  API è°ƒç”¨
âœ… æ•°æ®å®æ—¶åŒæ­¥

éªŒè¯ç‚¹ï¼š
âœ… Home å’Œ Dashboard æ•°æ®ä¸€è‡´
âœ… æ•°æ®æ›´æ–°å³æ—¶åæ˜ 
âœ… æ— å»¶è¿Ÿï¼Œæ— é—ªçƒ
```

---

### æµ‹è¯• 4ï¼šå¿«é€Ÿè·¨é¡µé¢å¯¼èˆªï¼ˆå‹åŠ›æµ‹è¯•ï¼‰â­

```bash
æ­¥éª¤ï¼š
1. å·²ç™»å½•çŠ¶æ€
2. Network é¢æ¿ä¿æŒæ‰“å¼€
3. å¿«é€Ÿå¯¼èˆªï¼šHome â†’ Dashboard â†’ Home â†’ Dashboard â†’ Home
4. è§‚å¯Ÿ Network é¢æ¿æ€»è°ƒç”¨æ¬¡æ•°

é¢„æœŸç»“æœï¼š
âœ… åªæœ‰ç™»å½•æ—¶çš„ 1 æ¬¡ /api/user-info
âœ… æ‰€æœ‰åç»­å¯¼èˆªï¼š0 æ¬¡ API è°ƒç”¨
âœ… é¡µé¢åˆ‡æ¢æµç•…
âœ… æ•°æ®å§‹ç»ˆä¸€è‡´

éªŒè¯ç‚¹ï¼š
âœ… æ€» API è°ƒç”¨ï¼š1 æ¬¡
âœ… æ— é‡å¤è°ƒç”¨
âœ… æ— æ–°çš„åˆå§‹åŒ–
```

---

### æµ‹è¯• 5ï¼šé¡µé¢åˆ·æ–°ï¼ˆé‡æ–°åˆå§‹åŒ–ï¼‰âœ…

```bash
æ­¥éª¤ï¼š
1. Dashboard é¡µé¢ï¼ˆå·²ç™»å½•ï¼‰
2. æŒ‰ F5 åˆ·æ–°
3. è§‚å¯Ÿ Network å’Œ Console

é¢„æœŸç»“æœï¼š
âœ… è°ƒç”¨ 1 æ¬¡ /api/user-infoï¼ˆæ­£å¸¸ï¼ŒProvider é‡æ–°åˆå§‹åŒ–ï¼‰
âœ… æ˜¾ç¤º GLOBAL åˆå§‹åŒ–æ—¥å¿—
âœ… Dashboard æ•°æ®æ­£ç¡®åŠ è½½

éªŒè¯ç‚¹ï¼š
âœ… åˆ·æ–°è§¦å‘é‡æ–°åˆå§‹åŒ–ï¼ˆç¬¦åˆé¢„æœŸï¼‰
âœ… åªè°ƒç”¨ 1 æ¬¡ API
âœ… æ•°æ®æ­£ç¡®
```

---

### æµ‹è¯• 6ï¼šç™»å‡ºæ¸…é™¤ï¼ˆéšç§ä¿æŠ¤ï¼‰âœ…

```bash
æ­¥éª¤ï¼š
1. å·²ç™»å½•çŠ¶æ€
2. æ‰“å¼€ Console
3. ç‚¹å‡»ç™»å‡º
4. è§‚å¯Ÿæ—¥å¿—å’Œ localStorage

é¢„æœŸæ—¥å¿—ï¼š
[Usage Limit Context] ğŸ”„ User logged out, resetting state...
[Usage Limit Context] ğŸ—‘ï¸ Cleared all cached data

é¢„æœŸ localStorageï¼š
localStorage.getItem('lumi_user_tier')  â†’ null âœ…
localStorage.getItem('lumi_usage_data_v2')  â†’ null âœ…

éªŒè¯ç‚¹ï¼š
âœ… æ‰€æœ‰ç¼“å­˜æ¸…é™¤
âœ… çŠ¶æ€é‡ç½®
âœ… æ— æ•°æ®æ³„éœ²
```

---

### æµ‹è¯• 7ï¼šå–æ¶ˆè®¢é˜…ï¼ˆåŠŸèƒ½å®Œæ•´æ€§ï¼‰âœ…

```bash
æ­¥éª¤ï¼š
1. ä»˜è´¹ç”¨æˆ·åœ¨ Dashboard
2. ç‚¹å‡» "Cancel" æŒ‰é’®
3. ç¡®è®¤å–æ¶ˆ
4. è§‚å¯Ÿè¡Œä¸º

é¢„æœŸ Networkï¼š
DELETE /api/subscription/manage  â† å¿…è¦çš„åˆ é™¤è¯·æ±‚
GET /api/user-info  â† refreshUserInfo åˆ·æ–°æ•°æ®

é¢„æœŸè¡Œä¸ºï¼š
âœ… å–æ¶ˆæˆåŠŸ
âœ… æ•°æ®ç«‹å³æ›´æ–°
âœ… æ˜¾ç¤ºæ›´æ–°åçš„å±‚çº§
âœ… Home å’Œ Dashboard åŒæ­¥

éªŒè¯ç‚¹ï¼š
âœ… å–æ¶ˆ API è°ƒç”¨æˆåŠŸ
âœ… åˆ·æ–°åªè°ƒç”¨ 1 æ¬¡ /api/user-info
âœ… æ‰€æœ‰é¡µé¢æ•°æ®åŒæ­¥æ›´æ–°
```

---

## ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•

### åœºæ™¯ï¼šç™»å½• â†’ Home â†’ Dashboard â†’ Home

```bash
æµ‹è¯•æ­¥éª¤ï¼š
1. æ¸…é™¤ç¼“å­˜
2. æ‰“å¼€ Performance é¢æ¿
3. å¼€å§‹å½•åˆ¶
4. ç™»å½• â†’ å¯¼èˆªåˆ° Dashboard â†’ è¿”å› Home
5. åœæ­¢å½•åˆ¶
6. åˆ†æç»“æœ

é¢„æœŸæŒ‡æ ‡ï¼š
- æ€» API è°ƒç”¨ï¼š1 æ¬¡
- Home åŠ è½½æ—¶é—´ï¼š< 1500ms
- Dashboard åŠ è½½æ—¶é—´ï¼š< 100msï¼ˆæ—  APIï¼‰
- è¿”å› Homeï¼š< 100msï¼ˆæ—  APIï¼‰

éªŒè¯ç‚¹ï¼š
âœ… åªæœ‰ç™»å½•æ—¶çš„ 1 æ¬¡ API
âœ… Dashboard æ— ç½‘ç»œæ´»åŠ¨
âœ… æ‰€æœ‰æ“ä½œæµç•…
```

---

## ğŸ” è¾¹ç¼˜æƒ…å†µæµ‹è¯•

### åœºæ™¯ 8ï¼šProvider å¤–éƒ¨ä½¿ç”¨ Hook

```bash
æµ‹è¯•æ­¥éª¤ï¼š
1. åˆ›å»ºæµ‹è¯•ç»„ä»¶ï¼ˆåœ¨ Provider å¤–éƒ¨ï¼‰
2. è°ƒç”¨ useUsageLimitV2()

é¢„æœŸç»“æœï¼š
âŒ æŠ›å‡ºé”™è¯¯ï¼š"useUsageLimitV2 must be used within UsageLimitProvider"
âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°
âœ… å¼€å‘æ—¶åŠæ—©å‘ç°é—®é¢˜

éªŒè¯ç‚¹ï¼š
âœ… æ­£ç¡®æŠ›å‡ºé”™è¯¯
âœ… é”™è¯¯ä¿¡æ¯å‹å¥½
```

### åœºæ™¯ 9ï¼šå¿«é€Ÿç™»å½•ç™»å‡º

```bash
æµ‹è¯•æ­¥éª¤ï¼š
1. ç™»å½•
2. ç«‹å³ç™»å‡º
3. ç«‹å³å†æ¬¡ç™»å½•
4. è§‚å¯Ÿè¡Œä¸º

é¢„æœŸç»“æœï¼š
âœ… æ¯æ¬¡ç™»å½•éƒ½æ­£ç¡®åˆå§‹åŒ–
âœ… ç™»å‡ºæ—¶æ¸…é™¤æ‰€æœ‰æ•°æ®
âœ… æ— çŠ¶æ€æ®‹ç•™
âœ… æ— æ•°æ®æ··æ·†

éªŒè¯ç‚¹ï¼š
âœ… æ•°æ®æ¸…é™¤å®Œæ•´
âœ… é‡æ–°åˆå§‹åŒ–æ­£ç¡®
âœ… æ— æ—§æ•°æ®æ®‹ç•™
```

---

## âœ… æµ‹è¯•å®Œæˆæ¸…å•

### æ ¸å¿ƒåŠŸèƒ½
- [ ] å…¨å±€å•ä¾‹éªŒè¯ï¼ˆæµ‹è¯• 1ï¼‰
- [ ] Dashboard 0 æ¬¡è°ƒç”¨ï¼ˆæµ‹è¯• 2ï¼‰â­â­â­
- [ ] è·¨ç»„ä»¶æ•°æ®åŒæ­¥ï¼ˆæµ‹è¯• 3ï¼‰
- [ ] å¿«é€Ÿå¯¼èˆªæµ‹è¯•ï¼ˆæµ‹è¯• 4ï¼‰

### åŸºç¡€åŠŸèƒ½
- [ ] é¡µé¢åˆ·æ–°æ­£å¸¸ï¼ˆæµ‹è¯• 5ï¼‰
- [ ] ç™»å‡ºæ¸…é™¤æ•°æ®ï¼ˆæµ‹è¯• 6ï¼‰
- [ ] å–æ¶ˆè®¢é˜…æ­£å¸¸ï¼ˆæµ‹è¯• 7ï¼‰

### æ€§èƒ½éªŒè¯
- [ ] API è°ƒç”¨åªæœ‰ 1 æ¬¡
- [ ] Dashboard åŠ è½½ < 100ms
- [ ] æ•°æ®åŒæ­¥å³æ—¶

### è¾¹ç¼˜æƒ…å†µ
- [ ] Provider å¤–éƒ¨é”™è¯¯å¤„ç†ï¼ˆæµ‹è¯• 8ï¼‰
- [ ] å¿«é€Ÿç™»å½•ç™»å‡ºï¼ˆæµ‹è¯• 9ï¼‰

---

## ğŸ“ æµ‹è¯•è®°å½•è¡¨

### å…³é”®æµ‹è¯•ç»“æœ

| æµ‹è¯•é¡¹ | é¢„æœŸ | å®é™… | çŠ¶æ€ |
|--------|------|------|------|
| ç™»å½• API è°ƒç”¨ | 1 æ¬¡ | | [ ] |
| Dashboard API è°ƒç”¨ | **0 æ¬¡** | | [ ] |
| è·¨é¡µé¢å¯¼èˆª | **0 æ¬¡** | | [ ] |
| æ•°æ®åŒæ­¥ | å³æ—¶ | | [ ] |
| åŠ è½½æ—¶é—´ | < 100ms | | [ ] |

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### å¿…é¡»è¾¾åˆ°

- âœ… Dashboard è®¿é—®æ—¶ï¼š**0 æ¬¡ API è°ƒç”¨**
- âœ… è·¨é¡µé¢å¯¼èˆªï¼š**0 æ¬¡é¢å¤–è°ƒç”¨**
- âœ… æ•°æ®å®Œå…¨åŒæ­¥
- âœ… æ— é”™è¯¯æ—¥å¿—

### æ€§èƒ½æ ‡å‡†

- âœ… æ€» API è°ƒç”¨ï¼šâ‰¤ 1 æ¬¡
- âœ… Dashboard åŠ è½½ï¼š< 100ms
- âœ… æ•°æ®åŒæ­¥å»¶è¿Ÿï¼š< 50ms

---

## ğŸ› å¦‚æœå‘ç°é—®é¢˜

### é—®é¢˜æ’æŸ¥æ­¥éª¤

1. **æ£€æŸ¥ Provider æ˜¯å¦æ­£ç¡®åŒ…è£¹**
   ```typescript
   // app/layout.tsx
   <UsageLimitProvider>  â† æ£€æŸ¥æ˜¯å¦å­˜åœ¨
     {children}
   </UsageLimitProvider>
   ```

2. **æ£€æŸ¥å¯¼å…¥è·¯å¾„æ˜¯å¦æ›´æ–°**
   ```typescript
   // app/page.tsx, app/dashboard/page.tsx
   import { useUsageLimitV2 } from "@/contexts/usage-limit-context"  â† æ–°è·¯å¾„
   ```

3. **æ£€æŸ¥æ—§æ–‡ä»¶æ˜¯å¦å·²å¤‡ä»½**
   ```bash
   ls hooks/use-usage-limit-v2.ts.backup  â† åº”è¯¥å­˜åœ¨
   ls hooks/use-usage-limit-v2.ts  â† ä¸åº”è¯¥å­˜åœ¨
   ```

4. **é‡å¯å¼€å‘æœåŠ¡å™¨**
   ```bash
   Ctrl + C
   npm run dev  æˆ–  pnpm dev
   ```

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸ‰

è¿™æ¬¡åº”è¯¥èƒ½çœŸæ­£çœ‹åˆ° Dashboard **0 æ¬¡ API è°ƒç”¨**çš„æ•ˆæœäº†ï¼

