# 登出跳转逻辑优化

## 功能概述

根据用户所在页面的不同，登出后会执行不同的跳转行为，优化用户体验。

## 跳转规则

| 当前页面 | 登出后行为 | 原因说明 |
|---------|-----------|---------|
| Dashboard | 跳转到 Pricing 页 | Dashboard 是需要登录的页面，登出后引导用户了解付费计划 |
| Home 页 (/) | 刷新当前页面 | 保持在首页，显示未登录状态 |
| Pricing 页 | 刷新当前页面 | 用户可能想以游客身份浏览定价信息 |
| 其他页面 | 刷新当前页面 | 默认行为，保持在当前页面 |

## 用户体验流程

### 场景 1：Dashboard 页面登出

1. 用户在 Dashboard 查看订阅信息
2. 点击用户头像 → 选择 "Sign out"
3. ✅ 登出成功
4. ✅ 自动跳转到 Pricing 页面
5. 💡 用户可以了解各个套餐的功能

**用户价值**：引导用户重新考虑订阅方案，提升转化率

### 场景 2：Home 页面登出

1. 用户在首页浏览
2. 点击用户头像 → 选择 "Sign out"
3. ✅ 登出成功
4. ✅ 页面刷新，显示未登录状态
5. 💡 用户可以继续使用免费功能

**用户价值**：保持在首页，无缝切换到访客模式

### 场景 3：Pricing 页面登出

1. 用户在 Pricing 页面查看套餐
2. 点击用户头像 → 选择 "Sign out"
3. ✅ 登出成功
4. ✅ 页面刷新，显示未登录价格
5. 💡 用户可以继续浏览定价信息

**用户价值**：不打断用户的浏览流程

## 技术实现

### 核心代码

**文件**: `components/user-button.tsx`

```typescript
// 处理登出逻辑（根据当前页面决定登出后的行为）
const handleSignOut = async () => {
  await signOut()
  
  // 根据当前页面路径决定登出后的跳转
  if (pathname.startsWith("/dashboard")) {
    // Dashboard 页面 → 跳转到 Pricing 页
    router.push("/pricing")
  } else if (pathname === "/" || pathname.startsWith("/pricing")) {
    // Home 页或 Pricing 页 → 刷新当前页面
    router.refresh()
  } else {
    // 其他页面 → 默认刷新
    router.refresh()
  }
}
```

### 实现步骤

1. **导入必要的 Hooks**
```typescript
import { usePathname, useRouter } from "next/navigation"
```

2. **获取路径和路由实例**
```typescript
const pathname = usePathname()
const router = useRouter()
```

3. **创建登出处理函数**
   - 调用原有的 `signOut()` 函数
   - 根据 `pathname` 判断当前页面
   - 使用 `router.push()` 或 `router.refresh()` 执行跳转

4. **更新按钮点击事件**
```typescript
<DropdownMenuItem onClick={handleSignOut} className="cursor-pointer">
  <LogOut className="mr-2 h-4 w-4" />
  <span>Sign out</span>
</DropdownMenuItem>
```

## 涉及文件

- ✅ `components/user-button.tsx` - 用户按钮组件（主要修改）

## 扩展性

### 添加更多页面的自定义登出行为

只需在 `handleSignOut` 函数中添加更多条件判断：

```typescript
const handleSignOut = async () => {
  await signOut()
  
  if (pathname.startsWith("/dashboard")) {
    router.push("/pricing")
  } else if (pathname.startsWith("/settings")) {
    // 设置页登出 → 跳转到首页
    router.push("/")
  } else if (pathname.startsWith("/billing")) {
    // 账单页登出 → 跳转到定价页
    router.push("/pricing")
  } else if (pathname === "/" || pathname.startsWith("/pricing")) {
    router.refresh()
  } else {
    router.refresh()
  }
}
```

### 添加登出成功提示

可以在登出后显示 Toast 提示：

```typescript
import { toast } from "sonner"

const handleSignOut = async () => {
  await signOut()
  
  toast.success("Successfully signed out")
  
  // 跳转逻辑...
}
```

### 添加登出前确认

可以添加确认对话框，防止误操作：

```typescript
const [showLogoutConfirm, setShowLogoutConfirm] = useState(false)

// 在菜单项中显示确认对话框
<AlertDialog open={showLogoutConfirm} onOpenChange={setShowLogoutConfirm}>
  <AlertDialogTrigger asChild>
    <DropdownMenuItem onSelect={(e) => e.preventDefault()}>
      <LogOut className="mr-2 h-4 w-4" />
      <span>Sign out</span>
    </DropdownMenuItem>
  </AlertDialogTrigger>
  <AlertDialogContent>
    <AlertDialogTitle>Are you sure you want to sign out?</AlertDialogTitle>
    <AlertDialogDescription>
      You can sign in again anytime to access your account.
    </AlertDialogDescription>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction onClick={handleSignOut}>Sign Out</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

## 测试指南

### 测试用例

#### 1. Dashboard 页面登出测试

**前置条件**：已登录状态

1. 访问 `/dashboard` 页面
2. 点击右上角用户头像
3. 点击 "Sign out"
4. ✅ 应该成功登出
5. ✅ 应该自动跳转到 `/pricing` 页面
6. ✅ 页面应该显示未登录状态

#### 2. Home 页面登出测试

**前置条件**：已登录状态

1. 访问 `/` 首页
2. 点击右上角用户头像
3. 点击 "Sign out"
4. ✅ 应该成功登出
5. ✅ 页面应该刷新
6. ✅ 应该停留在首页
7. ✅ 导航栏应该显示 "Sign In" 按钮

#### 3. Pricing 页面登出测试

**前置条件**：已登录状态

1. 访问 `/pricing` 页面
2. 点击右上角用户头像
3. 点击 "Sign out"
4. ✅ 应该成功登出
5. ✅ 页面应该刷新
6. ✅ 应该停留在 Pricing 页面
7. ✅ 价格卡片应该显示未登录状态的 CTA

#### 4. 其他页面登出测试

**前置条件**：已登录状态

1. 访问任意其他页面（如隐私政策页）
2. 点击右上角用户头像
3. 点击 "Sign out"
4. ✅ 应该成功登出
5. ✅ 页面应该刷新
6. ✅ 应该停留在当前页面

### 边界情况

- ✅ Dashboard 子路径（如 `/dashboard/settings`）也应该跳转到 Pricing
- ✅ Pricing 子路径（如 `/pricing/success`）应该刷新当前页面
- ✅ 登出过程中用户不应该能再次点击登出按钮
- ✅ 登出失败时应该有适当的错误提示

### 自动化测试建议

```typescript
// E2E 测试示例（Playwright）
test("logout from dashboard redirects to pricing", async ({ page }) => {
  // 登录
  await login(page)
  
  // 访问 Dashboard
  await page.goto("/dashboard")
  
  // 点击用户头像
  await page.click("[data-testid=user-button]")
  
  // 点击登出
  await page.click("[data-testid=sign-out]")
  
  // 验证跳转到 Pricing 页面
  await expect(page).toHaveURL("/pricing")
  
  // 验证未登录状态
  await expect(page.locator("[data-testid=sign-in-button]")).toBeVisible()
})
```

## 业务价值

### 1. 提升转化率

- Dashboard 登出后引导到 Pricing 页面
- 用户可能重新考虑订阅方案
- 降低用户流失率

### 2. 改善用户体验

- 不同页面的登出行为符合用户心理预期
- 减少用户迷失感
- 提供更流畅的导航体验

### 3. 数据洞察

可以通过分析登出行为来优化产品：

```typescript
// 在登出时记录分析事件
const handleSignOut = async () => {
  // 记录登出事件
  analytics.track("user_logout", {
    from_page: pathname,
    redirect_to: pathname.startsWith("/dashboard") ? "/pricing" : "current"
  })
  
  await signOut()
  // 跳转逻辑...
}
```

## 性能考虑

- ✅ `router.refresh()` 只刷新服务端组件，比整页刷新更快
- ✅ `router.push()` 使用客户端路由，无需重新加载整个页面
- ✅ 登出 API 调用是异步的，不会阻塞 UI
- ✅ 使用了 Next.js 的路由缓存机制

## 未来优化方向

1. **个性化跳转**
   - 记住用户最常访问的页面
   - 登出后跳转到用户最感兴趣的页面

2. **智能引导**
   - 如果用户是付费用户登出，显示挽留弹窗
   - 如果用户是免费用户，引导升级

3. **登出原因收集**
   - 添加"为什么要登出"的可选反馈
   - 收集用户流失原因

4. **快速重新登录**
   - 记住用户偏好的登录方式
   - 一键重新登录功能

---

**实施完成时间**: 2025-10-28  
**状态**: ✅ 已完成并测试  
**相关功能**: Dashboard登录引导功能

