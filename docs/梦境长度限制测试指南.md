# 梦境长度限制功能测试指南

## 🎯 测试目标

验证以下功能是否正常工作：
1. ✅ 字符计数器实时显示
2. ✅ 超限时的视觉警告
3. ✅ 升级引导对话框
4. ✅ 后端长度验证
5. ✅ 定价页面展示

---

## 🚀 前置准备

1. **启动开发服务器**
```bash
cd d:\CursorWorkspace\lumi-dream-app
pnpm dev
```

2. **访问应用**
   - 打开浏览器：http://localhost:3000
   - 打开开发者工具（F12）查看控制台日志

---

## 📋 测试场景

### 测试 1: 字符计数器基本功能

**目标**: 验证字符计数器正确显示

**步骤**:
1. 访问首页 http://localhost:3000
2. 在梦境输入框中输入文字
3. 观察输入框下方的字符计数器

**预期结果**:
- ✅ 应显示 `0 / 500 characters`（初始状态）
- ✅ 输入时实时更新：`50 / 500 characters`
- ✅ 字符数为灰色（未超限状态）

**截图位置**: 输入框下方

---

### 测试 2: 接近限制警告

**目标**: 验证接近限制时的提示

**步骤**:
1. 在输入框中输入约 450 字符的文字
2. 观察字符计数器

**预期结果**:
- ✅ 显示 `450 / 500 characters`
- ✅ 字符数仍为灰色
- ✅ 没有错误提示

**测试文本**:
```
I had a very vivid dream last night. I was flying through clouds of cotton candy, and below me I could see a vast ocean made of liquid gold. There were dolphins jumping in and out of the golden waves, and they were singing the most beautiful melody I've ever heard. As I flew higher, I noticed that the sky wasn't blue but rather a deep purple with stars that twinkled in rainbow colors. Suddenly, I found myself landing on a floating island made entirely of books.
```

---

### 测试 3: 超限视觉警告（关键测试）

**目标**: 验证超过 500 字符时的警告

**步骤**:
1. 继续在输入框中输入，超过 500 字符
2. 观察字符计数器和错误提示

**预期结果**:
- ✅ 字符计数器变红：`550 / 500 characters`（红色字体）
- ✅ 显示错误提示：`Character limit exceeded (550/500). Upgrade for longer dreams!`
- ✅ 显示 "Upgrade for more space" 链接（右侧）
- ✅ "Interpret My Dream" 按钮仍然可点击

**测试文本**:
```
I had a very vivid dream last night. I was flying through clouds of cotton candy, and below me I could see a vast ocean made of liquid gold. There were dolphins jumping in and out of the golden waves, and they were singing the most beautiful melody I've ever heard. As I flew higher, I noticed that the sky wasn't blue but rather a deep purple with stars that twinkled in rainbow colors. Suddenly, I found myself landing on a floating island made entirely of books. Each book glowed with a different color.
```

**控制台日志**:
```
[前端] Dream length: 550/500 characters (超限)
```

---

### 测试 4: 点击"Upgrade for more space"链接

**目标**: 验证升级链接功能

**步骤**:
1. 保持梦境长度超过 500 字符
2. 点击字符计数器右侧的 "Upgrade for more space" 链接

**预期结果**:
- ✅ 弹出升级对话框
- ✅ 对话框标题：`Need More Space?` + 👑 图标
- ✅ 对话框描述：提示超过 500 字符限制
- ✅ 显示层级对比：
  - Current (free): 500 characters
  - Basic: 1,000 characters ✨
  - Pro: 2,000 characters
- ✅ 显示升级好处列表
- ✅ CTA 按钮：`Upgrade to Basic - $4.99/mo`

---

### 测试 5: 点击"Interpret My Dream"按钮（超限状态）

**目标**: 验证提交超限梦境时的行为

**步骤**:
1. 保持梦境长度超过 500 字符（如 550 字符）
2. 点击 "Interpret My Dream" 按钮

**预期结果**:
- ✅ **不会发送 API 请求**
- ✅ 显示错误提示：`Your dream description is too long (550/500 characters). Please upgrade for longer dreams.`
- ✅ 弹出升级对话框
- ✅ 对话框内容同测试 4

**控制台日志**:
```
[前端] Dream length validation failed: 550/500
```

---

### 测试 6: 升级对话框交互

**目标**: 验证对话框内的所有按钮

**步骤**:
1. 打开升级对话框（通过测试 4 或 5）
2. 点击 "Upgrade to Basic - $4.99/mo" 按钮

**预期结果**:
- ✅ 跳转到 `/pricing` 页面
- ✅ 对话框自动关闭

**步骤 2**:
1. 重新触发升级对话框
2. 点击 "I'll Shorten It" 按钮

**预期结果**:
- ✅ 对话框关闭
- ✅ 返回首页，梦境内容保留
- ✅ 字符计数器仍显示（仍为红色）

---

### 测试 7: 后端 API 验证（关键测试）

**目标**: 验证即使绕过前端，后端也会拒绝

**步骤**:
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 粘贴以下代码并执行：

```javascript
// 测试超限梦境（600 字符）
const longDream = "I had a dream. ".repeat(40) // 约 600 字符

fetch("/api/interpret", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ dream: longDream })
})
.then(res => res.json())
.then(data => {
  console.log("Response:", data)
  if (data.error) {
    console.log("✅ 后端验证成功: 拒绝了超长梦境")
    console.log("错误信息:", data.error)
    console.log("最大长度:", data.maxLength)
    console.log("当前长度:", data.currentLength)
    console.log("用户层级:", data.userTier)
  } else {
    console.log("❌ 后端验证失败: 接受了超长梦境")
  }
})
.catch(err => console.error("请求失败:", err))
```

**预期结果**:
- ✅ HTTP 状态码：`400`
- ✅ 响应内容：
```json
{
  "error": "Dream description is too long. Free users can use up to 500 characters. Please upgrade for longer dreams.",
  "maxLength": 500,
  "currentLength": 600,
  "userTier": "free"
}
```

**控制台日志**:
```
✅ 后端验证成功: 拒绝了超长梦境
错误信息: Dream description is too long...
最大长度: 500
当前长度: 600
用户层级: free
```

---

### 测试 8: 后端验证通过（正常梦境）

**目标**: 验证合法长度的梦境能正常处理

**步骤**:
1. 在输入框中输入 400 字符的梦境
2. 点击 "Interpret My Dream" 按钮

**预期结果**:
- ✅ 字符计数器显示：`400 / 500 characters`（灰色）
- ✅ 没有错误提示
- ✅ 按钮变为加载状态："Lumi is reflecting..."
- ✅ API 请求成功发送
- ✅ 返回梦境解析结果

**控制台日志**:
```
[Interpret] Dream length validation passed: 400/500 characters (free)
```

---

### 测试 9: 定价页面展示

**目标**: 验证定价页面显示长度限制

**步骤**:
1. 访问 http://localhost:3000/pricing
2. 查看三个套餐卡片

**预期结果**:

**Free 套餐**:
- ✅ 显示 "Up to 500 characters per dream"
- ✅ 位于功能列表第二项

**Basic 套餐**:
- ✅ 显示 "Up to 1,000 characters per dream"
- ✅ 位于功能列表第二项

**Pro 套餐**:
- ✅ 显示 "Up to 2,000 characters per dream"
- ✅ 位于功能列表第二项

---

### 测试 10: 边界值测试

**目标**: 测试正好 500 字符的边界情况

**步骤**:
1. 在输入框中输入正好 500 字符的文字
2. 观察字符计数器

**预期结果**:
- ✅ 显示 `500 / 500 characters`
- ✅ 字符数为灰色（不是红色）
- ✅ 没有错误提示
- ✅ "Interpret My Dream" 按钮可点击
- ✅ 点击后能正常发送请求

**生成 500 字符的脚本**:
```javascript
// 在浏览器控制台运行
const text = "I had a dream. ".repeat(33).substring(0, 500)
console.log("Length:", text.length) // 应该是 500
navigator.clipboard.writeText(text) // 复制到剪贴板
```

---

## 🎨 视觉验证清单

### 字符计数器样式

- [ ] 正常状态（≤ 500）：
  - 字体颜色：灰色（`text-muted-foreground`）
  - 字体大小：`text-xs`
  - 位置：输入框下方左侧

- [ ] 超限状态（> 500）：
  - 字体颜色：红色（`text-destructive`）
  - 字体粗细：加粗（`font-semibold`）
  - 显示升级链接

### 错误提示样式

- [ ] 超限错误：
  - 红色边框
  - 警告图标
  - 错误文本清晰可读

### 升级对话框样式

- [ ] 对话框居中显示
- [ ] 背景半透明遮罩
- [ ] 👑 图标显示在标题旁
- [ ] 层级对比部分：
  - 灰色背景（`bg-muted/50`）
  - 当前层级和升级层级明显对比
  - Basic/Pro 层级用金色（`text-primary`）高亮
- [ ] CTA 按钮：
  - 金色背景
  - 👑 图标
  - 价格显示清晰

---

## 📊 测试记录表

| 测试编号 | 测试项目 | 预期结果 | 实际结果 | 通过/失败 |
|---------|---------|---------|---------|---------|
| 1 | 字符计数器基本显示 | 0 / 500 characters | | ☐ |
| 2 | 接近限制（450字符） | 灰色显示 | | ☐ |
| 3 | 超限警告（550字符） | 红色 + 错误提示 | | ☐ |
| 4 | "Upgrade for more space"链接 | 弹出对话框 | | ☐ |
| 5 | 超限时点击解析按钮 | 弹出对话框 | | ☐ |
| 6 | 对话框升级按钮 | 跳转/pricing | | ☐ |
| 7 | 后端验证拒绝超限 | 400错误 | | ☐ |
| 8 | 后端验证通过合法 | 200成功 | | ☐ |
| 9 | 定价页面展示 | 显示长度限制 | | ☐ |
| 10 | 边界值（500字符） | 正常处理 | | ☐ |

---

## 🐛 常见问题排查

### 问题 1: 字符计数器不显示

**可能原因**:
- 前端组件未正确导入 `getPricingConfig`
- `subscription` 数据未加载

**检查**:
1. 打开控制台，查看是否有错误
2. 检查 `maxDreamLength` 的值：
```javascript
console.log("Max length:", document.querySelector('textarea').getAttribute('maxLength'))
```

---

### 问题 2: 超限但仍能提交

**可能原因**:
- 前端验证逻辑被绕过
- 后端验证未生效

**检查**:
1. 查看网络请求（Network 标签）
2. 检查响应状态码
3. 查看后端日志：
```
[Interpret] Dream length validation passed/failed: X/Y characters
```

---

### 问题 3: 升级对话框不弹出

**可能原因**:
- `showLengthUpgradePrompt` 状态未更新
- 对话框组件渲染问题

**检查**:
1. 在 React DevTools 中查看组件状态
2. 检查 Dialog 组件的 `open` 属性

---

## ✅ 测试完成标准

所有测试通过需满足：

1. ✅ 字符计数器正常显示和更新
2. ✅ 超限时视觉警告明显（红色字体）
3. ✅ 升级对话框能正常弹出和关闭
4. ✅ 对话框内容准确（层级、价格、好处）
5. ✅ 后端验证拒绝超限梦境（400 错误）
6. ✅ 后端验证接受合法梦境（200 成功）
7. ✅ 定价页面正确展示长度限制
8. ✅ 边界值（500 字符）处理正确
9. ✅ 所有按钮和链接跳转正常
10. ✅ 无控制台错误

---

## 📸 测试截图建议

建议截图保存以下状态：

1. **正常状态**: 400 字符，灰色计数器
2. **超限状态**: 550 字符，红色计数器 + 错误提示
3. **升级对话框**: 完整对话框内容
4. **定价页面**: 三个套餐卡片

---

**测试日期**: _________  
**测试人员**: _________  
**测试结果**: ☐ 全部通过 ☐ 部分失败  
**备注**: _______________

