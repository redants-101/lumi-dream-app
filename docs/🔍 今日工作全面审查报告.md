# ğŸ” ä»Šæ—¥å·¥ä½œå…¨é¢å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2025-10-28  
**å®¡æŸ¥æ–¹æ³•**: ç³»ç»Ÿæ€§æ€è€ƒ + æå‰è§„åˆ’ + è¾¹ç•Œæƒ…å†µ + ä»£ç é‡æ„

---

## ğŸš¨ å‘ç°çš„ä¸¥é‡é—®é¢˜

### ğŸ”´ é—®é¢˜ 1: æ•°æ®ä¸åŒæ­¥ï¼ˆæœ€ä¸¥é‡ï¼‰

**ç°çŠ¶**:
- **å‰ç«¯** (use-usage-limit-v2): ä½¿ç”¨ **localStorage** å­˜å‚¨ä½¿ç”¨æ¬¡æ•°
- **åç«¯** (interpret API): æŸ¥è¯¢ **usage_tracking è¡¨** åˆ¤æ–­é™çº§

**é—®é¢˜**:
```
ç”¨æˆ·ä½¿ç”¨è§£æ¢¦:
  â”œâ”€ å‰ç«¯: incrementUsage() â†’ æ›´æ–° localStorage âœ…
  â”œâ”€ åç«¯: æŸ¥è¯¢ usage_tracking è¡¨ â†’ âŒ è¡¨å¯èƒ½ä¸å­˜åœ¨
  â””â”€ ç»“æœ: å‰ç«¯æ˜¾ç¤º"å·²ç”¨ 10 æ¬¡"ï¼Œä½†åç«¯æŸ¥åˆ° 0 æ¬¡ â†’ é™çº§é€»è¾‘å¤±æ•ˆ
```

**å½±å“**:
- âŒ Pro ç”¨æˆ·æ°¸è¿œä¸ä¼šé™çº§ï¼ˆæ•°æ®åº“æ²¡æ•°æ®ï¼‰
- âŒ å‰åç«¯æ•°æ®ä¸ä¸€è‡´
- âŒ ç”¨æˆ·çœ‹åˆ°çš„å’Œå®é™…çš„ä¸åŒ

**ä¸¥é‡æ€§**: ğŸ”´ğŸ”´ğŸ”´ æé«˜

---

### ğŸ”´ é—®é¢˜ 2: usage_tracking è¡¨æœªåˆ›å»º

**ç°çŠ¶**:
- âœ… åˆ›å»ºäº† SQL è„šæœ¬ (`usage_trackingè¡¨ç»“æ„.sql`)
- âŒ ä½†æ²¡æœ‰åœ¨ Supabase ä¸­å®é™…æ‰§è¡Œ
- âŒ interpret API æŸ¥è¯¢è¿™ä¸ªè¡¨ä¼šæŠ¥é”™

**é—®é¢˜**:
```typescript
// app/api/interpret/route.ts ç¬¬ 96-102 è¡Œ
const { data: usageData } = await supabase
  .from("usage_tracking")  // âŒ è¡¨ä¸å­˜åœ¨
  .select("monthly_count")
  .eq("user_id", user.id)
  .single()

// ç»“æœ: æŸ¥è¯¢å¤±è´¥ï¼Œerror ä¸ä¸º null
const monthlyCount = usageData?.monthly_count || 0  // æ°¸è¿œæ˜¯ 0
```

**å½±å“**:
- âŒ Pro ç”¨æˆ·é™çº§åŠŸèƒ½å®Œå…¨ä¸å·¥ä½œ
- âŒ æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæœ‰æ•°æ®åº“é”™è¯¯æ—¥å¿—

**ä¸¥é‡æ€§**: ğŸ”´ğŸ”´ğŸ”´ æé«˜

---

### ğŸ”´ é—®é¢˜ 3: ä½¿ç”¨æ¬¡æ•°æœªåŒæ­¥åˆ°æ•°æ®åº“

**ç°çŠ¶**:
- å‰ç«¯: `incrementUsage()` åªæ›´æ–° localStorage
- åç«¯: éœ€è¦æŸ¥è¯¢æ•°æ®åº“
- ç¼ºå¤±: **æ²¡æœ‰ API å°†ä½¿ç”¨æ¬¡æ•°å†™å…¥æ•°æ®åº“**

**é—®é¢˜**:
```
ç”¨æˆ·ä½¿ç”¨è§£æ¢¦:
  â”œâ”€ å‰ç«¯è°ƒç”¨: incrementUsage() â†’ localStorage +1 âœ…
  â”œâ”€ åç«¯æŸ¥è¯¢: usage_tracking è¡¨ â†’ 0ï¼ˆæ²¡æœ‰æ›´æ–°ï¼‰ âŒ
  â””â”€ ç»“æœ: æ•°æ®ä¸åŒæ­¥
```

**éœ€è¦æ·»åŠ **:
```typescript
// åœ¨ interpret API æˆåŠŸå
await supabase
  .from("usage_tracking")
  .upsert({
    user_id: user.id,
    month: currentMonth,
    monthly_count: supabase.raw('monthly_count + 1'),
    daily_count: supabase.raw('daily_count + 1'),
  })
```

**ä¸¥é‡æ€§**: ğŸ”´ğŸ”´ğŸ”´ æé«˜

---

### ğŸŸ  é—®é¢˜ 4: ç±»å‹å®šä¹‰é‡å¤

**ç°çŠ¶**:
```typescript
// lib/usage-limits.ts
export type UserTier = "anonymous" | "free" | "basic" | "pro"

// lib/ai-config.ts
export type UserTier = "anonymous" | "free" | "basic" | "pro"
export type SubscriptionTier = "free" | "basic" | "pro"

// lib/pricing-config.ts
export type SubscriptionTier = "free" | "basic" | "pro"
```

**é—®é¢˜**:
- âŒ UserTier é‡å¤å®šä¹‰ 2 æ¬¡
- âŒ SubscriptionTier é‡å¤å®šä¹‰ 2 æ¬¡
- âŒ ä¸ç¬¦åˆ DRY åŸåˆ™

**å»ºè®®**: åˆ›å»ºç»Ÿä¸€çš„ç±»å‹å®šä¹‰æ–‡ä»¶

**ä¸¥é‡æ€§**: ğŸŸ  ä¸­ç­‰

---

### ğŸŸ  é—®é¢˜ 5: é”™è¯¯å¤„ç†ä¸å®Œæ•´

**åœºæ™¯ 1**: usage_tracking è¡¨æŸ¥è¯¢å¤±è´¥
```typescript
// app/api/interpret/route.ts
const { data: usageData } = await supabase
  .from("usage_tracking")
  .select("monthly_count")
  .single()

// âŒ æ²¡æœ‰æ£€æŸ¥ error
const monthlyCount = usageData?.monthly_count || 0  // å¤±è´¥æ—¶é»˜è®¤ 0
```

**é—®é¢˜**: 
- æŸ¥è¯¢å¤±è´¥æ—¶é™é»˜å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´é€»è¾‘é”™è¯¯

**åœºæ™¯ 2**: è®¢é˜…æŸ¥è¯¢å¤±è´¥
```typescript
const { data: subscription, error } = await supabase
  .from("user_subscriptions")
  .select("tier")
  .single()

// âŒ error æ—¶åªæ‰“å°æ—¥å¿—ï¼Œä½†ç»§ç»­ä½¿ç”¨ "free"
// å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯å‘¢ï¼Ÿåº”è¯¥è¿”å› 500 è€Œä¸æ˜¯ç»§ç»­
```

**ä¸¥é‡æ€§**: ğŸŸ  ä¸­ç­‰

---

### ğŸŸ¡ é—®é¢˜ 6: ç¯å¢ƒå˜é‡æœªéªŒè¯

**ç¼ºå¤±çš„éªŒè¯**:
```typescript
// .env.local éœ€è¦æ·»åŠ ä½†æ²¡æœ‰æ£€æŸ¥è„šæœ¬éªŒè¯
SUPABASE_SERVICE_ROLE_KEY=xxx  // â† æ²¡æœ‰éªŒè¯æ˜¯å¦å·²é…ç½®
```

**å»ºè®®**: åœ¨å¯åŠ¨æ—¶æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡

**ä¸¥é‡æ€§**: ğŸŸ¡ ä¸­ä½

---

### ğŸŸ¡ é—®é¢˜ 7: æ¢¦å¢ƒé•¿åº¦é™åˆ¶çš„è¾¹ç•Œæƒ…å†µ

**åœºæ™¯**: ç”¨æˆ·è¾“å…¥æ­£å¥½ 500 å­—ç¬¦ï¼ˆè¾¹ç•Œå€¼ï¼‰

**å½“å‰ä»£ç **:
```typescript
if (dream.length > maxDreamLength) {  // > 500
  // æ‹’ç»
}
```

**é—®é¢˜**: 500 å­—ç¬¦ä¼šè¢«æ¥å—ï¼Œä½†ç”¨æˆ·å¯èƒ½æœŸæœ›çœ‹åˆ° "500/500" æ˜¯æ»¡çš„

**å»ºè®®**: >= åˆ¤æ–­æˆ–è€…æå‰ 1 å­—ç¬¦è­¦å‘Š

**ä¸¥é‡æ€§**: ğŸŸ¢ ä½

---

### ğŸŸ¡ é—®é¢˜ 8: Pro ç”¨æˆ·é™çº§é˜ˆå€¼ç¡¬ç¼–ç 

**å½“å‰ä»£ç **:
```typescript
// app/api/interpret/route.ts ç¬¬ 105 è¡Œ
if (monthlyCount >= 100) {  // âŒ ç¡¬ç¼–ç  100
  modelId = fallback
}
```

**é—®é¢˜**: 
- 100 è¿™ä¸ªæ•°å­—åº”è¯¥åœ¨ USAGE_LIMITS ä¸­é…ç½®
- å¦‚æœä»¥åæƒ³è°ƒæ•´é™çº§ç‚¹ï¼Œéœ€è¦æ”¹ä»£ç 

**å»ºè®®**: 
```typescript
pro: {
  warningThresholds: {
    monthly: {
      gentle: 100,
      downgrade: 100,  // âœ… æ–°å¢é™çº§ç‚¹é…ç½®
    }
  }
}
```

**ä¸¥é‡æ€§**: ğŸŸ¡ ä¸­ä½

---

### ğŸŸ¢ é—®é¢˜ 9: Alert æ˜¾ç¤ºé€»è¾‘å¤æ‚

**å½“å‰ä»£ç **:
```typescript
{!isLimitReached && (
  (warningThresholds.daily.urgent && remainingDaily <= warningThresholds.daily.urgent) || 
  (warningThresholds.monthly.urgent && remainingMonthly <= warningThresholds.monthly.urgent)
) && remainingCount > 0 && ( ... )}
```

**é—®é¢˜**: 
- é€»è¾‘åµŒå¥—å¤ªæ·±
- å¯è¯»æ€§å·®

**å»ºè®®**: æå–ä¸ºå‡½æ•°

**ä¸¥é‡æ€§**: ğŸŸ¢ ä½

---

### ğŸŸ¢ é—®é¢˜ 10: æ–‡æ¡£è¿‡å¤šã€æœ‰é‡å¤

**å½“å‰**: åˆ›å»ºäº† 15+ ä»½æ–‡æ¡£ï¼Œæœ‰äº›å†…å®¹é‡å¤

**å»ºè®®**: 
- åˆå¹¶ç›¸ä¼¼æ–‡æ¡£
- åˆ›å»ºä¸€ä¸ªä¸»ç´¢å¼•æ–‡æ¡£
- å½’æ¡£è¿‡æ—¶æ–‡æ¡£

**ä¸¥é‡æ€§**: ğŸŸ¢ ä½

---

## ğŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ

### ğŸ”´ P0 çº§åˆ«ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰

#### ä¼˜åŒ– 1: ç»Ÿä¸€ä½¿ç”¨æ•°æ®æ¥æº

**æ–¹æ¡ˆ A**: å…¨éƒ¨ä½¿ç”¨ localStorageï¼ˆæ¨èï¼‰
- âœ… ç®€å•ï¼Œæ— éœ€æ•°æ®åº“
- âœ… å‰ç«¯ç›´æ¥å¯ç”¨
- âŒ æ— æ³•è·¨è®¾å¤‡åŒæ­¥
- âŒ ç”¨æˆ·å¯ä»¥æ¸…é™¤ç»•è¿‡

**æ–¹æ¡ˆ B**: å…¨éƒ¨ä½¿ç”¨æ•°æ®åº“
- âœ… æ•°æ®å®‰å…¨
- âœ… è·¨è®¾å¤‡åŒæ­¥
- âŒ æ¯æ¬¡éƒ½è¦æŸ¥è¯¢æ•°æ®åº“
- âŒ å¢åŠ å»¶è¿Ÿ

**æ–¹æ¡ˆ C**: æ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³ï¼‰
- LocalStorage ä½œä¸ºç¼“å­˜ï¼ˆå‰ç«¯æ˜¾ç¤ºï¼‰
- æ•°æ®åº“ä½œä¸ºæƒå¨æ•°æ®ï¼ˆåç«¯éªŒè¯ï¼‰
- å‰ç«¯æ˜¾ç¤ºç”¨ localStorageï¼ˆå¿«é€Ÿï¼‰
- åç«¯éªŒè¯ç”¨æ•°æ®åº“ï¼ˆå®‰å…¨ï¼‰
- æ¯æ¬¡æˆåŠŸè§£æ¢¦ååŒæ­¥åˆ°æ•°æ®åº“

---

#### ä¼˜åŒ– 2: å®ç°ä½¿ç”¨æ¬¡æ•°åŒæ­¥

**åœ¨ interpret API ä¸­æ·»åŠ **:
```typescript
// è§£æ¢¦æˆåŠŸåï¼Œæ›´æ–°æ•°æ®åº“
await supabase.rpc('increment_usage_tracking', {
  p_user_id: user.id,
  p_increment: 1
})
```

---

#### ä¼˜åŒ– 3: åˆ›å»º usage_tracking è¡¨

**æ‰§è¡Œæ­¥éª¤**:
1. åœ¨ Supabase Dashboard æ‰§è¡Œ SQL
2. éªŒè¯è¡¨ã€ç´¢å¼•ã€å‡½æ•°éƒ½å·²åˆ›å»º
3. æ·»åŠ åˆ°éƒ¨ç½²æ£€æŸ¥æ¸…å•

---

### ğŸŸ  P1 çº§åˆ«ï¼ˆé‡è¦ä¼˜åŒ–ï¼‰

#### ä¼˜åŒ– 4: ç»Ÿä¸€ç±»å‹å®šä¹‰

**åˆ›å»º**: `lib/types.ts`
```typescript
export type UserTier = "anonymous" | "free" | "basic" | "pro"
export type SubscriptionTier = "free" | "basic" | "pro"
export type BillingCycle = "monthly" | "yearly"
```

**ç„¶å**:
- lib/usage-limits.ts â†’ import from types
- lib/ai-config.ts â†’ import from types
- lib/pricing-config.ts â†’ import from types

---

#### ä¼˜åŒ– 5: æ”¹è¿›é”™è¯¯å¤„ç†

**åœ¨æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢åæ·»åŠ **:
```typescript
const { data, error } = await supabase.from("table").select()

if (error) {
  console.error("[Error]:", error)
  // æ ¹æ®é”™è¯¯ç±»å‹å†³å®š:
  // - ç½‘ç»œé”™è¯¯ â†’ è¿”å› 500
  // - æ•°æ®ä¸å­˜åœ¨ â†’ ä½¿ç”¨é»˜è®¤å€¼
  // - æƒé™é”™è¯¯ â†’ è¿”å› 401
}
```

---

#### ä¼˜åŒ– 6: é™çº§é˜ˆå€¼å¯é…ç½®

**åœ¨ USAGE_LIMITS ä¸­æ·»åŠ **:
```typescript
pro: {
  warningThresholds: {
    monthly: {
      gentle: 100,
      urgent: 40,
      downgrade: 100,  // âœ… é™çº§ç‚¹
    }
  }
}
```

---

### ğŸŸ¡ P2 çº§åˆ«ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

#### ä¼˜åŒ– 7: æå– Alert æ˜¾ç¤ºé€»è¾‘

```typescript
const shouldShowAlert = useMemo(() => {
  if (isLimitReached || remainingCount === 0) return false
  
  return (
    (warningThresholds.daily.urgent && remainingDaily <= warningThresholds.daily.urgent) ||
    (warningThresholds.monthly.urgent && remainingMonthly <= warningThresholds.monthly.urgent)
  )
}, [isLimitReached, remainingCount, remainingDaily, remainingMonthly, warningThresholds])

// ä½¿ç”¨
{shouldShowAlert && <Alert>...</Alert>}
```

---

#### ä¼˜åŒ– 8: æ·»åŠ ç¯å¢ƒå˜é‡æ£€æŸ¥è„šæœ¬

**æ›´æ–°**: `scripts/check-env.js`
```javascript
const required = [
  'OPENROUTER_API_KEY',
  'NEXT_PUBLIC_SUPABASE_URL',
  'NEXT_PUBLIC_SUPABASE_ANON_KEY',
  'SUPABASE_SERVICE_ROLE_KEY',  // â† æ–°å¢
  'CREEM_API_KEY',
  'CREEM_WEBHOOK_SECRET',
]

// æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
```

---

#### ä¼˜åŒ– 9: æ–‡æ¡£æ•´ç†

**è¡ŒåŠ¨**:
1. åˆ›å»ºä¸»ç´¢å¼•æ–‡æ¡£ï¼ˆREADME.mdï¼‰
2. åˆå¹¶é‡å¤æ–‡æ¡£
3. å½’æ¡£è¿‡æ—¶æ–‡æ¡£åˆ° `docs/archive/`
4. åˆ›å»ºå¿«é€Ÿå‚è€ƒå¡ç‰‡

---

### ğŸŸ¢ P3 çº§åˆ«ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

#### ä¼˜åŒ– 10: æ·»åŠ å•å…ƒæµ‹è¯•

```typescript
// tests/usage-limits.test.ts
describe('USAGE_LIMITS', () => {
  test('getModelForTier returns correct model', () => {
    expect(getModelForTier('pro')).toBe(AI_MODELS.PREMIUM)
  })
})
```

---

## ğŸ“Š ä¼˜åŒ–ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | ä¼˜åŒ–ç‚¹ | ä¸¥é‡æ€§ | å·¥ä½œé‡ | å»ºè®® |
|--------|--------|--------|--------|------|
| ğŸ”´ P0 | æ•°æ®ä¸åŒæ­¥é—®é¢˜ | æé«˜ | 2h | ç«‹å³ä¿®å¤ |
| ğŸ”´ P0 | åˆ›å»º usage_tracking è¡¨ | æé«˜ | 10min | ç«‹å³æ‰§è¡Œ |
| ğŸ”´ P0 | å®ç°ä½¿ç”¨æ¬¡æ•°åŒæ­¥ | æé«˜ | 1h | ç«‹å³ä¿®å¤ |
| ğŸŸ  P1 | ç»Ÿä¸€ç±»å‹å®šä¹‰ | ä¸­ç­‰ | 30min | æœ¬å‘¨å®Œæˆ |
| ğŸŸ  P1 | æ”¹è¿›é”™è¯¯å¤„ç† | ä¸­ç­‰ | 1h | æœ¬å‘¨å®Œæˆ |
| ğŸŸ  P1 | é™çº§é˜ˆå€¼å¯é…ç½® | ä¸­ä½ | 20min | æœ¬å‘¨å®Œæˆ |
| ğŸŸ¡ P2 | æå– Alert é€»è¾‘ | ä½ | 15min | å¯é€‰ |
| ğŸŸ¡ P2 | ç¯å¢ƒå˜é‡æ£€æŸ¥ | ä½ | 20min | å¯é€‰ |
| ğŸŸ¡ P2 | æ–‡æ¡£æ•´ç† | ä½ | 1h | å¯é€‰ |
| ğŸŸ¢ P3 | å•å…ƒæµ‹è¯• | ä½ | 2h | æœªæ¥ |

---

## ğŸ¯ æ¨èçš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ··åˆæ•°æ®æºï¼ˆæ¨èï¼‰

**æ¶æ„**:
```
å‰ç«¯æ˜¾ç¤º:
  â† localStorage (å¿«é€Ÿï¼Œå³æ—¶åé¦ˆ)

åç«¯éªŒè¯:
  â† usage_tracking è¡¨ (æƒå¨ï¼Œå®‰å…¨)

åŒæ­¥æœºåˆ¶:
  æ¯æ¬¡æˆåŠŸè§£æ¢¦ â†’ åŒæ—¶æ›´æ–° localStorage å’Œæ•°æ®åº“
```

**å®æ–½**:
1. ä¿ç•™ localStorageï¼ˆå‰ç«¯æ˜¾ç¤ºå¿«é€Ÿï¼‰
2. åˆ›å»º usage_tracking è¡¨ï¼ˆåç«¯éªŒè¯ï¼‰
3. åœ¨ interpret API ä¸­åŒæ­¥æ›´æ–°æ•°æ®åº“
4. å‰ç«¯å®šæœŸä»æ•°æ®åº“åˆ·æ–°ï¼ˆå¯é€‰ï¼‰

**ä¼˜åŠ¿**:
- âœ… å‰ç«¯æ˜¾ç¤ºå¿«é€Ÿ
- âœ… åç«¯æ•°æ®å‡†ç¡®
- âœ… Pro é™çº§åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… é˜²æ­¢ä½œå¼Šï¼ˆåç«¯éªŒè¯ï¼‰

---

### æ–¹æ¡ˆ 2: çº¯ LocalStorageï¼ˆç®€åŒ–ï¼‰

**æ¶æ„**:
```
å‰ç«¯å’Œåç«¯éƒ½ä½¿ç”¨ localStorage æ¦‚å¿µ:
  - å‰ç«¯: localStorage ç›´æ¥ä½¿ç”¨
  - åç«¯: ä»è¯·æ±‚å¤´è·å–æˆ–æŸ¥è¯¢ç¼“å­˜
```

**é—®é¢˜**:
- âŒ æ— æ³•è·¨è®¾å¤‡åŒæ­¥
- âŒ ç”¨æˆ·å¯ä»¥æ¸…é™¤ç»•è¿‡
- âŒ Pro é™çº§ä¾èµ–å‰ç«¯æ•°æ®ï¼ˆä¸å®‰å…¨ï¼‰

**ä¸æ¨è**

---

### æ–¹æ¡ˆ 3: çº¯æ•°æ®åº“ï¼ˆæ ‡å‡†ï¼‰

**æ¶æ„**:
```
å‰ç«¯æ˜¾ç¤º: â† ä» API æŸ¥è¯¢æ•°æ®åº“
åç«¯éªŒè¯: â† æŸ¥è¯¢æ•°æ®åº“
```

**é—®é¢˜**:
- âŒ æ¯æ¬¡æ˜¾ç¤ºéƒ½è¦æŸ¥è¯¢ï¼ˆæ…¢ï¼‰
- âŒ å¢åŠ æ•°æ®åº“è´Ÿè½½

**å¯è¡Œä½†éæœ€ä¼˜**

---

## ğŸ“‹ ç«‹å³éœ€è¦ä¿®å¤çš„ï¼ˆP0ï¼‰

### ä¿®å¤ 1: åˆ›å»º usage_tracking è¡¨

**æ–‡ä»¶**: å·²æœ‰ `docs/3.å®šä»·æ”¯ä»˜/usage_trackingè¡¨ç»“æ„.sql`

**æ‰§è¡Œ**: åœ¨ Supabase SQL Editor ä¸­è¿è¡Œ

**éªŒè¯**:
```sql
SELECT * FROM usage_tracking LIMIT 1;
```

---

### ä¿®å¤ 2: åœ¨ interpret API ä¸­åŒæ­¥ä½¿ç”¨æ¬¡æ•°

**ä½ç½®**: `app/api/interpret/route.ts`

**æ·»åŠ **:
```typescript
// è§£æ¢¦æˆåŠŸåï¼Œæ›´æ–°ä½¿ç”¨æ¬¡æ•°
if (user) {
  const currentMonth = new Date().toISOString().slice(0, 7)
  const currentDay = new Date().toISOString().slice(0, 10)
  
  await supabase
    .from("usage_tracking")
    .upsert({
      user_id: user.id,
      month: currentMonth,
      day: currentDay,
      monthly_count: supabase.raw('COALESCE(monthly_count, 0) + 1'),
      daily_count: supabase.raw('COALESCE(daily_count, 0) + 1'),
    }, {
      onConflict: 'user_id,month'
    })
}
```

---

### ä¿®å¤ 3: æ”¹è¿›é”™è¯¯å¤„ç†

```typescript
const { data: usageData, error: usageError } = await supabase
  .from("usage_tracking")
  .select("monthly_count")
  .single()

if (usageError && usageError.code !== 'PGRST116') {  // PGRST116 = è®°å½•ä¸å­˜åœ¨
  console.error("[Interpret] Failed to fetch usage:", usageError)
  // æ•°æ®åº“é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼ç»§ç»­
}

const monthlyCount = usageData?.monthly_count || 0
```

---

## ğŸ”„ ä¿®å¤åçš„æ•°æ®æµ

### å®Œæ•´æµç¨‹

```
ç”¨æˆ·è¯·æ±‚è§£æ¢¦
    â†“
[åç«¯ 1] æŸ¥è¯¢è®¢é˜…å±‚çº§ â†’ tier = "pro"
    â†“
[åç«¯ 2] æŸ¥è¯¢ä½¿ç”¨æ¬¡æ•° â†’ monthlyCount = 99
    â†“
[åç«¯ 3] åˆ¤æ–­é™çº§ â†’ 99 < 100 â†’ ä½¿ç”¨ Sonnet âœ…
    â†“
[åç«¯ 4] è°ƒç”¨ AI è§£æ
    â†“
[åç«¯ 5] è§£ææˆåŠŸ â†’ æ›´æ–° usage_tracking: monthlyCount = 100 âœ…
    â†“
[åç«¯ 6] è¿”å›ç»“æœ
    â†“
[å‰ç«¯ 1] æ¥æ”¶ç»“æœ â†’ æ˜¾ç¤ºè§£æ
    â†“
[å‰ç«¯ 2] incrementUsage() â†’ æ›´æ–° localStorage âœ…
    â†“
[å‰ç«¯ 3] æ£€æŸ¥æé†’é˜ˆå€¼ â†’ 100 === gentle â†’ æ˜¾ç¤ºé™çº§æç¤º âœ…
```

**å…³é”®**: åç«¯æ›´æ–°æ•°æ®åº“ï¼Œå‰ç«¯æ›´æ–° localStorageï¼ŒåŒç®¡é½ä¸‹ âœ…

---

## ğŸ“Š è¾¹ç•Œæƒ…å†µæ£€æŸ¥

### è¾¹ç•Œ 1: æ–°ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨

```
åœºæ™¯: ç”¨æˆ·åˆšæ³¨å†Œï¼Œä»æœªä½¿ç”¨è¿‡

æ•°æ®åº“: usage_tracking è¡¨æ— è®°å½•
LocalStorage: æ— æ•°æ®

æµç¨‹:
1. æŸ¥è¯¢ usage_tracking â†’ æ— è®°å½• â†’ monthlyCount = 0 âœ…
2. ä½¿ç”¨è§£æ¢¦ â†’ æˆåŠŸ
3. Upsert usage_tracking â†’ åˆ›å»ºè®°å½• {monthly_count: 1} âœ…
4. incrementUsage() â†’ localStorage {monthlyCount: 1} âœ…

ç»“æœ: âœ… æ­£å¸¸å·¥ä½œ
```

---

### è¾¹ç•Œ 2: è·¨æœˆä»½åˆ‡æ¢

```
åœºæ™¯: 10æœˆ31æ—¥ 23:59 ä½¿ç”¨ï¼Œ11æœˆ1æ—¥ 0:00 åè®¿é—®

10æœˆ31æ—¥:
  - usage_tracking: {month: "2025-10", monthly_count: 10}
  - localStorage: {month: "2025-10", monthlyCount: 10}

11æœˆ1æ—¥:
  - localStorage è‡ªåŠ¨æ£€æµ‹æœˆä»½å˜åŒ– â†’ é‡ç½® âœ…
  - ä½† usage_tracking è¿˜æ˜¯ 10 æœˆçš„è®°å½•

ç¬¬ä¸€æ¬¡ä½¿ç”¨:
  - æŸ¥è¯¢ usage_tracking â†’ æ‰¾åˆ° "2025-10" è®°å½•ï¼ˆæ—§çš„ï¼‰
  - åº”è¯¥æŸ¥è¯¢ "2025-11" â†’ æ— è®°å½• â†’ monthlyCount = 0 âœ…
  
å½“å‰ä»£ç å·²æ­£ç¡®: eq("month", "2025-11") âœ…
```

---

### è¾¹ç•Œ 3: æ¸…é™¤ localStorage

```
åœºæ™¯: ç”¨æˆ·æ¸…é™¤æµè§ˆå™¨æ•°æ®

LocalStorage: å…¨éƒ¨æ¸…é™¤
æ•°æ®åº“: æœ‰å‡†ç¡®è®°å½•

å‰ç«¯æ˜¾ç¤º:
  - remainingMonthly ä» localStorage è¯»å– â†’ æ˜¾ç¤º 10ï¼ˆé”™è¯¯ï¼‰
  
åç«¯éªŒè¯:
  - ä»æ•°æ®åº“è¯»å– â†’ monthlyCount = 5ï¼ˆæ­£ç¡®ï¼‰
  
é—®é¢˜: å‰ç«¯æ˜¾ç¤ºä¸å‡†ç¡®

è§£å†³: å‰ç«¯ä» API è·å–çœŸå®ä½¿ç”¨æ¬¡æ•°
```

---

### è¾¹ç•Œ 4: Pro ç”¨æˆ·æ°å¥½ 100 æ¬¡

```
å½“å‰: 99 æ¬¡
ä½¿ç”¨ç¬¬ 100 æ¬¡:
  - æŸ¥è¯¢: monthlyCount = 99
  - åˆ¤æ–­: 99 < 100 â†’ ä½¿ç”¨ Sonnet âœ…
  - æ›´æ–°: monthlyCount = 100 âœ…
  - å‰ç«¯: æ˜¾ç¤ºé™çº§æç¤º âœ…
  
ä½¿ç”¨ç¬¬ 101 æ¬¡:
  - æŸ¥è¯¢: monthlyCount = 100
  - åˆ¤æ–­: 100 >= 100 â†’ ä½¿ç”¨ Haiku âœ…
  - æ— é™çº§æç¤ºï¼ˆå·²ç»æç¤ºè¿‡ï¼‰âœ…

ç»“æœ: âœ… é€»è¾‘æ­£ç¡®
```

---

## ğŸ¯ æœ€ç»ˆä¼˜åŒ–å»ºè®®

### ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰

**ä¼˜åŒ– 1**: åˆ›å»º usage_tracking è¡¨
- å·¥ä½œé‡: 10 åˆ†é’Ÿ
- æ‰§è¡Œ: åœ¨ Supabase è¿è¡Œ SQL

**ä¼˜åŒ– 2**: åœ¨ interpret API ä¸­åŒæ­¥ä½¿ç”¨æ¬¡æ•°åˆ°æ•°æ®åº“
- å·¥ä½œé‡: 30 åˆ†é’Ÿ
- ä½ç½®: `app/api/interpret/route.ts`

**ä¼˜åŒ– 3**: æ”¹è¿›æ•°æ®åº“æŸ¥è¯¢çš„é”™è¯¯å¤„ç†
- å·¥ä½œé‡: 20 åˆ†é’Ÿ
- ä½ç½®: `app/api/interpret/route.ts`

---

### æœ¬å‘¨å®Œæˆï¼ˆP1ï¼‰

**ä¼˜åŒ– 4**: ç»Ÿä¸€ç±»å‹å®šä¹‰åˆ° `lib/types.ts`
- å·¥ä½œé‡: 30 åˆ†é’Ÿ

**ä¼˜åŒ– 5**: é™çº§é˜ˆå€¼é…ç½®åŒ–
- å·¥ä½œé‡: 20 åˆ†é’Ÿ

---

### å¯é€‰ï¼ˆP2-P3ï¼‰

**ä¼˜åŒ– 6**: æå– Alert æ˜¾ç¤ºé€»è¾‘
**ä¼˜åŒ– 7**: ç¯å¢ƒå˜é‡æ£€æŸ¥
**ä¼˜åŒ– 8**: æ–‡æ¡£æ•´ç†
**ä¼˜åŒ– 9**: å•å…ƒæµ‹è¯•

---

## ğŸ“ å®¡æŸ¥æ€»ç»“

### å‘ç°çš„é—®é¢˜

- ğŸ”´ **ä¸¥é‡é—®é¢˜**: 3 ä¸ªï¼ˆæ•°æ®ä¸åŒæ­¥ã€è¡¨æœªåˆ›å»ºã€æ¬¡æ•°æœªåŒæ­¥ï¼‰
- ğŸŸ  **é‡è¦é—®é¢˜**: 3 ä¸ªï¼ˆç±»å‹é‡å¤ã€é”™è¯¯å¤„ç†ã€ç¯å¢ƒå˜é‡ï¼‰
- ğŸŸ¡ **ä¸€èˆ¬é—®é¢˜**: 4 ä¸ªï¼ˆè¾¹ç•Œå€¼ã€ç¡¬ç¼–ç ã€ä»£ç å¤æ‚ã€æ–‡æ¡£ï¼‰

### éœ€è¦ä¿®å¤

- **å¿…é¡»**: P0 çš„ 3 ä¸ªé—®é¢˜ï¼ˆå¦åˆ™åŠŸèƒ½ä¸å·¥ä½œï¼‰
- **åº”è¯¥**: P1 çš„ 3 ä¸ªé—®é¢˜ï¼ˆæé«˜ä»£ç è´¨é‡ï¼‰
- **å¯ä»¥**: P2-P3 çš„ 4 ä¸ªé—®é¢˜ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰

---

**è€æ¿ï¼Œè¿™æ˜¯æˆ‘ç³»ç»Ÿæ€§å®¡æŸ¥åçš„å‘ç°ï¼Œç‰¹åˆ«æ˜¯ P0 çš„ 3 ä¸ªé—®é¢˜éå¸¸ä¸¥é‡ï¼Œéœ€è¦ç«‹å³ä¿®å¤ã€‚**

**è¯·é—®è¦æˆ‘ç«‹å³ä¿®å¤è¿™äº›é—®é¢˜å—ï¼Ÿè¿˜æ˜¯å…ˆä¿®å¤å“ªäº›ï¼Ÿè¯·è€æ¿æŒ‡ç¤ºï¼** ğŸ™
