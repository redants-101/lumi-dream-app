# ğŸ“‹ æœ€ç»ˆéƒ¨ç½²æ£€æŸ¥æ¸…å•

**æ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: ä»£ç å®Œæˆï¼Œå¾…éƒ¨ç½²

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰

### æ­¥éª¤ 1: åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆ10 åˆ†é’Ÿï¼‰â­ å¿…é¡»

#### è¡¨ 1: user_subscriptionsï¼ˆå¦‚æœè¿˜æ²¡åˆ›å»ºï¼‰

```sql
-- æ–‡ä»¶ä½ç½®: docs/3.å®šä»·æ”¯ä»˜/Creemæ•°æ®åº“Schema.sql
-- æ‰§è¡Œä½ç½®: Supabase Dashboard â†’ SQL Editor

-- å¤åˆ¶æ•´ä¸ªæ–‡ä»¶å†…å®¹å¹¶æ‰§è¡Œ
```

#### è¡¨ 2: usage_tracking

```sql
-- æ–‡ä»¶ä½ç½®: docs/3.å®šä»·æ”¯ä»˜/usage_trackingè¡¨ç»“æ„.sql
-- æ‰§è¡Œä½ç½®: Supabase Dashboard â†’ SQL Editor

-- å¤åˆ¶æ•´ä¸ªæ–‡ä»¶å†…å®¹å¹¶æ‰§è¡Œ
```

#### è¡¨ 3: anonymous_usage

```sql
-- æ–‡ä»¶ä½ç½®: docs/3.å®šä»·æ”¯ä»˜/anonymous_usageè¡¨ç»“æ„.sql
-- æ‰§è¡Œä½ç½®: Supabase Dashboard â†’ SQL Editor

-- å¤åˆ¶æ•´ä¸ªæ–‡ä»¶å†…å®¹å¹¶æ‰§è¡Œ
```

#### éªŒè¯è¡¨åˆ›å»º

```sql
-- æ£€æŸ¥æ‰€æœ‰è¡¨
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('user_subscriptions', 'usage_tracking', 'anonymous_usage');

-- åº”è¯¥è¿”å› 3 è¡Œ
```

---

### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ5 åˆ†é’Ÿï¼‰â­ å¿…é¡»

æ£€æŸ¥ `.env.local` åŒ…å«ä»¥ä¸‹å˜é‡:

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=xxx
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx  # â­ å¿…é¡»ï¼ˆç”¨äº Webhookï¼‰

# OpenRouter
OPENROUTER_API_KEY=xxx

# Creem
CREEM_API_KEY=xxx
CREEM_WEBHOOK_SECRET=xxx
CREEM_BASIC_MONTHLY_PRODUCT_ID=xxx
CREEM_BASIC_YEARLY_PRODUCT_ID=xxx
CREEM_PRO_MONTHLY_PRODUCT_ID=xxx
CREEM_PRO_YEARLY_PRODUCT_ID=xxx

# App URL
NEXT_PUBLIC_APP_URL=https://www.lumidreams.app  # ç”Ÿäº§ç¯å¢ƒ
```

---

### æ­¥éª¤ 3: é‡å¯å¼€å‘æœåŠ¡å™¨ï¼ˆ1 åˆ†é’Ÿï¼‰

```bash
# åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)
# æ¸…é™¤ç¼“å­˜
rm -rf .next

# é‡æ–°å¯åŠ¨
pnpm dev
```

---

### æ­¥éª¤ 4: åŠŸèƒ½æµ‹è¯•ï¼ˆ20 åˆ†é’Ÿï¼‰

#### æµ‹è¯• 1: Anonymous ç”¨æˆ· IP é™æµ

```bash
# å¿«é€Ÿç‚¹å‡»"Interpret My Dream" 6 æ¬¡

é¢„æœŸ:
  - å‰ 5 æ¬¡: âœ… æˆåŠŸ
  - ç¬¬ 6 æ¬¡: âŒ "Too many requests"
  
æ—¥å¿—:
  [Interpret] Anonymous user IP: xxx.xxx.xxx.xxx
  [Interpret] âœ… IP limit check passed (hourly: 5/5)
  [Interpret] âŒ IP hourly limit reached
```

---

#### æµ‹è¯• 2: Free ç”¨æˆ·æ—¥é™åˆ¶

```bash
# Free ç”¨æˆ·ä½¿ç”¨ 6 æ¬¡è§£æ¢¦

é¢„æœŸ:
  - å‰ 5 æ¬¡: âœ… æˆåŠŸ
  - ç¬¬ 6 æ¬¡: âŒ "Daily limit reached"

æ—¥å¿—:
  [Interpret] âœ… Usage limit check passed: free (daily: 5/5)
  [Interpret] âŒ Daily limit reached: free (5/5)
```

---

#### æµ‹è¯• 3: æ•°æ®åŒæ­¥

```bash
# 1. ç™»å½•ç”¨æˆ·ä½¿ç”¨è§£æ¢¦ 3 æ¬¡
# 2. æŸ¥çœ‹ Supabase:
SELECT * FROM usage_tracking WHERE user_id = 'YOUR_USER_ID';

é¢„æœŸ:
  - daily_count = 3
  - monthly_count = 3

# 3. æ¸…é™¤æµè§ˆå™¨ localStorage
# 4. åˆ·æ–°é¡µé¢

é¢„æœŸ:
  - å³ä¸Šè§’ä»æ˜¾ç¤º "2 today â€¢ 7 this month"ï¼ˆä»æ•°æ®åº“åŒæ­¥ï¼‰

æ—¥å¿—:
  [Usage Limit V2] âœ… Synced from database
```

---

#### æµ‹è¯• 4: Pro ç”¨æˆ·é™çº§

```bash
# 1. åœ¨ Supabase æ‰‹åŠ¨è®¾ç½®:
UPDATE usage_tracking 
SET monthly_count = 100
WHERE user_id = 'YOUR_PRO_USER_ID';

# 2. Pro ç”¨æˆ·ä½¿ç”¨è§£æ¢¦

é¢„æœŸ:
  - è¿”å›è§£æç»“æœ
  - ä½¿ç”¨ Claude Haikuï¼ˆä¸æ˜¯ Sonnetï¼‰

æ—¥å¿—:
  [Interpret] ğŸ”„ Pro user downgraded (100/200, threshold: 100) â†’ anthropic/claude-3.5-haiku
```

---

### æ­¥éª¤ 5: é…ç½® Creem Webhookï¼ˆå¦‚æœè¿˜æ²¡é…ç½®ï¼‰

```
1. ç™»å½• Creem Dashboard
2. è¿›å…¥ Settings â†’ Webhooks
3. æ·»åŠ  Webhook URL: https://www.lumidreams.app/api/webhooks/creem
4. é€‰æ‹©äº‹ä»¶:
   - checkout.completed
   - subscription.created
   - subscription.updated
   - subscription.canceled
   - subscription.expired
```

---

## âœ… æ ¸å¿ƒåŠŸèƒ½æ£€æŸ¥è¡¨

### ç”¨æˆ·æƒç›Š

- [ ] Anonymous: 2/å¤©ï¼Œ4/æœˆï¼ŒClaude Haiku
- [ ] Free: 5/å¤©ï¼Œ10/æœˆï¼ŒClaude Haiku
- [ ] Basic: 10/å¤©ï¼Œ50/æœˆï¼ŒClaude Haiku
- [ ] Pro: 20/å¤©ï¼Œ200/æœˆï¼ŒClaude Sonnetï¼ˆå‰100æ¬¡ï¼‰

### é™åˆ¶éªŒè¯

- [ ] å‰ç«¯é™åˆ¶ï¼ˆlocalStorageï¼‰âœ…
- [ ] åç«¯é™åˆ¶ï¼ˆæ•°æ®åº“ï¼‰âœ…
- [ ] IP é™æµï¼ˆAnonymousï¼‰âœ…
- [ ] æ¢¦å¢ƒé•¿åº¦é™åˆ¶ âœ…

### æé†’ç³»ç»Ÿ

- [ ] æ—¥é™åˆ¶æé†’ï¼ˆæ¸©å’Œ + ç´§æ€¥ï¼‰
- [ ] æœˆé™åˆ¶æé†’ï¼ˆæ¸©å’Œ + ç´§æ€¥ï¼‰
- [ ] Pro é™çº§æç¤º
- [ ] ä¼˜å…ˆçº§é¿å…å†²çª

### AI æ¨¡å‹

- [ ] Anonymous: Claude Haiku
- [ ] Free: Claude Haiku
- [ ] Basic: Claude Haiku
- [ ] Pro: Claude Sonnet â†’ Haikuï¼ˆ100 æ¬¡åï¼‰

### æ”¯ä»˜æµç¨‹

- [ ] æœªç™»å½•ç‚¹å‡»è®¢é˜… â†’ å¼•å¯¼ç™»å½•
- [ ] ç™»å½•åè‡ªåŠ¨ç»§ç»­æ”¯ä»˜
- [ ] Webhook æ›´æ–°è®¢é˜…çŠ¶æ€
- [ ] Success é¡µé¢è½®è¯¢éªŒè¯

---

## ğŸ” å…³é”®éªŒè¯ç‚¹

### 1. æ•°æ®åŒæ­¥éªŒè¯

```
æ“ä½œ: ç™»å½•åä½¿ç”¨ 3 æ¬¡ï¼Œæ¸…é™¤ localStorageï¼Œåˆ·æ–°é¡µé¢
é¢„æœŸ: æ˜¾ç¤º "2 today â€¢ 7 this month"ï¼ˆæ•°æ®åº“åŒæ­¥ï¼‰âœ…
```

### 2. åç«¯éªŒè¯

```
æ“ä½œ: ç”¨ curl ç›´æ¥è°ƒç”¨ APIï¼ˆç»•è¿‡å‰ç«¯ï¼‰
é¢„æœŸ: è¶…è¿‡é™åˆ¶æ—¶è¿”å› 429 âœ…
```

### 3. Pro é™çº§

```
æ“ä½œ: è®¾ç½® monthly_count = 100ï¼Œä½¿ç”¨è§£æ¢¦
é¢„æœŸ: ä½¿ç”¨ Claude Haikuï¼Œè¿”å› isDowngraded: true âœ…
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: è¡¨åˆ›å»ºå¤±è´¥ï¼Ÿ

**å¯èƒ½åŸå› **: 
- service_role key æœªé…ç½®
- SQL è¯­æ³•é”™è¯¯

**è§£å†³**:
```sql
-- æ£€æŸ¥æƒé™
SELECT current_user, current_database();

-- é€è¡Œæ‰§è¡Œ SQLï¼Œæ‰¾å‡ºé”™è¯¯è¡Œ
```

---

### Q2: Webhook ä¸å·¥ä½œï¼Ÿ

**æ£€æŸ¥**:
1. Creem Dashboard â†’ Webhooks â†’ Events
2. æŸ¥çœ‹çŠ¶æ€ç ï¼ˆåº”è¯¥æ˜¯ 200ï¼‰
3. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯

---

### Q3: å‰ç«¯æ˜¾ç¤ºä¸æ›´æ–°ï¼Ÿ

**å¯èƒ½åŸå› **: 
- API è¿”å›é”™è¯¯
- syncUsageFromDatabase æœªè°ƒç”¨

**æ£€æŸ¥**: 
```javascript
// æµè§ˆå™¨æ§åˆ¶å°
localStorage.getItem('lumi_usage_data_v2')
```

---

## ğŸ“Š å®Œæˆç»Ÿè®¡

### ä»Šæ—¥å·¥ä½œé‡

- **ä»£ç å˜æ›´**: ~500 è¡Œ
- **æ–°å»ºæ–‡ä»¶**: 8 ä¸ª
- **ä¿®æ”¹æ–‡ä»¶**: 10 ä¸ª
- **åˆ›å»ºæ–‡æ¡£**: 20+ ä»½
- **å·¥ä½œæ—¶é—´**: çº¦ 6 å°æ—¶

### è´¨é‡æŒ‡æ ‡

- âœ… Linter é”™è¯¯: 0
- âœ… TypeScript é”™è¯¯: 0
- âœ… æµ‹è¯•è¦†ç›–: å¾…æ‰§è¡Œ
- âœ… æ–‡æ¡£å®Œæ•´: 100%

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ç«‹å³**: åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆ10 åˆ†é’Ÿï¼‰
2. **ä»Šå¤©**: å®Œæ•´æµ‹è¯•ï¼ˆ30 åˆ†é’Ÿï¼‰
3. **æ˜å¤©**: éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
4. **æœ¬å‘¨**: ç›‘æ§æ•°æ®å’Œæˆæœ¬

---

**è€æ¿ï¼Œæ‰€æœ‰ä»£ç å·²å®Œæˆï¼Œç­‰å¾…ä½ åˆ›å»ºæ•°æ®åº“è¡¨åå°±èƒ½éƒ¨ç½²äº†ï¼** ğŸš€âœ…

