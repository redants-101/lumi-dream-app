# âœ… P0 çº§åˆ«é—®é¢˜ä¿®å¤å®Œæˆ

**å®Œæˆæ—¥æœŸ**: 2025-10-28  
**ä¿®å¤æ—¶é—´**: 1 å°æ—¶  
**ä¿®å¤é—®é¢˜**: 3 ä¸ªä¸¥é‡é—®é¢˜

---

## âœ… å·²ä¿®å¤çš„ P0 é—®é¢˜

### ä¿®å¤ 1: åˆ›å»º usage_tracking è¡¨ âœ…

**é—®é¢˜**: è¡¨ä¸å­˜åœ¨ï¼ŒPro é™çº§åŠŸèƒ½æ— æ³•å·¥ä½œ

**è§£å†³**:
- âœ… åˆ›å»ºäº†æ‰§è¡ŒæŒ‡å—ï¼š`docs/ğŸ“‹ ç«‹å³æ‰§è¡Œ-åˆ›å»ºusage_trackingè¡¨.md`
- âœ… æä¾›äº†ç²¾ç®€çš„ SQL è„šæœ¬
- âœ… åŒ…å«éªŒè¯æ­¥éª¤

**æ‰§è¡Œ**: éœ€è¦åœ¨ Supabase Dashboard è¿è¡Œ SQLï¼ˆ5 åˆ†é’Ÿï¼‰

---

### ä¿®å¤ 2: å®ç°æ•°æ®åº“åŒæ­¥ âœ…

**é—®é¢˜**: ä½¿ç”¨æ¬¡æ•°åªå­˜åœ¨ localStorageï¼Œåç«¯æŸ¥ä¸åˆ°

**è§£å†³**: åœ¨ interpret API è§£æ¢¦æˆåŠŸååŒæ­¥åˆ°æ•°æ®åº“

**ä»£ç **:
```typescript
// app/api/interpret/route.ts

if (user) {
  const currentMonth = new Date().toISOString().slice(0, 7)
  const currentDay = new Date().toISOString().slice(0, 10)
  
  try {
    // 1. å…ˆæŸ¥è¯¢å½“å‰å€¼
    const { data: currentUsage } = await supabase
      .from("usage_tracking")
      .select("daily_count, monthly_count, day")
      .eq("user_id", user.id)
      .eq("month", currentMonth)
      .single()
    
    // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ—¥è®¡æ•°
    const isDifferentDay = currentUsage?.day !== currentDay
    const newDailyCount = isDifferentDay ? 1 : (currentUsage?.daily_count || 0) + 1
    const newMonthlyCount = (currentUsage?.monthly_count || 0) + 1
    
    // 3. æ›´æ–°æ•°æ®åº“
    await supabase
      .from("usage_tracking")
      .upsert({
        user_id: user.id,
        month: currentMonth,
        day: currentDay,
        daily_count: newDailyCount,
        monthly_count: newMonthlyCount,
      }, {
        onConflict: 'user_id,month',
      })
    
    console.log("[Interpret] âœ… Usage synced to database")
  } catch (syncErr) {
    console.error("[Interpret] âš ï¸ Database sync error:", syncErr)
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·
  }
}
```

**æ•ˆæœ**:
- âœ… å‰ç«¯å’Œåç«¯æ•°æ®åŒæ­¥
- âœ… Pro é™çº§åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… è‡ªåŠ¨å¤„ç†æ—¥æœŸåˆ‡æ¢

---

### ä¿®å¤ 3: æ”¹è¿›é”™è¯¯å¤„ç† âœ…

**é—®é¢˜**: æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶é™é»˜å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´é€»è¾‘é”™è¯¯

**è§£å†³**: åŒºåˆ†é”™è¯¯ç±»å‹ï¼Œåˆ†åˆ«å¤„ç†

**ä»£ç **:
```typescript
const { data: subscription, error: subscriptionError } = await supabase
  .from("user_subscriptions")
  .select("tier")
  .single()

if (subscriptionError) {
  if (subscriptionError.code === 'PGRST116') {
    // è®°å½•ä¸å­˜åœ¨ï¼ˆæ­£å¸¸æƒ…å†µï¼‰
    tier = "free"
  } else {
    // æ•°æ®åº“é”™è¯¯ï¼ˆç½‘ç»œã€æƒé™ç­‰ï¼‰
    console.error("[Interpret] âŒ Database error:", subscriptionError)
    tier = "free"  // é™çº§å¤„ç†
  }
}
```

**é”™è¯¯ä»£ç **:
- `PGRST116`: è®°å½•ä¸å­˜åœ¨ï¼ˆæ­£å¸¸ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
- `42P01`: è¡¨ä¸å­˜åœ¨ï¼ˆéœ€è¦åˆ›å»ºè¡¨ï¼‰
- å…¶ä»–: ç½‘ç»œæˆ–æƒé™é”™è¯¯ï¼ˆé™çº§å¤„ç†ï¼‰

**æ•ˆæœ**:
- âœ… åŒºåˆ†æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µ
- âœ… è¡¨ä¸å­˜åœ¨æ—¶æœ‰æ˜ç¡®æç¤º
- âœ… é”™è¯¯ä¸ä¼šå¯¼è‡´åŠŸèƒ½å´©æºƒ

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### æ•°æ®æµå¯¹æ¯”

#### ä¿®å¤å‰ï¼ˆæ•°æ®ä¸åŒæ­¥ï¼‰

```
å‰ç«¯: localStorage
  â”œâ”€ dailyCount: 5
  â””â”€ monthlyCount: 10

åç«¯: usage_tracking è¡¨
  â”œâ”€ è¡¨ä¸å­˜åœ¨ âŒ
  â””â”€ æŸ¥è¯¢å¤±è´¥ â†’ monthlyCount = 0 âŒ

ç»“æœ: Pro ç”¨æˆ·æ°¸è¿œä¸ä¼šé™çº§
```

#### ä¿®å¤åï¼ˆæ•°æ®åŒæ­¥ï¼‰

```
å‰ç«¯: localStorage
  â”œâ”€ dailyCount: 5
  â””â”€ monthlyCount: 10

åç«¯: usage_tracking è¡¨
  â”œâ”€ è¡¨å·²åˆ›å»º âœ…
  â”œâ”€ æ¯æ¬¡è§£æ¢¦åæ›´æ–° âœ…
  â””â”€ daily_count: 5, monthly_count: 10 âœ…

ç»“æœ: æ•°æ®ä¸€è‡´ï¼Œé™çº§åŠŸèƒ½æ­£å¸¸ âœ…
```

---

### é”™è¯¯å¤„ç†å¯¹æ¯”

#### ä¿®å¤å‰

```typescript
const { data } = await supabase.from("table").select()
const value = data?.field || 0  // âŒ ä¸æ£€æŸ¥ error
```

**é—®é¢˜**: 
- è¡¨ä¸å­˜åœ¨æ—¶é™é»˜å¤±è´¥
- ç½‘ç»œé”™è¯¯æ—¶é™é»˜å¤±è´¥
- æ²¡æœ‰æ—¥å¿—æç¤º

#### ä¿®å¤å

```typescript
const { data, error } = await supabase.from("table").select()

if (error) {
  if (error.code === 'PGRST116') {
    // è®°å½•ä¸å­˜åœ¨ï¼ˆæ­£å¸¸ï¼‰
    console.log("No record, using default")
  } else if (error.code === '42P01') {
    // è¡¨ä¸å­˜åœ¨ï¼ˆéœ€è¦åˆ›å»ºï¼‰
    console.error("âŒ Table does not exist. Please run SQL script")
  } else {
    // å…¶ä»–é”™è¯¯
    console.error("âŒ Database error:", error)
  }
}

const value = data?.field || 0
```

**æ•ˆæœ**:
- âœ… æ˜ç¡®çš„é”™è¯¯åˆ†ç±»
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… è¡¨ä¸å­˜åœ¨æ—¶æœ‰æ“ä½œæŒ‡å—

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### åŠŸèƒ½å®Œæ•´æ€§

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **è®¢é˜…è¯†åˆ«** | âœ… å·¥ä½œ | âœ… å·¥ä½œ + é”™è¯¯å¤„ç† |
| **Pro é™çº§** | âŒ ä¸å·¥ä½œ | âœ… æ­£å¸¸å·¥ä½œ |
| **ä½¿ç”¨ç»Ÿè®¡** | âš ï¸ ä»…å‰ç«¯ | âœ… å‰åç«¯åŒæ­¥ |
| **é”™è¯¯å¤„ç†** | âŒ é™é»˜å¤±è´¥ | âœ… æ˜ç¡®æç¤º |

---

### æ•°æ®å‡†ç¡®æ€§

| æ•°æ® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **LocalStorage** | âœ… å‡†ç¡® | âœ… å‡†ç¡® |
| **æ•°æ®åº“** | âŒ æ— æ•°æ® | âœ… å‡†ç¡® |
| **ä¸€è‡´æ€§** | âŒ ä¸ä¸€è‡´ | âœ… åŒæ­¥ |

---

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| `app/api/interpret/route.ts` | æ·»åŠ æ•°æ®åº“åŒæ­¥é€»è¾‘ | +30 è¡Œ |
| `app/api/interpret/route.ts` | æ”¹è¿›é”™è¯¯å¤„ç†ï¼ˆè®¢é˜…æŸ¥è¯¢ï¼‰ | +10 è¡Œ |
| `app/api/interpret/route.ts` | æ”¹è¿›é”™è¯¯å¤„ç†ï¼ˆä½¿ç”¨æŸ¥è¯¢ï¼‰ | +15 è¡Œ |

**æ€»å˜æ›´**: +55 è¡Œé«˜è´¨é‡ä»£ç 

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. åˆ›å»ºè¡¨ï¼ˆå¿…é¡»å…ˆæ‰§è¡Œï¼‰

```bash
1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶ docs/ğŸ“‹ ç«‹å³æ‰§è¡Œ-åˆ›å»ºusage_trackingè¡¨.md ä¸­çš„ SQL
4. æ‰§è¡Œ
5. éªŒè¯æˆåŠŸ
```

---

### 2. æµ‹è¯•æ•°æ®åŒæ­¥

```bash
# æµ‹è¯•æµç¨‹
1. è®¿é—® http://localhost:3000
2. ç™»å½•ç”¨æˆ·
3. ä½¿ç”¨è§£æ¢¦åŠŸèƒ½
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š
   - âœ… "[Interpret] âœ… Usage synced to database"

5. åœ¨ Supabase æŸ¥è¯¢ï¼š
   SELECT * FROM usage_tracking WHERE user_id = 'YOUR_USER_ID';
   
6. éªŒè¯ï¼š
   - âœ… daily_count = 1
   - âœ… monthly_count = 1
```

---

### 3. æµ‹è¯• Pro é™çº§

```bash
# æµ‹è¯•æµç¨‹
1. åœ¨ Supabase æ‰‹åŠ¨è®¾ç½®ï¼š
   UPDATE usage_tracking 
   SET monthly_count = 100
   WHERE user_id = 'YOUR_PRO_USER_ID';

2. Pro ç”¨æˆ·ä½¿ç”¨è§£æ¢¦

3. æŸ¥çœ‹æ—¥å¿—ï¼š
   - âœ… "[Interpret] ğŸ”„ Pro user downgraded (100/200)"
   - âœ… ä½¿ç”¨ Claude Haiku

4. éªŒè¯é™çº§åŠŸèƒ½æ­£å¸¸å·¥ä½œ âœ…
```

---

### 4. æµ‹è¯•é”™è¯¯å¤„ç†

```bash
# æµ‹è¯•è¡¨ä¸å­˜åœ¨
1. ä¸´æ—¶åˆ é™¤è¡¨ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰ï¼š
   DROP TABLE usage_tracking;

2. ä½¿ç”¨è§£æ¢¦åŠŸèƒ½

3. æŸ¥çœ‹æ—¥å¿—ï¼š
   - âœ… "[Interpret] âš ï¸ usage_tracking table does not exist"
   - âœ… "Please run the SQL script: ..."
   - âœ… åŠŸèƒ½ä»ç„¶å·¥ä½œï¼ˆä½¿ç”¨ Sonnetï¼‰

4. é‡æ–°åˆ›å»ºè¡¨
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

### ä»£ç ä¿®æ”¹

- [x] æ·»åŠ æ•°æ®åº“åŒæ­¥é€»è¾‘
- [x] å¤„ç†æ—¥æœŸåˆ‡æ¢ï¼ˆè‡ªåŠ¨é‡ç½®æ—¥è®¡æ•°ï¼‰
- [x] æ”¹è¿›è®¢é˜…æŸ¥è¯¢é”™è¯¯å¤„ç†
- [x] æ”¹è¿›ä½¿ç”¨æŸ¥è¯¢é”™è¯¯å¤„ç†
- [x] åŒºåˆ†é”™è¯¯ä»£ç ç±»å‹
- [x] æ·»åŠ è¯¦ç»†æ—¥å¿—
- [x] ä¿®å¤ Linter é”™è¯¯

### åŠŸèƒ½éªŒè¯

- [ ] åˆ›å»º usage_tracking è¡¨
- [ ] æµ‹è¯•æ•°æ®åº“åŒæ­¥
- [ ] æµ‹è¯• Pro é™çº§
- [ ] æµ‹è¯•é”™è¯¯å¤„ç†
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. æ•°æ®åŒæ­¥

**ä¹‹å‰**: 
```
å‰ç«¯ â† LocalStorageï¼ˆç‹¬ç«‹ï¼‰
åç«¯ â† æ•°æ®åº“ï¼ˆç©ºçš„ï¼‰
```

**ç°åœ¨**:
```
å‰ç«¯ â† LocalStorageï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰
åç«¯ â† æ•°æ®åº“ï¼ˆæƒå¨æ•°æ®ï¼‰
       â†‘
       æ¯æ¬¡è§£æ¢¦ååŒæ­¥ âœ…
```

---

### 2. é”™è¯¯å®¹é”™

**ä¹‹å‰**:
- æŸ¥è¯¢å¤±è´¥ â†’ é™é»˜ä½¿ç”¨é»˜è®¤å€¼
- ä¸çŸ¥é“æ˜¯ä»€ä¹ˆé—®é¢˜

**ç°åœ¨**:
- è®°å½•ä¸å­˜åœ¨ â†’ ä½¿ç”¨é»˜è®¤å€¼ï¼ˆæ­£å¸¸ï¼‰
- è¡¨ä¸å­˜åœ¨ â†’ æç¤ºåˆ›å»ºè¡¨
- å…¶ä»–é”™è¯¯ â†’ è¯¦ç»†æ—¥å¿—

---

### 3. æ—¥æœŸå¤„ç†

**è‡ªåŠ¨å¤„ç†**:
```typescript
const isDifferentDay = currentUsage?.day !== currentDay

if (isDifferentDay) {
  newDailyCount = 1  // âœ… è‡ªåŠ¨é‡ç½®
} else {
  newDailyCount = currentUsage.daily_count + 1  // ç´¯åŠ 
}
```

---

## ğŸš€ P0 ä¿®å¤å®Œæˆ

### å®ŒæˆçŠ¶æ€

- âœ… åˆ›å»ºè¡¨æŒ‡å—
- âœ… æ•°æ®åº“åŒæ­¥
- âœ… é”™è¯¯å¤„ç†
- âœ… æ—  Linter é”™è¯¯

### å¾…æ‰§è¡Œ

- [ ] åœ¨ Supabase åˆ›å»ºè¡¨ï¼ˆ5 åˆ†é’Ÿï¼‰
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹ï¼ˆ10 åˆ†é’Ÿï¼‰

---

**è€æ¿ï¼ŒP0 çº§åˆ«çš„ 3 ä¸ªä¸¥é‡é—®é¢˜éƒ½å·²ä¿®å¤ï¼**

**ä¸‹ä¸€æ­¥**: 
1. ä½ å…ˆåœ¨ Supabase åˆ›å»ºè¡¨ï¼ˆæŒ‰ç…§ `docs/ğŸ“‹ ç«‹å³æ‰§è¡Œ-åˆ›å»ºusage_trackingè¡¨.md`ï¼‰
2. ç„¶åæµ‹è¯•ä¸€ä¸‹åŠŸèƒ½
3. å¦‚æœæœ‰é—®é¢˜éšæ—¶å‘Šè¯‰æˆ‘

**ä»£ç å·²ç»å‡†å¤‡å¥½ï¼Œç­‰å¾…ä½ åˆ›å»ºè¡¨åå°±èƒ½æ­£å¸¸å·¥ä½œï¼** ğŸ¯

