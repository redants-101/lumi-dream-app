# 🧪 混合模式测试指南

## 快速验证前后端数据同步机制

---

## 🎯 测试目标

验证混合模式是否正确工作：
- ✅ 前端快速响应（使用 localStorage）
- ✅ 后端作为权威（防止滥用）
- ✅ 自动同步修正（不一致时）

---

## 🚀 核心测试场景

### 场景 1：正常使用（基准测试）

#### 测试步骤
```bash
1. 打开无痕模式浏览器
2. 访问：http://localhost:3000
3. 输入梦境 → 点击解析
4. 观察右上角显示："1 of 2 left today"
5. 再次输入梦境 → 点击解析
6. 观察显示："Daily limit reached"
```

#### 预期结果
- ✅ 第 1 次：成功，显示 "1/2"
- ✅ 第 2 次：成功，显示 "2/2"
- ✅ 第 3 次：被拒绝，显示错误提示

#### 验证点
- [ ] 前端显示剩余次数正确
- [ ] 第 3 次请求被后端拒绝
- [ ] 错误消息友好清晰

---

### 场景 2：清除缓存自动修正（关键）

#### 测试步骤
```bash
1. 先完成场景 1（使用 2 次）
2. F12 → Application → Storage → Clear site data
3. 刷新页面
4. 观察右上角显示："0 of 2 left today" ⚠️（不准确）
5. 输入梦境 → 点击解析
6. 观察前端自动更新为："Daily limit reached" ✅
```

#### 预期结果
- ⚠️ 清除缓存后：前端显示 "0/2"（临时不准确）
- ✅ 提交后：后端拒绝
- ✅ 自动同步：前端更新为 "2/2 已用完"

#### 验证点
- [ ] 清除缓存后前端显示重置
- [ ] 后端仍然拦截请求
- [ ] **前端自动同步后端真实数据**
- [ ] 控制台显示同步日志

#### 控制台日志示例
```
[Home] 🔄 Syncing usage from error response: { daily: 2, monthly: 4 }
[Usage Limit V2] ✅ Synced from API response: { dailyCount: 2, date: '2025-10-30', monthlyCount: 4, month: '2025-10' }
```

---

### 场景 3：换浏览器（跨设备同步）

#### 测试步骤
```bash
1. Chrome 无痕模式使用 2 次（达到限制）
2. 打开 Firefox 无痕模式（同一 IP）
3. 访问：http://localhost:3000
4. 观察显示："0 of 2 left today" ⚠️（新浏览器，无缓存）
5. 输入梦境 → 点击解析
6. 观察前端自动更新为："Daily limit reached" ✅
```

#### 预期结果
- ⚠️ 新浏览器：前端显示 "0/2"（无 localStorage）
- ✅ 提交后：后端拒绝（同 IP）
- ✅ 自动同步：前端显示正确限制

#### 验证点
- [ ] 跨浏览器 IP 限制生效
- [ ] 前端自动同步后端数据
- [ ] 用户看到正确的限制提示

---

### 场景 4：换网络（IP 变化）

#### 测试步骤
```bash
1. WiFi 网络使用 2 次（前端显示 2/2）
2. 切换到手机热点（新 IP）
3. 刷新页面
4. 观察显示："2 of 2 used" ⚠️（旧数据）
5. 输入梦境 → 点击解析
6. 成功解析 ✅
7. 观察前端更新为："1 of 2 left today" ✅
```

#### 预期结果
- ⚠️ 换网络前：前端显示 "2/2"（旧 IP 的数据）
- ✅ 换网络后：后端允许（新 IP）
- ✅ 自动同步：前端更新为 "1/2"（新 IP 的真实数据）

#### 验证点
- [ ] 新 IP 有独立的限制额度
- [ ] 成功请求后自动同步
- [ ] 前端显示新 IP 的真实使用情况

---

### 场景 5：月限制测试

#### 测试步骤
```bash
1. 第一天使用 2 次（日限制）
2. 等待第二天或手动重置日期
3. 第二天使用 2 次（月累计：4 次）
4. 尝试第 5 次使用
5. 观察月限制提示
```

#### 预期结果
- ✅ 第一天：2 次后日限制
- ✅ 第二天：可以再用 2 次
- ✅ 第 5 次：月限制触发

#### 验证点
- [ ] 日限制每天重置
- [ ] 月累计正确统计
- [ ] 月限制正确触发

---

## 🔍 数据库验证

### 查看 IP 使用记录
```sql
-- 查看今日所有 IP 使用情况
SELECT 
  ip_address,
  date,
  hour,
  count,
  updated_at
FROM anonymous_usage
WHERE date = CURRENT_DATE
ORDER BY ip_address, hour;

-- 统计每个 IP 的日总数
SELECT 
  ip_address,
  date,
  SUM(count) as daily_total
FROM anonymous_usage
WHERE date = CURRENT_DATE
GROUP BY ip_address, date;

-- 统计每个 IP 的月总数
SELECT 
  ip_address,
  DATE_TRUNC('month', date::date) as month,
  SUM(count) as monthly_total
FROM anonymous_usage
WHERE date >= DATE_TRUNC('month', CURRENT_DATE)::date
GROUP BY ip_address, month;
```

### 查看您的 IP 地址
访问：http://localhost:3000/api/usage
查看响应中的 IP 信息（开发环境可能显示为 `::1` 或 `127.0.0.1`）

---

## 🧪 手动 API 测试

### PowerShell 脚本
```powershell
# 测试变量
$apiUrl = "http://localhost:3000/api/interpret"
$dream = "I was flying over a beautiful ocean"

# 请求体
$body = @{ dream = $dream } | ConvertTo-Json

# 测试函数
function Test-DreamAPI {
    param([int]$attemptNumber)
    
    Write-Host "`n=== 测试 $attemptNumber ===" -ForegroundColor Cyan
    
    try {
        $response = Invoke-WebRequest -Uri $apiUrl -Method POST -Body $body -ContentType "application/json" -UseBasicParsing
        $result = $response.Content | ConvertFrom-Json
        
        Write-Host "✅ 成功 ($($response.StatusCode))" -ForegroundColor Green
        
        if ($result.metadata.currentUsage) {
            Write-Host "使用情况：$($result.metadata.currentUsage.daily)/$($result.metadata.currentUsage.limits.daily) (日)" -ForegroundColor Yellow
            Write-Host "月累计：$($result.metadata.currentUsage.monthly)/$($result.metadata.currentUsage.limits.monthly)" -ForegroundColor Yellow
        }
    } catch {
        $statusCode = $_.Exception.Response.StatusCode.value__
        $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
        $errorBody = $reader.ReadToEnd() | ConvertFrom-Json
        
        Write-Host "❌ 失败 ($statusCode)" -ForegroundColor Red
        Write-Host "错误：$($errorBody.error.message)" -ForegroundColor Red
        
        if ($errorBody.error.details.currentUsage) {
            Write-Host "使用情况：$($errorBody.error.details.currentUsage.daily)/$($errorBody.error.details.limits.daily) (日)" -ForegroundColor Yellow
            Write-Host "月累计：$($errorBody.error.details.currentUsage.monthly)/$($errorBody.error.details.limits.monthly)" -ForegroundColor Yellow
        }
    }
    
    Start-Sleep -Seconds 2
}

# 执行测试
1..3 | ForEach-Object { Test-DreamAPI $_ }
```

---

## 📊 前端状态检查

### 检查 localStorage
```javascript
// 在浏览器控制台执行
localStorage.getItem('lumi_usage_data_v2')

// 预期输出示例：
// {"dailyCount":2,"date":"2025-10-30","monthlyCount":4,"month":"2025-10"}
```

### 清除 localStorage
```javascript
// 手动清除（用于测试）
localStorage.removeItem('lumi_usage_data_v2')
```

### 监控同步日志
```javascript
// 打开控制台，筛选日志
// 搜索：[Home] 🔄 Syncing
// 或：[Usage Limit V2] ✅ Synced
```

---

## ✅ 验证清单

### 功能验证
- [ ] 正常使用流程（场景 1）
- [ ] 清除缓存自动修正（场景 2）
- [ ] 跨浏览器同步（场景 3）
- [ ] 换网络修正（场景 4）
- [ ] 月限制统计（场景 5）

### 同步机制验证
- [ ] 成功响应时同步使用数据
- [ ] 错误响应时同步使用数据
- [ ] 控制台日志正确输出
- [ ] localStorage 正确更新

### 用户体验验证
- [ ] 前端响应快速（无延迟感）
- [ ] 错误提示友好清晰
- [ ] 限制提示准确及时
- [ ] 不一致时自动修正（对用户透明）

---

## 🐛 常见问题排查

### 问题 1：同步不生效
```bash
症状：清除缓存后，前端仍显示旧数据

检查：
1. 控制台是否有同步日志？
   → 搜索 "[Home] 🔄 Syncing"
2. API 响应是否包含 currentUsage？
   → 检查 Network 面板
3. syncFromResponse 方法是否正确调用？
   → 添加断点调试
```

### 问题 2：后端不拦截
```bash
症状：使用超过 2 次仍然成功

检查：
1. 后端是否正确获取 IP？
   → 查看服务器日志
2. 数据库是否正确记录？
   → 执行 SQL 查询
3. 限制配置是否正确？
   → 检查 usage-limits.ts
```

### 问题 3：前端显示不更新
```bash
症状：同步后前端显示未变化

检查：
1. React 状态是否更新？
   → 检查 usageData 状态
2. localStorage 是否更新？
   → 执行 localStorage.getItem(...)
3. 组件是否重新渲染？
   → 使用 React DevTools
```

---

## 🔄 重置测试环境

### 清空所有匿名使用数据
```sql
-- ⚠️ 谨慎：清空所有匿名用户数据
TRUNCATE TABLE anonymous_usage;
```

### 清空特定 IP 数据
```sql
-- 清空您的 IP 数据（用于重新测试）
DELETE FROM anonymous_usage 
WHERE ip_address = '你的IP地址';
```

### 清空今日数据
```sql
-- 只清空今天的数据
DELETE FROM anonymous_usage 
WHERE date = CURRENT_DATE;
```

---

## 📝 测试报告模板

```markdown
## 混合模式测试报告

**测试日期**：2025-10-30  
**测试人**：[你的名字]  
**测试环境**：本地开发

### 场景测试结果

#### ✅ 场景 1：正常使用
- 第 1 次使用：✅ 成功
- 第 2 次使用：✅ 成功
- 第 3 次使用：✅ 被拒绝
- 前端显示：✅ 正确

#### ✅ 场景 2：清除缓存自动修正
- 清除缓存前：✅ 显示 2/2
- 清除缓存后：✅ 显示 0/2（预期）
- 提交后：✅ 后端拒绝
- 自动同步：✅ 前端更新为 2/2
- 控制台日志：✅ 显示同步信息

#### ✅ 场景 3：换浏览器
- 跨浏览器限制：✅ 生效
- 自动同步：✅ 正常

#### ✅ 场景 4：换网络
- IP 独立限制：✅ 正确
- 自动修正：✅ 正常

### 发现的问题
1. [如有问题，在此列出]

### 总结
✅ 所有测试通过，混合模式工作正常
```

---

## 🎯 性能基准

### 响应时间
- 前端显示更新：< 50ms（localStorage）
- API 请求：< 500ms（正常）
- 同步操作：< 10ms（setState + localStorage）

### 用户体验
- ✅ 前端响应即时（无感知延迟）
- ✅ 自动同步透明（用户无感）
- ✅ 错误提示清晰（友好）

---

## 🚀 下一步

测试通过后：
1. ✅ 提交代码到 Git
2. ✅ 部署到 Vercel
3. ✅ 监控生产环境数据
4. ✅ 观察用户行为（是否有绕过尝试）

---

**祝测试顺利！** 🎉

如果遇到任何问题，请参考 `docs/✅ 混合模式实施完成.md` 了解实现细节。

