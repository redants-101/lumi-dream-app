# âœ… Pro ç”¨æˆ·æˆæœ¬ä¼˜åŒ–å®Œæˆ

**å®Œæˆæ—¥æœŸ**: 2025-10-28  
**ä¼˜åŒ–æ–¹æ¡ˆ**: æ™ºèƒ½é™çº§ç­–ç•¥

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### é—®é¢˜ï¼šPro ç”¨æˆ·æˆæœ¬å¤±æ§

**ä¿®æ”¹å‰**:
- Pro ç”¨æˆ·: 200 æ¬¡/æœˆ Ã— $0.06/æ¬¡ (Claude Sonnet)
- AI æˆæœ¬: **$12.00**
- æ€»æˆæœ¬: **$12.50** (å«åŸºç¡€è®¾æ–½)
- æ”¶å…¥: $9.99
- **åˆ©æ¶¦: -$2.51** âŒ (äºæŸ 25%)

---

## âœ… å®æ–½çš„ä¼˜åŒ–æ–¹æ¡ˆï¼šæ™ºèƒ½é™çº§

### æ ¸å¿ƒç­–ç•¥

```
Pro ç”¨æˆ·æ¯æœˆ 200 æ¬¡é¢åº¦ï¼š
â”œâ”€ å‰ 100 æ¬¡: Claude Sonnet  ğŸ”¥ (é«˜ç«¯ä½“éªŒ)
â””â”€ å 100 æ¬¡: Claude Haiku   âœ… (èŠ‚çœæˆæœ¬)
```

### é™çº§é€»è¾‘

```typescript
if (tier === "pro" && monthlyCount >= 100) {
  modelId = "anthropic/claude-3.5-haiku"  // é™çº§
  isDowngraded = true
} else {
  modelId = "anthropic/claude-3.5-sonnet" // é«˜ç«¯æ¨¡å‹
}
```

---

## ğŸ“Š æˆæœ¬æ•ˆæœåˆ†æ

### ä¿®æ”¹åçš„æˆæœ¬ç»“æ„

| é˜¶æ®µ | ä½¿ç”¨æ¬¡æ•° | æ¨¡å‹ | å•ä»· | æˆæœ¬ |
|------|---------|------|------|------|
| **å‰ 100 æ¬¡** | 100 | Claude Sonnet | $0.06 | $6.00 |
| **å 100 æ¬¡** | 100 | Claude Haiku | $0.02 | $2.00 |
| **åˆè®¡** | 200 | - | - | **$8.00** |

**å®Œæ•´æˆæœ¬**:
- AI æˆæœ¬: $8.00
- åŸºç¡€è®¾æ–½: $0.50
- **æ€»æˆæœ¬: $8.50**

**ç›ˆåˆ©åˆ†æ**:
- æ”¶å…¥: $9.99
- æˆæœ¬: $8.50
- **åˆ©æ¶¦: $1.49** âœ…
- **åˆ©æ¶¦ç‡: 15%** âœ…

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|--------|--------|------|
| AI æˆæœ¬ | $12.00 | **$8.00** | -$4.00 (-33%) |
| æ€»æˆæœ¬ | $12.50 | **$8.50** | -$4.00 (-32%) |
| åˆ©æ¶¦ | -$2.51 âŒ | **$1.49** âœ… | +$4.00 |
| åˆ©æ¶¦ç‡ | -25% | **15%** | +40% |
| çŠ¶æ€ | äºæŸ | **ç›ˆåˆ©** | âœ… |

---

## ğŸ”§ å®æ–½ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶

**`app/api/interpret/route.ts`**

#### 1. æŸ¥è¯¢ç”¨æˆ·æœ¬æœˆä½¿ç”¨æ¬¡æ•°

```typescript
if (tier === "pro" && user) {
  const { data: usageData } = await supabase
    .from("usage_tracking")
    .select("monthly_count")
    .eq("user_id", user.id)
    .eq("month", new Date().toISOString().slice(0, 7))  // "2025-10"
    .single()
  
  const monthlyCount = usageData?.monthly_count || 0
  // ...
}
```

#### 2. æ ¹æ®ä½¿ç”¨æ¬¡æ•°å†³å®šæ¨¡å‹

```typescript
if (monthlyCount >= 100) {
  modelId = "anthropic/claude-3.5-haiku"  // é™çº§
  isDowngraded = true
  console.log(`[Interpret] ğŸ”„ Pro user downgraded (${monthlyCount}/200 used)`)
} else {
  console.log(`[Interpret] ğŸš€ Pro user using premium model (${monthlyCount}/100)`)
}
```

#### 3. è®°å½•é™çº§çŠ¶æ€

```typescript
// æ—¥å¿—ä¸­è®°å½•
console.log("[Lumi] AI Interpretation Stats:", {
  userTier: tier,
  model: modelId,
  isDowngraded: isDowngraded,  // âœ… è®°å½•æ˜¯å¦é™çº§
  // ...
})

// è¿”å›ç»™å‰ç«¯
return Response.json({
  interpretation: result.text,
  metadata: {
    userTier: tier,
    model: modelId,
    isDowngraded: isDowngraded,  // âœ… å‰ç«¯å¯ä»¥çŸ¥é“æ˜¯å¦é™çº§
    // ...
  },
})
```

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒè®¾è®¡

### Pro ç”¨æˆ·çš„ä½¿ç”¨æµç¨‹

#### å‰ 100 æ¬¡ï¼ˆé«˜ç«¯ä½“éªŒï¼‰

```
Pro ç”¨æˆ·è¯·æ±‚è§£æ¢¦ (ç¬¬ 50 æ¬¡)
    â†“
æŸ¥è¯¢ä½¿ç”¨æ¬¡æ•°: 50/200
    â†“
åˆ¤æ–­: 50 < 100 â†’ ä½¿ç”¨ Sonnet âœ…
    â†“
è¿”å›é«˜è´¨é‡è§£æ + metadata: { isDowngraded: false }
```

**ç”¨æˆ·æ„ŸçŸ¥**:
- ğŸ”¥ è·å¾—æœ€é«˜è´¨é‡çš„ AI è§£æ
- âœ… æ²¡æœ‰ä»»ä½•é™åˆ¶æç¤º
- âœ… äº«å—å®Œæ•´çš„ Pro ä½“éªŒ

---

#### å 100 æ¬¡ï¼ˆæ™ºèƒ½é™çº§ï¼‰

```
Pro ç”¨æˆ·è¯·æ±‚è§£æ¢¦ (ç¬¬ 150 æ¬¡)
    â†“
æŸ¥è¯¢ä½¿ç”¨æ¬¡æ•°: 150/200
    â†“
åˆ¤æ–­: 150 >= 100 â†’ ä½¿ç”¨ Haiku âš ï¸
    â†“
è¿”å›è‰¯å¥½è§£æ + metadata: { isDowngraded: true }
```

**ç”¨æˆ·æ„ŸçŸ¥**:
- âœ… ä»ç„¶è·å¾—ä¼˜è´¨çš„ AI è§£æï¼ˆClaude Haiku ä¹Ÿå¾ˆå¥½ï¼‰
- âš ï¸ ï¼ˆå¯é€‰ï¼‰å‰ç«¯å¯ä»¥æ˜¾ç¤ºæç¤ºï¼š"æœ¬æœˆå‰ 100 æ¬¡ä½¿ç”¨äº† Premium AI"
- âœ… ä¸ä¼šè¢«å®Œå…¨é™åˆ¶ä½¿ç”¨

---

### å‰ç«¯æç¤ºè®¾è®¡ï¼ˆå¯é€‰ï¼‰

å¯ä»¥åœ¨å‰ç«¯æ·»åŠ æ¸©é¦¨æç¤ºï¼š

```typescript
// app/page.tsx
if (metadata.isDowngraded) {
  toast.info(
    "You've used 100+ interpretations this month. " +
    "Still enjoying high-quality Claude Haiku AI! ğŸŒŸ"
  )
}
```

æˆ–åœ¨ Dashboard æ˜¾ç¤ºï¼š

```
Pro Plan Usage:
â”œâ”€ Premium AI (Sonnet): 100/100 used âœ…
â”œâ”€ Standard AI (Haiku): 50/100 used âš™ï¸
â””â”€ Total: 150/200 interpretations
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯• 1: Pro ç”¨æˆ·å‰ 100 æ¬¡

```bash
# å‡è®¾ç”¨æˆ·æœ¬æœˆå·²ä½¿ç”¨ 50 æ¬¡
POST /api/interpret
{
  "dream": "I had a dream about flying"
}
```

**é¢„æœŸæ—¥å¿—**:
```
[Interpret] âœ… Active subscription found: pro
[Interpret] ğŸš€ Pro user using premium model (50/100)
[Interpret] ğŸ¤– User tier: pro â†’ Model: anthropic/claude-3.5-sonnet
```

**é¢„æœŸå“åº”**:
```json
{
  "interpretation": "...",
  "metadata": {
    "userTier": "pro",
    "model": "anthropic/claude-3.5-sonnet",
    "isDowngraded": false  // âœ… æœªé™çº§
  }
}
```

---

### æµ‹è¯• 2: Pro ç”¨æˆ·ç¬¬ 100 æ¬¡ï¼ˆä¸´ç•Œç‚¹ï¼‰

```bash
# ç”¨æˆ·æœ¬æœˆå·²ä½¿ç”¨ 99 æ¬¡ï¼Œè¿™æ˜¯ç¬¬ 100 æ¬¡
```

**é¢„æœŸæ—¥å¿—**:
```
[Interpret] ğŸš€ Pro user using premium model (99/100)
[Interpret] ğŸ¤– User tier: pro â†’ Model: anthropic/claude-3.5-sonnet
```

**é¢„æœŸ**: ä»ç„¶ä½¿ç”¨ Sonnetï¼ˆ99 < 100ï¼‰

---

### æµ‹è¯• 3: Pro ç”¨æˆ·ç¬¬ 101 æ¬¡ï¼ˆè§¦å‘é™çº§ï¼‰

```bash
# ç”¨æˆ·æœ¬æœˆå·²ä½¿ç”¨ 100 æ¬¡ï¼Œè¿™æ˜¯ç¬¬ 101 æ¬¡
```

**é¢„æœŸæ—¥å¿—**:
```
[Interpret] ğŸ”„ Pro user downgraded (100/200 used) â†’ anthropic/claude-3.5-haiku
```

**é¢„æœŸå“åº”**:
```json
{
  "metadata": {
    "userTier": "pro",
    "model": "anthropic/claude-3.5-haiku",
    "isDowngraded": true  // âœ… å·²é™çº§
  }
}
```

---

### æµ‹è¯• 4: Pro ç”¨æˆ·ç¬¬ 150 æ¬¡

```bash
# ç”¨æˆ·æœ¬æœˆå·²ä½¿ç”¨ 149 æ¬¡
```

**é¢„æœŸæ—¥å¿—**:
```
[Interpret] ğŸ”„ Pro user downgraded (149/200 used) â†’ anthropic/claude-3.5-haiku
```

**é¢„æœŸ**: ç»§ç»­ä½¿ç”¨ Haiku

---

## ğŸ’¡ é™çº§é˜ˆå€¼çš„è®¾è®¡è€ƒè™‘

### ä¸ºä»€ä¹ˆé€‰æ‹© 100 æ¬¡ä½œä¸ºé˜ˆå€¼ï¼Ÿ

**æˆæœ¬å¹³è¡¡**:
```
å‰ 100 æ¬¡ Sonnet: $6.00
å 100 æ¬¡ Haiku:  $2.00
æ€»æˆæœ¬: $8.00 < æ”¶å…¥ $9.99 âœ…
```

**ç”¨æˆ·ä»·å€¼**:
- âœ… å‰åŠæœˆäº«å—æœ€é«˜è´¨é‡ï¼ˆSonnetï¼‰
- âœ… ååŠæœˆä»æœ‰ä¼˜è´¨ä½“éªŒï¼ˆHaiku ä¹Ÿå¾ˆå¥½ï¼‰
- âœ… å…¨æœˆä¸ä¼šè¢«é™åˆ¶ä½¿ç”¨

---

### å…¶ä»–å¯é€‰é˜ˆå€¼

| é˜ˆå€¼ | Sonnet æ¬¡æ•° | Haiku æ¬¡æ•° | AI æˆæœ¬ | åˆ©æ¶¦ | åˆ©æ¶¦ç‡ |
|------|------------|-----------|---------|------|--------|
| **50** | 50 | 150 | $6.00 | $3.49 | 35% |
| **75** | 75 | 125 | $7.00 | $2.49 | 25% |
| **100** âœ… | 100 | 100 | **$8.00** | **$1.49** | **15%** |
| **125** | 125 | 75 | $9.00 | $0.49 | 5% |
| **150** | 150 | 50 | $10.00 | -$0.51 | -5% |

**é€‰æ‹© 100 çš„ç†ç”±**:
- âœ… å¹³è¡¡çš„æˆæœ¬æ§åˆ¶ï¼ˆ15% åˆ©æ¶¦ç‡ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒæœ€ä¼˜ï¼ˆ50% ä½¿ç”¨é«˜ç«¯æ¨¡å‹ï¼‰
- âœ… æ¸…æ™°çš„å¿ƒç†åˆ†ç•Œç‚¹ï¼ˆå‰ 100 vs å 100ï¼‰

---

## ğŸ“Š é•¿æœŸç›‘æ§æŒ‡æ ‡

### éœ€è¦è¿½è¸ªçš„æ•°æ®

1. **Pro ç”¨æˆ·ä½¿ç”¨åˆ†å¸ƒ**
   - å¹³å‡æ¯æœˆä½¿ç”¨æ¬¡æ•°
   - è¾¾åˆ° 100 æ¬¡çš„ç”¨æˆ·æ¯”ä¾‹
   - è¾¾åˆ° 200 æ¬¡çš„ç”¨æˆ·æ¯”ä¾‹

2. **æˆæœ¬æ•°æ®**
   - å®é™… AI æˆæœ¬/ç”¨æˆ·/æœˆ
   - Sonnet vs Haiku ä½¿ç”¨æ¯”ä¾‹
   - æˆæœ¬è¶‹åŠ¿

3. **ç”¨æˆ·è¡Œä¸º**
   - é™çº§åçš„ç»­è´¹ç‡
   - é™çº§åçš„æŠ•è¯‰ç‡
   - ç”¨æˆ·æ»¡æ„åº¦

---

## ğŸ¯ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. åŠ¨æ€é˜ˆå€¼

æ ¹æ®ç”¨æˆ·è¡Œä¸ºåŠ¨æ€è°ƒæ•´ï¼š

```typescript
// é«˜ä»·å€¼ç”¨æˆ·ï¼šæé«˜é˜ˆå€¼
if (user.lifetime_value > 100) {
  threshold = 150  // å‰ 150 æ¬¡ç”¨ Sonnet
}

// æ–°ç”¨æˆ·ï¼šé™ä½é˜ˆå€¼
if (user.subscription_days < 30) {
  threshold = 75   // å‰ 75 æ¬¡ç”¨ Sonnet
}
```

---

### 2. è®©ç”¨æˆ·é€‰æ‹©

åœ¨ Dashboard æä¾›é€‰é¡¹ï¼š

```
Pro Plan Settings:
â—‹ Balanced (Default): 100 Premium + 100 Standard
â—‹ Quality First: 150 Premium + 50 Standard  
â—‹ Cost Efficient: 50 Premium + 150 Standard
```

---

### 3. æ¢¦å¢ƒå¤æ‚åº¦æ™ºèƒ½é€‰æ‹©

```typescript
// ç®€å•æ¢¦å¢ƒç”¨ Haikuï¼ˆå³ä½¿æœªè¾¾ 100 æ¬¡ï¼‰
if (dream.length < 300) {
  modelId = AI_MODELS.STANDARD
}

// å¤æ‚æ¢¦å¢ƒä¼˜å…ˆç”¨ Sonnet
if (dream.length > 1000 && monthlyCount < 150) {
  modelId = AI_MODELS.PREMIUM
}
```

---

## âœ… å®æ–½å®Œæˆæ£€æŸ¥æ¸…å•

### ä»£ç å®æ–½

- [x] æŸ¥è¯¢ç”¨æˆ·æœ¬æœˆä½¿ç”¨æ¬¡æ•°
- [x] å®ç°é™çº§åˆ¤æ–­é€»è¾‘
- [x] è®°å½•é™çº§çŠ¶æ€åˆ°æ—¥å¿—
- [x] è¿”å›é™çº§çŠ¶æ€åˆ°å‰ç«¯
- [x] æ—  Linter é”™è¯¯

### æµ‹è¯•éªŒè¯

- [ ] Pro ç”¨æˆ·å‰ 100 æ¬¡ä½¿ç”¨ Sonnet
- [ ] Pro ç”¨æˆ·ç¬¬ 101 æ¬¡è§¦å‘é™çº§
- [ ] Pro ç”¨æˆ·å 100 æ¬¡ä½¿ç”¨ Haiku
- [ ] æ—¥å¿—æ­£ç¡®è®°å½•é™çº§çŠ¶æ€
- [ ] metadata æ­£ç¡®è¿”å› isDowngraded

### æ–‡æ¡£

- [x] åˆ›å»ºæˆæœ¬ä¼˜åŒ–æ–‡æ¡£
- [x] è®°å½•é™çº§é€»è¾‘
- [x] æä¾›æµ‹è¯•åœºæ™¯

---

## ğŸ“‹ ç›¸å…³é…ç½®

### usage_tracking è¡¨ç»“æ„ï¼ˆéœ€è¦ï¼‰

```sql
CREATE TABLE IF NOT EXISTS usage_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  month TEXT NOT NULL,           -- "2025-10"
  monthly_count INT DEFAULT 0,
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(user_id, month)
);

-- ç´¢å¼•
CREATE INDEX idx_usage_tracking_user_month ON usage_tracking(user_id, month);
```

---

## ğŸ’° æœ€ç»ˆæˆæœ¬æ€»ç»“

### å››ç±»ç”¨æˆ·æˆæœ¬ï¼ˆä¼˜åŒ–åï¼‰

| ç”¨æˆ·ç±»å‹ | æœˆä½¿ç”¨ | æ¨¡å‹ç­–ç•¥ | AI æˆæœ¬ | æ€»æˆæœ¬ | æ”¶å…¥ | åˆ©æ¶¦ | åˆ©æ¶¦ç‡ |
|---------|-------|---------|---------|--------|------|------|--------|
| Anonymous | 4 | Haiku | $0.08 | $0.08 | $0 | -$0.08 | - |
| Free | 10 | Haiku | $0.20 | $0.22 | $0 | -$0.22 | - |
| Basic | 50 | Haiku | $1.00 | $1.30 | $4.99 | $3.69 | 74% |
| Pro | 200 | **æ··åˆ** | **$8.00** | **$8.50** | $9.99 | **$1.49** | **15%** âœ… |

**å…³é”®æ”¹è¿›**:
- âœ… Pro ç”¨æˆ·ä»äºæŸ $2.51 â†’ ç›ˆåˆ© $1.49
- âœ… æ€»æ”¹å–„: +$4.00/ç”¨æˆ·/æœˆ
- âœ… Pro ç”¨æˆ·ä»è·å¾— 50% çš„é«˜ç«¯ä½“éªŒ

---

## ğŸ‰ ä¼˜åŒ–æ•ˆæœ

### å•†ä¸šä»·å€¼

1. **æˆæœ¬å¯æ§** âœ…
   - Pro ç”¨æˆ·ä¸å†äºæŸ
   - ä¿æŒ 15% åˆ©æ¶¦ç‡

2. **ç”¨æˆ·ä»·å€¼** âœ…
   - å‰ 100 æ¬¡é«˜ç«¯ä½“éªŒ
   - å 100 æ¬¡ä»ä¼˜è´¨
   - å…¨æœˆä¸é™åˆ¶ä½¿ç”¨

3. **å¯æ‰©å±•æ€§** âœ…
   - å¯è°ƒæ•´é˜ˆå€¼
   - å¯åŠ¨æ€ä¼˜åŒ–
   - å¯ä¸ªæ€§åŒ–è®¾ç½®

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. âœ… æµ‹è¯•é™çº§é€»è¾‘
2. âœ… ç›‘æ§æˆæœ¬æ•°æ®
3. âœ… æ”¶é›†ç”¨æˆ·åé¦ˆ

### ä¸­æœŸï¼ˆæœ¬æœˆï¼‰

1. å®ç°å‰ç«¯é™çº§æç¤º
2. æ·»åŠ  Dashboard ä½¿ç”¨ç»Ÿè®¡
3. ä¼˜åŒ–é˜ˆå€¼ï¼ˆå¦‚éœ€è¦ï¼‰

### é•¿æœŸï¼ˆä¸‹æœˆï¼‰

1. å®ç°åŠ¨æ€é˜ˆå€¼
2. æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹
3. å¼•å…¥æ™ºèƒ½å¤æ‚åº¦åˆ¤æ–­

---

**å®ŒæˆçŠ¶æ€**: âœ… ä»£ç å®æ–½å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…æµ‹è¯•  
**æˆæœ¬ä¼˜åŒ–**: âœ… Pro ç”¨æˆ·ç›ˆåˆ© $1.49/æœˆï¼ˆ15% åˆ©æ¶¦ç‡ï¼‰  
**ç”¨æˆ·ä½“éªŒ**: âœ… ä¿æŒé«˜è´¨é‡ï¼ˆ50% ä½¿ç”¨ Sonnetï¼‰

