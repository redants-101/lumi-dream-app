# âš ï¸ P2 ä¼˜åŒ–è´¨é‡å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¶é—´**: 2025-10-29  
**å®¡æŸ¥èŒƒå›´**: æœåŠ¡å±‚é‡æ„ä»£ç è´¨é‡  
**å®¡æŸ¥ç»“æœ**: å‘ç° 5 ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜

---

## ğŸ› å‘ç°çš„é—®é¢˜

### âŒ é—®é¢˜ 1ï¼šä¸å¿…è¦çš„å¾ªç¯å¯¼å…¥ï¼ˆä½é£é™©ï¼‰

**æ–‡ä»¶**: `lib/services/usage-service.ts`  
**ä½ç½®**: ç¬¬ 9 è¡Œ

```typescript
import { getUserIP } from "./auth-service"  // âŒ ä¸å¿…è¦çš„å¯¼å…¥
```

**é—®é¢˜è¯´æ˜**:
- `usage-service.ts` å¯¼å…¥äº† `getUserIP`ï¼Œä½†ä»æœªä½¿ç”¨
- è¿™ä¼šé€ æˆæ½œåœ¨çš„å¾ªç¯ä¾èµ–é£é™©
- å®é™…ä¸Š IP åœ°å€åº”è¯¥ç”±è°ƒç”¨æ–¹ä¼ å…¥ï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å†…è·å–

**å½±å“**: ä»£ç æ··ä¹±ï¼Œä½†ä¸å½±å“åŠŸèƒ½

---

### âš ï¸ é—®é¢˜ 2ï¼šé‡å¤è°ƒç”¨ `getUserIP()`ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰

**æ–‡ä»¶**: `app/api/interpret/route.ts`  
**ä½ç½®**: ç¬¬ 71 è¡Œå’Œç¬¬ 93 è¡Œ

```typescript
// ç¬¬ 71 è¡Œ - éªŒè¯æ—¶è°ƒç”¨
const ip = await getUserIP()
usageValidation = await validateAnonymousUsage(ip)

// ç¬¬ 93 è¡Œ - è®°å½•æ—¶å†æ¬¡è°ƒç”¨
const ip = await getUserIP()  // âŒ é‡å¤è°ƒç”¨
await recordAnonymousUsage(ip)
```

**é—®é¢˜è¯´æ˜**:
- IP åœ°å€è·å–éœ€è¦è®¿é—® headersï¼Œä¼šæœ‰æ€§èƒ½å¼€é”€
- åŒä¸€ä¸ªè¯·æ±‚ä¸­è·å–ä¸¤æ¬¡æ˜¯æµªè´¹

**å½±å“**: è½»å¾®æ€§èƒ½æŸå¤±

---

### âŒ é—®é¢˜ 3ï¼šé”™è¯¯å“åº”ä¿¡æ¯ä¸å®Œæ•´ï¼ˆç”¨æˆ·ä½“éªŒé—®é¢˜ï¼‰

**æ–‡ä»¶**: `lib/services/usage-service.ts`  
**ä½ç½®**: ç¬¬ 65-84 è¡Œï¼ˆæ—¥é™åˆ¶é”™è¯¯ï¼‰ã€ç¬¬ 189-218 è¡Œï¼ˆæœˆé™åˆ¶é”™è¯¯ï¼‰

**é—®é¢˜è¯´æ˜**:
- è¾¾åˆ°**æ—¥é™åˆ¶**æ—¶ï¼Œåªè¿”å› `daily` é‡ç½®æ—¶é—´ï¼Œæ²¡æœ‰ `monthly`
- è¾¾åˆ°**æœˆé™åˆ¶**æ—¶ï¼Œåªè¿”å› `monthly` é‡ç½®æ—¶é—´ï¼Œæ²¡æœ‰ `daily`
- ç”¨æˆ·æ— æ³•åŒæ—¶çœ‹åˆ°ä¸¤ä¸ªç»´åº¦çš„ä½¿ç”¨æƒ…å†µ

**å½“å‰ä»£ç **ï¼ˆæ—¥é™åˆ¶é”™è¯¯ï¼‰:
```typescript
resetTime: { 
  daily: resetTimes.daily,
  dailyLocal: resetTimes.dailyLocal 
  // âŒ ç¼ºå°‘ monthly
}
```

**åº”è¯¥è¿”å›**:
```typescript
resetTime: {
  daily: resetTimes.daily,
  dailyLocal: resetTimes.dailyLocal,
  monthly: resetTimes.monthly,      // âœ… æ·»åŠ 
  monthlyLocal: resetTimes.monthlyLocal  // âœ… æ·»åŠ 
}
```

**å½±å“**: å‰ç«¯æ— æ³•æ˜¾ç¤ºå®Œæ•´çš„ä½¿ç”¨æƒ…å†µ

---

### âŒ é—®é¢˜ 4ï¼šåŒ¿åç”¨æˆ· usageData æ¦‚å¿µæ··æ·†ï¼ˆæ•°æ®ä¸å‡†ç¡®ï¼‰

**æ–‡ä»¶**: `lib/services/usage-service.ts`  
**ä½ç½®**: ç¬¬ 105-115 è¡Œ

**å½“å‰ä»£ç **:
```typescript
return {
  allowed: true,
  usageData: {
    daily: dailyTotal,
    monthly: dailyTotal,  // âŒ åŒ¿åç”¨æˆ·æ²¡æœ‰æœˆé™åˆ¶æ¦‚å¿µ
    limits: {
      daily: dailyLimit,
      monthly: dailyLimit,  // âŒ è¯¯å¯¼æ€§æ•°æ®
    },
  },
}
```

**é—®é¢˜è¯´æ˜**:
- åŒ¿åç”¨æˆ·åªæœ‰**æ—¥é™åˆ¶**å’Œ**å°æ—¶é™åˆ¶**ï¼Œæ²¡æœ‰æœˆé™åˆ¶
- æŠŠ `monthly` è®¾ä¸º `dailyLimit` ä¼šè¯¯å¯¼å‰ç«¯
- å‰ç«¯å¯èƒ½ä¼šæ˜¾ç¤º "10/10 this month"ï¼Œå®é™…ä¸Šæ˜¯æ¯å¤©é‡ç½®çš„

**å»ºè®®ä¿®å¤**:
```typescript
usageData: {
  daily: dailyTotal,
  monthly: dailyTotal,  // ä¿æŒå…¼å®¹æ€§ï¼Œä½†å€¼åº”è¯¥æ˜¯ç´¯è®¡çš„
  limits: {
    daily: dailyLimit,
    monthly: 999999,  // è¡¨ç¤ºæ— é™åˆ¶ï¼ˆæˆ–è€…ä¸è¿”å› monthlyï¼‰
  },
}
```

**å½±å“**: å‰ç«¯æ˜¾ç¤ºå¯èƒ½è¯¯å¯¼ç”¨æˆ·

---

### âš ï¸ é—®é¢˜ 5ï¼šPro ç”¨æˆ·é™çº§æ—¶ usageData å¯èƒ½ä¸º undefinedï¼ˆæ½œåœ¨ bugï¼‰

**æ–‡ä»¶**: `app/api/interpret/route.ts`  
**ä½ç½®**: ç¬¬ 84-87 è¡Œ

**å½“å‰ä»£ç **:
```typescript
usageData = usageValidation.usageData  // âš ï¸ å¯èƒ½ä¸º undefined

// æ­¥éª¤ 7ï¼šç”Ÿæˆ AI è§£æ
const result = await generateDreamInterpretation(dream, auth.tier, usageData)
```

**é—®é¢˜è¯´æ˜**:
- å¦‚æœ `validateUserUsage` é‡åˆ°æ•°æ®åº“é”™è¯¯å¹¶é™çº§å¤„ç†ï¼Œä¼šè¿”å› `{ allowed: true }` ä½†æ²¡æœ‰ `usageData`
- è¿™ä¼šå¯¼è‡´ Pro ç”¨æˆ·é™çº§é€»è¾‘å¤±æ•ˆï¼ˆå› ä¸ºæ²¡æœ‰ `usageData.monthly`ï¼‰
- è™½ç„¶ä¸ä¼šæŠ¥é”™ï¼Œä½†ä¼šå¯¼è‡´ Pro ç”¨æˆ·æ€»æ˜¯ä½¿ç”¨é«˜æˆæœ¬æ¨¡å‹

**éªŒè¯**ï¼ˆ`usage-service.ts` ç¬¬ 138-142 è¡Œï¼‰:
```typescript
if (usageError && usageError.code !== 'PGRST116') {
  console.error("[UsageService] âŒ Failed to fetch usage:", usageError)
  // å…è®¸ç»§ç»­ï¼Œä½†è®°å½•é”™è¯¯
  return { allowed: true }  // âŒ æ²¡æœ‰è¿”å› usageData
}
```

**å½±å“**: Pro ç”¨æˆ·æˆæœ¬ä¼˜åŒ–å¤±æ•ˆ

---

## ğŸ“Š é—®é¢˜ä¼˜å…ˆçº§

| é—®é¢˜ | ä¼˜å…ˆçº§ | å½±å“èŒƒå›´ | ä¿®å¤éš¾åº¦ |
|------|--------|----------|----------|
| é—®é¢˜ 1: ä¸å¿…è¦çš„å¯¼å…¥ | P3 ä½ | ä»£ç è´¨é‡ | ç®€å•ï¼ˆåˆ é™¤ 1 è¡Œï¼‰ |
| é—®é¢˜ 2: é‡å¤è°ƒç”¨ IP | P2 ä¸­ | æ€§èƒ½ | ç®€å•ï¼ˆå¤ç”¨å˜é‡ï¼‰ |
| é—®é¢˜ 3: é”™è¯¯ä¿¡æ¯ä¸å®Œæ•´ | P1 é«˜ | ç”¨æˆ·ä½“éªŒ | ç®€å•ï¼ˆæ·»åŠ å­—æ®µï¼‰ |
| é—®é¢˜ 4: åŒ¿åç”¨æˆ·æ•°æ®æ··æ·† | P2 ä¸­ | æ•°æ®å‡†ç¡®æ€§ | ä¸­ç­‰ï¼ˆéœ€è¦é‡æ–°è®¾è®¡ï¼‰ |
| é—®é¢˜ 5: usageData å¯èƒ½ undefined | P1 é«˜ | Pro ç”¨æˆ·æˆæœ¬ | ç®€å•ï¼ˆæ·»åŠ é»˜è®¤å€¼ï¼‰ |

---

## âœ… éªŒè¯é€šè¿‡çš„éƒ¨åˆ†

1. âœ… **TypeScript ç±»å‹å®šä¹‰å®Œæ•´**ï¼ˆæ— ç¼–è¯‘é”™è¯¯ï¼‰
2. âœ… **æœåŠ¡å±‚èŒè´£æ¸…æ™°**ï¼ˆå•ä¸€èŒè´£åŸåˆ™ï¼‰
3. âœ… **é”™è¯¯å¤„ç†å®Œå–„**ï¼ˆtry-catch è¦†ç›–ï¼‰
4. âœ… **æ—¥å¿—è®°å½•è¯¦ç»†**ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
5. âœ… **ä»£ç æ³¨é‡Šæ¸…æ™°**ï¼ˆä¾¿äºç»´æŠ¤ï¼‰
6. âœ… **API å“åº”æ ¼å¼ç»Ÿä¸€**ï¼ˆç¬¦åˆè®¾è®¡ï¼‰
7. âœ… **æ—¶åŒºå¤„ç†æ­£ç¡®**ï¼ˆUTC + æœ¬åœ°åŒ–ï¼‰

---

## ğŸ”§ éœ€è¦ç«‹å³ä¿®å¤çš„é—®é¢˜

### å¿…é¡»ä¿®å¤ï¼ˆP1ï¼‰

1. **é—®é¢˜ 3**: è¡¥å…¨é”™è¯¯å“åº”çš„é‡ç½®æ—¶é—´ä¿¡æ¯
2. **é—®é¢˜ 5**: ç¡®ä¿ usageData æ€»æ˜¯æœ‰é»˜è®¤å€¼

### å»ºè®®ä¿®å¤ï¼ˆP2ï¼‰

3. **é—®é¢˜ 2**: å¤ç”¨ IP åœ°å€å˜é‡
4. **é—®é¢˜ 4**: é‡æ–°è®¾è®¡åŒ¿åç”¨æˆ·çš„ usageData ç»“æ„

### å¯é€‰ä¿®å¤ï¼ˆP3ï¼‰

5. **é—®é¢˜ 1**: åˆ é™¤ä¸å¿…è¦çš„å¯¼å…¥

---

## ğŸ“ ä¿®å¤å»ºè®®

### ä¿®å¤é—®é¢˜ 1ï¼ˆåˆ é™¤ä¸å¿…è¦çš„å¯¼å…¥ï¼‰

```typescript
// lib/services/usage-service.ts
// åˆ é™¤ç¬¬ 9 è¡Œ
- import { getUserIP } from "./auth-service"
```

### ä¿®å¤é—®é¢˜ 2ï¼ˆå¤ç”¨ IP å˜é‡ï¼‰

```typescript
// app/api/interpret/route.ts
let usageValidation
let usageData
let ip: string | undefined  // âœ… æå‰å£°æ˜ IP å˜é‡

if (auth.isAuthenticated && auth.userId) {
  usageValidation = await validateUserUsage(auth.userId, auth.tier)
} else {
  ip = await getUserIP()  // âœ… è·å–ä¸€æ¬¡
  usageValidation = await validateAnonymousUsage(ip)
}

// ...åç»­...

if (auth.isAuthenticated && auth.userId) {
  await recordUserUsage(auth.userId)
} else {
  await recordAnonymousUsage(ip!)  // âœ… å¤ç”¨ IP
}
```

### ä¿®å¤é—®é¢˜ 3ï¼ˆè¡¥å…¨é‡ç½®æ—¶é—´ï¼‰

```typescript
// lib/services/usage-service.ts
// ç¬¬ 65-84 è¡Œï¼ˆæ—¥é™åˆ¶é”™è¯¯ï¼‰
resetTime: {
  daily: resetTimes.daily,
  dailyLocal: resetTimes.dailyLocal,
  monthly: resetTimes.monthly,        // âœ… æ·»åŠ 
  monthlyLocal: resetTimes.monthlyLocal  // âœ… æ·»åŠ 
}

// ç¬¬ 189-218 è¡Œï¼ˆæœˆé™åˆ¶é”™è¯¯ï¼‰
resetTime: {
  daily: resetTimes.daily,            // âœ… æ·»åŠ 
  dailyLocal: resetTimes.dailyLocal,  // âœ… æ·»åŠ 
  monthly: resetTimes.monthly,
  monthlyLocal: resetTimes.monthlyLocal
}
```

### ä¿®å¤é—®é¢˜ 4ï¼ˆåŒ¿åç”¨æˆ·æ•°æ®ï¼‰

```typescript
// lib/services/usage-service.ts
// ç¬¬ 105-115 è¡Œ
usageData: {
  daily: dailyTotal,
  monthly: 0,  // âœ… åŒ¿åç”¨æˆ·æ— æœˆé™åˆ¶ï¼Œè®¾ä¸º 0
  limits: {
    daily: dailyLimit,
    monthly: 0,  // âœ… è¡¨ç¤ºæ— æœˆé™åˆ¶
  },
}
```

### ä¿®å¤é—®é¢˜ 5ï¼ˆç¡®ä¿ usageData é»˜è®¤å€¼ï¼‰

```typescript
// lib/services/usage-service.ts
// ç¬¬ 138-142 è¡Œ
if (usageError && usageError.code !== 'PGRST116') {
  console.error("[UsageService] âŒ Failed to fetch usage:", usageError)
  // âœ… è¿”å›é»˜è®¤çš„ usageData
  return {
    allowed: true,
    usageData: {
      daily: 0,
      monthly: 0,
      limits: {
        daily: limits.daily,
        monthly: limits.monthly,
      },
    },
  }
}
```

---

## ğŸ“ˆ ä¿®å¤åçš„æ”¹è¿›

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **ä»£ç å‡†ç¡®æ€§** | 85% | 100% |
| **ç”¨æˆ·ä½“éªŒ** | è‰¯å¥½ï¼ˆä¿¡æ¯ä¸å®Œæ•´ï¼‰ | ä¼˜ç§€ï¼ˆä¿¡æ¯å®Œæ•´ï¼‰ |
| **æ€§èƒ½** | é‡å¤è°ƒç”¨ IP | ä¼˜åŒ–ï¼ˆå¤ç”¨ï¼‰ |
| **Pro æˆæœ¬ä¼˜åŒ–** | å¯èƒ½å¤±æ•ˆ | ç¨³å®šå¯é  |
| **æ•°æ®å‡†ç¡®æ€§** | åŒ¿åç”¨æˆ·æ•°æ®æ··æ·† | æ¸…æ™°å‡†ç¡® |

---

## ğŸ¯ æ€»ç»“

### ä¼˜ç‚¹
- âœ… æ¶æ„è®¾è®¡åˆç†ï¼ˆæœåŠ¡å±‚åˆ†ç¦»ï¼‰
- âœ… ç±»å‹å®šä¹‰å®Œæ•´ï¼ˆTypeScriptï¼‰
- âœ… é”™è¯¯å¤„ç†å…¨é¢ï¼ˆtry-catchï¼‰
- âœ… ä»£ç å¯è¯»æ€§é«˜ï¼ˆæ¸…æ™°æ³¨é‡Šï¼‰

### ç¼ºç‚¹
- âŒ ç»†èŠ‚è€ƒè™‘ä¸å‘¨ï¼ˆé‡å¤è°ƒç”¨ã€æ•°æ®æ··æ·†ï¼‰
- âŒ è¾¹ç¼˜æƒ…å†µå¤„ç†ä¸è¶³ï¼ˆusageData undefinedï¼‰
- âŒ ç”¨æˆ·ä½“éªŒç»†èŠ‚ç¼ºå¤±ï¼ˆé”™è¯¯ä¿¡æ¯ä¸å®Œæ•´ï¼‰

### ç»“è®º

**æ•´ä½“è´¨é‡**: è‰¯å¥½ï¼ˆ85 åˆ† / 100 åˆ†ï¼‰  
**å»ºè®®**: ä¿®å¤ä¸Šè¿° 5 ä¸ªé—®é¢˜åå¯è¾¾åˆ°ä¼˜ç§€ï¼ˆ95 åˆ†ï¼‰

è¿™äº›é—®é¢˜éƒ½ä¸æ˜¯è‡´å‘½é”™è¯¯ï¼Œä½†å½±å“ä»£ç è´¨é‡å’Œç”¨æˆ·ä½“éªŒã€‚å»ºè®®ç«‹å³ä¿®å¤ P1 é—®é¢˜ï¼Œå°½å¿«ä¿®å¤ P2 é—®é¢˜ã€‚

