# ⏰ 时区与限制重置说明

## 📋 概述

Lumi Dream App 的使用限制基于 **UTC（协调世界时）** 进行重置。本文档说明时区逻辑、重置时间计算和用户体验优化。

---

## 🌍 时区配置

### 当前时区标准

- **服务器时区**: UTC（协调世界时）
- **数据库时区**: UTC
- **限制重置基准**: UTC 时间

### 为什么选择 UTC？

1. **统一性**: 避免不同地区用户的混淆
2. **简单性**: 无需处理夏令时变化
3. **可扩展性**: 便于国际化部署
4. **稳定性**: 数据库和服务器时间一致

---

## 🔄 重置时间规则

### 每日限制重置

- **重置时间**: 每天 UTC 00:00（午夜）
- **计算方式**: 按 `YYYY-MM-DD` 格式判断日期

#### 不同时区的重置时间示例

| 时区 | 重置时间（本地时间） |
|------|---------------------|
| **UTC** | 00:00 |
| **美国东部（EST）** | 前一天 19:00 |
| **美国西部（PST）** | 前一天 16:00 |
| **中国（CST）** | 08:00 |
| **英国（GMT）** | 00:00 |
| **澳大利亚东部（AEST）** | 10:00 |

### 每月限制重置

- **重置时间**: 每月 1 日 UTC 00:00
- **计算方式**: 按 `YYYY-MM` 格式判断月份

---

## 💬 用户提示优化

### API 响应中的时区信息

当用户达到限制时，API 返回以下信息：

```json
{
  "success": false,
  "error": {
    "message": "Daily limit reached. Come back tomorrow!",
    "details": {
      "currentUsage": {
        "daily": 10,
        "monthly": 45
      },
      "limits": {
        "daily": 10,
        "monthly": 50
      },
      "resetTime": {
        "daily": "2025-10-30T00:00:00.000Z",
        "dailyLocal": "Oct 30, 2025, 12:00 AM UTC",
        "monthly": "2025-11-01T00:00:00.000Z",
        "monthlyLocal": "Nov 1, 2025, 12:00 AM UTC"
      },
      "userTier": "basic"
    }
  }
}
```

### 字段说明

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `currentUsage.daily` | number | 今日已用次数 | 10 |
| `currentUsage.monthly` | number | 本月已用次数 | 45 |
| `limits.daily` | number | 每日限制 | 10 |
| `limits.monthly` | number | 每月限制 | 50 |
| `resetTime.daily` | ISO 8601 | 日重置时间（UTC） | `2025-10-30T00:00:00.000Z` |
| `resetTime.dailyLocal` | string | 日重置时间（可读） | `Oct 30, 2025, 12:00 AM UTC` |
| `resetTime.monthly` | ISO 8601 | 月重置时间（UTC） | `2025-11-01T00:00:00.000Z` |
| `resetTime.monthlyLocal` | string | 月重置时间（可读） | `Nov 1, 2025, 12:00 AM UTC` |

---

## 🛠️ 前端显示建议

### 方案 1：显示 UTC 时间（推荐）

**优点**: 清晰、无歧义  
**缺点**: 用户需要自己转换

```typescript
// 示例代码
const resetTimeUTC = "Oct 30, 2025, 12:00 AM UTC"
toast.error(`Daily limit reached. Resets at ${resetTimeUTC}`)
```

### 方案 2：转换为用户本地时区

**优点**: 用户体验更好  
**缺点**: 需要前端计算

```typescript
// 示例代码
const resetTimeISO = "2025-10-30T00:00:00.000Z"
const localTime = new Date(resetTimeISO).toLocaleString()
toast.error(`Daily limit reached. Resets at ${localTime}`)
```

### 方案 3：显示相对时间

**优点**: 最友好的用户体验  
**缺点**: 需要定时更新

```typescript
// 示例代码（使用 date-fns 或类似库）
import { formatDistanceToNow } from 'date-fns'

const resetTimeISO = "2025-10-30T00:00:00.000Z"
const relativeTime = formatDistanceToNow(new Date(resetTimeISO))
toast.error(`Daily limit reached. Resets in ${relativeTime}`)
```

---

## 📊 不同用户层级的限制

| 层级 | 每日限制 | 每月限制 | 重置规则 |
|------|----------|----------|----------|
| **Anonymous** | 2 次/天<br>5 次/小时 | 无月限制 | 按 IP 地址计算<br>每日 UTC 00:00 重置 |
| **Free** | 5 次/天 | 10 次/月 | 每日 UTC 00:00 重置<br>每月 1 日 UTC 00:00 重置 |
| **Basic** | 10 次/天 | 50 次/月 | 同上 |
| **Pro** | 20 次/天 | 200 次/月 | 同上 |

---

## ⚠️ 注意事项

### 1. IP 限流的时区特性

- **匿名用户**: 按 IP 地址 + UTC 日期限流
- **小时限制**: 按 UTC 小时（0-23）计算
- **跨日重置**: UTC 00:00 自动清零日计数

### 2. 用户跨时区旅行

**场景**: 用户从美国飞往中国

- **限制规则**: 仍按 UTC 时间重置
- **用户感知**: 可能感觉重置时间"不同"
- **解决方案**: 在 UI 中明确标注 "UTC" 或显示本地时间

### 3. 夏令时无影响

UTC 不受夏令时影响，确保重置时间全年一致。

---

## 🚀 未来优化方向

### 可选功能（需要额外开发）

1. **用户时区偏好设置**
   - 允许用户在 Dashboard 设置偏好时区
   - 所有时间显示按用户偏好展示
   - 后端仍使用 UTC 存储

2. **智能提示**
   - 自动检测用户浏览器时区
   - 前端显示："Resets in 8 hours (at 8:00 AM your time)"

3. **时区转换 API**
   - 提供 `/api/convert-timezone` 端点
   - 接收 UTC 时间，返回指定时区的本地时间

---

## 📝 实施建议

### 前端实施步骤

1. **接收错误响应**
   ```typescript
   const response = await fetch('/api/interpret', { ... })
   const data = await response.json()
   
   if (!data.success) {
     const resetTime = data.error.details.resetTime
     // 显示给用户
   }
   ```

2. **显示友好提示**
   ```typescript
   // 使用相对时间
   const resetISO = data.error.details.resetTime.daily
   const hoursUntilReset = calculateHoursUntil(resetISO)
   
   toast.error(
     `Daily limit reached (${data.error.details.currentUsage.daily}/${data.error.details.limits.daily}). ` +
     `Resets in ${hoursUntilReset} hours.`
   )
   ```

3. **提供升级提示**
   ```typescript
   if (data.error.details.upgradeAvailable) {
     // 显示 "Upgrade to get more interpretations" 按钮
   }
   ```

---

## 🔍 调试与验证

### 验证重置时间计算

```typescript
// 在浏览器控制台测试
const resetDaily = "2025-10-30T00:00:00.000Z"
const resetMonthly = "2025-11-01T00:00:00.000Z"

console.log("Daily reset (UTC):", new Date(resetDaily).toISOString())
console.log("Daily reset (Local):", new Date(resetDaily).toLocaleString())
console.log("Monthly reset (UTC):", new Date(resetMonthly).toISOString())
console.log("Monthly reset (Local):", new Date(resetMonthly).toLocaleString())
```

### 测试不同时区

```bash
# 设置环境变量模拟不同时区（Node.js）
TZ=America/New_York node -e "console.log(new Date('2025-10-30T00:00:00.000Z'))"
TZ=Asia/Shanghai node -e "console.log(new Date('2025-10-30T00:00:00.000Z'))"
```

---

## 📚 参考资料

- [ISO 8601 时间格式](https://en.wikipedia.org/wiki/ISO_8601)
- [UTC 时区介绍](https://www.timeanddate.com/time/aboututc.html)
- [JavaScript Date API](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date)
- [date-fns 库](https://date-fns.org/)（推荐用于时间处理）

---

## ✅ 总结

- **后端统一使用 UTC 时间**，确保一致性
- **API 返回 ISO 8601 和可读格式**，兼顾机器和人类
- **前端负责时区转换**，提升用户体验
- **明确标注 UTC**，避免用户混淆

如有疑问，请查看 `lib/services/api-response.ts` 中的 `getResetTimes()` 函数实现。

