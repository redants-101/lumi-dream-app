# ğŸ” P0 + P1 å®Œæˆæƒ…å†µæ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¥æœŸ**: 2025-10-28  
**æ£€æŸ¥æ–¹æ³•**: é€è¡Œä»£ç å®¡æŸ¥ + é€»è¾‘éªŒè¯

---

## âœ… P0 ä¼˜åŒ–æ£€æŸ¥

### P0-1: åˆ›å»º /api/usage ç«¯ç‚¹ âœ…

**æ–‡ä»¶**: `app/api/usage/route.ts`

**æ£€æŸ¥é¡¹**:
- [x] æ–‡ä»¶å·²åˆ›å»º
- [x] å¤„ç† Anonymous ç”¨æˆ·ï¼ˆè¿”å›é»˜è®¤å€¼ï¼‰
- [x] å¤„ç†å·²ç™»å½•ç”¨æˆ·ï¼ˆæŸ¥è¯¢æ•°æ®åº“ï¼‰
- [x] è¿”å› tier, usage, limits, remaining
- [x] é”™è¯¯å¤„ç†å®Œå–„

**çŠ¶æ€**: âœ… æ­£ç¡®å®ç°

**ä½†å‘ç°å°é—®é¢˜**: Anonymous ç”¨æˆ·è¿”å›ç¡¬ç¼–ç å€¼ï¼ˆdaily: 2, monthly: 4ï¼‰ï¼Œåº”è¯¥ä» USAGE_LIMITS è·å–

---

### P0-2: å‰ç«¯ä» API åŒæ­¥çœŸå®ä½¿ç”¨æ¬¡æ•° âœ…

**æ–‡ä»¶**: `hooks/use-usage-limit-v2.ts`

**æ£€æŸ¥é¡¹**:
- [x] æ–°å¢ syncUsageFromDatabase() å‡½æ•°
- [x] ç™»å½•æ—¶è‡ªåŠ¨è°ƒç”¨åŒæ­¥
- [x] æ›´æ–° localStorage
- [x] æ›´æ–°ç»„ä»¶çŠ¶æ€
- [x] é”™è¯¯å¤„ç†ï¼ˆé™é»˜å¤±è´¥ï¼‰

**çŠ¶æ€**: âœ… æ­£ç¡®å®ç°

**ä½†å‘ç°é—®é¢˜**: 
1. åŒæ­¥åªåœ¨ç™»å½•æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œä¸æ˜¯å®æ—¶çš„
2. å¦‚æœç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ï¼Œå½“å‰è®¾å¤‡ä¸ä¼šè‡ªåŠ¨æ›´æ–°
3. åº”è¯¥åœ¨æ¯æ¬¡è§£æ¢¦æˆåŠŸåä¹Ÿè°ƒç”¨åŒæ­¥

---

## âœ… P1 ä¼˜åŒ–æ£€æŸ¥

### P1-3: åˆå¹¶ Pro ç”¨æˆ·çš„é‡å¤æŸ¥è¯¢ âœ…

**æ–‡ä»¶**: `app/api/interpret/route.ts`

**æ£€æŸ¥é¡¹**:
- [x] åœ¨ç¬¬ 165 è¡Œå£°æ˜ `let usage: any = null`
- [x] åœ¨ç¬¬ 169-176 è¡ŒæŸ¥è¯¢å¹¶ä¿å­˜åˆ° usage
- [x] åœ¨ç¬¬ 209 è¡Œä½¿ç”¨ usage è¿›è¡Œé™çº§åˆ¤æ–­
- [x] é¿å…äº†é‡å¤æŸ¥è¯¢

**çŠ¶æ€**: âœ… æ­£ç¡®å®ç°

**é€»è¾‘éªŒè¯**: âœ… å˜é‡ä½œç”¨åŸŸæ­£ç¡®

---

### P1-4: ä¼˜åŒ– Anonymous æ—¥æ€»æ•°è®¡ç®— âœ…

**æ–‡ä»¶**: `app/api/interpret/route.ts` ç¬¬ 119-133 è¡Œ

**æ£€æŸ¥é¡¹**:
- [x] å•æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰å°æ—¶æ•°æ®
- [x] å‰ç«¯ reduce è®¡ç®—æ—¥æ€»æ•°
- [x] find æŸ¥æ‰¾å½“å‰å°æ—¶æ•°æ®
- [x] å‡å°‘äº† 1 æ¬¡æŸ¥è¯¢

**çŠ¶æ€**: âœ… æ­£ç¡®å®ç°

---

### P1-5: å¤„ç† IP=unknown çš„æƒ…å†µ âœ…

**æ–‡ä»¶**: `app/api/interpret/route.ts` ç¬¬ 118-123ã€143-153 è¡Œ

**æ£€æŸ¥é¡¹**:
- [x] æ£€æµ‹ IP === 'unknown'
- [x] unknown IP ä½¿ç”¨å®½æ¾é™åˆ¶
- [x] dailyLimit: 20ï¼ˆæ­£å¸¸ 10ï¼‰
- [x] hourlyLimit: 10ï¼ˆæ­£å¸¸ 5ï¼‰
- [x] æœ‰æ—¥å¿—æç¤º

**çŠ¶æ€**: âœ… æ­£ç¡®å®ç°

---

### P1-6: é™çº§é˜ˆå€¼é…ç½®åŒ– âœ…

**æ–‡ä»¶**: `lib/usage-limits.ts` ç¬¬ 71ã€113-118 è¡Œ

**æ£€æŸ¥é¡¹**:
- [x] åœ¨ USAGE_LIMITS.pro æ·»åŠ  downgradeThreshold: 100
- [x] æ–°å¢ getDowngradeThreshold() å‡½æ•°
- [x] åœ¨ interpret API ä¸­ä½¿ç”¨é…ç½®å€¼
- [x] æ—¥å¿—è¾“å‡ºé˜ˆå€¼ä¿¡æ¯

**çŠ¶æ€**: âœ… æ­£ç¡®å®ç°

---

## ğŸš¨ å‘ç°çš„é—®é¢˜

### ğŸŸ¡ é—®é¢˜ 1: /api/usage å¯¹ Anonymous ç”¨æˆ·çš„å¤„ç†

**å½“å‰ä»£ç ** (ç¬¬ 22-39 è¡Œ):
```typescript
if (!user) {
  return Response.json({
    tier: "anonymous",
    usage: { daily: 0, monthly: 0 },
    limits: { daily: 2, monthly: 4 },  // âŒ ç¡¬ç¼–ç 
    remaining: { daily: 2, monthly: 4 },
  })
}
```

**é—®é¢˜**: 
- ç¡¬ç¼–ç äº† Anonymous çš„é™åˆ¶ï¼ˆåº”è¯¥ä» USAGE_LIMITS è·å–ï¼‰
- å¦‚æœä»¥åä¿®æ”¹ Anonymous é™åˆ¶ï¼Œè¿™é‡Œä¼šä¸ä¸€è‡´

**å»ºè®®ä¿®å¤**:
```typescript
if (!user) {
  const limits = getLimits("anonymous")
  return Response.json({
    tier: "anonymous",
    usage: { daily: 0, monthly: 0 },
    limits: { daily: limits.daily, monthly: limits.monthly },
    remaining: { daily: limits.daily, monthly: limits.monthly },
  })
}
```

**ä¸¥é‡æ€§**: ğŸŸ¡ ä¸­ä½ï¼ˆåŠŸèƒ½æ­£å¸¸ï¼Œä½†ä¸å¤Ÿè§„èŒƒï¼‰

---

### ğŸŸ¡ é—®é¢˜ 2: å‰ç«¯åŒæ­¥ä¸æ˜¯å®æ—¶çš„

**å½“å‰å®ç°**:
- åªåœ¨ç™»å½•æ—¶åŒæ­¥ä¸€æ¬¡
- ä¸åœ¨è§£æ¢¦æˆåŠŸååŒæ­¥

**åœºæ™¯**:
```
è®¾å¤‡ A: ä½¿ç”¨ 3 æ¬¡ â†’ æ•°æ®åº“ = 3
è®¾å¤‡ B: localStorage = 0ï¼ˆæœªåŒæ­¥ï¼‰
  â†“
è®¾å¤‡ B ç™»å½•æ—¶ä¼šåŒæ­¥ âœ…
  â†“
è®¾å¤‡ B ä½¿ç”¨ 2 æ¬¡ â†’ localStorage = 5
è®¾å¤‡ A ä½¿ç”¨ 1 æ¬¡ â†’ æ•°æ®åº“ = 6
  â†“
è®¾å¤‡ B æ˜¾ç¤º: 2 todayï¼ˆé”™è¯¯ï¼Œå®é™…æ˜¯ 3ï¼‰
```

**å»ºè®®ä¿®å¤**: 
åœ¨ app/page.tsx è§£æ¢¦æˆåŠŸåè°ƒç”¨ `syncUsageFromDatabase()`

**ä¸¥é‡æ€§**: ğŸŸ¡ ä¸­ä½ï¼ˆè¾¹ç•Œæƒ…å†µï¼Œå½±å“æœ‰é™ï¼‰

---

### ğŸŸ¢ é—®é¢˜ 3: Anonymous ç”¨æˆ·çš„æ•°æ®åº“åŒæ­¥

**å½“å‰å®ç°**:
- Anonymous ç”¨æˆ·ä½¿ç”¨åæ›´æ–° anonymous_usage è¡¨ âœ…
- ä½† /api/usage ç«¯ç‚¹ä¸æŸ¥è¯¢ IP ä½¿ç”¨æ•°æ®

**åœºæ™¯**:
```
Anonymous ç”¨æˆ·ä½¿ç”¨ 3 æ¬¡
  â†“
anonymous_usage è¡¨è®°å½•: count = 3 âœ…
  â†“
è°ƒç”¨ /api/usage
  â†“
è¿”å›: usage = { daily: 0, monthly: 0 } âŒ ä¸å‡†ç¡®
```

**å½±å“**: Anonymous ç”¨æˆ·å‰ç«¯æ˜¾ç¤ºä¸å‡†ï¼ˆä½†åŠŸèƒ½æ­£å¸¸ï¼Œå› ä¸ºä¾èµ– localStorageï¼‰

**å»ºè®®**: Anonymous ç”¨æˆ·ä¸éœ€è¦åŒæ­¥æ•°æ®åº“ï¼ˆä¾èµ– localStorage å³å¯ï¼‰

**ä¸¥é‡æ€§**: ğŸŸ¢ ä½ï¼ˆè®¾è®¡å¦‚æ­¤ï¼Œacceptableï¼‰

---

## ğŸ“Š æ£€æŸ¥ç»“æœæ±‡æ€»

| ä¼˜åŒ–é¡¹ | å®ç°çŠ¶æ€ | å‘ç°é—®é¢˜ | ä¸¥é‡æ€§ |
|--------|---------|---------|--------|
| P0-1: /api/usage ç«¯ç‚¹ | âœ… å®ç° | ç¡¬ç¼–ç é™åˆ¶ | ğŸŸ¡ ä¸­ä½ |
| P0-2: å‰ç«¯åŒæ­¥ | âœ… å®ç° | ä¸æ˜¯å®æ—¶ | ğŸŸ¡ ä¸­ä½ |
| P1-3: åˆå¹¶æŸ¥è¯¢ | âœ… å®ç° | æ—  | âœ… |
| P1-4: ä¼˜åŒ–è®¡ç®— | âœ… å®ç° | æ—  | âœ… |
| P1-5: unknown IP | âœ… å®ç° | æ—  | âœ… |
| P1-6: é˜ˆå€¼é…ç½®åŒ– | âœ… å®ç° | æ—  | âœ… |

**æ€»ä½“è¯„ä»·**: âœ… æ‰€æœ‰ä¼˜åŒ–éƒ½æ­£ç¡®å®ç°ï¼Œå‘ç° 2 ä¸ªå°é—®é¢˜

---

## ğŸ”§ å»ºè®®çš„ä¿®å¤

### ä¿®å¤ 1: /api/usage ä½¿ç”¨ getLimitsï¼ˆ5 åˆ†é’Ÿï¼‰

```typescript
if (!user) {
  const limits = getLimits("anonymous")  // âœ… ä»é…ç½®è·å–
  return Response.json({
    tier: "anonymous",
    limits: { 
      daily: limits.daily, 
      monthly: limits.monthly 
    },
    // ...
  })
}
```

---

### ä¿®å¤ 2: è§£æ¢¦æˆåŠŸååŒæ­¥ï¼ˆ10 åˆ†é’Ÿï¼‰

```typescript
// app/page.tsx
const handleInterpret = async () => {
  const data = await fetch("/api/interpret").then(r => r.json())
  setInterpretation(data.interpretation)
  incrementUsage()
  
  // âœ… åŒæ­¥æ•°æ®åº“ï¼ˆå·²ç™»å½•ç”¨æˆ·ï¼‰
  if (isAuthenticated) {
    syncUsageFromDatabase()
  }
}
```

---

## âœ… æ ¸å¿ƒåŠŸèƒ½éªŒè¯

### 1. åç«¯ä½¿ç”¨æ¬¡æ•°éªŒè¯

**Anonymous ç”¨æˆ·**:
```typescript
// ç¬¬ 109-161 è¡Œ
if (!user) {
  // æŸ¥è¯¢ IP ä½¿ç”¨æ¬¡æ•°
  const ipUsage = await supabase.from("anonymous_usage").select()
  
  // æ£€æŸ¥æ—¥é™åˆ¶
  if (dailyTotal >= 10) { return 429 }
  
  // æ£€æŸ¥å°æ—¶é™åˆ¶
  if (hourCount >= 5) { return 429 }
}
```

âœ… é€»è¾‘æ­£ç¡®ï¼š
- æŸ¥è¯¢æ•°æ®åº“
- éªŒè¯é™åˆ¶
- æ‹’ç»è¶…é™è¯·æ±‚

---

**å·²ç™»å½•ç”¨æˆ·**:
```typescript
// ç¬¬ 167-201 è¡Œ
if (user) {
  // æŸ¥è¯¢ä½¿ç”¨æ¬¡æ•°
  const usage = await supabase.from("usage_tracking").select()
  
  // éªŒè¯æ—¥é™åˆ¶
  if (usage.daily_count >= limits.daily) { return 429 }
  
  // éªŒè¯æœˆé™åˆ¶
  if (usage.monthly_count >= limits.monthly) { return 429 }
}
```

âœ… é€»è¾‘æ­£ç¡®ï¼š
- æŸ¥è¯¢æ•°æ®åº“
- ä¸¥æ ¼éªŒè¯
- æ‹’ç»è¶…é™è¯·æ±‚

---

### 2. Pro ç”¨æˆ·é™çº§

```typescript
// ç¬¬ 209-220 è¡Œ
if (tier === "pro" && user && usage) {
  const threshold = getDowngradeThreshold(tier) || 100
  if (usage.monthly_count >= threshold) {
    modelId = getFallbackModel(tier)  // é™çº§
    isDowngraded = true
  }
}
```

âœ… é€»è¾‘æ­£ç¡®ï¼š
- ä½¿ç”¨é…ç½®åŒ–é˜ˆå€¼
- æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
- é™çº§åˆ° Haiku

---

### 3. æ•°æ®åº“åŒæ­¥

**å·²ç™»å½•ç”¨æˆ·**:
```typescript
// ç¬¬ 275-302 è¡Œ
if (user) {
  const currentUsage = await supabase.from("usage_tracking").select()
  const isDifferentDay = currentUsage?.day !== currentDay
  const newDailyCount = isDifferentDay ? 1 : (currentUsage?.daily_count || 0) + 1
  const newMonthlyCount = (currentUsage?.monthly_count || 0) + 1
  
  await supabase.from("usage_tracking").upsert({ ... })
}
```

âœ… é€»è¾‘æ­£ç¡®ï¼š
- è‡ªåŠ¨å¤„ç†æ—¥æœŸåˆ‡æ¢
- ç´¯åŠ è®¡æ•°
- upsert æ’å…¥æˆ–æ›´æ–°

---

**Anonymous ç”¨æˆ·**:
```typescript
// ç¬¬ 304-343 è¡Œ
if (!user) {
  const ip = headers.get('x-forwarded-for')
  const hourUsage = await supabase.from("anonymous_usage").select()
  const newCount = (hourUsage?.count || 0) + 1
  
  await supabase.from("anonymous_usage").upsert({ ... })
}
```

âœ… é€»è¾‘æ­£ç¡®ï¼š
- è·å– IP
- æŒ‰å°æ—¶ç´¯åŠ 
- upsert æ›´æ–°

---

## ğŸ¯ æœ€ç»ˆæ£€æŸ¥ç»“æœ

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | é—®é¢˜ |
|------|------|------|
| åç«¯ä½¿ç”¨æ¬¡æ•°éªŒè¯ | âœ… æ­£ç¡® | æ—  |
| Anonymous IP é™æµ | âœ… æ­£ç¡® | æ—  |
| Pro ç”¨æˆ·é™çº§ | âœ… æ­£ç¡® | æ—  |
| æ•°æ®åº“åŒæ­¥ | âœ… æ­£ç¡® | æ—  |
| å‰ç«¯æ•°æ®åŒæ­¥ | âœ… å®ç° | ğŸŸ¡ ä¸æ˜¯å®æ—¶ |
| æŸ¥è¯¢ä¼˜åŒ– | âœ… å®ç° | æ—  |

---

### å‘ç°çš„å°é—®é¢˜

| é—®é¢˜ | ä¸¥é‡æ€§ | æ˜¯å¦é˜»å¡ | å»ºè®® |
|------|--------|---------|------|
| /api/usage ç¡¬ç¼–ç  Anonymous é™åˆ¶ | ğŸŸ¡ ä¸­ä½ | âŒ å¦ | å»ºè®®ä¿®å¤ |
| å‰ç«¯åŒæ­¥ä¸æ˜¯å®æ—¶çš„ | ğŸŸ¡ ä¸­ä½ | âŒ å¦ | å¯é€‰ä¿®å¤ |

---

## ğŸ’¡ å»ºè®®çš„é¢å¤–ä¿®å¤ï¼ˆå¯é€‰ï¼‰

### ä¿®å¤ A: /api/usage ä½¿ç”¨ getLimitsï¼ˆ5 åˆ†é’Ÿï¼‰

**å·¥ä½œé‡**: 5 åˆ†é’Ÿ  
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­ä½  
**æ˜¯å¦å¿…é¡»**: å¦ï¼ˆä½†æ›´è§„èŒƒï¼‰

---

### ä¿®å¤ B: è§£æ¢¦æˆåŠŸååŒæ­¥æ•°æ®ï¼ˆ10 åˆ†é’Ÿï¼‰

**å·¥ä½œé‡**: 10 åˆ†é’Ÿ  
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­ä½  
**æ˜¯å¦å¿…é¡»**: å¦ï¼ˆè¾¹ç•Œæƒ…å†µï¼Œå½±å“å°ï¼‰

---

## âœ… ç»“è®º

### å®Œæˆæƒ…å†µ

**P0 ä¼˜åŒ–**: âœ… 2/2 æ­£ç¡®å®ç°  
**P1 ä¼˜åŒ–**: âœ… 4/4 æ­£ç¡®å®ç°

**å‘ç°é—®é¢˜**: 2 ä¸ªå°é—®é¢˜ï¼ˆéƒ½ä¸é˜»å¡åŠŸèƒ½ï¼‰

### ä»£ç è´¨é‡

- âœ… æ—  Linter é”™è¯¯
- âœ… é€»è¾‘æ­£ç¡®
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ€§èƒ½ä¼˜åŒ–è¾¾æˆ
- ğŸŸ¡ æœ‰ 2 ä¸ªå¯é€‰çš„æ”¹è¿›ç‚¹

---

## â“ è€æ¿ï¼Œè¯·æŒ‡ç¤º

**é€‰é¡¹ 1**: è¿™ 2 ä¸ªå°é—®é¢˜å¯ä»¥æ¥å—ï¼Œç°åœ¨å°±éƒ¨ç½²  
**é€‰é¡¹ 2**: ä¿®å¤è¿™ 2 ä¸ªå°é—®é¢˜å†éƒ¨ç½²ï¼ˆ15 åˆ†é’Ÿï¼‰  
**é€‰é¡¹ 3**: è€æ¿ä½ å†³å®š

**æˆ‘çš„å»ºè®®**: 
- æ ¸å¿ƒåŠŸèƒ½éƒ½æ­£ç¡®äº†
- 2 ä¸ªå°é—®é¢˜ä¸å½±å“ä½¿ç”¨
- å¯ä»¥å…ˆéƒ¨ç½²ï¼Œåç»­å†ä¼˜åŒ–

**ç­‰å¾…è€æ¿æŒ‡ç¤ºï¼** ğŸ™

