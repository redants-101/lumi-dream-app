# 🧪 混合限制系统测试指南

**测试目标**: 验证每日 + 每月双重限制正常工作

---

## 🚀 快速开始

```bash
# 开发服务器运行中
访问 http://localhost:3000
```

---

## 📋 测试前准备

### 清除旧数据

```javascript
// 打开浏览器控制台（F12）
localStorage.removeItem("lumi_usage_data")      // 旧系统
localStorage.removeItem("lumi_usage_data_v2")   // 新系统
localStorage.clear()  // 清除所有

// 刷新页面
location.reload()
```

---

## 🧪 测试场景

### 场景 1: 未登录用户每日限制 ⭐

**配置**: 2次/天，5次/月

#### 步骤

1. **确保未登录**
   - 如果已登录，点击 Sign out

2. **解析第 1 次梦境**
   ```
   输入: "I was flying"
   点击: Illuminate My Dream
   
   观察:
   ✅ 成功显示解析结果
   ✅ 右上角显示"4 left this month"
   ```

3. **解析第 2 次梦境**
   ```
   输入: "I was swimming"
   点击: Illuminate
   
   观察:
   ✅ 成功显示解析结果
   ✅ 右上角显示"3 left this month"
   ⚠️ Alert 显示提示（剩余 ≤ 5）
   ```

4. **尝试解析第 3 次**
   ```
   输入: "I was running"
   点击: Illuminate
   
   预期:
   ❌ 显示错误："You've reached your daily limit of 2 interpretations. Please try again tomorrow."
   ❌ 按钮禁用
   ```

5. **验证 localStorage**
   ```javascript
   // 控制台
   JSON.parse(localStorage.getItem("lumi_usage_data_v2"))
   
   // 应该看到:
   {
     "dailyCount": 2,     // ← 今天用了 2 次
     "date": "2025-10-21",
     "monthlyCount": 2,   // ← 本月用了 2 次
     "month": "2025-10"
   }
   ```

---

### 场景 2: 未登录用户月度限制 ⭐⭐

**目标**: 验证月度限制（5次/月）

#### 步骤

1. **模拟已使用 4 次**
   ```javascript
   // 控制台
   localStorage.setItem("lumi_usage_data_v2", JSON.stringify({
     dailyCount: 0,
     date: "2025-10-21",
     monthlyCount: 4,  // ← 本月已用 4 次
     month: "2025-10"
   }))
   
   location.reload()
   ```

2. **解析第 5 次（最后 1 次）**
   ```
   观察:
   ✅ 右上角显示"1 left this month"
   ✅ Alert 显示警告
   ✅ 解析成功
   ```

3. **尝试解析第 6 次**
   ```
   预期:
   ❌ 显示错误："You've reached your monthly limit of 5 interpretations."
   ❌ 按钮禁用
   🔐 显示登录对话框
   ```

---

### 场景 3: 已登录免费用户 ⭐⭐⭐

**配置**: 5次/天，30次/月

#### 步骤

1. **登录**
   - 点击 Sign in with Google/GitHub

2. **解析 5 次梦境**
   ```
   观察:
   ✅ 每次成功
   ✅ 右上角显示剩余（30→29→28...→25）
   ✅ 第 5 次后显示"达到每日限制"
   ```

3. **模拟跨天**
   ```javascript
   // 修改日期为昨天
   const data = JSON.parse(localStorage.getItem("lumi_usage_data_v2"))
   data.date = "2025-10-20"  // 昨天
   data.dailyCount = 5        // 昨天用了 5 次
   localStorage.setItem("lumi_usage_data_v2", JSON.stringify(data))
   
   location.reload()
   ```

4. **验证今天又有 5 次**
   ```
   观察:
   ✅ 可以继续解析
   ✅ dailyCount 重置为 0
   ✅ monthlyCount 保持累计
   ```

5. **测试月度限制**
   ```javascript
   // 模拟本月已用 30 次
   localStorage.setItem("lumi_usage_data_v2", JSON.stringify({
     dailyCount: 0,
     date: "2025-10-21",
     monthlyCount: 30,  // ← 本月用完
     month: "2025-10"
   }))
   
   location.reload()
   ```

6. **验证显示升级提示**
   ```
   预期:
   ❌ 不能解析
   👑 显示升级对话框
   💬 "Upgrade to Basic for 50/month"
   ```

---

### 场景 4: 跨月重置 ⭐⭐⭐

#### 步骤

1. **模拟10月用完**
   ```javascript
   localStorage.setItem("lumi_usage_data_v2", JSON.stringify({
     dailyCount: 2,
     date: "2025-10-31",  // 10月最后一天
     monthlyCount: 5,      // 本月用完
     month: "2025-10"
   }))
   
   location.reload()
   ```

2. **模拟11月1号**
   ```javascript
   // 修改月份
   const data = JSON.parse(localStorage.getItem("lumi_usage_data_v2"))
   data.month = "2025-11"  // ← 改为11月
   // 注意：实际使用时会自动检测
   localStorage.setItem("lumi_usage_data_v2", JSON.stringify(data))
   
   location.reload()
   ```

3. **验证重置**
   ```
   观察:
   ✅ monthlyCount 重置为 0
   ✅ 可以继续使用
   ✅ 右上角显示"5 left this month"
   ```

---

### 场景 5: 限制提示分级 ⭐⭐

#### 剩余次数提示

| 剩余（月度） | 提示位置 | 提示强度 |
|------------|---------|---------|
| > 5 | 无 | - |
| ≤ 5 | Alert | ⚠️ 温和 |
| ≤ 2 | Alert + Toast | ⚠️⚠️ 加强 |
| = 0 | 对话框 | 🚨 强制 |

#### 测试步骤

```javascript
// 剩余 5 次
localStorage.setItem("lumi_usage_data_v2", JSON.stringify({
  dailyCount: 0,
  date: "2025-10-21",
  monthlyCount: 25,  // 已用 25，剩余 5
  month: "2025-10"
}))
刷新 → 观察是否显示 Alert ✅

// 剩余 2 次
data.monthlyCount = 28  // 已用 28，剩余 2
// 解析一次 → 观察是否显示 Toast ✅

// 用完
data.monthlyCount = 30  // 用完
刷新 → 观察是否显示对话框 ✅
```

---

## 📊 数据验证清单

### 每日数据

- [ ] `dailyCount` 正确递增
- [ ] 每天 0:00 自动重置为 0
- [ ] 达到每日限制时不能使用
- [ ] 跨天后可以继续使用

### 每月数据

- [ ] `monthlyCount` 正确递增
- [ ] 每月 1 号自动重置为 0
- [ ] 达到每月限制时不能使用
- [ ] 跨月后可以继续使用

### 限制类型检测

- [ ] 达到每日限制 → `limitType = "daily"`
- [ ] 达到每月限制 → `limitType = "monthly"`
- [ ] 未达到 → `limitType = "none"`

---

## 🔍 调试技巧

### 查看当前使用数据

```javascript
// 浏览器控制台
const data = JSON.parse(localStorage.getItem("lumi_usage_data_v2"))
console.table(data)

// 输出:
// ┌──────────────┬────────┐
// │ dailyCount   │ 2      │
// │ date         │ 2025-… │
// │ monthlyCount │ 8      │
// │ month        │ 2025-10│
// └──────────────┴────────┘
```

### 手动修改测试

```javascript
// 设置任意值测试
localStorage.setItem("lumi_usage_data_v2", JSON.stringify({
  dailyCount: 1,        // ← 今天用了 1 次
  date: "2025-10-21",
  monthlyCount: 28,     // ← 本月用了 28 次
  month: "2025-10"
}))

location.reload()

// 验证:
// - 今天还可以用 1 次（每日限制 2）
// - 本月还可以用 2 次（每月限制 30）
// - 最小值是 1 次
```

### 重置到初始状态

```javascript
localStorage.removeItem("lumi_usage_data_v2")
location.reload()
```

---

## ✅ 验收标准

### 必须通过

- [ ] 未登录用户：2次/天，5次/月
- [ ] 已登录用户：5次/天，30次/月
- [ ] 每日 0:00 重置每日计数
- [ ] 每月 1 号重置月度计数
- [ ] 达到任一限制都不能使用
- [ ] 提示文案正确
- [ ] UI 显示月度剩余
- [ ] 无代码错误

### 边界情况

- [ ] 跨天正确重置
- [ ] 跨月正确重置
- [ ] 登录后计数独立
- [ ] localStorage 清除后正常
- [ ] 快速连续解析正常

---

## 🎯 预期效果

### 成本控制

**之前**: $435/月（1000 用户）  
**现在**: $84/月  
**节省**: **$351/月**（-81%）✅

### 用户体验

**免费用户**:
- 旧: 150 次/月（太多，没升级动力）
- 新: 5 次/月（稀缺，有升级动力）✅

**付费价值**:
- 旧: Free 300 vs Basic 300（无区别）
- 新: Free 30 vs Basic 50（+67%）✅

---

**立即开始测试！** 🧪

**重点测试**: 场景 1 和场景 2

---

**预计测试时间**: 20-30 分钟  
**验收标准**: 所有复选框打勾

