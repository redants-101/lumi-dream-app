# âš ï¸ ç”¨æˆ·å±‚çº§æ˜¾ç¤ºé—ªçƒé—®é¢˜

## ğŸš¨ é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šBasic ç”¨æˆ·ç™»å½•åï¼Œé¡µé¢æ˜¾ç¤ºä¼šç»å†å¤šæ¬¡å˜åŒ–ï¼š

```
åˆå§‹ï¼š0 today, 0 this month
  â†“
é”™è¯¯ï¼š5 today, 10 this month  â† Free å±‚çº§çš„é™åˆ¶ âŒ
  â†“
æ­£ç¡®ï¼š10 today, 50 this month  â† Basic å±‚çº§çš„é™åˆ¶ âœ…
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âŒ æ˜¾ç¤ºé—ªçƒï¼Œä¸ä¸“ä¸š
- âŒ ç”¨æˆ·çœ‹åˆ°é”™è¯¯çš„é™åˆ¶æ•°å€¼
- âŒ å¯èƒ½å¯¼è‡´ç”¨æˆ·å›°æƒ‘

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### æ•°æ®åŠ è½½æ—¶é—´çº¿

```
æ—¶é—´ 0msï¼šé¡µé¢åŠ è½½
  â†“
subscription: null â† åˆå§‹çŠ¶æ€
usageData: null
  â†“
getUserTier() è¿”å› "free" â† âŒ é»˜è®¤å€¼é”™è¯¯
  â†“
æ˜¾ç¤ºï¼š5 today, 10 this monthï¼ˆfree çš„é™åˆ¶ï¼‰
  
æ—¶é—´ 1000msï¼šAPI å®Œæˆ
  â†“
subscription: { tier: "basic" } âœ…
usageData: { daily: 0, monthly: 0 }
  â†“
getUserTier() è¿”å› "basic" âœ…
  â†“
æ˜¾ç¤ºï¼š10 today, 50 this monthï¼ˆbasic çš„é™åˆ¶ï¼‰âœ…
```

### é—®é¢˜ä»£ç 

```typescript
// hooks/use-usage-limit-v2.ts
const getUserTier = (): UserTier => {
  if (!isAuthenticated) {
    return "anonymous"
  }
  
  // âŒ é—®é¢˜ï¼šsubscription åŠ è½½ä¸­æ—¶ï¼Œè¿”å› "free"
  if (subscription && subscription.tier) {
    return subscription.tier as UserTier
  }
  
  // âŒ é»˜è®¤ä¸º freeï¼ˆä¸å‡†ç¡®ï¼‰
  return "free"
}
```

### å½±å“èŒƒå›´

```typescript
// app/page.tsx
const { remainingDaily, remainingMonthly } = useUsageLimitV2()

// æ˜¾ç¤ºéƒ¨åˆ†
<span>{remainingDaily} today</span>  â† åŸºäº getUserTier() è®¡ç®—
<span>{remainingMonthly} this month</span>  â† åŸºäº getUserTier() è®¡ç®—
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šåŠ è½½æ—¶ä¸æ˜¾ç¤ºï¼ˆæ¨è â­â­â­ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨ subscription åŠ è½½å®Œæˆä¹‹å‰ï¼Œä¸æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°æˆ–æ˜¾ç¤ºåŠ è½½çŠ¶æ€ã€‚

```typescript
// app/page.tsx

// å¼•å…¥ subscriptionLoading çŠ¶æ€
const { 
  remainingDaily,
  remainingMonthly,
  subscription,
  subscriptionLoading,  // âœ… æ–°å¢
} = useUsageLimitV2()

// æ˜¾ç¤ºé€»è¾‘
{!isLimitReached && (
  subscriptionLoading ? (
    // âœ… åŠ è½½ä¸­ï¼šæ˜¾ç¤º Skeleton æˆ–éšè—
    <Skeleton className="h-4 w-32" />
  ) : (
    // âœ… åŠ è½½å®Œæˆï¼šæ˜¾ç¤ºæ­£ç¡®çš„å€¼
    <span className="flex items-center gap-1.5">
      <span>{remainingDaily} today</span>
      <span>â€¢</span>
      <span>{remainingMonthly} this month</span>
    </span>
  )
)}
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ— é—ªçƒ
- âœ… æ˜¾ç¤ºå§‹ç»ˆæ­£ç¡®
- âœ… ç”¨æˆ·ä½“éªŒä¸“ä¸š

**åŠ£åŠ¿**ï¼š
- âš ï¸ åŠ è½½æ—¶çŸ­æš‚çœ‹ä¸åˆ°æ•°å€¼ï¼ˆçº¦ 1 ç§’ï¼‰

---

### æ–¹æ¡ˆ Bï¼šç¼“å­˜ä¸Šæ¬¡çš„å±‚çº§ï¼ˆæ¨è â­â­ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šå°†ç”¨æˆ·å±‚çº§ç¼“å­˜åˆ° localStorageï¼Œåˆå§‹æ—¶ä½¿ç”¨ç¼“å­˜å€¼ã€‚

```typescript
// hooks/use-usage-limit-v2.ts

// ç¼“å­˜å±‚çº§åˆ° localStorage
const TIER_STORAGE_KEY = "lumi_user_tier"

const getUserTier = (): UserTier => {
  if (!isAuthenticated) {
    return "anonymous"
  }
  
  // ä» subscription è·å–
  if (subscription && subscription.tier) {
    const tier = subscription.tier as UserTier
    // âœ… ç¼“å­˜åˆ° localStorage
    if (typeof window !== "undefined") {
      localStorage.setItem(TIER_STORAGE_KEY, tier)
    }
    return tier
  }
  
  // âœ… ä» localStorage è¯»å–ä¸Šæ¬¡çš„å±‚çº§
  if (typeof window !== "undefined") {
    const cachedTier = localStorage.getItem(TIER_STORAGE_KEY)
    if (cachedTier && ['free', 'basic', 'pro'].includes(cachedTier)) {
      return cachedTier as UserTier
    }
  }
  
  // æœ€åæ‰é»˜è®¤ä¸º free
  return "free"
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… åˆå§‹æ˜¾ç¤ºå‡†ç¡®ï¼ˆåŸºäºç¼“å­˜ï¼‰
- âœ… æ— é—ªçƒ
- âœ… API å®ŒæˆåéªŒè¯å¹¶æ›´æ–°

**åŠ£åŠ¿**ï¼š
- âš ï¸ å¦‚æœç”¨æˆ·é™çº§ï¼Œå¯èƒ½çŸ­æš‚æ˜¾ç¤ºæ—§å±‚çº§
- âš ï¸ éœ€è¦é¢å¤–çš„ localStorage ç®¡ç†

---

### æ–¹æ¡ˆ Cï¼šå»¶è¿Ÿæ¸²æŸ“ï¼ˆæ¨è â­ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šç­‰å¾… subscription åŠ è½½å®Œæˆåå†æ¸²æŸ“æ•´ä¸ªç»„ä»¶ã€‚

```typescript
// app/page.tsx

const { subscription, subscriptionLoading } = useUsageLimitV2()

if (isAuthenticated && subscriptionLoading) {
  // âœ… æ˜¾ç¤ºåŠ è½½ç•Œé¢
  return (
    <main className="min-h-screen flex items-center justify-center">
      <Loader2 className="w-8 h-8 animate-spin text-primary" />
    </main>
  )
}

// âœ… subscription å·²åŠ è½½ï¼Œæ­£å¸¸æ˜¾ç¤º
return (
  <main>
    {/* æ˜¾ç¤ºæ­£ç¡®çš„é™åˆ¶ */}
    <span>{remainingDaily} today, {remainingMonthly} this month</span>
  </main>
)
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ— é—ªçƒ
- âœ… æ˜¾ç¤ºå§‹ç»ˆæ­£ç¡®
- âœ… å®ç°ç®€å•

**åŠ£åŠ¿**ï¼š
- âš ï¸ é¡µé¢åŠ è½½ç•¥æ…¢ï¼ˆç­‰å¾… APIï¼‰

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### ç»¼åˆæ–¹æ¡ˆï¼šA + Bï¼ˆæœ€ä½³ï¼‰

**ç»“åˆæ–¹æ¡ˆ A å’Œ B çš„ä¼˜ç‚¹**ï¼š

1. **ä½¿ç”¨ç¼“å­˜å±‚çº§**ï¼ˆå‡å°‘é—ªçƒï¼‰
2. **åŠ è½½æ—¶æ˜¾ç¤º Skeleton**ï¼ˆä¸“ä¸šä½“éªŒï¼‰
3. **åŠ è½½å®Œæˆåæ˜¾ç¤ºå‡†ç¡®å€¼**ï¼ˆå¯é ï¼‰

```typescript
// hooks/use-usage-limit-v2.ts

const TIER_STORAGE_KEY = "lumi_user_tier"

const getUserTier = (): UserTier => {
  if (!isAuthenticated) {
    return "anonymous"
  }
  
  // ä¼˜å…ˆä» subscription è·å–
  if (subscription && subscription.tier) {
    const tier = subscription.tier as UserTier
    // ç¼“å­˜åˆ° localStorage
    if (typeof window !== "undefined") {
      localStorage.setItem(TIER_STORAGE_KEY, tier)
    }
    return tier
  }
  
  // âœ… åŠ è½½ä¸­ï¼šä»ç¼“å­˜è¯»å–
  if (subscriptionLoading && typeof window !== "undefined") {
    const cachedTier = localStorage.getItem(TIER_STORAGE_KEY)
    if (cachedTier && ['free', 'basic', 'pro'].includes(cachedTier)) {
      return cachedTier as UserTier
    }
  }
  
  // æœ€åæ‰é»˜è®¤ä¸º free
  return "free"
}
```

```typescript
// app/page.tsx

{!isLimitReached && (
  <span className="text-xs text-muted-foreground">
    {subscriptionLoading && !subscription ? (
      // âœ… é¦–æ¬¡åŠ è½½ï¼šæ˜¾ç¤º Skeleton
      <Skeleton className="h-4 w-32" />
    ) : (
      // âœ… åŠ è½½å®Œæˆï¼šæ˜¾ç¤ºæ­£ç¡®çš„å€¼
      <span className="flex items-center gap-1.5">
        <span>{remainingDaily} today</span>
        <span>â€¢</span>
        <span>{remainingMonthly} this month</span>
      </span>
    )}
  </span>
)}
```

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆæœ‰é—ªçƒï¼‰

```
0ms: æ˜¾ç¤º "0 today, 0 this month"
100ms: æ˜¾ç¤º "5 today, 10 this month"  â† é”™è¯¯ï¼ˆfree å±‚çº§ï¼‰
1000ms: æ˜¾ç¤º "10 today, 50 this month"  â† æ­£ç¡®ï¼ˆbasic å±‚çº§ï¼‰

ç”¨æˆ·çœ‹åˆ°ï¼š3 æ¬¡å˜åŒ–ï¼Œä½“éªŒå·® âŒ
```

### ä¿®å¤åï¼ˆæ–¹æ¡ˆ Aï¼‰

```
0ms: æ˜¾ç¤º Skeletonï¼ˆåŠ è½½ä¸­ï¼‰
1000ms: æ˜¾ç¤º "10 today, 50 this month"  â† ç›´æ¥æ˜¾ç¤ºæ­£ç¡®å€¼

ç”¨æˆ·çœ‹åˆ°ï¼š1 æ¬¡å˜åŒ–ï¼Œä½“éªŒå¥½ âœ…
```

### ä¿®å¤åï¼ˆæ–¹æ¡ˆ Bï¼‰

```
0ms: æ˜¾ç¤º "10 today, 50 this month"  â† ä½¿ç”¨ç¼“å­˜ï¼ˆé€šå¸¸æ­£ç¡®ï¼‰
1000ms: éªŒè¯å¹¶æ›´æ–°ï¼ˆå¦‚æœ‰å˜åŒ–ï¼‰

ç”¨æˆ·çœ‹åˆ°ï¼šå‡ ä¹æ— å˜åŒ–ï¼Œä½“éªŒæœ€å¥½ âœ…
```

### ä¿®å¤åï¼ˆæ–¹æ¡ˆ A + Bï¼‰

```
é¦–æ¬¡ç™»å½•ï¼š
0ms: æ˜¾ç¤º Skeletonï¼ˆæ— ç¼“å­˜ï¼‰
1000ms: æ˜¾ç¤º "10 today, 50 this month"  â† æ­£ç¡®

å†æ¬¡è®¿é—®ï¼š
0ms: æ˜¾ç¤º "10 today, 50 this month"  â† ä½¿ç”¨ç¼“å­˜
1000ms: éªŒè¯ï¼ˆæ— å˜åŒ–ï¼‰

ç”¨æˆ·çœ‹åˆ°ï¼šé¦–æ¬¡æœ‰ Skeletonï¼Œä¹‹åç«‹å³æ˜¾ç¤º âœ…
```

---

## âœ… æ¨èæ–¹æ¡ˆ

**ç«‹å³å®æ–½ï¼šæ–¹æ¡ˆ Aï¼ˆåŠ è½½æ—¶æ˜¾ç¤º Skeletonï¼‰**

**ä¼˜åŠ¿**ï¼š
- âœ… å®ç°ç®€å•ï¼ˆ5 åˆ†é’Ÿï¼‰
- âœ… æ— é—ªçƒ
- âœ… ä¸“ä¸šä½“éªŒ

**ä¸­æœŸå®æ–½ï¼šæ–¹æ¡ˆ A + Bï¼ˆç¼“å­˜ + Skeletonï¼‰**

**ä¼˜åŠ¿**ï¼š
- âœ… é¦–æ¬¡åŠ è½½æœ‰ Skeleton
- âœ… åç»­è®¿é—®ç«‹å³æ˜¾ç¤º
- âœ… æœ€ä½³ç”¨æˆ·ä½“éªŒ

---

## ğŸ¯ å®æ–½å»ºè®®

éœ€è¦æˆ‘å¸®æ‚¨ç«‹å³å®æ–½**æ–¹æ¡ˆ Aï¼ˆæ˜¾ç¤º Skeletonï¼‰**å—ï¼Ÿ

åªéœ€ä¿®æ”¹ `app/page.tsx`ï¼Œ5 åˆ†é’Ÿå®Œæˆï¼Œç«‹å³æ¶ˆé™¤é—ªçƒé—®é¢˜ï¼

