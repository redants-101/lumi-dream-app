# âœ… æ··åˆæ¨¡å¼ï¼ˆHybrid Modeï¼‰å®æ–½å®Œæˆ

## ğŸ“‹ å®æ–½æ¦‚è¿°

æˆåŠŸå®æ–½**æ–¹æ¡ˆ 2ï¼šæ··åˆæ¨¡å¼**ï¼Œè§£å†³ Anonymous ç”¨æˆ·å‰åç«¯æ•°æ®ä¸åŒæ­¥é—®é¢˜ã€‚

**æ ¸å¿ƒç­–ç•¥**ï¼š
- ğŸ“± **å‰ç«¯**ï¼šä½¿ç”¨ localStorageï¼ˆå¿«é€Ÿå“åº”ï¼‰
- ğŸ” **åç«¯**ï¼šä½œä¸ºæœ€ç»ˆæƒå¨ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰
- ğŸ”„ **è‡ªåŠ¨åŒæ­¥**ï¼šä» API å“åº”åŒæ­¥çœŸå®æ•°æ®

---

## ğŸ¯ è§£å†³çš„é—®é¢˜

### âŒ é—®é¢˜åœºæ™¯

#### åœºæ™¯ 1ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜
```
1ï¸âƒ£ ç”¨æˆ·ä½¿ç”¨ 2 æ¬¡ â†’ åç«¯ IP è®°å½•ï¼š2/2
2ï¸âƒ£ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ â†’ å‰ç«¯ localStorageï¼š0/2
3ï¸âƒ£ å‰ç«¯æ˜¾ç¤º"å¯ç”¨" â†’ ç”¨æˆ·ç‚¹å‡»è§£æ
4ï¸âƒ£ åç«¯æ‹’ç» â†’ ç”¨æˆ·å›°æƒ‘ âŒ
```

#### åœºæ™¯ 2ï¼šæ¢æµè§ˆå™¨/è®¾å¤‡
```
1ï¸âƒ£ Chrome ä½¿ç”¨ 2 æ¬¡ â†’ IPï¼š2/2
2ï¸âƒ£ åˆ‡æ¢åˆ° Firefox â†’ å‰ç«¯ï¼š0/2
3ï¸âƒ£ å‰ç«¯æ˜¾ç¤º"å¯ç”¨" â†’ åç«¯æ‹’ç» âŒ
```

#### åœºæ™¯ 3ï¼šæ¢ç½‘ç»œï¼ˆæ¢ IPï¼‰
```
1ï¸âƒ£ WiFi ä½¿ç”¨ 2 æ¬¡ â†’ å‰ç«¯ï¼š2/2
2ï¸âƒ£ åˆ‡æ¢åˆ° 4Gï¼ˆæ–° IPï¼‰ â†’ åç«¯ï¼š0/2
3ï¸âƒ£ å‰ç«¯æ˜¾ç¤º"å·²ç”¨å®Œ" â†’ å®é™…å¯ç”¨ âŒ
```

### âœ… æ··åˆæ¨¡å¼è§£å†³æ–¹æ¡ˆ

**è‡ªåŠ¨åŒæ­¥æœºåˆ¶**ï¼š
- API æˆåŠŸå“åº” â†’ åŒæ­¥çœŸå®ä½¿ç”¨æ•°æ®
- API é”™è¯¯å“åº”ï¼ˆé™åˆ¶ï¼‰â†’ åŒæ­¥çœŸå®ä½¿ç”¨æ•°æ®
- **ç»“æœ**ï¼šå‰ç«¯è‡ªåŠ¨ä¿®æ­£ï¼Œå§‹ç»ˆä¸åç«¯ä¸€è‡´

---

## ğŸ”§ å®æ–½ç»†èŠ‚

### 1. ä¿®æ”¹ Hookï¼ˆ`hooks/use-usage-limit-v2.ts`ï¼‰

#### æ–°å¢æ–¹æ³•ï¼š`syncFromResponse`

```typescript
/**
 * âœ… ä» API å“åº”åŒæ­¥ä½¿ç”¨æ•°æ®ï¼ˆæ··åˆæ¨¡å¼å…³é”®ï¼‰
 * ç”¨äºï¼šåç«¯æ‹’ç»è¯·æ±‚æ—¶ï¼ŒåŒæ­¥çœŸå®ä½¿ç”¨æƒ…å†µåˆ°å‰ç«¯
 */
const syncFromResponse = (responseUsage: { daily: number; monthly: number }) => {
  const today = getTodayDate()
  const thisMonth = getCurrentMonth()
  
  const syncedData: UsageData = {
    dailyCount: responseUsage.daily,
    date: today,
    monthlyCount: responseUsage.monthly,
    month: thisMonth,
  }
  
  saveUsageData(syncedData)
  setUsageData(syncedData)
  updateLimitStatus(syncedData)
  
  console.log("[Usage Limit V2] âœ… Synced from API response:", syncedData)
}

// å¯¼å‡ºæ–¹æ³•
return {
  // ... å…¶ä»–è¿”å›å€¼
  syncFromResponse,  // âœ… ä»å“åº”åŒæ­¥ï¼ˆæ··åˆæ¨¡å¼ - æ‰€æœ‰ç”¨æˆ·ï¼‰
}
```

---

### 2. ä¿®æ”¹é¡µé¢ï¼ˆ`app/page.tsx`ï¼‰

#### å¼•å…¥åŒæ­¥æ–¹æ³•

```typescript
const { 
  canUse, 
  incrementUsage, 
  // ... å…¶ä»–æ–¹æ³•
  syncFromResponse  // âœ… æ··åˆæ¨¡å¼ï¼šä» API å“åº”åŒæ­¥ä½¿ç”¨æ•°æ®
} = useUsageLimitV2()
```

#### æˆåŠŸå“åº”åŒæ­¥

```typescript
// âœ… API æˆåŠŸæ ¼å¼ï¼š{ success: true, data: { interpretation: "..." }, metadata: {...} }
setInterpretation(result.data.interpretation)

// âœ… æ··åˆæ¨¡å¼å…³é”®ï¼šä»æˆåŠŸå“åº”åŒæ­¥çœŸå®ä½¿ç”¨æ•°æ®
if (result.metadata?.currentUsage) {
  console.log("[Home] ğŸ”„ Syncing usage from success response:", result.metadata.currentUsage)
  syncFromResponse({
    daily: result.metadata.currentUsage.daily || 0,
    monthly: result.metadata.currentUsage.monthly || 0
  })
} else {
  // å¦‚æœæ²¡æœ‰è¿”å›ä½¿ç”¨æ•°æ®ï¼ˆå‘åå…¼å®¹ï¼‰ï¼Œä½¿ç”¨æœ¬åœ°è®¡æ•°
  incrementUsage()
}
```

#### é”™è¯¯å“åº”åŒæ­¥ï¼ˆå…³é”®ï¼‰

```typescript
// æ£€æŸ¥ API å“åº”çŠ¶æ€
if (!result.success) {
  // âœ… æ··åˆæ¨¡å¼å…³é”®ï¼šä»é”™è¯¯å“åº”åŒæ­¥çœŸå®ä½¿ç”¨æ•°æ®
  if (result.error?.details?.currentUsage) {
    console.log("[Home] ğŸ”„ Syncing usage from error response:", result.error.details.currentUsage)
    syncFromResponse({
      daily: result.error.details.currentUsage.daily || 0,
      monthly: result.error.details.currentUsage.monthly || 0
    })
  }
  
  // âœ… API é”™è¯¯æ ¼å¼ï¼š{ success: false, error: { message: "...", code: "...", details: {...} } }
  throw new Error(result.error?.message || "Failed to interpret dream")
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### Anonymous ç”¨æˆ·ä½¿ç”¨æµç¨‹

```
1ï¸âƒ£ ç”¨æˆ·æ‰“å¼€é¡µé¢
   â†“
   å‰ç«¯ä» localStorage è¯»å–ï¼š{ daily: 0, monthly: 0 }
   æ˜¾ç¤ºï¼š"2 interpretations left"
   
2ï¸âƒ£ ç”¨æˆ·æäº¤æ¢¦å¢ƒ
   â†“
   åç«¯éªŒè¯ IP ä½¿ç”¨æƒ…å†µï¼š{ daily: 1, monthly: 3 }
   
3ï¸âƒ£ åç«¯è¿”å›æˆåŠŸ
   â†“
   å‰ç«¯æ”¶åˆ°ï¼šmetadata.currentUsage = { daily: 1, monthly: 3 }
   
4ï¸âƒ£ è‡ªåŠ¨åŒæ­¥
   â†“
   localStorage æ›´æ–°ä¸ºï¼š{ daily: 1, monthly: 3 }
   å‰ç«¯æ˜¾ç¤ºï¼š"1 interpretation left today"
```

### æ¸…é™¤ç¼“å­˜åçš„è‡ªåŠ¨ä¿®æ­£

```
åœºæ™¯ï¼šç”¨æˆ·å·²ç”¨ 2 æ¬¡ï¼Œæ¸…é™¤ç¼“å­˜

1ï¸âƒ£ æ¸…é™¤ç¼“å­˜
   â†“
   localStorageï¼š{ daily: 0, monthly: 0 }
   å‰ç«¯æ˜¾ç¤ºï¼š"2 interpretations left" âš ï¸ ä¸å‡†ç¡®
   
2ï¸âƒ£ ç”¨æˆ·æäº¤æ¢¦å¢ƒ
   â†“
   åç«¯éªŒè¯ IPï¼š{ daily: 2, monthly: 4 } âŒ å·²è¾¾é™åˆ¶
   
3ï¸âƒ£ åç«¯è¿”å›é”™è¯¯
   â†“
   error.details.currentUsage = { daily: 2, monthly: 4 }
   
4ï¸âƒ£ è‡ªåŠ¨åŒæ­¥ä¿®æ­£
   â†“
   localStorage æ›´æ–°ä¸ºï¼š{ daily: 2, monthly: 4 }
   å‰ç«¯æ˜¾ç¤ºï¼š"Daily limit reached" âœ… å·²ä¿®æ­£
```

---

## ğŸ“Š æ•°æ®æµå‘

### æˆåŠŸè¯·æ±‚
```
ç”¨æˆ·æäº¤
  â†“
å‰ç«¯ localStorage â†’ é¢„æ£€æŸ¥ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰
  â†“
åç«¯ IP éªŒè¯ â†’ æœ€ç»ˆæƒå¨
  â†“
æˆåŠŸå“åº” + currentUsage
  â†“
å‰ç«¯åŒæ­¥çœŸå®æ•°æ® â†’ æ›´æ–° localStorage
```

### å¤±è´¥è¯·æ±‚
```
ç”¨æˆ·æäº¤
  â†“
å‰ç«¯ localStorage â†’ é¢„æ£€æŸ¥ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰
  â†“
åç«¯ IP éªŒè¯ â†’ æœ€ç»ˆæƒå¨
  â†“
æ‹’ç»å“åº” + currentUsageï¼ˆçœŸå®æ•°æ®ï¼‰
  â†“
å‰ç«¯åŒæ­¥çœŸå®æ•°æ® â†’ æ›´æ–° localStorage â†’ æ˜¾ç¤ºæ­£ç¡®é™åˆ¶
```

---

## ğŸ ä¼˜åŠ¿

### âœ… 1. å¿«é€Ÿå“åº”
- å‰ç«¯ç«‹å³æ˜¾ç¤ºé¢„ä¼°å€¼
- æ— éœ€ç­‰å¾… API è°ƒç”¨
- ç”¨æˆ·ä½“éªŒæµç•…

### âœ… 2. é˜²æ­¢æ»¥ç”¨
- åç«¯ä½œä¸ºæœ€ç»ˆæƒå¨
- ç”¨æˆ·æ— æ³•é€šè¿‡æ¸…é™¤ç¼“å­˜ç»•è¿‡é™åˆ¶
- IP é™æµçœŸæ­£ç”Ÿæ•ˆ

### âœ… 3. è‡ªåŠ¨ä¿®æ­£
- å‰åç«¯ä¸ä¸€è‡´æ—¶è‡ªåŠ¨åŒæ­¥
- æ— éœ€æ‰‹åŠ¨åˆ·æ–°
- å¯¹ç”¨æˆ·é€æ˜

### âœ… 4. å‘åå…¼å®¹
- æ”¯æŒæ—§ç‰ˆ APIï¼ˆæ—  currentUsageï¼‰
- è‡ªåŠ¨é™çº§åˆ° localStorage è®¡æ•°
- æ— ç ´åæ€§å˜æ›´

### âœ… 5. ç»Ÿä¸€å®ç°
- åŒæ—¶æ”¯æŒ Anonymous å’Œå·²ç™»å½•ç”¨æˆ·
- ç›¸åŒçš„åŒæ­¥é€»è¾‘
- æ˜“äºç»´æŠ¤

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæ­£å¸¸ä½¿ç”¨
```bash
æµ‹è¯•æ­¥éª¤ï¼š
1. æ— ç—•æ¨¡å¼æ‰“å¼€é¡µé¢
2. ä½¿ç”¨ 1 æ¬¡ â†’ æ£€æŸ¥æ˜¾ç¤º "1/2"
3. ä½¿ç”¨ 2 æ¬¡ â†’ æ£€æŸ¥æ˜¾ç¤º "2/2"
4. å°è¯•ç¬¬ 3 æ¬¡ â†’ è¢«æ‹’ç»ï¼Œæ˜¾ç¤ºæ­£ç¡®é”™è¯¯

é¢„æœŸç»“æœï¼šâœ… æ¯æ¬¡ä½¿ç”¨åæ˜¾ç¤ºæ­£ç¡®çš„å‰©ä½™æ¬¡æ•°
```

### åœºæ™¯ 2ï¼šæ¸…é™¤ç¼“å­˜
```bash
æµ‹è¯•æ­¥éª¤ï¼š
1. ä½¿ç”¨ 2 æ¬¡ï¼ˆè¾¾åˆ°æ—¥é™åˆ¶ï¼‰
2. F12 â†’ Application â†’ Clear Storage
3. åˆ·æ–°é¡µé¢ â†’ æ˜¾ç¤º "0/2"ï¼ˆä¸å‡†ç¡®ï¼‰
4. å°è¯•ä½¿ç”¨ â†’ åç«¯æ‹’ç»
5. æ£€æŸ¥å‰ç«¯æ˜¾ç¤º â†’ è‡ªåŠ¨æ›´æ–°ä¸º "2/2 å·²ç”¨å®Œ"

é¢„æœŸç»“æœï¼šâœ… è‡ªåŠ¨ä¿®æ­£ä¸ºåç«¯çœŸå®æ•°æ®
```

### åœºæ™¯ 3ï¼šæ¢æµè§ˆå™¨
```bash
æµ‹è¯•æ­¥éª¤ï¼š
1. Chrome ä½¿ç”¨ 2 æ¬¡
2. åˆ‡æ¢åˆ° Firefoxï¼ˆåŒ IPï¼‰
3. å‰ç«¯æ˜¾ç¤º "0/2"
4. å°è¯•ä½¿ç”¨ â†’ åç«¯æ‹’ç»
5. å‰ç«¯è‡ªåŠ¨æ›´æ–°ä¸º "2/2"

é¢„æœŸç»“æœï¼šâœ… è‡ªåŠ¨åŒæ­¥çœŸå®é™åˆ¶
```

### åœºæ™¯ 4ï¼šæ¢ç½‘ç»œ
```bash
æµ‹è¯•æ­¥éª¤ï¼š
1. WiFi ä½¿ç”¨ 2 æ¬¡ â†’ å‰ç«¯æ˜¾ç¤º "2/2"
2. åˆ‡æ¢åˆ° 4Gï¼ˆæ–° IPï¼‰
3. å‰ç«¯ä»æ˜¾ç¤º "2/2"ï¼ˆä¸å‡†ç¡®ï¼‰
4. å°è¯•ä½¿ç”¨ â†’ åç«¯å…è®¸ï¼ˆæ–° IPï¼‰
5. å‰ç«¯åŒæ­¥ä¸º "1/2"

é¢„æœŸç»“æœï¼šâœ… è‡ªåŠ¨ä¿®æ­£ä¸ºå¯ç”¨çŠ¶æ€
```

---

## ğŸ“ API å“åº”æ ¼å¼

### æˆåŠŸå“åº”ï¼ˆåŒ…å«ä½¿ç”¨æ•°æ®ï¼‰
```json
{
  "success": true,
  "data": {
    "interpretation": "Your dream suggests..."
  },
  "metadata": {
    "currentUsage": {
      "daily": 1,
      "monthly": 3,
      "limits": {
        "daily": 2,
        "monthly": 4
      }
    },
    "modelUsed": "claude-3-5-haiku-20241022"
  }
}
```

### é”™è¯¯å“åº”ï¼ˆåŒ…å«ä½¿ç”¨æ•°æ®ï¼‰
```json
{
  "success": false,
  "error": {
    "message": "Daily limit reached. Please sign in for more interpretations.",
    "code": "RATE_LIMIT_EXCEEDED",
    "details": {
      "currentUsage": {
        "daily": 2,
        "monthly": 4
      },
      "limits": {
        "daily": 2,
        "monthly": 4
      },
      "resetTime": {
        "daily": "2025-10-31T00:00:00.000Z",
        "monthly": "2025-11-01T00:00:00.000Z"
      },
      "userTier": "anonymous"
    }
  }
}
```

---

## ğŸ” æ§åˆ¶å°æ—¥å¿—

### æ­£å¸¸åŒæ­¥
```
[Home] ğŸ”„ Syncing usage from success response: { daily: 1, monthly: 3 }
[Usage Limit V2] âœ… Synced from API response: { dailyCount: 1, date: '2025-10-30', monthlyCount: 3, month: '2025-10' }
```

### é”™è¯¯åŒæ­¥ï¼ˆä¿®æ­£ä¸ä¸€è‡´ï¼‰
```
[Home] ğŸ”„ Syncing usage from error response: { daily: 2, monthly: 4 }
[Usage Limit V2] âœ… Synced from API response: { dailyCount: 2, date: '2025-10-30', monthlyCount: 4, month: '2025-10' }
```

---

## âš–ï¸ æƒè¡¡ä¸é™åˆ¶

### âœ… ä¼˜åŠ¿
- å¿«é€Ÿå“åº”ï¼ˆæ— éœ€æ¯æ¬¡ API è°ƒç”¨ï¼‰
- è‡ªåŠ¨ä¿®æ­£ï¼ˆä¸ä¸€è‡´æ—¶åŒæ­¥ï¼‰
- é˜²æ­¢æ»¥ç”¨ï¼ˆåç«¯æƒå¨ï¼‰

### âš ï¸ é™åˆ¶
- å‰ç«¯æ˜¾ç¤ºå¯èƒ½çŸ­æš‚ä¸å‡†ç¡®ï¼ˆé¦–æ¬¡åŠ è½½æ—¶ï¼‰
- ç”¨æˆ·å¯èƒ½çœ‹åˆ°"å¯ç”¨"ä½†æäº¤å¤±è´¥ï¼ˆè‡ªåŠ¨ä¿®æ­£åæ­£ç¡®ï¼‰
- ä¾èµ– API å“åº”åŒ…å« currentUsage å­—æ®µ

### ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘
1. **ä¸»åŠ¨åŒæ­¥**ï¼šé¡µé¢åŠ è½½æ—¶ä¸»åŠ¨è°ƒç”¨ `/api/usage/anonymous`
2. **ç¼“å­˜ç­–ç•¥**ï¼šä½¿ç”¨ sessionStorage å‡å°‘ä¸ä¸€è‡´çª—å£
3. **ç”¨æˆ·æç¤º**ï¼šæ£€æµ‹åˆ°ä¸ä¸€è‡´æ—¶æ˜¾ç¤ºå‹å¥½æç¤º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **é…ç½®æ–‡ä»¶**ï¼š`lib/usage-limits.ts` - Anonymous é™åˆ¶é…ç½®ï¼ˆ2æ¬¡/å¤©ï¼Œ4æ¬¡/æœˆï¼‰
- **åç«¯æœåŠ¡**ï¼š`lib/services/usage-service.ts` - IP é™æµå®ç°
- **å‰ç«¯ Hook**ï¼š`hooks/use-usage-limit-v2.ts` - ä½¿ç”¨é™åˆ¶ç®¡ç†
- **API è·¯ç”±**ï¼š`app/api/interpret/route.ts` - æ¢¦å¢ƒè§£æ API

---

## âœ… éªŒè¯æ¸…å•

- [x] æ·»åŠ  `syncFromResponse` æ–¹æ³•åˆ° Hook
- [x] ä¿®æ”¹é¡µé¢å¼•å…¥åŒæ­¥æ–¹æ³•
- [x] æˆåŠŸå“åº”æ—¶åŒæ­¥ä½¿ç”¨æ•°æ®
- [x] é”™è¯¯å“åº”æ—¶åŒæ­¥ä½¿ç”¨æ•°æ®
- [x] å‘åå…¼å®¹æ—§ç‰ˆ API
- [x] æ·»åŠ æ§åˆ¶å°æ—¥å¿—
- [x] é€šè¿‡ Lint æ£€æŸ¥
- [x] åˆ›å»ºå®Œæ•´æ–‡æ¡£

---

## ğŸ‰ æ€»ç»“

**æ··åˆæ¨¡å¼å·²æˆåŠŸå®æ–½ï¼š**

âœ… **å‰ç«¯**ï¼šä½¿ç”¨ localStorageï¼ˆå¿«é€Ÿå“åº”ï¼‰  
âœ… **åç«¯**ï¼šä½œä¸ºæœ€ç»ˆæƒå¨ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰  
âœ… **è‡ªåŠ¨åŒæ­¥**ï¼šä» API å“åº”ä¿®æ­£ä¸ä¸€è‡´  
âœ… **å‘åå…¼å®¹**ï¼šæ”¯æŒæ—§ç‰ˆ API  

**ç”¨æˆ·ä½“éªŒ**ï¼š
- å¿«é€Ÿæ˜¾ç¤ºé¢„ä¼°å€¼
- è‡ªåŠ¨ä¿®æ­£ä¸ä¸€è‡´
- æ— æ„ŸçŸ¥åŒæ­¥
- é˜²æ­¢æ»¥ç”¨ç”Ÿæ•ˆ

**é€‚ç”¨åœºæ™¯**ï¼š
- Anonymous ç”¨æˆ· âœ…
- å·²ç™»å½•ç”¨æˆ· âœ…
- æ¸…é™¤ç¼“å­˜ âœ…
- æ¢æµè§ˆå™¨ âœ…
- æ¢ç½‘ç»œ âœ…

---

**å®æ–½å®Œæˆæ—¶é—´**ï¼š2025-10-30  
**å®æ–½æ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 2ï¼ˆæ··åˆæ¨¡å¼ï¼‰  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•

