/**
 * ä½¿ç”¨æ¬¡æ•°é™åˆ¶ç®¡ç† Hook V2
 * 
 * åŠŸèƒ½ï¼š
 * - åŒé‡é™åˆ¶ï¼šæ¯æ—¥ + æ¯æœˆ
 * - é›†æˆè®¢é˜…å±‚çº§ï¼ˆanonymous/free/basic/proï¼‰
 * - è‡ªåŠ¨é‡ç½®ï¼šæ¯æ—¥ 0:00 å’Œæ¯æœˆ 1 å·
 * - localStorage æœ¬åœ°å­˜å‚¨
 */

"use client"

import { useState, useEffect } from "react"
import { useAuth } from "@/hooks/use-auth"
import { getLimits, type UserTier } from "@/lib/usage-limits"

interface UsageData {
  // æ¯æ—¥æ•°æ®
  dailyCount: number
  date: string  // YYYY-MM-DD
  
  // æ¯æœˆæ•°æ®
  monthlyCount: number
  month: string  // YYYY-MMï¼ˆæœˆä»½ï¼‰
}

const STORAGE_KEY = "lumi_usage_data_v2"
const TIER_STORAGE_KEY = "lumi_user_tier"  // âœ… ç¼“å­˜ç”¨æˆ·å±‚çº§

export function useUsageLimitV2() {
  const { isAuthenticated, user } = useAuth()
  const [usageData, setUsageData] = useState<UsageData | null>(null)
  const [isLimitReached, setIsLimitReached] = useState(false)
  const [subscription, setSubscription] = useState<any>(null)
  const [subscriptionLoading, setSubscriptionLoading] = useState(false)
  const [initialized, setInitialized] = useState(false)  // âœ… åˆå§‹åŒ–æ ‡å¿—ï¼šé˜²æ­¢é‡å¤è°ƒç”¨

  // === è¾…åŠ©å‡½æ•°ï¼ˆéœ€è¦åœ¨å‰é¢å£°æ˜ï¼‰===
  
  // è·å–ä»Šå¤©çš„æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
  const getTodayDate = () => {
    return new Date().toISOString().split('T')[0]
  }

  // è·å–å½“å‰æœˆä»½ï¼ˆYYYY-MMï¼‰
  const getCurrentMonth = () => {
    const date = new Date()
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    return `${year}-${month}`
  }

  // ä» localStorage è·å–ä½¿ç”¨æ•°æ®
  const getUsageData = (): UsageData => {
    if (typeof window === "undefined") {
      return {
        dailyCount: 0,
        date: getTodayDate(),
        monthlyCount: 0,
        month: getCurrentMonth(),
      }
    }

    try {
      const stored = localStorage.getItem(STORAGE_KEY)
      if (stored) {
        const data: UsageData = JSON.parse(stored)
        const today = getTodayDate()
        const thisMonth = getCurrentMonth()
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
        const needsDailyReset = data.date !== today
        const needsMonthlyReset = data.month !== thisMonth
        
        return {
          dailyCount: needsDailyReset ? 0 : data.dailyCount,
          date: today,
          monthlyCount: needsMonthlyReset ? 0 : data.monthlyCount,
          month: thisMonth,
        }
      }
    } catch (error) {
      console.error("[Usage Limit V2] Error reading data:", error)
    }

    return {
      dailyCount: 0,
      date: getTodayDate(),
      monthlyCount: 0,
      month: getCurrentMonth(),
    }
  }

  // ä¿å­˜ä½¿ç”¨æ•°æ®åˆ° localStorage
  const saveUsageData = (data: UsageData) => {
    if (typeof window === "undefined") return

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
    } catch (error) {
      console.error("[Usage Limit V2] Error saving data:", error)
    }
  }

  // è·å–ç”¨æˆ·å±‚çº§ï¼ˆä»æ•°æ®åº“è®¢é˜…æ•°æ® + ç¼“å­˜ï¼‰
  const getUserTier = (): UserTier => {
    // âœ… Anonymous ç”¨æˆ·ï¼šç›´æ¥è¿”å›ï¼Œä¸ç¼“å­˜
    if (!isAuthenticated) {
      return "anonymous"
    }
    
    // âœ… ä¼˜å…ˆä» subscription è·å–ï¼ˆæœ€å‡†ç¡®ï¼‰
    if (subscription && subscription.tier) {
      const tier = subscription.tier as UserTier
      
      // âœ… ç¼“å­˜åˆ° localStorageï¼ˆç”¨äºä¸‹æ¬¡è®¿é—®ï¼‰
      if (typeof window !== "undefined") {
        try {
          localStorage.setItem(TIER_STORAGE_KEY, tier)
        } catch (error) {
          console.error("[Usage Limit V2] Failed to cache tier:", error)
        }
      }
      
      return tier
    }
    
    // âœ… åŠ è½½ä¸­ï¼šä» localStorage è¯»å–ä¸Šæ¬¡çš„å±‚çº§ï¼ˆå‡å°‘é—ªçƒï¼‰
    if (subscriptionLoading && typeof window !== "undefined") {
      try {
        const cachedTier = localStorage.getItem(TIER_STORAGE_KEY)
        if (cachedTier && ['free', 'basic', 'pro'].includes(cachedTier)) {
          console.log("[Usage Limit V2] ğŸ“¦ Using cached tier:", cachedTier)
          return cachedTier as UserTier
        }
      } catch (error) {
        console.error("[Usage Limit V2] Failed to read cached tier:", error)
      }
    }
    
    // âœ… æœ€åæ‰é»˜è®¤ä¸º freeï¼ˆé¦–æ¬¡ç™»å½• + æ— ç¼“å­˜ï¼‰
    return "free"
  }

  // è·å–å½“å‰é™åˆ¶é…ç½®
  const getCurrentLimits = () => {
    const tier = getUserTier()
    return getLimits(tier)
  }

  // æ›´æ–°é™åˆ¶çŠ¶æ€
  const updateLimitStatus = (data: UsageData) => {
    const tier = getUserTier()
    const limits = getLimits(tier)
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¯æ—¥æˆ–æ¯æœˆé™åˆ¶
    const dailyReached = data.dailyCount >= limits.daily
    const monthlyReached = data.monthlyCount >= limits.monthly
    
    setIsLimitReached(dailyReached || monthlyReached)
  }

  // âœ… ä»åˆå¹¶æ¥å£è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè®¢é˜… + ä½¿ç”¨æƒ…å†µï¼‰
  const fetchUserInfo = async () => {
    if (subscriptionLoading) return
    
    setSubscriptionLoading(true)
    try {
      const response = await fetch("/api/user-info")
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }
      
      const result = await response.json()
      
      if (!result.success) {
        throw new Error(result.error?.message || "API returned error")
      }
      
      // âœ… æ›´æ–°è®¢é˜…ä¿¡æ¯
      setSubscription(result.data.subscription)
      console.log("[Usage Limit V2] âœ… User info loaded:", result.data.subscription.tier)
      
      // âœ… æ›´æ–°ä½¿ç”¨æƒ…å†µ
      const today = getTodayDate()
      const thisMonth = getCurrentMonth()
      
      const syncedData: UsageData = {
        dailyCount: result.data.usage.daily,
        date: today,
        monthlyCount: result.data.usage.monthly,
        month: thisMonth,
      }
      
      saveUsageData(syncedData)
      setUsageData(syncedData)
      updateLimitStatus(syncedData)
      
      console.log("[Usage Limit V2] âœ… Usage synced from user-info:", syncedData)
      
    } catch (error) {
      console.error("[Usage Limit V2] Error fetching user info:", error)
      
      // âœ… å®Œæ•´çš„é”™è¯¯é™çº§å¤„ç†
      setSubscription({ tier: "free", status: "active" })
      
      // âœ… åˆå§‹åŒ–é»˜è®¤ usageDataï¼ˆé¿å… null é”™è¯¯ï¼‰
      const defaultData: UsageData = {
        dailyCount: 0,
        date: getTodayDate(),
        monthlyCount: 0,
        month: getCurrentMonth(),
      }
      
      saveUsageData(defaultData)
      setUsageData(defaultData)
      updateLimitStatus(defaultData)
      
      console.log("[Usage Limit V2] âš ï¸ Fell back to default values")
    } finally {
      setSubscriptionLoading(false)
    }
  }

  // âœ… ä»æ•°æ®åº“è·å–ç”¨æˆ·è®¢é˜…å±‚çº§ï¼ˆä¿ç•™ç”¨äºå•ç‹¬åˆ·æ–°ï¼‰
  const fetchUserSubscription = async () => {
    if (subscriptionLoading) return
    
    setSubscriptionLoading(true)
    try {
      const response = await fetch("/api/subscription/manage")
      
      if (response.ok) {
        const result = await response.json()
        
        // âœ… é€‚é…ç»Ÿä¸€å“åº”æ ¼å¼ï¼š{ success: true, data: {...}, metadata: {...} }
        if (result.success) {
          setSubscription(result.data)
          console.log("[Usage Limit V2] User subscription loaded:", result.data.tier)
        } else {
          console.error("[Usage Limit V2] API returned error:", result.error)
          setSubscription({ tier: "free", status: "active" })
        }
      } else {
        console.error("[Usage Limit V2] Failed to fetch subscription:", response.status)
        setSubscription({ tier: "free", status: "active" })
      }
    } catch (error) {
      console.error("[Usage Limit V2] Error fetching subscription:", error)
      setSubscription({ tier: "free", status: "active" })
    } finally {
      setSubscriptionLoading(false)
    }
  }

  // âœ… ä»æ•°æ®åº“åŒæ­¥çœŸå®ä½¿ç”¨æ¬¡æ•°
  const syncUsageFromDatabase = async () => {
    try {
      const response = await fetch("/api/usage")
      
      if (response.ok) {
        const result = await response.json()
        
        // âœ… é€‚é…ç»Ÿä¸€å“åº”æ ¼å¼ï¼š{ success: true, data: {...}, metadata: {...} }
        if (result.success && result.metadata?.source === "database") {
          // ä½¿ç”¨æ•°æ®åº“çš„çœŸå®æ•°æ®æ›´æ–° localStorage
          const today = getTodayDate()
          const thisMonth = getCurrentMonth()
          
          const syncedData: UsageData = {
            dailyCount: result.data.usage.daily,
            date: today,
            monthlyCount: result.data.usage.monthly,
            month: thisMonth,
          }
          
          saveUsageData(syncedData)
          setUsageData(syncedData)
          updateLimitStatus(syncedData)
          
          console.log("[Usage Limit V2] âœ… Synced from database:", syncedData)
        }
      }
    } catch (error) {
      console.error("[Usage Limit V2] Failed to sync from database:", error)
      // åŒæ­¥å¤±è´¥ä¸å½±å“åŠŸèƒ½ï¼Œç»§ç»­ä½¿ç”¨ localStorage
    }
  }

  // === useEffect: åœ¨æ‰€æœ‰å‡½æ•°å£°æ˜ä¹‹å ===
  
  // âœ… è·å–ç”¨æˆ·è®¢é˜…ä¿¡æ¯å’ŒçœŸå®ä½¿ç”¨æ¬¡æ•°ï¼ˆåªåœ¨é¦–æ¬¡è®¤è¯æ—¶æ‰§è¡Œï¼‰
  useEffect(() => {
    if (isAuthenticated && user && !initialized) {
      // é¦–æ¬¡è®¤è¯æˆåŠŸï¼šåˆå§‹åŒ–ç”¨æˆ·æ•°æ®
      console.log("[Usage Limit V2] ğŸ”„ Initializing user data (first time)...")
      fetchUserInfo()  // âœ… ä½¿ç”¨åˆå¹¶æ¥å£ï¼ˆ2æ¬¡è°ƒç”¨ â†’ 1æ¬¡ï¼‰
      setInitialized(true)  // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
    } else if (!isAuthenticated && initialized) {
      // ç”¨æˆ·ç™»å‡ºï¼šé‡ç½®çŠ¶æ€
      console.log("[Usage Limit V2] ğŸ”„ User logged out, resetting state...")
      setSubscription(null)
      setUsageData(null)  // âœ… é‡ç½®ä½¿ç”¨æ•°æ®
      setInitialized(false)  // é‡ç½®åˆå§‹åŒ–æ ‡å¿—
      
      // âœ… æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼ˆé¿å…æ•°æ®æ³„éœ²å’Œéšç§é—®é¢˜ï¼‰
      if (typeof window !== "undefined") {
        try {
          localStorage.removeItem(TIER_STORAGE_KEY)    // æ¸…é™¤å±‚çº§ç¼“å­˜
          localStorage.removeItem(STORAGE_KEY)         // âœ… æ¸…é™¤ä½¿ç”¨æ•°æ®ç¼“å­˜
          console.log("[Usage Limit V2] ğŸ—‘ï¸ Cleared all cached data")
        } catch (error) {
          console.error("[Usage Limit V2] Failed to clear cache:", error)
        }
      }
    }
  }, [isAuthenticated, user, initialized])

  // åˆå§‹åŒ–ä½¿ç”¨æ•°æ®
  useEffect(() => {
    const data = getUsageData()
    setUsageData(data)
    updateLimitStatus(data)
  }, [isAuthenticated])

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨
  const canUse = (): boolean => {
    const data = getUsageData()
    const tier = getUserTier()
    const limits = getLimits(tier)
    
    // å¿…é¡»åŒæ—¶æ»¡è¶³æ¯æ—¥å’Œæ¯æœˆé™åˆ¶
    return data.dailyCount < limits.daily && data.monthlyCount < limits.monthly
  }

  // å¢åŠ ä½¿ç”¨æ¬¡æ•°
  const incrementUsage = () => {
    const data = getUsageData()
    const newData: UsageData = {
      dailyCount: data.dailyCount + 1,
      date: data.date,
      monthlyCount: data.monthlyCount + 1,
      month: data.month,
    }
    
    saveUsageData(newData)
    setUsageData(newData)
    updateLimitStatus(newData)
  }

  // è·å–å‰©ä½™æ¬¡æ•°
  const getRemainingCount = () => {
    if (!usageData) return { daily: 0, monthly: 0 }
    
    const tier = getUserTier()
    const limits = getLimits(tier)
    
    return {
      daily: Math.max(0, limits.daily - usageData.dailyCount),
      monthly: Math.max(0, limits.monthly - usageData.monthlyCount),
    }
  }

  // è·å–é™åˆ¶ç±»å‹ï¼ˆå“ªä¸ªé™åˆ¶å…ˆåˆ°ï¼‰
  const getLimitType = (): "daily" | "monthly" | "none" => {
    if (!usageData) return "none"
    
    const tier = getUserTier()
    const limits = getLimits(tier)
    
    if (usageData.dailyCount >= limits.daily) return "daily"
    if (usageData.monthlyCount >= limits.monthly) return "monthly"
    return "none"
  }

  // è·å–é™åˆ¶æç¤ºä¿¡æ¯
  const getLimitMessage = (): string => {
    const tier = getUserTier()
    const limits = getLimits(tier)
    const remaining = getRemainingCount()
    const limitType = getLimitType()

    // å·²è¾¾åˆ°é™åˆ¶
    if (isLimitReached) {
      if (limitType === "daily") {
        return `You've reached your daily limit of ${limits.daily} interpretations. Please try again tomorrow.`
      } else if (limitType === "monthly") {
        return `You've reached your monthly limit of ${limits.monthly} interpretations. Upgrade for more!`
      }
    }

    // æ¥è¿‘é™åˆ¶ï¼ˆå‰©ä½™ <= 2ï¼‰
    const minRemaining = Math.min(remaining.daily, remaining.monthly)
    
    if (tier === "anonymous") {
      return `You have ${minRemaining} of ${limits.monthly} free interpretations left this month.`
    } else {
      return `You have ${minRemaining} interpretations left (${remaining.daily} today, ${remaining.monthly} this month).`
    }
  }

  /**
   * âœ… ä» API å“åº”åŒæ­¥ä½¿ç”¨æ•°æ®ï¼ˆæ··åˆæ¨¡å¼å…³é”®ï¼‰
   * ç”¨äºï¼šåç«¯æ‹’ç»è¯·æ±‚æ—¶ï¼ŒåŒæ­¥çœŸå®ä½¿ç”¨æƒ…å†µåˆ°å‰ç«¯
   */
  const syncFromResponse = (responseUsage: { daily: number; monthly: number }) => {
    const today = getTodayDate()
    const thisMonth = getCurrentMonth()
    
    const syncedData: UsageData = {
      dailyCount: responseUsage.daily,
      date: today,
      monthlyCount: responseUsage.monthly,
      month: thisMonth,
    }
    
    saveUsageData(syncedData)
    setUsageData(syncedData)
    updateLimitStatus(syncedData)
    
    console.log("[Usage Limit V2] âœ… Synced from API response:", syncedData)
  }

  return {
    // ä½¿ç”¨æ•°æ®
    usageData,
    usageCount: usageData?.monthlyCount || 0,
    
    // å‰©ä½™æ¬¡æ•°
    remainingCount: Math.min(
      getRemainingCount().daily,
      getRemainingCount().monthly
    ),
    remainingDaily: getRemainingCount().daily,
    remainingMonthly: getRemainingCount().monthly,
    
    // é™åˆ¶çŠ¶æ€
    isLimitReached,
    limitType: getLimitType(),
    
    // æ–¹æ³•
    canUse,
    incrementUsage,
    getLimitMessage,
    
    // å…ƒæ•°æ®
    isAuthenticated,
    userTier: getUserTier(),
    limits: getCurrentLimits(),
    
    // âœ… è®¢é˜…ç›¸å…³
    subscription,                    // è®¢é˜…æ•°æ®
    subscriptionLoading,             // è®¢é˜…åŠ è½½çŠ¶æ€
    refreshUserInfo: fetchUserInfo,  // âœ… æ‰‹åŠ¨åˆ·æ–°å…¨éƒ¨ä¿¡æ¯ï¼ˆè®¢é˜… + ä½¿ç”¨æƒ…å†µï¼Œ1æ¬¡è°ƒç”¨ï¼‰
    refreshSubscription: fetchUserSubscription,  // æ‰‹åŠ¨åˆ·æ–°è®¢é˜…ï¼ˆå•ç‹¬è°ƒç”¨ï¼‰
    syncUsageFromDatabase,           // âœ… æ‰‹åŠ¨åŒæ­¥ä½¿ç”¨æ¬¡æ•°ï¼ˆå·²ç™»å½•ç”¨æˆ·ï¼‰
    syncFromResponse,                // âœ… ä»å“åº”åŒæ­¥ï¼ˆæ··åˆæ¨¡å¼ - æ‰€æœ‰ç”¨æˆ·ï¼‰
  }
}

